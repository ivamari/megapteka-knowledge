# Экран «Поиск в каталоге»

## Описание и назначение экрана
Экран предназначен для поиска товаров в каталоге аптеки. Пользователь может вводить поисковый запрос вручную, воспользоваться голосовым вводом или сканированием штрихкода, а также выбрать одну из популярных категорий или воспользоваться историей поиска. Экран позволяет быстро находить нужные препараты, просматривать результаты, фильтровать их и переходить к деталям товара.

## Общая иерархия экрана
Экран реализован на базе `UIViewController` (`SearchVC`). Основная разметка построена с помощью вертикального `UIStackView`, в который вложены контейнер панели поиска и основной контейнер с контентом. В зависимости от состояния отображаются различные контейнеры: история поиска (`UICollectionView`), подсказки (`UITableView`), результаты поиска (`UITableView`).

---

## 1. Верхняя панель
### 1.1. Назначение и элементы
- **Навигационная панель (UINavigationBar)**
  - Заголовок: «Поиск в каталоге» (устанавливается через `navigationItem.title`)
  - Кнопка «Назад» (стандартная кнопка навигации)

---

## 2. Основная область (основной контент)
Экран состоит из панели поиска и основной области, которая динамически меняется в зависимости от состояния поиска.

### 2.1. Панель поиска (`SearchPanelView`)
- **Контейнер панели поиска (`searchPanelContainer: UIView`)**
  - Вложен кастомный компонент `SearchPanelView`, реализованный через XIB.
  - Содержит:
    - **Текстовое поле поиска (`PaddedTextField`)** — для ввода запроса, с иконкой лупы слева и кнопкой очистки.
    - **Кнопка голосового поиска (`buttonVoice: ExtendedHitButton`)** — запускает голосовой ввод. При активном голосовом вводе иконка меняется.
    - **Кнопка сканирования штрихкода (`buttonScan: ExtendedHitButton`)** — открывает экран сканирования.
  - Особенности:
    - Кнопки могут быть скрыты в зависимости от состояния.
    - Поддерживается placeholder и стилизация.
    - Взаимодействие: ввод текста, нажатие на кнопки, переход к сканеру, запуск голосового поиска.

### 2.2. Основной контейнер (`viewContainer: UIView`)
Внутри основной области отображается один из трёх контейнеров в зависимости от состояния:

#### 2.2.1. История поиска (`collectionViewHistory: UICollectionView`)
- **Секции (SearchHistoryDataAdatper):**
  - **querySuggestions** — предложения по поиску (отображаются как одна ячейка с набором вариантов).
  - **history** — список последних поисковых запросов пользователя.
  - **clear** — кнопка «Очистить историю поиска».
  - **prompt** — информационный промпт, если история пуста.
- **Ячейки:**
  - `SearchQueryCell` — ячейка с вариантами быстрых поисковых запросов.
  - `SuggestionView` — ячейка истории поиска.
  - `SuggestionsClearCell` — ячейка-кнопка для очистки истории.
  - `SearchPromptHistoryCell` — ячейка с подсказкой при пустой истории.
- **Взаимодействие:**
  - Тап по истории или предложению — выполняет поиск.
  - Тап по «Очистить историю поиска» — очищает историю.

#### 2.2.2. Подсказки (`tableViewSuggestions: UITableView`)
- **Секции (SuggestionsVM.Section):**
  - **suggests** — подсказки по текущему запросу (например, товары, категории, теги).
  - **groups** — группы популярных категорий (например, «от боли в горле», «от аллергии» и др.), каждая оформлена как кнопка.
- **Ячейки:**
  - `SuggestionView` — отображает подсказку или группу.
- **Взаимодействие:**
  - Тап по подсказке или группе — выполняет поиск или фильтрацию по выбранному тегу/группе.

#### 2.2.3. Результаты поиска (`viewItemsContainer: UIView` > `tableViewItems: UITableView`)
- **Секции (ItemsVM.Section):**
  - **filters** — фильтры поиска (`SearchFiltersView`), отображаются в виде горизонтального списка фильтров и сортировок.
  - **prompt** — информационные сообщения (например, «ничего не найдено», ошибки, рекомендации).
  - **alerts** — алерты (например, предупреждение о предоплате).
  - **groups** — группы товаров (например, «Рядом со мной»).
  - **items** — список найденных товаров (`CatalogueItem`).
  - **loader** — индикатор загрузки.
- **Ячейки:**
  - `FlexiblePromptView` — отображает информационные сообщения и рекомендации.
  - `AlertInItemsView` — отображает алерты.
  - `SearchGroupsView` — отображает группы товаров.
  - `SearchFiltersView` — отображает фильтры.
  - `LoaderView` — индикатор загрузки.
  - Ячейки товаров — отображают карточки товаров с кнопками «В корзину», «В избранное» и др.
- **Взаимодействие:**
  - Тап по товару — переход к деталям товара.
  - Тап по кнопкам — добавление в корзину, избранное и др.
  - Тап по фильтрам/сортировкам — изменение условий поиска.
  - Скролл — подгрузка новых товаров (пагинация).

##### 2.2.3.1. Подробно о SearchFiltersView
- **SearchFiltersView** — кастомный UIView, отображающий горизонтальный скроллируемый список фильтров.
  - Внутри содержит компонент `FiltersItemsView` (`UIScrollView` + горизонтальный `UIStackView`).
  - Каждый фильтр отображается с помощью `FilterItemView`.
    - **viewContainer (HighlightedView)** — контейнер с закруглениями и тенью, реагирует на нажатие.
    - **imageViewIcon (UIImageView)** — иконка фильтра (например, сортировка, адрес, категория и т.д.).
    - **labelTitle (UILabel)** — название фильтра (например, «По популярности», «Рядом», «Категория»).
    - **buttonAction (ExtendedHitButton)** — кнопка для раскрытия фильтра (стрелка). Для этих фильтров сброс не предусмотрен.
  - **Состав фильтров:**
    1. **Сортировка** (`SortModel`) — выбор способа сортировки товаров (по популярности, цене и т.д.).
    2. **Фильтр по адресу/близости** (`AddressesModel`) — выбор адреса или опции «Рядом» для поиска в ближайших аптеках.
    3. **Дополнительные фильтры** (`ItemsFiltersModel`) — набор фильтров из модели данных (например, производитель, форма выпуска, категория и др.).
  - **Взаимодействие:**
    - Тап по фильтру (viewContainer): если поддерживается выбор, открывается модальное окно выбора или выпадающий список.
    - При выборе/изменении фильтра обновляется список товаров.
    - Для фильтра «Рядом» при обновлении адресов автоматически обновляется отображение фильтров.
  - **Особенности:**
    - Фильтры могут быть скрыты (isVisible = false).
    - Для каждого фильтра динамически определяется иконка, название, возможность раскрытия.
    - Высота фильтров фиксирована (`SearchFiltersView.height = 36`).
    - Фильтры автоматически обновляются при изменении модели данных.

---

## 3. Всплывающие и дополнительные элементы
- **Алерты и промпты** — отображаются в секциях prompt/alerts (например, ошибки, пустой результат, рекомендации).
- **Модальные окна** — открываются при сканировании штрихкода, выборе товара и других действиях (реализовано через роутер `SearchRouter`).

---

## 4. Нижняя навигационная панель
- **TabBar (UITabBarController)** — стандартная нижняя панель приложения с разделами: Главный, Каталог, Корзина, Избранное, Меню.
- Переход между разделами осуществляется через нажатие на иконки.

---

## 5. Открываемые экраны при взаимодействии с элементами

### Интерактивные элементы и открываемые экраны (с кодовыми названиями)

- **Кнопка сканирования штрихкода** (на панели поиска)
  - Открывает: Экран сканирования штрихкода (**ScanItemBarcodeVC**)
- **Тап по элементу истории или предложению**
  - Открывает: Результаты поиска (тот же экран, но с новым поисковым запросом) (**SearchVC**)
- **Тап по тегу/группе (в истории или подсказках)**
  - Открывает: Список товаров по тегу/группе (**CatalogueItemsVC**)
- **Тап по подсказке (query/tag/group)**
  - Открывает: Список товаров по выбранному тегу/группе (**CatalogueItemsVC**)
- **Тап по карточке товара**
  - Открывает: Детали товара (**ItemDetailVC**)
- **Тап по кнопке «Похожие»**
  - Открывает: Список похожих товаров (**ItemsSimilarVC**)
- **Тап по кнопке «Вы покупали»**
  - Открывает: Экран персональных заказов по товару (**ItemPersonalOrderedVC**)
- **Тап по ссылке**
  - Открывает: Внешний браузер или внутренний WebView (**WebVC** или системный браузер)
- **Тап по фильтру сортировки**
  - Открывает: Экран сортировки товаров (**ItemsSortsVC**, модальное окно)
- **Тап по фильтру адреса/близости**
  - Открывает: Экран выбора адреса/радиуса (**FilterAddressesVC**, модальное окно)
- **Тап по дополнительным фильтрам**
  - Открывает: Экран списка фильтров (**FiltersListVC**, модальное окно)
- **Кнопка с deeplink**
  - Открывает: Внешний или внутренний экран по ссылке (**WebVC** или другой VC по deeplink)

---

## 6. Схематичное дерево иерархии экрана
```
Экран поиска в каталоге (SearchVC)
├── Верхняя панель (UINavigationBar)
│   ├── Кнопка «Назад»
│   └── Заголовок «Поиск в каталоге»
├── Основная область (UIStackView)
│   ├── Панель поиска (SearchPanelView)
│   │   ├── Текстовое поле поиска (PaddedTextField)
│   │   ├── Кнопка голосового поиска (ExtendedHitButton)
│   │   └── Кнопка сканирования штрихкода (ExtendedHitButton)
│   └── Контейнер контента (viewContainer)
│       ├── История поиска (UICollectionView)
│       │   ├── Секция querySuggestions (SearchQueryCell)
│       │   ├── Секция history (SuggestionView)
│       │   ├── Секция clear (SuggestionsClearCell)
│       │   └── Секция prompt (SearchPromptHistoryCell)
│       ├── Подсказки (UITableView)
│       │   ├── Секция suggests (SuggestionView)
│       │   └── Секция groups (SuggestionView)
│       └── Результаты поиска (viewItemsContainer)
│           └── Таблица товаров (UITableView)
│               ├── Секция filters (SearchFiltersView)
│               │   └── FiltersItemsView (UIScrollView)
│               │       └── UIStackView (горизонтальный)
│               │           └── FilterItemView (на каждый фильтр)
│               │               ├── viewContainer (HighlightedView)
│               │               ├── imageViewIcon (UIImageView)
│               │               ├── labelTitle (UILabel)
│               │               └── buttonAction (ExtendedHitButton)
│               ├── Секция prompt (FlexiblePromptView)
│               ├── Секция alerts (AlertInItemsView)
│               ├── Секция groups (SearchGroupsView)
│               ├── Секция items (CatalogueItem)
│               └── Секция loader (LoaderView)
└── Нижняя навигационная панель (UITabBarController)
    ├── Главный
    ├── Каталог
    ├── Корзина
    ├── Избранное
    └── Меню
```

---

## [Нужно дополнить]
- Не хватает информации о точных названиях и структуре всех ячеек для истории поиска, подсказок и товаров (например, какие именно классы используются для карточек товаров, фильтров, групп и промптов).
- Не все состояния отображения элементов (например, условия показа алертов, промптов, групп) можно однозначно определить без дополнительного анализа кода и XIB.
- Не описаны все возможные пользовательские сценарии взаимодействия с фильтрами и сортировками.
- Не хватает информации о кастомных иконках и изображениях, используемых в панели поиска и карточках товаров. 
