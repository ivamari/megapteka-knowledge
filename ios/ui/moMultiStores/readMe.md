# Экран «Заказ из нескольких аптек» (MOMultiStoresVC)

## Описание и назначение экрана
Экран предназначен для выбора оптимального варианта заказа товаров из нескольких аптек. Пользователь может видеть на карте варианты комплектования заказа, сравнивать их по цене и количеству аптек, просматривать детали каждого варианта, а также выбирать подходящий вариант для оформления заказа. Экран играет ключевую роль в сценарии выбора и подтверждения заказа из нескольких аптек.

## Общая иерархия экрана
Экран реализован на базе UIViewController (`MOMultiStoresVC`). Состоит из следующих основных областей:
- Верхняя панель (навигационный бар)
- Основная область (карта, коллекция вариантов, лист с деталями варианта)
- Всплывающие и дополнительные элементы (кнопки, алерты)
- Нижняя панель выбора

---

## 1. Верхняя панель
### 1.1. Назначение и элементы
- **Заголовок**: «Заказ из нескольких аптек» (navigationItem.title, задаётся через `TextProvider.MakeOrder.Stores.Multi.screenTitle`)
- **Кнопка назад**: стандартная кнопка возврата (слева)
- **Особенности**: Верхняя панель всегда закреплена в верхней части экрана, не содержит дополнительных элементов поиска или фильтрации.

---

## 2. Основная область
Основная область экрана реализована с помощью нескольких вложенных представлений:

### 2.1. Карта (MultiStoresMapAdapter)
- **Описание**: Отображает карту с маркерами вариантов комплектования заказа (MultiStoresMarker), а также отдельные аптеки.
- **Взаимодействие**:
  - Тап по маркеру варианта — выделяет соответствующий вариант, раскрывает лист с деталями.
  - Кнопка компаса (`CompassButton`) — сбрасывает положение компаса.
  - Кнопка текущей локации (`buttonLocation`) — перемещает карту к текущей геопозиции пользователя.
  - Кнопки зума (`buttonZoomIn`, `buttonZoomOut`) — увеличивают/уменьшают масштаб карты.
- **Особенности**: Кнопки управления картой сгруппированы в вертикальный стек (`stackViewMapButton`), расположены справа поверх карты.

### 2.2. Кнопка «Показать все варианты» (`buttonShowAllVariants`)
- **Описание**: Кнопка появляется, если выбран конкретный вариант, и позволяет вернуться к просмотру всех вариантов на карте.
- **Взаимодействие**: При нажатии возвращает к отображению всех вариантов (сброс выбора).
- **Особенности**: Плавающая, появляется/скрывается анимированно в зависимости от состояния экрана.

### 2.3. Коллекция вариантов (UICollectionView, `collectionViewVariants`)
- **Описание**: Горизонтальная коллекция карточек вариантов комплектования заказа (`MOMultiStoresVariantCardView`).
- **Элементы карточки**:
  - Цена варианта (`labelTitle`)
  - Количество аптек (`labelText`)
- **Взаимодействие**: Тап по карточке — выбирает вариант, раскрывает лист с деталями.
- **Особенности**: Коллекция закреплена в верхней части листа, скролл горизонтальный, поддерживает выделение.

### 2.4. Лист с деталями варианта (viewSheetContainer > viewSheet)
- **Описание**: Нижний лист, который может быть свернут, развернут или скрыт. Содержит детали выбранного варианта.
- **Состояния**:
  - Скрыт (нет выбранного варианта)
  - Компактный (отображается только превью)
  - Развернутый (отображаются все детали)
- **Взаимодействие**:
  - Перетаскивание листа (панорамный жест) — изменяет состояние листа.
  - Кнопка «Развернуть» (`buttonExpandSheet`) — переводит лист в развернутое состояние.

#### 2.4.1. Превью варианта (viewPreview)
- **Заголовок**: «Из N аптек за X ₽» (`labelPreviewTitle`)
- **Кнопка «Развернуть»** (`buttonExpandSheet`): переводит лист в развернутое состояние.
- **Кнопка «Выбрать»** (`buttonPreviewChoose`): подтверждает выбор варианта.
- **Особенности**: Превью отображается только в компактном состоянии листа.

#### 2.4.2. Список аптек варианта (UITableView, `tableViewStores`)
- **Описание**: Таблица с деталями аптек, входящих в выбранный вариант (`MOMultiStoresStoreView`).
- **Ячейка аптеки** (`MOMultiStoresStoreView`):
  - Адрес аптеки (`labelAddress`)
  - Метро (иконки и названия, `stackViewMetro`)
  - Название и логотип бренда (`labelBrand`, `imageViewBrand`)
  - Расстояние и время (`labelDistance`, `labelDistanceTime`)
  - Рейтинг (`viewRating`)
  - Доступность для маломобильных (`viewAccessibility`)
  - График работы (`labelSchedule`)
  - Описание графика (`textViewScheduleDescr`)
  - Время сборки заказа (`labelBuildTime`)
  - Срок брони (`labelReservationDays`)
  - Дата готовности (`labelArrivalDate`)
  - Список товаров (`stackViewItems`)
  - Ворнинги/предупреждения (`stackViewWarnings`)
- **Особенности**: Ячейки не кликабельны, но могут содержать дополнительные интерактивные элементы (например, раскрытие описания графика).

#### 2.4.3. Разделитель (viewPreviewSeparator)
- **Описание**: Визуальный разделитель между превью и списком аптек.

#### 2.4.4. Нижняя панель выбора (viewMainChooseContainer)
- **Кнопка «ВЫБРАТЬ»** (`buttonMainChoose`): подтверждает выбор варианта, доступна только в развернутом состоянии листа.

---

## 3. Всплывающие и дополнительные элементы
- **Алерты**: Могут появляться при ошибках загрузки, отсутствии доступа к геолокации и т.д. (вызываются через `showAlert`).
- **Индикатор загрузки**: Отображается при загрузке вариантов или данных аптек.

---

## 4. Нижняя навигационная панель
- На экране отсутствует стандартная нижняя навигационная панель. Нижняя часть экрана занята листом с деталями и кнопкой выбора.

---

## 5. Открываемые экраны при взаимодействии с элементами
- **Кнопка «ВЫБРАТЬ»** (buttonMainChoose, buttonPreviewChoose): открывает экран подтверждения заказа (`MOMultiConfirmVC`).
- **Кнопка назад**: возвращает на предыдущий экран.
- **Кнопка «Показать все варианты»**: возвращает к просмотру всех вариантов на карте.

---

## 6. Схематичное дерево иерархии экрана
```
Экран «Заказ из нескольких аптек» (MOMultiStoresVC)
├── Верхняя панель (UINavigationBar)
│   ├── Кнопка назад
│   └── Заголовок
├── Основная область
│   ├── Карта (MultiStoresMapAdapter)
│   │   ├── Маркеры вариантов (MultiStoresMarker)
│   │   └── Кнопки управления картой (stackViewMapButton)
│   │       ├── Кнопка компаса (CompassButton)
│   │       ├── Кнопка текущей локации (buttonLocation)
│   │       ├── Кнопка зума + (buttonZoomIn)
│   │       └── Кнопка зума - (buttonZoomOut)
│   ├── Кнопка «Показать все варианты» (buttonShowAllVariants)
│   ├── Коллекция вариантов (collectionViewVariants)
│   │   └── Карточка варианта (MOMultiStoresVariantCardView)
│   │       ├── Цена варианта (labelTitle)
│   │       └── Количество аптек (labelText)
│   └── Лист с деталями варианта (viewSheetContainer > viewSheet)
│       ├── Превью варианта (viewPreview)
│       │   ├── Заголовок (labelPreviewTitle)
│       │   ├── Кнопка «Развернуть» (buttonExpandSheet)
│       │   └── Кнопка «Выбрать» (buttonPreviewChoose)
│       ├── Разделитель (viewPreviewSeparator)
│       ├── Список аптек (tableViewStores)
│       │   └── Ячейка аптеки (MOMultiStoresStoreView)
│       │       ├── Адрес (labelAddress)
│       │       ├── Метро (stackViewMetro)
│       │       ├── Название и логотип бренда (labelBrand, imageViewBrand)
│       │       ├── Расстояние и время (labelDistance, labelDistanceTime)
│       │       ├── Рейтинг (viewRating)
│       │       ├── Доступность (viewAccessibility)
│       │       ├── График работы (labelSchedule)
│       │       ├── Описание графика (textViewScheduleDescr)
│       │       ├── Время сборки (labelBuildTime)
│       │       ├── Срок брони (labelReservationDays)
│       │       ├── Дата готовности (labelArrivalDate)
│       │       ├── Список товаров (stackViewItems)
│       │       └── Ворнинги (stackViewWarnings)
│       └── Нижняя панель выбора (viewMainChooseContainer)
│           └── Кнопка «ВЫБРАТЬ» (buttonMainChoose)
└── Всплывающие элементы
    ├── Алерты
    └── Индикатор загрузки
```