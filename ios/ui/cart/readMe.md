# Корзина (CartVC)

## Описание и назначение экрана

Экран "Корзина" предназначен для управления товарами, которые пользователь планирует приобрести. Здесь можно просматривать список добавленных товаров, изменять их количество, удалять, отмечать для оформления заказа, видеть предупреждения и подсказки, а также переходить к выбору аптеки для оформления заказа. Экран поддерживает различные состояния: пустая корзина, ошибки, предупреждения, частичная или полная недоступность товаров.

## Общая иерархия экрана

Экран реализован на основе UIViewController (`CartVC`) с использованием `UITableView` для отображения основного контента, а также дополнительных вью для предупреждений, кнопки оформления заказа и всплывающих элементов.

---

## 1. Верхняя панель

### 1.1. Назначение и элементы

- **Заголовок**: "Корзина" (`navigationItem.title`)
- **Кнопка "Поделиться"**: появляется, если есть выбранные товары (`navigationItem.rightBarButtonItem`)
  - Открывает системное окно шаринга (share sheet).

---

## 2. Основная область (основной контент)

### 2.1. Секции и их элементы (в порядке отображения)

#### 2.1.1. Таблица товаров (`UITableView`, CartVC.tableView)

Секции таблицы определяются через `CartDataAdapter`:

1. **Отступ (space)**  
   - Служебная секция для визуального отступа сверху.

2. **Предупреждения (warnings)**  
   - Ячейки: `CartWarningView` (внутри — `WarningView`)
   - Отображаются предупреждения, связанные с заказом, оплатой, лимитами, условиями хранения и др.:
     - _"Предоплата не требуется. Заказ оплачивается в аптеке при получении"_
     - _"Цены на товары могут различаться в зависимости от выбранной аптеки"_
     - _"Мы заметили, что вы храните более 20 товаров в корзине..."_ (с кнопкой "Перенести в избранное")
   - Взаимодействие:  
     - Кнопка "Закрыть" — скрывает предупреждение (временно или навсегда).
     - Кнопка действия (если есть) — выполняет действие (например, перенести товары в избранное).
     - Ссылки — открывают внешние или внутренние экраны.

3. **Заголовок списка товаров (cartItemsH)**  
   - Хедер: `CartSelectionHeaderView`
     - **Чекбокс "Выбрать все"** (`buttonSelectAll`)
       - Отмечает/снимает выделение со всех товаров.
     - **Кнопка "Удалить выбранные"** (`buttonRemove`)
       - Открывает алерт для подтверждения удаления выбранных товаров.
     - **Разделитель** (`viewSeparator`)
   - Отображается только если в корзине есть товары.

4. **Список товаров (cartItems)**  
   - Ячейки: `MarkableItemView`
     - **Чекбокс выбора товара** (`buttonSelection`)
     - **Изображение товара** (`imageViewImg`)
     - **Название товара** (`labelName`)
     - **Производитель** (`labelManufacturer`)
     - **Цена** (`labelPrice`)
     - **Количество аптек** (`labelStoresQuantity`)
     - **Кнопка "В избранное"** (`buttonAddToFav`)
     - **Кнопка "Удалить"** (`buttonRemove`)
     - **Кнопка "Похожие"** (в составе `viewBuyButton`)
     - **Кнопки изменения количества** (в составе `viewBuyButton`)
     - **Стикеры, предупреждения, условия хранения** (отдельные вью)
     - **Цена за штуку** (`labelPriceApiece`)
     - **Разделитель** (`viewSeparatorBottom`)
   - Взаимодействие:
     - Чекбокс — выделяет товар для массовых операций.
     - Кнопка "Удалить" — удаляет товар из корзины.
     - Кнопка "В избранное" — добавляет товар в избранное.
     - Кнопка "Похожие" — открывает экран похожих товаров.
     - Кнопки +/- — изменяют количество.
     - Тап по ячейке — открывает экран детализации товара (`ItemDetailVC`).
   - Особенности:
     - Для недоступных товаров отображается статус "Нет в наличии".
     - Для товаров с особыми условиями — стикеры, подсказки, предупреждения.
     - Для товаров с ограничениями — всплывающие подсказки.
     - В карточке товара может отображаться предупреждение о лимите количества:  
       _"Ни в одной аптеке нет больше 99 шт."_ при попытке выбрать больше допустимого количества.

5. **Итоговая информация (total)**  
   - Хедер: `CartTotalView`
     - **Количество товаров** (`labelTitle`)
     - **Сумма** (`labelAmount`)
   - Отображается только если в корзине есть товары.

6. **Количество аптек (storesQuantity)**  
   - Хедер: `CartStoresQuantityView`
     - **Текст с количеством аптек** (`labelTitle`)
   - Отображается только если в корзине есть товары.

### 2.2. Нижняя область экрана (viewBottomContainer)

`viewBottomContainer` — это нижний фиксированный контейнер, который всегда находится внизу экрана корзины. В нем размещаются:
- предупреждения (viewWarning, labelWarning)
- кнопка оформления заказа (viewMakeOrderContainer, buttonMakeOrder)

#### Состояния и логика отображения

1. **Нет выбранных товаров**
   - Кнопка "ВЫБРАТЬ АПТЕКУ" (`buttonMakeOrder`) неактивна, заблокирована.
   - Отображается предупреждение на красном фоне:
     _"Выберите товары, чтобы перейти к оформлению заказа"_

2. **Выбраны товары, но не выполнено минимальное условие (например, минимальная сумма заказа со склада)**
   - Кнопка "ВЫБРАТЬ АПТЕКУ" (`buttonMakeOrder`) неактивна, заблокирована.
   - Отображается предупреждение на красном фоне:
     _"Минимальная сумма при заказе со склада составляет 400 рублей"_

3. **Выбраны товары, но все они временно отсутствуют в аптеках города**
   - Кнопка "ВЫБРАТЬ АПТЕКУ" (`buttonMakeOrder`) активна, не заблокирована.
   - Отображается предупреждение на красном фоне:
     _"Выбранные товары временно отсутствуют в аптеках города, но вы можете заказать их со склада поставщика. Срок ожидания от 3 дней."_

4. **Выбраны товары, сумма достаточна, все условия выполнены**
   - Кнопка "ВЫБРАТЬ АПТЕКУ" (`buttonMakeOrder`) активна, не заблокирована.
   - Предупреждений нет.

#### Взаимодействие пользователя

- **Кнопка "ВЫБРАТЬ АПТЕКУ"**  
  - Активируется только при выполнении всех условий (выбраны товары, товары доступны для заказа, сумма товаров выше минимально допустимой).
  - При нажатии открывает экран выбора аптеки (`MOChooseStoreVC`).

---

## 3. Всплывающие и дополнительные элементы

- **Вью предупреждения (viewWarning, labelWarning)**  
  - Отображается в нижней части экрана, содержит текстовое предупреждение (например, минимальная сумма заказа, сроки доставки).
  - Может быть скрыта или показана в зависимости от состояния корзины.

- **Вью prompt (PromptView)**  
  - Показывается вместо основного контента при ошибках или пустой корзине.
  - Содержит иконку, заголовок, описание, кнопку ("Перейти к товарам" или "Повторить попытку").
  - Взаимодействие:  
    - Кнопка "Перейти к товарам" — открывает каталог.
    - Кнопка "Повторить попытку" — повторяет загрузку корзины.

- **Алерты (AlertModel)**  
  - Подтверждение удаления выбранных товаров.
  - Сообщения об ошибках, успешных действиях (например, "Товары перенесены в избранное").

---

## 4. Нижняя навигационная панель

- **TabBar (UITabBarController)**  
  - Кнопки: "Главный", "Каталог", "Корзина", "Избранное", "Меню"
  - Переход между основными разделами приложения.

---

## 5. Открываемые экраны при взаимодействии с элементами

- **Кнопка "Поделиться"**  
  - Открывает системное окно шаринга (share sheet).

- **Кнопка "Удалить выбранные"**  
  - Открывает алерт подтверждения удаления.

- **Кнопка "Похожие"** (в ячейке товара)  
  - Открывает экран похожих товаров (`ItemsSimilarVC`).

- **Кнопка "В избранное"**  
  - Добавляет товар в избранное, не открывает отдельный экран.

- **Кнопка "Выбрать аптеку"**  
  - Открывает экран выбора аптеки (`MOChooseStoreVC`).

- **Тап по товару**  
  - Открывает экран детализации товара (`ItemDetailVC`).

- **Кнопка "Перейти к товарам"** (в PromptView)  
  - Открывает каталог товаров.

---

## 6. Схематичное дерево иерархии экрана

```
Корзина (CartVC)
├── Верхняя панель (UINavigationBar)
│   ├── Заголовок "Корзина"
│   └── Кнопка "Поделиться" (UIBarButtonItem)
├── Основная область (UIStackView: viewContainer)
│   └── Таблица (UITableView: tableView)
│       ├── Секция: Отступ (space)
│       ├── Секция: Предупреждения (warnings)
│       │   └── Ячейка: CartWarningView
│       │       └── WarningView
│       ├── Секция: Заголовок списка товаров (cartItemsH)
│       │   └── Хедер: CartSelectionHeaderView
│       │       ├── Чекбокс "Выбрать все" (buttonSelectAll)
│       │       ├── Кнопка "Удалить выбранные" (buttonRemove)
│       │       └── Разделитель (viewSeparator)
│       ├── Секция: Список товаров (cartItems)
│       │   └── Ячейка: MarkableItemView
│       │       ├── Чекбокс выбора (buttonSelection)
│       │       ├── Изображение товара (imageViewImg)
│       │       ├── Название (labelName)
│       │       ├── Производитель (labelManufacturer)
│       │       ├── Цена (labelPrice)
│       │       ├── Количество аптек (labelStoresQuantity)
│       │       ├── Кнопка "В избранное" (buttonAddToFav)
│       │       ├── Кнопка "Удалить" (buttonRemove)
│       │       ├── Кнопка "Похожие" (viewBuyButton)
│       │       ├── Кнопки +/- (viewBuyButton)
│       │       ├── Стикеры, предупреждения, условия хранения
│       │       ├── Цена за штуку (labelPriceApiece)
│       │       └── Разделитель (viewSeparatorBottom)
│       ├── Секция: Итоговая информация (total)
│       │   └── Хедер: CartTotalView
│       │       ├── Количество товаров (labelTitle)
│       │       └── Сумма (labelAmount)
│       └── Секция: Количество аптек (storesQuantity)
│           └── Хедер: CartStoresQuantityView
│               └── Текст (labelTitle)
├── Нижняя область (UIStackView: viewBottomContainer)
│   ├── Вью предупреждения (viewWarning)
│   │   └── Текст (labelWarning)
│   └── Вью кнопки оформления заказа (viewMakeOrderContainer)
│       └── Кнопка "Выбрать аптеку" (buttonMakeOrder)
├── Всплывающие элементы
│   ├── PromptView (пустая корзина/ошибка)
│   └── Алерты (AlertModel)
└── Нижняя навигационная панель (UITabBar)
    ├── Главный
    ├── Каталог
    ├── Корзина
    ├── Избранное
    └── Меню
```

---

## [Нужно дополнить]

- Не все состояния PromptView и WarningView можно описать без просмотра их моделей и TextProvider — требуется уточнение всех возможных текстов, иконок и сценариев.
- Для некоторых кнопок (например, "Похожие", "В избранное") требуется уточнение, всегда ли они доступны для всех товаров.
- Не все возможные стикеры, предупреждения и условия хранения товаров можно перечислить без дополнительной информации о моделях данных.
- Не описаны все возможные алерты и их сценарии (например, ошибки сети, лимиты, подтверждения). 