# Аптечный контроль

## Описание и назначение экрана

Экран "Аптечный контроль" предназначен для просмотра и контроля информации об аптеках, их адресах, брендах, времени работы, расстоянии до пользователя, а также для загрузки и просмотра пользовательских фотографий аптек. Пользователь может переключаться между списком и картой, фильтровать аптеки по городу, расстоянию и наличию фото, а также загружать фотографии и строить маршрут до выбранной аптеки.

## Общая иерархия экрана

Экран реализован на основе UIViewController (`PharmacyControlVC`) с использованием кастомных UIView-компонентов и xib-файлов. Основные области: верхняя панель с сегментами и фильтрами, основная область (список или карта), всплывающие элементы (алерты, попапы), нижняя навигационная панель.

---

## 1. Верхняя панель

### 1.1. Назначение и элементы

- **Заголовок**: "Аптечный контроль" (устанавливается через navigationItem.title)
- **Кнопка "Назад"**: стандартная кнопка возврата (слева)
- **Поле поиска**: появляется при активации поиска (SearchBarService)
- **Кнопка поиска**: справа, открывает строку поиска
- **Сегментированный контрол** (`ViSegmentedControl<StoresSegmentItem>` внутри `ContainerView`): переключение между вкладками "Список" и "Карта"
- **Фильтры** (`FiltersItemsView`): горизонтальный скроллируемый список фильтров (город, рядом, без фото и др.)

#### Взаимодействие:
- Переключение сегментов меняет отображаемую область (список/карта).
- Фильтры изменяют отображаемые аптеки.
- Поиск фильтрует аптеки по названию/адресу.

### 1.2. Фильтры (подробно)

На экране используются три фильтра, которые отображаются горизонтально под сегментами "Список/Карта":

1. **Город** (тип: ActionModel)
   - Кнопка с названием выбранного города (например, "Пермь").
   - При нажатии открывается экран выбора города.
   - После выбора города обновляется список аптек и фильтры.
   - Может быть скрыт, если нет доступных городов.

2. **Рядом** (тип: AddressesModel)
   - Кнопка с подписью "Рядом".
   - При нажатии открывается меню выбора адреса или радиуса (если доступно несколько адресов).
   - Если адрес только один, он выбирается сразу.
   - После выбора адреса обновляется список аптек и фильтры.
   - Сброс фильтра отменяет выбранный адрес (показываются все аптеки).
   - Может быть скрыт, если нет доступных адресов.

3. **Без фото** (тип: BoolModel)
   - Кнопка "Без фото".
   - При нажатии фильтр включается/выключается.
   - Включённый фильтр показывает только аптеки, у которых нет пользовательских фото.
   - Сброс фильтра выключает фильтр.
   - Может быть скрыт, если нет аптек для фильтрации.

#### Логика взаимодействия с фильтрами:
- **Выбор фильтра**:
  - "Город": открывается экран выбора города, после выбора обновляется список аптек.
  - "Рядом": открывается меню выбора адреса/радиуса, после выбора обновляется список аптек.
  - "Без фото": фильтр переключается, сразу применяется фильтрация.
- **Сброс фильтра**:
  - "Рядом": отменяет выбранный адрес, показываются все аптеки.
  - "Без фото": выключает фильтр.
- **Влияние на отображение**:
  - Любое изменение фильтра приводит к пересчёту и обновлению списка аптек и маркеров на карте.
  - Фильтры могут быть скрыты, если для них нет данных.

#### UI-поведение:
- Фильтры отображаются горизонтально в верхней части экрана под сегментами.
- Каждый фильтр — отдельная кнопка с названием (например, "Пермь", "Рядом", "Без фото").
- Активные фильтры визуально выделяются.
- При выборе фильтра "Город" или "Рядом" открывается модальное окно или меню для выбора значения.
- При выборе "Без фото" фильтр просто переключается.

#### Примеры сценариев:
- Пользователь выбирает город —> открывается экран выбора города —> после выбора обновляется список аптек.
- Пользователь выбирает "Рядом" —> открывается меню выбора адреса или радиуса —> после выбора обновляется список аптек.
- Пользователь включает "Без фото" —> отображаются только аптеки без пользовательских фото.
- Пользователь сбрасывает фильтр "Рядом" —> показываются все аптеки без фильтрации по адресу.

---

## 2. Основная область (основной контент)

### 2.1. Список (Сегмент "Список", компонент `PharmacyControlSegmentListView`)

- **UITableView**: отображает список аптек, каждая аптека — отдельная ячейка (`PharmacyControlListStoreView`)
- **Ячейка аптеки** (`PharmacyControlStoreView`):
  - Адрес аптеки (`labelAddress`)
  - Название и логотип бренда (`labelBrand`, `imageViewBrand`)
  - Расстояние до аптеки (`labelDistance`)
  - Время до аптеки (`labelDistanceTime`, `imageViewDistanceTime`)
  - Время работы (`textViewScheduleDescr`)
  - Блок "Фото от пользователей":
    - Заголовок с количеством фото (`labelPhotosTitle`)
    - Превью фотографий (`SmallImagesPreview`)
    - Кнопка "Загрузить фото" (`buttonUploadPhotos`)
  - Кнопки:
    - "Показать на карте" (`buttonShowOnMap`)
    - "Построить маршрут" (`buttonRoute`)
- **Особенности**:
  - Кнопка "Загрузить фото" открывает экран загрузки.
  - Кнопка "Показать на карте" переводит к выбранной аптеке на карте.
  - Кнопка "Построить маршрут" — открывает построение маршрута (если есть координаты).
  - Превью фото — открывает просмотр фото.
  - Если фото нет, отображается "Нет фото от пользователей".

#### Взаимодействие:
- Скроллинг списка.
- Тап по фото — просмотр фото.
- Тап по кнопкам — соответствующие действия.

---

### 2.2. Карта (Сегмент "Карта", компонент `PharmacyControlSegmentMapView`)

- **Карта** (`BaseMapAdapter` внутри `viewContainer`)
- **Кнопки управления картой**:
  - "Текущее местоположение" (`buttonLocation`)
  - "Приблизить" (`buttonZoomIn`)
  - "Отдалить" (`buttonZoomOut`)
  - "Компас" (`viewCompass`, `imageViewCompass`)
- **BottomSheet** (`ViBottomSheetVC`):
  - Карточка выбранной аптеки (`PharmacyControlMapStoreView` → `PharmacyControlStoreView`)
    - Содержит те же элементы, что и ячейка в списке, но с особенностями отображения для карты.
- **Особенности**:
  - Тап по маркеру на карте — открывает карточку аптеки.
  - BottomSheet можно тянуть вверх/вниз.
  - Кнопки управления картой работают только в режиме карты.

#### Взаимодействие:
- Перемещение и масштабирование карты.
- Выбор аптеки на карте.
- Взаимодействие с карточкой аптеки аналогично списку.

---

## 3. Всплывающие и дополнительные элементы

- **Алерты** (`AlertModel`): ошибки, подтверждения, информационные сообщения.
- **Попап "Спасибо за информацию"**: появляется после загрузки фото, содержит текст и кнопку "Закрыть".
- **BottomSheet**: карточка аптеки на карте.
- **Промпт/заглушка** (`PromptView`): отображается при ошибках загрузки или отсутствии данных.

#### Взаимодействие:
- Кнопка "Закрыть" в попапе — скрывает попап.
- Кнопки в алертах — повторить действие, закрыть, перейти в корзину и др.

---

## 4. Нижняя навигационная панель

- **TabBar**: стандартная нижняя панель приложения с разделами "Главный", "Каталог", "Корзина", "Избранное", "Меню".
- **Переходы**: осуществляется через стандартные механизмы UITabBarController.

---

## 5. Схематичное дерево иерархии экрана

```
Экран "Аптечный контроль"
├── Верхняя панель
│   ├── Заголовок "Аптечный контроль"
│   ├── Кнопка "Назад"
│   ├── Кнопка поиска / строка поиска
│   ├── Сегментированный контрол ("Список" / "Карта")
│   └── Фильтры (Город, Рядом, Без фото и др.)
├── Основная область
│   ├── Список аптек (Сегмент "Список")
│   │   └── Ячейка аптеки
│   │       ├── Адрес
│   │       ├── Бренд (название, логотип)
│   │       ├── Расстояние, время до аптеки
│   │       ├── Время работы
│   │       ├── Фото от пользователей (превью, количество)
│   │       ├── Кнопка "Загрузить фото"
│   │       ├── Кнопка "Показать на карте"
│   │       └── Кнопка "Построить маршрут"
│   └── Карта (Сегмент "Карта")
│       ├── Карта с маркерами аптек
│       ├── Кнопки управления картой (компас, местоположение, zoom)
│       └── BottomSheet с карточкой аптеки (структура как у ячейки)
├── Всплывающие элементы
│   ├── Алерты
│   ├── Попап "Спасибо за информацию"
│   └── Промпт/заглушка
└── Нижняя навигационная панель (TabBar)
    ├── Главный
    ├── Каталог
    ├── Корзина
    ├── Избранное
    └── Меню
```

---

## [Нужно дополнить]

- Не раскрыта структура и взаимодействие с компонентом SmallImagesPreview (отображение превью фото).
- Не описаны все возможные состояния PromptView (заглушки).
- Не все детали по работе с BottomSheet на карте (уровни раскрытия, анимации).
- Не описаны все возможные алерты и их сценарии появления.
- Не раскрыта логика отображения и скрытия строки поиска.
- Не описаны все параметры иконок и изображений (например, логотип бренда, иконки кнопок).

--- 