# Экран «Заказ оформлен» (MOSuccessVC)

## Описание и назначение экрана
Экран отображается после успешного оформления заказа или нескольких заказов. Его задача — информировать пользователя о статусе заказа, предложить дополнительные действия (выбрать подарок, подписаться на Telegram-бота, добавить заказ в Apple Wallet), предупредить о важных деталях (например, о необходимости рецепта), а также дать возможность закрыть экран или поделиться информацией о заказе. **Все созданные заказы на этом экране автоматически добавляются в Live Activities (если поддерживается устройством и тип заказа позволяет).**

## Общая иерархия экрана
Экран реализован на базе UIViewController (`MOSuccessVC`) и построен с использованием ScrollView, StackView и кастомных UIView-компонентов. Вся разметка и структура определены в storyboard-файле MOSuccessVC.storyboard и xib MOSuccessFlocktoryView.xib.

---

## 1. Верхняя панель
### 1.1. Назначение и элементы
- **Заголовок** (`navigationItem.title`)
  - Отображает текст «Заказ оформлен» или «Заказы оформлены» в зависимости от количества заказов.
- **Кнопка закрытия/стрелка назад** (ViewControllerCloseType.dismiss)
  - Позволяет закрыть экран. В некоторых случаях отображается как стрелка назад.
- **Кнопка «Поделиться»** (бар-кнопка справа, появляется если доступен текст для шаринга)
  - Открывает системное меню для отправки информации о заказе.

---

## 2. Основная область (основной контент)
Вся основная область находится внутри ScrollView и вертикального StackView (`StackViewPassthroughHit`).

### 2.1. Секции и их элементы (в порядке отображения)

#### 2.1.1. Блок подарка за заказ (MOSuccessFlocktoryView)
- **Назначение:** Предлагает выбрать подарок за оформленный заказ, если доступно предложение.
- **Состав:**
  - Градиентный фон (`GradientView`)
  - Картинка с шарами и подарком (`UIImageView`)
  - Текстовое описание предложения (`UILabel`)
  - Кнопка «Выбрать» (`UIButton`)
- **Особенности:**
  - Блок отображается только если в модели есть предложение (`flocktoryOffer`).
  - При нажатии на кнопку открывается внешний URL (переход через presenter/openUrl).
  - Если блока нет, вместо него отображается логотип (UIImageView makeOrderSuccessLogo).

#### 2.1.2. Логотип (UIImageView)
- **Назначение:** Показывает иллюстрацию (например, единорога или коробку с товарами), если блок подарка скрыт.
- **Особенности:**
  - Взаимно исключается с блоком подарка.

#### 2.1.3. Заголовок (UILabel)
- **Назначение:** Показывает основной заголовок экрана (например, «Спасибо за заказ», «Создано 2 из 3 заказов»).
- **Особенности:**
  - Текст зависит от количества заказов и типа оформления.

#### 2.1.4. Информационный текст (DescriptionTextView)
- **Назначение:** Подробно информирует пользователя о дальнейших шагах: когда ждать уведомление, где отслеживать статус, что делать если отключены пуши, как подписаться на Telegram-бота и т.д.
- **Особенности:**
  - Текст формируется динамически в зависимости от состояния заказа и статуса уведомлений.
  - В тексте могут быть кликабельные ссылки (например, «Мои заказы», «Включите их»), которые обрабатываются через handleUrl.

#### 2.1.5. Верхнее предупреждение (DescriptionTextView)
- **Назначение:** Показывает важное предупреждение (например, о частичном оформлении заказа).
- **Особенности:**
  - Может быть скрыто, если нет текста для предупреждения.
  - Оформлено с фоном и скруглениями.

#### 2.1.6. Блоки дополнительных предупреждений (UIStackView)
- **Назначение:** Отображает один или несколько блоков с дополнительными предупреждениями (например, о рецептурных товарах, необходимости сверить срок годности и т.д.).
- **Особенности:**
  - Каждый блок — отдельный DescriptionTextView с фоном и скруглениями.
  - Количество и содержание блоков зависит от модели заказа.
  - **Блок о необходимости сверить срок годности отображается только при заказе товаров с уценкой.**

#### 2.1.7. Кнопка «Подписаться в Telegram» (UIButton)
- **Назначение:** Открывает ссылку на Telegram-бота для отслеживания статуса заказа.
- **Особенности:**
  - Отображается только если в модели есть ссылка на Telegram.
  - При нажатии открывается внешний URL.

#### 2.1.8. Кнопка «Добавить в Wallet» (UIButton)
- **Назначение:** Позволяет добавить заказ в Apple Wallet.
- **Особенности:**
  - При нажатии запускается процесс добавления pass-файла через AppleWalletWorker.
  - Рядом с кнопкой может быть иконка вопроса (ExtendedHitButton), открывающая модальное окно с подсказкой.

#### 2.1.9. Кнопка «Закрыть» (UIButton)
- **Назначение:** Закрывает экран успеха.
- **Особенности:**
  - Текст кнопки может меняться в зависимости от состояния заказа (например, «Закрыть» или «Вернуться в корзину»).

---

## 3. Всплывающие и дополнительные элементы
- **Алерты (AlertModel)**
  - Показываются при ошибках, успешном добавлении в Wallet, если pass уже добавлен или Wallet недоступен.
- **Модальное окно с подсказкой по Wallet (ModalPromptModel.wallet)**
  - Открывается по нажатию на иконку вопроса рядом с кнопкой Wallet.
- **Системное меню шаринга**
  - Открывается по нажатию на кнопку «Поделиться».

---

## 4. Нижняя навигационная панель
- На экране отсутствует отдельная нижняя навигационная панель. Все основные действия вынесены в основную область.

---

## 5. Открываемые экраны при взаимодействии с элементами

- **Кнопка «Выбрать подарок»** (MOSuccessFlocktoryView.buttonChoose)
  - Открывает внешний URL (браузер или WebView)
- **Ссылки в информационном тексте** (DescriptionTextView)
  - «Мои заказы» — переход к экрану заказов (DeepLinkService, screen: .orders)
  - «Включите их» — переход к настройкам уведомлений
- **Кнопка «Подписаться в Telegram»**
  - Открывает внешний URL (Telegram-бот)
- **Кнопка «Добавить в Wallet»**
  - Запускает добавление pass-файла, может вызвать алерт
- **Иконка вопроса рядом с Wallet**
  - Открывает модальное окно с подсказкой (ModalPromptModel.wallet)
- **Кнопка «Закрыть»**
  - Закрывает экран успеха
- **Кнопка «Поделиться»**
  - Открывает системное меню шаринга

---

## 6. Схематичное дерево иерархии экрана
```
Экран «Заказ оформлен» (MOSuccessVC)
├── Верхняя панель (UINavigationBar)
│   ├── Заголовок (navigationItem.title)
│   ├── Кнопка закрытия/стрелка назад
│   └── Кнопка «Поделиться» (если доступно)
├── Основная область (ScrollView)
│   └── Вертикальный StackView (StackViewPassthroughHit)
│       ├── Блок подарка за заказ (MOSuccessFlocktoryView)
│       │   ├── Градиентный фон (GradientView)
│       │   ├── Картинка (UIImageView)
│       │   ├── Текст предложения (UILabel)
│       │   └── Кнопка «Выбрать» (UIButton)
│       ├── Логотип (UIImageView) [если блок подарка скрыт]
│       ├── Заголовок (UILabel)
│       ├── Информационный текст (DescriptionTextView)
│       ├── Верхнее предупреждение (DescriptionTextView) [может быть скрыто]
│       ├── Блоки дополнительных предупреждений (UIStackView)
│       │   └── Блок предупреждения (DescriptionTextView) [0..N, блок о сроке годности — только для уценённых товаров]
│       ├── Кнопка «Подписаться в Telegram» (UIButton) [может быть скрыта]
│       ├── Кнопка «Добавить в Wallet» (UIButton)
│       │   └── Иконка вопроса (ExtendedHitButton)
│       └── Кнопка «Закрыть» (UIButton)
├── Всплывающие элементы
│   ├── Алерты (AlertModel)
│   └── Модальное окно подсказки по Wallet (ModalPromptModel.wallet)
└── [Нижняя навигационная панель отсутствует]
```

---

## [Нужно дополнить]
- Не все тексты и состояния видны на скриншотах — часть формируется динамически в зависимости от модели заказа.
- Не все возможные алерты и их тексты видны в коде и на скриншотах. 