# Экран оформления заказа (MOConfirmVC)

## Описание и назначение экрана
Экран предназначен для подтверждения и оформления заказа в приложении Мегаптека. Пользователь выбирает аптеку для самовывоза, видит детали заказа, вводит свои данные, соглашается с условиями и подтверждает заказ. Экран отображает всю необходимую информацию о выбранной аптеке, составе заказа, способе оплаты, бонусах, а также предупреждения и ошибки, связанные с оформлением.

## Общая иерархия экрана
Экран реализован на базе UIViewController (`MOConfirmVC`) и содержит основную область с таблицей (`UITableView`), нижнюю фиксированную панель с кнопкой подтверждения заказа и предупреждением о необходимости согласия с условиями. Контент экрана структурирован в виде секций таблицы, каждая из которых содержит отдельные компоненты (кастомные UIView).

---

## 1. Верхняя панель
### 1.1. Назначение и элементы
- **Заголовок**: "Оформление заказа" (navigationItem.title)
- **Кнопка назад**: стандартная кнопка возврата (Back)

---

## 2. Основная область (UITableView)
Таблица состоит из секций, каждая из которых содержит определённый компонент/блок. Секции и их элементы отображаются или скрываются в зависимости от состояния заказа и данных пользователя.

### 2.1. Секции и их элементы (в порядке отображения)

- **Секция: Аптека для самовывоза**
  - **Блок с информацией об аптеке** (`MOConfirmStoreView`)
    - Название аптеки, адрес, расстояние, доступность, бренд, метро, режим работы, срок сборки, срок брони, иконка доступности
    - Особенности: отображает разные статусы (например, "Открыто круглосуточно", "Срок брони всего 1 день"), может содержать предупреждения (например, перерыв в работе)
    - Взаимодействие: нажатие на адрес открывает экран с картой (`StoresMapVC`)
  - **Блок с картой** (`MOConfirmMapView`)
    - Мини-карта с отмеченной аптекой
    - Взаимодействие: нажатие открывает экран карты аптек (`StoresMapVC`)

- **Секция: Дата готовности заказа**
  - **Блок с датой** (`MOConfirmTextView`)
    - Текст с датой готовности или информацией о сроках
    - Особенности: может меняться в зависимости от статуса заказа

- **Секция: Способ оплаты**
  - **Блок с информацией об оплате** (`MOConfirmTextView`)
    - Текстовое описание способа оплаты (например, "Оплата в аптеке только наличными")
    - Особенности: может содержать предупреждения (например, перерыв в аптеке)

- **Секция: Ворнинги и предупреждения**
  - **Блоки предупреждений** (`MOConfirmWarningView`)
    - Все ворнинги определяются на сервере и передаются через API метод. Примеры: "В аптеке перерыв до 14:50", "Ошибка e-mail", "Не подтверждён телефон" и др.
    - Особенности: цвет фона, иконки, ссылки, динамическое появление

- **Секция: Информация о покупателе**
  - **Блок с полями для ввода** (`MOConfirmUserInfoView`)
    - Поля: Имя, Телефон, (опционально) поле для кода подтверждения, кнопки отправки и подтверждения кода
    - Особенности: валидация, отображение ошибок, поддержка повторной отправки кода, обратный отсчёт
    - Взаимодействие: ввод данных, отправка и подтверждение кода, автоматический переход к следующему полю

- **Секция: E-mail**
  - **Блок с e-mail** (`MOConfirmEmailView`)
    - Поле для ввода e-mail, кнопка "У меня нет почты"/"У меня есть почта"
    - Особенности: блок отображается только если у пользователя есть сохранённый e-mail (введён ранее или взят из профиля). Если e-mail отсутствует, блок скрыт. Если e-mail есть, поле предзаполнено этим значением.
    - Взаимодействие: ввод e-mail, скрытие/отображение поля

- **Секция: Состав заказа**
  - **Блоки товаров** (`MOConfirmItemView`)
    - Для каждого товара: название, производитель, количество, цена, причина скидки, изображение
    - Особенности: отображается список всех товаров в заказе

- **Секция: Итого**
  - **Блок с итоговой суммой** (`MOConfirmTotalView`)
    - Количество товаров, итоговая сумма

- **Секция: Экономия**
  - **Блок с информацией об экономии** (`EconomyView`)
    - Текст о сэкономленных средствах по заказу
    - Особенности: блок отображается только если экономия составляет больше 30 рублей

- **Секция: Согласие с условиями**
  - **Блок с чекбоксом согласия** (`MOConfirmAgreementsView`)
    - Чекбокс, текст с условиями, ссылки на пользовательское соглашение и политику конфиденциальности
    - Особенности: если чекбокс не отмечен, появляется предупреждение внизу экрана
    - Взаимодействие: нажатие на чекбокс, переход по ссылкам

---

## 3. Всплывающие и дополнительные элементы
- **Ворнинги/алерты** (`MOConfirmWarningView`)
  - Все ворнинги определяются на сервере и приходят через API. Примеры: ошибки, неверные данные, специальные условия (например, перерыв в аптеке, неверный e-mail, не подтверждён телефон)
  - Взаимодействие: закрытие по кнопке, переход по ссылкам
- **Алерты и диалоги**
  - Используются для отображения ошибок, подтверждений, информационных сообщений.
  - **Алерты о недоступности товаров и изменении суммы заказа**:
    - **Алерт "Часть товаров недоступна"**: появляется, если после выбора аптеки часть товаров стала недоступна для заказа. Содержит заголовок "Часть товаров недоступна", поясняющий текст и кнопку "OK" для закрытия.
    - **Алерт "Сумма заказа увеличилась"**: появляется, если после выбора аптеки сумма заказа увеличилась. Содержит заголовок "Сумма заказа увеличилась", поясняющий текст и кнопку "OK" для закрытия.
    - **Алерт "Сумма заказа уменьшилась"**: появляется, если после выбора аптеки сумма заказа уменьшилась. Содержит заголовок "Сумма заказа уменьшилась", поясняющий текст и кнопку "OK" для закрытия. В тексте может быть призыв оформить заказ по выгодной цене.
    - Все эти алерты отображаются в виде модального окна с затемнением фона, не позволяют продолжить оформление заказа, пока пользователь не нажмёт "OK".
    - Условия показа определяются логикой сравнения актуального состояния заказа с моментом выбора аптеки (например, если изменилась доступность товаров или их стоимость).

---

## 4. Нижняя навигационная панель
- **Фиксированная панель** (UIView внизу экрана)
  - **Кнопка "ПОДТВЕРДИТЬ ЗАКАЗ"** (`UIButton`)
    - Активна только если отмечен чекбокс согласия
    - Взаимодействие: нажатие инициирует оформление заказа
  - **Текстовое предупреждение** (`UILabel`)
    - "Необходимо принять условия соглашения, чтобы продолжить" — появляется, если чекбокс не отмечен
    - Особенности: красный фон, белый текст

---

## 5. Открываемые экраны при взаимодействии с элементами

- **Строка с адресом аптеки** (MOConfirmStoreView)
  - Открывает: экран карты аптек (`StoresMapVC`)
- **Мини-карта** (MOConfirmMapView)
  - Открывает: экран карты аптек (`StoresMapVC`)
- **Ссылки в согласии** (MOConfirmAgreementsView)
  - Открывает: экран с пользовательским соглашением/политикой (`WebVC`)
- **Кнопка "ПОДТВЕРДИТЬ ЗАКАЗ"**
  - При успешной валидации открывает: экран успешного оформления заказа (`MOSuccessVC`)
  - При ошибках — алерты/ворнинги

---

## 6. Схематичное дерево иерархии экрана
```
Экран оформления заказа (MOConfirmVC)
├── Верхняя панель (UINavigationBar)
│   ├── Заголовок
│   └── Кнопка назад
├── Основная область (UITableView)
│   ├── Секция: Аптека для самовывоза
│   │   ├── Блок с информацией об аптеке (MOConfirmStoreView)
│   │   └── Мини-карта (MOConfirmMapView)
│   ├── Секция: Дата готовности заказа
│   │   └── Блок с датой (MOConfirmTextView)
│   ├── Секция: Способ оплаты
│   │   └── Блок с информацией об оплате (MOConfirmTextView)
│   ├── Секция: Ворнинги и предупреждения
│   │   └── Блоки предупреждений (MOConfirmWarningView)
│   ├── Секция: Информация о покупателе
│   │   └── Блок с полями для ввода (MOConfirmUserInfoView)
│   ├── Секция: E-mail
│   │   └── Блок с e-mail (MOConfirmEmailView)
│   ├── Секция: Состав заказа
│   │   └── Блоки товаров (MOConfirmItemView)
│   ├── Секция: Итого
│   │   └── Блок с итоговой суммой (MOConfirmTotalView)
│   ├── Секция: Экономия
│   │   └── Блок с информацией об экономии (EconomyView)
│   └── Секция: Согласие с условиями
│       └── Блок с чекбоксом согласия (MOConfirmAgreementsView)
├── Всплывающие элементы
│   └── Ворнинги/алерты (MOConfirmWarningView, AlertModel)
│       └── Алерты о недоступности товаров и изменении суммы заказа (AlertModel)
└── Нижняя панель
    ├── Кнопка "ПОДТВЕРДИТЬ ЗАКАЗ" (UIButton)
    └── Текстовое предупреждение (UILabel)
```