# Компонент: Скачивание отчета (DowloadReport)

## 1. Обзор Компонента

-   **Назначение:** Компонент `app-dowload-report` предоставляет пользователю интерфейс для запроса и скачивания отчетов в формате `.xlsx` или `.zip`.
-   **Основные функции:**
    -   Формирование отчета по выбранным в таблице товарам (по регионам или городам).
    -   Формирование отчета по всем доступным товарам (по регионам или городам).
    -   Отображение состояния загрузки для каждой кнопки.

## 2. Элементы Пользовательского Интерфейса (UI Elements)

| Название элемента | Назначение/Функция | Возможные состояния | Взаимодействие пользователя |
| :--- | :--- | :--- | :--- |
| **Кнопка "По регионам" (для выбранных товаров)** | Инициирует генерацию и скачивание отчета по товарам, выбранным в `DashboardService`, с группировкой по регионам. | - Активная<br>- Загрузка (`loading`, отображается спиннер) | - Нажатие (click) |
| **Кнопка "По городам" (для выбранных товаров)** | Инициирует генерацию и скачивание отчета по товарам, выбранным в `DashboardService`, с группировкой по городам. | - Активная<br>- Загрузка (`loading`) | - Нажатие (click) |
| **Кнопка "По регионам" (для всех товаров)** | Инициирует генерацию и скачивание отчета по всем товарам с группировкой по регионам. | - Активная<br>- Загрузка (`loading`) | - Нажатие (click) |
| **Кнопка "По городам" (для всех товаров)** | Инициирует генерацию и скачивание отчета по всем товарам с группировкой по городам. *Отображается только если `allItemsCities=true`*. | - Активная<br>- Загрузка (`loading`) | - Нажатие (click) |

## 3. Пользовательские Сценарии (User Flows)

1.  **Скачивание отчета по выбранным товарам:**
    -   Пользователь выбирает товары на странице `Dashboard`.
    -   Нажимает на одну из кнопок в секции "Скачать отчет по выбранным товарам".
    -   Кнопка переходит в состояние загрузки.
    -   Компонент получает ID выбранных товаров из `DashboardService`.
    -   Отправляется API-запрос на генерацию отчета с соответствующими параметрами.
    -   После получения ответа от сервера (файла в виде `Blob`), компонент симулирует клик по ссылке, и браузер предлагает пользователю сохранить файл `report.xlsx`.
    -   Кнопка возвращается в активное состояние.
2.  **Скачивание отчета по всем товарам:**
    -   Пользователь нажимает на одну из кнопок в секции "Скачать отчет по всем товарам".
    -   Процесс аналогичен предыдущему, но в API-запрос не передаются ID товаров, что является для бэкенда сигналом для включения в отчет всех позиций.

## 4. Навигация

-   Компонент не управляет навигацией.

## 5. Отображаемые Данные

-   **Получаемые данные:**
    -   **Состояние дашборда (выбранные товары):**
        -   **Откуда:** `DashboardService`.
    -   **Файл отчета (по городам):**
        -   **Откуда:** `ApiItemsReportСitiesService`
        -   **REST метод:** `GET`
        -   **Ендпоинт:** `vendors/v2/items/report/cities`
    -   **Файл отчета (по регионам):**
        -   **Откуда:** `ApiItemsReportRegionsService`
        -   **REST метод:** `GET`
        -   **Ендпоинт:** `vendors/v2/items/report/regions`
-   **Отправляемые данные:**
    -   Компонент не отправляет данные, а только запрашивает их, передавая в `GET` запросах ID выбранных товаров.

## 6. Особые Состояния/Логика

-   **`newView`:** В зависимости от этого входного параметра, компонент по-разному получает ID выбранных товаров из `DashboardService`:
    -   `newView = true`: Используется `_dashboardService.tableData$.getValue()`, который возвращает массив ID.
    -   `newView = false`: Используется `_dashboardService.data$.getValue().itemId`, который возвращает один ID.
-   **`allItemsCities`:** Входной параметр, который определяет, будет ли отображаться кнопка "По городам" для отчета по всем товарам.
-   **Обработка файла:** Полученный от API `Blob` динамически преобразуется в URL (`window.URL.createObjectURL`) и присваивается невидимому элементу `<a>`, по которому программно совершается клик для инициации скачивания.
-   **Управление загрузкой:** Каждая кнопка имеет свой флаг загрузки в объекте `loading`, что позволяет им работать независимо друг от друга.
