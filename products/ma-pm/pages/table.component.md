# Компонент: Таблица (Table)

## 1. Обзор Компонента

-   **Назначение:** Компонент `app-table` предназначен для отображения иерархических (древовидных) данных в табличном виде. Он позволяет пользователю последовательно "проваливаться" от общего к частному: от Федеральных Округов к Регионам, а затем к Городам.
-   **Основные функции:**
    -   Отображение многоуровневой таблицы с данными.
    -   Динамическая подгрузка дочерних элементов при раскрытии узла дерева.
    -   Выбор типа отображаемых значений (например, "Цена", "Остаток").
    -   Отображение общего количества подключенных аптек.
    -   Адаптация логики в зависимости от режима `newView`.

## 2. Элементы Пользовательского Интерфейса (UI Elements)

| Название элемента | Назначение/Функция | Возможные состояния | Взаимодействие пользователя |
| :--- | :--- | :--- | :--- |
| **Счетчик "Подключено аптек"** | Отображает общее количество аптек, по которым агрегированы данные. | - Статичное (для текущего среза) | - Нет |
| **Выпадающий список "Тип данных"** | (`ng-select`) Позволяет выбрать, какой именно показатель будет отображаться в ячейках таблицы (например, "Средняя цена", "Минимальная цена" и т.д.). | - Активное<br>- Открытое | - Выбор элемента из списка |
| **Заголовок таблицы** | Отображает названия столбцов. Первый столбец - это выбранный тип данных, остальные - названия товаров. | - Статичное (для текущего среза)<br>- "Прилипающее" (sticky) при скролле | - Нет |
| **Строка таблицы (1-й уровень)** | Представляет Федеральный Округ. Является раскрываемым элементом. | - Свернутое (по умолчанию)<br>- Раскрытое (`active`, `show=true`) | - Нажатие (click) раскрывает/сворачивает дочерние элементы (Регионы) |
| **Строка таблицы (2-й уровень)** | Представляет Регион. Появляется при раскрытии ФО. Также является раскрываемым. | - Свернутое<br>- Раскрытое | - Нажатие (click) раскрывает/сворачивает дочерние элементы (Города) |
| **Строка таблицы (3-й уровень)** | Представляет Город. Конечный уровень иерархии. | - Статичное | - Нет |
| **Индикатор загрузки** | (`app-loading-page-big`) Отображается во время первоначальной загрузки данных или при обновлении типа данных. | - Видимый<br>- Скрытый | - Нет |

## 3. Пользовательские Сценарии (User Flows)

1.  **Первичная загрузка:**
    -   Компонент получает `itemId` (или `ids` для `newView`) от `DashboardService`.
    -   Загружается список доступных типов данных (`value_types`) для выпадающего списка.
    -   Выбирается первый тип данных по умолчанию.
    -   Отправляется запрос на получение данных первого уровня (Федеральные Округа).
    -   После получения данных таблица отрисовывается.
2.  **Раскрытие уровня иерархии:**
    -   Пользователь нажимает на строку с Федеральным Округом.
    -   Компонент отправляет API-запрос на получение дочерних элементов (Регионов) для данного ФО.
    -   После получения ответа под строкой ФО отрисовываются строки с Регионами.
    -   Аналогичный процесс происходит при клике на Регион для загрузки Городов.
3.  **Смена типа данных:**
    -   Пользователь выбирает новое значение в выпадающем списке "Тип данных".
    -   Компонент инициирует полную перезагрузку данных таблицы с новым `value_type_id`.
    -   Вся иерархия сбрасывается до первого уровня (ФО).

## 4. Навигация

-   Компонент не управляет глобальной навигацией приложения.

## 5. Отображаемые Данные

-   **Получаемые данные:**
    -   **Состояние дашборда (выбранные товары):**
        -   **Откуда:** `DashboardService`.
    -   **Типы значений для фильтра:**
        -   **Откуда:** `ApiItemsTableValueTypesService`
        -   **REST метод:** `GET`
        -   **Ендпоинт:** `vendors/v1/items/table/value-types`
    -   **Данные по Федеральным Округам (1-й уровень):**
        -   **Откуда:** `ApiItemsTableFederalDistrictsService`
        -   **REST метод:** `GET`
        -   **Ендпоинт:** `vendors/v2/items/table/federal-districts`
    -   **Данные по Регионам (2-й уровень):**
        -   **Откуда:** `ApiItemsTableRegionsService`
        -   **REST метод:** `GET`
        -   **Ендпоинт:** `vendors/v2/items/table/regions`
    -   **Данные по Городам (3-й уровень):**
        -   **Откуда:** `ApiItemsTableCitiesService`
        -   **REST метод:** `GET`
        -   **Ендпоинт:** `vendors/v2/items/table/cities`
-   **Отправляемые данные:**
    -   Компонент не отправляет данные, а только запрашивает их, передавая в `GET` запросах ID выбранных сущностей (товаров, регионов, типов данных).

## 6. Особые Состояния/Логика

-   **`newView`:** В этом режиме компонент подписывается на другой `Observable` в `DashboardService` (`tableData$`) и получает массив ID (`ids`) для отображения нескольких товаров в столбцах. В обычном режиме используется `data$` и одиночный `id`.
-   **Ленивая загрузка уровней:** Данные для дочерних уровней (Регионы, Города) не загружаются сразу, а только по запросу пользователя (при клике на родительский элемент). Это значительно оптимизирует первоначальную загрузку.
-   **Горизонтальный скролл:** Если столбцов в таблице становится слишком много, появляется горизонтальная прокрутка для обеспечения читаемости.
-   **Change Detection:** Используется стратегия `OnPush`, поэтому для обновления UI после асинхронных операций (загрузка данных) вызывается `_cdr.detectChanges()`.
