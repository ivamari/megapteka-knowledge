# Компонент: Карта (Map)

## 1. Обзор Компонента

-   **Назначение:** Компонент `app-map` предназначен для визуализации гео-данных по выбранному товару. Он отображает карту России, разделенную на Федеральные Округа или Регионы, и раскрашивает их в зависимости от показателей.
-   **Основные функции:**
    -   Отображение карты с данными по ФО или регионам.
    -   Переключение вида карты между Федеральными Округами и Регионами.
    -   Выбор конкретного товара (основного или конкурента) для отображения на карте.
    -   Загрузка и отображение данных с API.

## 2. Элементы Пользовательского Интерфейса (UI Elements)

| Название элемента | Назначение/Функция | Возможные состояния | Взаимодействие пользователя |
| :--- | :--- | :--- | :--- |
| **Переключатель "ФО/Регионы"** | (`mat-slide-toggle`) Позволяет выбрать режим отображения карты: по Федеральным Округам или по Регионам. | - Выбраны ФО (`false`)<br>- Выбраны Регионы (`true`) | - Нажатие на переключатель<br>- Нажатие на текстовые метки |
| **Выпадающий список "Товар"** | (`ng-select`) Позволяет выбрать товар, данные по которому будут отображаться на карте. Список включает основной товар и его конкурентов. | - Активное<br>- Открытое (отображается список) | - Нажатие открывает список<br>- Выбор элемента из списка |
| **Карта России** | (Компоненты `app-yandex-maps-fo` / `app-yandex-maps-region`) Интерактивная карта, отображающая данные. | - Загрузка (`app-loading-page-big`)<br>- Отображение карты ФО<br>- Отображение карты Регионов | - (Предположительно) Наведение/клик на регион для получения доп. информации. |
| **Индикатор загрузки** | (`app-loading-page-big`) Отображается во время загрузки данных для карты. | - Видимый (во время загрузки)<br>- Скрытый | - Нет |

## 3. Пользовательские Сценарии (User Flows)

1.  **Первичная загрузка:**
    -   Компонент получает `itemId` и `itemName` от родительского `DashboardComponent` через сервис `DashboardService`.
    -   Загружается список товаров-конкурентов.
    -   Формируется общий список для выпадающего меню (основной товар + конкуренты).
    -   По умолчанию выбирается основной товар.
    -   Запускается загрузка данных для карты (по умолчанию - Федеральные Округа).
    -   После загрузки данных отображается карта.
2.  **Смена товара для отображения:**
    -   Пользователь открывает выпадающий список товаров.
    -   Выбирает другой товар.
    -   Компонент инициирует загрузку данных для карты по новому `item_id`.
    -   Карта обновляется с новыми данными.
3.  **Смена вида карты:**
    -   Пользователь нажимает на переключатель "ФО/Регионы".
    -   Компонент инициирует загрузку соответствующего типа данных (либо для ФО, либо для регионов) для текущего выбранного товара.
    -   Один компонент карты (`app-yandex-maps-fo`) скрывается, а другой (`app-yandex-maps-region`) отображается с новыми данными.

## 4. Навигация

-   Компонент не управляет глобальной навигацией приложения.

## 5. Отображаемые Данные

-   **Получаемые данные:**
    -   **Состояние дашборда (выбранный товар):**
        -   **Откуда:** `DashboardService` (локальный сервис-состояние).
    -   **Список товаров-конкурентов:**
        -   **Откуда:** `ApiItemsCompetitorItemsService`
        -   **REST метод:** `GET`
        -   **Ендпоинт:** `vendors/v1/items/competitor-items`
    -   **Данные для карты по Федеральным Округам:**
        -   **Откуда:** `ApiItemsMapFederalDistrictsService`
        -   **REST метод:** `GET`
        -   **Ендпоинт:** `vendors/v1/items/map/federal-districts`
    -   **Данные для карты по Регионам:**
        -   **Откуда:** `ApiItemsMapRegionsService`
        -   **REST метод:** `GET`
        -   **Ендпоинт:** `vendors/v1/items/map/regions`
-   **Отправляемые данные:**
    -   Компонент не отправляет данные, а только запрашивает их.

## 6. Особые Состояния/Логика

-   **Управление состоянием:** Компонент подписывается на изменения в `DashboardService` для обновления своего состояния при смене основного товара в родительском компоненте.
-   **Динамическая смена компонента карты:** В зависимости от значения переключателя (`checkedSelect`) в шаблоне отображается либо `<app-yandex-maps-fo>`, либо `<app-yandex-maps-region>`, что позволяет разделить логику отображения для разных типов карт.
-   **Change Detection:** Компонент использует стратегию `OnPush`, что требует ручного вызова `_cdr.detectChanges()` после асинхронных операций для обновления UI.
