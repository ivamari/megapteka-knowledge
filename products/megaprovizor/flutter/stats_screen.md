# Экран: Статистика (ScreenStats)

## 1. Обзор Экрана

*   **Назначение:** Предоставляет детальную статистику по работе аптеки, включая общий рейтинг, ключевые показатели эффективности, среднее время сборки и отзывы клиентов. Позволяет фильтровать данные по периодам и типам отзывов.
*   **Основные функции:**
    *   Отображение общего рейтинга аптеки.
    *   Отображение статистики по заказам и оценкам за выбранный период.
    *   Выбор периода для отображения статистики.
    *   Просмотр списка отзывов клиентов с пагинацией.
    *   Фильтрация отзывов (все или только с комментариями).
    *   Обновление данных с помощью pull-to-refresh.

## 2. Элементы Пользовательского Интерфейса (UI Elements)

*   **AppBar:**
    *   **Назначение:** Верхняя панель с заголовком "Статистика".
    *   **Взаимодействие:** Нет.
*   **Блок "Рейтинг аптеки" (`_ServiceRatingWidget`):**
    *   **Назначение:** Отображает общий рейтинг аптеки, его текстовое описание и подсказку.
    *   **UI Элементы:**
        *   **Плашка с рейтингом:** Цветная плашка со значением рейтинга.
        *   **Текстовое описание рейтинга.**
        *   **Иконка-подсказка (`Tooltip`):** При нажатии показывает детальное описание того, как рассчитывается рейтинг.
        *   **Индикатор и дополнительный текст.**
    *   **Взаимодействие:** Нажатие на иконку вопроса (`ic_question.svg`) показывает всплывающую подсказку.
*   **Блок "Заказы и оценки" (`_StatsWidget`):**
    *   **Назначение:** Отображает ключевые метрики и позволяет управлять фильтрами.
    *   **UI Элементы:**
        *   **Выпадающий список "Период" (`Chooser`):** Показывает текущий выбранный период.
        *   **Горизонтальный список карточек статистики (`StatCard`).**
        *   **Среднее время сборки.**
        *   **Средняя оценка и количество отзывов.**
        *   **Выпадающий список "Фильтр отзывов" (`Chooser`):** Показывает текущий фильтр ("Все оценки" или "Только с комментарием").
    *   **Взаимодействие:**
        *   Нажатие на `Chooser` периода открывает `BottomSheet` для выбора нового периода.
        *   Нажатие на `Chooser` фильтра отзывов открывает `BottomSheet` для выбора типа отображаемых отзывов.
*   **Список отзывов:**
    *   **Назначение:** Отображает ленту отзывов от клиентов с использованием пагинации.
    *   **UI Элементы:** `PagedSliverList` с карточками отзывов (`ReviewCard`).
    *   **Состояния:**
        *   **Загрузка:** Отображается индикатор.
        *   **Пустое состояние:** Ничего не отображается (согласно `noItemsFoundIndicatorBuilder: (context) => const SizedBox()`).
        *   **Ошибка:** Отображается виджет с сообщением об ошибке.
    *   **Взаимодействие:**
        *   Прокрутка вниз загружает следующую страницу отзывов.
        *   Нажатие на карточку отзыва переходит на экран деталей соответствующего заказа.

## 3. Пользовательские Сценарии (User Flows)

*   **Анализ статистики за другой период:**
    1.  Пользователь открывает экран.
    2.  Нажимает на `Chooser` с текущим периодом (например, "Текущий месяц").
    3.  В появившемся `BottomSheet` выбирает другой период (например, "Прошлый месяц").
    4.  Данные в блоке "Заказы и оценки" и список отзывов обновляются в соответствии с выбранным периодом.
*   **Просмотр отзывов с комментариями:**
    1.  Пользователь нажимает на `Chooser` с фильтром "Все оценки".
    2.  В `BottomSheet` выбирает "Только с комментарием".
    3.  Список отзывов обновляется, показывая только те, где есть текстовый комментарий.
*   **Переход к заказу из отзыва:**
    1.  Пользователь просматривает ленту отзывов.
    2.  Нажимает на интересующий его отзыв.
    3.  Происходит переход на экран деталей заказа, к которому оставлен этот отзыв.

## 4. Навигация

*   **На экран "Детали заказа" (`/stats/orders/:orderId`):**
    *   **Условие:** Нажатие на карточку отзыва в списке.
    *   **Метод:** `context.go('/stats/orders/${item.order.id}')`.

## 5. Отображаемые Данные

*   **Типы данных:**
    *   `StoreServiceRating`: Общий рейтинг аптеки.
    *   `StoreStatistics`: Статистика по заказам и оценкам.
    *   `List<Period>`: Список доступных для выбора периодов.
    *   `Review`: Отзыв клиента, включая оценку, комментарий и информацию о заказе.
*   **Источник данных:**
    *   **API:**
        *   `GET /v1/stores/service-rating`
        *   `GET /v2/stores/statistics`
        *   `GET /v1/stores/statistics/periods`
        *   `GET /v2/stores/feedback`
    *   **Локальное хранилище:** Не используется.

## 6. Особые Состояния/Логика

*   **Пагинация:** Список отзывов использует `PagedSliverList` из библиотеки `infinite_scroll_pagination` для подгрузки данных по мере прокрутки.
*   **Фильтрация:** `ControllerStats` управляет состоянием фильтров (`periodCode`, `onlyWithComments`). При изменении любого из фильтров вызывается `refresh()` контроллера, что приводит к перезагрузке данных статистики и сбросу пагинации отзывов.
*   **Pull-to-refresh:** Обновляет все данные на экране (рейтинг, статистику и сбрасывает пагинацию отзывов).
*   **Пустое состояние отзывов:** Если отзывы отсутствуют, список просто остается пустым, не показывая специального виджета.
