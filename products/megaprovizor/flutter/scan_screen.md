# Экран: Сканирование (ScreenScan)

## 1. Обзор Экрана

*   **Назначение:** Предоставляет пользователю интерфейс для сканирования QR-кодов или штрих-кодов (Code 128) с помощью камеры устройства. После успешного сканирования экран автоматически закрывается и возвращает отсканированное значение.
*   **Основные функции:**
    *   Отображение видеопотока с камеры.
    *   Распознавание QR-кодов и штрих-кодов.
    *   Обработка отсутствия прав доступа к камере.
    *   Управление жизненным циклом сканера (пауза/возобновление).

## 2. Элементы Пользовательского Интерфейса (UI Elements)

*   **AppBar:**
    *   **Назначение:** Верхняя панель с заголовком "Сканировать код заказа" и кнопкой "назад".
    *   **Взаимодействие:** Кнопка "назад" закрывает экран сканирования, не возвращая результата.
*   **Окно сканера (`MobileScanner`):**
    *   **Назначение:** Основная область, где отображается видео с камеры.
    *   **Состояния:**
        *   **Активно:** Камера работает, идет поиск кодов.
        *   **Ошибка (нет прав):** Вместо видео отображается экран с сообщением о необходимости предоставить доступ к камере.
        *   **Инициализация:** Может отображаться `placeholderBuilder`.
    *   **Взаимодействие:** Непрямое, через наведение камеры на код.
*   **Оверлей сканирования (`ScannerOverlayShape`):**
    *   **Назначение:** Рисует рамку поверх видеопотока, чтобы визуально подсказать пользователю, куда наводить камеру.
    *   **Состояния:** Статичный.
    *   **Взаимодействие:** Нет.
*   **Нижняя панель с подсказкой:**
    *   **Назначение:** Информирует пользователя о том, что нужно делать.
    *   **UI Элементы:** Иконка сканирования и текст "Наведите камеру на код заказа...".
    *   **Состояния:** Статичная.
    *   **Взаимодействие:** Нет.
*   **Экран "Нет доступа к камере":**
    *   **Назначение:** Отображается, если у приложения нет разрешения на использование камеры.
    *   **UI Элементы:** Иллюстрация, заголовок, поясняющий текст и кнопка "Настройки".
    *   **Взаимодействие:** Нажатие на кнопку "Настройки" открывает системные настройки приложения, где пользователь может выдать разрешение.

## 3. Пользовательские Сценарии (User Flows)

*   **Успешное сканирование:**
    1.  Пользователь открывает экран сканирования.
    2.  Наводит камеру на QR-код или штрих-код.
    3.  Сканер распознает код.
    4.  Экран автоматически закрывается, возвращая распознанное значение (например, номер заказа) на предыдущий экран.
*   **Отсутствие прав доступа к камере:**
    1.  Пользователь открывает экран, но ранее запретил доступ к камере.
    2.  Вместо камеры отображается экран с просьбой предоставить доступ.
    3.  Пользователь нажимает "Настройки".
    4.  Открываются системные настройки. Пользователь предоставляет доступ.
    5.  После возвращения в приложение сканер должен заработать.
*   **Закрытие без сканирования:**
    1.  Пользователь открывает экран.
    2.  Нажимает системную кнопку "назад" или кнопку "назад" в AppBar.
    3.  Экран закрывается, не возвращая никакого результата.

## 4. Навигация

*   **Возврат на предыдущий экран:**
    *   **Условие 1 (успех):** Успешное сканирование кода.
        *   **Метод:** `context.pop(barcodeCapture.barcodes.firstOrNull?.rawValue)`. Возвращает отсканированное значение.
    *   **Условие 2 (отмена):** Нажатие кнопки "назад".
        *   **Метод:** `context.pop()`. Возвращает `null`.
*   **Диплинки:** На этот экран можно попасть по пути `/scan`.

## 5. Отображаемые Данные

*   На экране не отображаются данные с сервера. Он только генерирует данные (отсканированный код) и возвращает их.

## 6. Особые Состояния/Логика

*   **Управление жизненным циклом:** Экран использует `WidgetsBindingObserver` для отслеживания состояния приложения. Когда приложение сворачивается (`inactive`, `paused`), сканер и подписка на события останавливаются. Когда приложение возобновляется (`resumed`), они запускаются снова. Это сделано для экономии заряда батареи и ресурсов.
*   **Обработка разрешений:** `MobileScanner` имеет встроенный `errorBuilder`, который используется для отображения специального UI, если `exception.errorCode == MobileScannerErrorCode.permissionDenied`.
*   **Предотвращение многократного сканирования:**
    *   `detectionSpeed: DetectionSpeed.noDuplicates` в контроллере помогает избежать многократной быстрой отправки одного и того же результата.
    *   Сразу после получения первого успешного результата (`_handleBarcode`) вызывается `controller.stop()` и `context.pop()`, что немедленно останавливает сканирование и закрывает экран.
*   **Кастомный оверлей:** `ScannerOverlayShape` - это кастомный `ShapeBorder`, который рисует рамку для сканирования.
