# Экран: Детали заказа (ScreenOrderDetails)

## 1. Обзор Экрана

*   **Назначение:** Отображает всю подробную информацию о конкретном заказе. Позволяет управлять статусом заказа, просматривать его состав, информацию о клиенте и историю изменений.
*   **Основные функции:**
    *   Отображение полной информации о заказе.
    *   Изменение статуса заказа.
    *   Просмотр истории статусов.
    *   Возможность позвонить клиенту.
    *   Редактирование состава заказа (частичная выдача).
    *   Отправка сообщения об ошибке связки товара.
    *   Переход к оставлению отзыва о заказе.
    *   Обновление информации о заказе с помощью pull-to-refresh.

## 2. Элементы Пользовательского Интерфейса (UI Elements)

*   **AppBar:**
    *   **Назначение:** Отображает номер заказа и кнопку "назад".
    *   **Состояния:** Заголовок обновляется после загрузки данных.
    *   **Взаимодействие:** Кнопка "назад" возвращает на предыдущий экран.
*   **Блок "Статус заказа":**
    *   **Назначение:** Показывает текущий статус заказа.
    *   **UI Элементы:**
        *   **Плашка статуса:** Цветная плашка с названием статуса.
        *   **Ссылка "История статусов":** Открывает модальное окно с историей.
    *   **Взаимодействие:** Нажатие на "История статусов" открывает BottomSheet.
*   **Блок "Информация о заказе":**
    *   **Назначение:** Отображает основные данные заказа.
    *   **UI Элементы:** Дата заказа, номер заказа, имя покупателя, телефон.
    *   **Взаимодействие:** Нажатие на номер телефона инициирует звонок через системное приложение.
*   **Блок "Состав заказа":**
    *   **Назначение:** Перечисляет все товары в заказе.
    *   **UI Элементы:**
        *   **Список товаров (`ItemWidget`):** Каждый товар отображается с названием, производителем, количеством и ценой.
        *   **Слайдер "Ошибка связки":** Появляется при свайпе товара влево.
    *   **Взаимодействие:**
        *   Свайп влево по товару открывает кнопку "Ошибка связки".
        *   Нажатие на кнопку "Ошибка связки" (или иконку `i`) открывает диалог подтверждения.
*   **Блок "Итог":**
    *   **Назначение:** Показывает общее количество позиций и итоговую сумму заказа.
    *   **Состояния:** Статичный.
    *   **Взаимодействие:** Нет.
*   **Кнопка "Изменить статус":**
    *   **Назначение:** Открывает диалог для смены статуса заказа.
    *   **Состояния:** Отображается, если для заказа доступны следующие статусы. Неактивна во время загрузки.
    *   **Взаимодействие:** Нажатие открывает диалоговое окно `_changeStatusDialog`.
*   **Кнопка "Оставить отзыв":**
    *   **Назначение:** Переводит на экран оставления отзыва.
    *   **Состояния:** Отображается, если заказ выполнен и доступен для оценки.
    *   **Взаимодействие:** Нажатие переходит на экран `/orders/:orderId/review`.

## 3. Пользовательские Сценарии (User Flows)

*   **Смена статуса заказа:**
    1.  Пользователь нажимает "Изменить статус".
    2.  В диалоговом окне выбирает новый статус из списка доступных.
    3.  Нажимает "ОК".
    4.  Если для нового статуса требуется указать частичное наличие, открывается следующий диалог.
    5.  В диалоге "Указать частичное наличие" пользователь изменяет количество товаров.
    6.  Нажимает "ОК".
    7.  Статус заказа и, возможно, его состав обновляются.
*   **Сообщение об ошибке связки:**
    1.  Пользователь свайпает товар влево и нажимает "Ошибка связки".
    2.  В появившемся диалоге подтверждает отправку сообщения.
    3.  Приложение отправляет информацию об ошибке на сервер.
*   **Просмотр истории статусов:**
    1.  Пользователь нажимает на ссылку "История статусов".
    2.  Снизу экрана появляется модальное окно (`BottomSheet`), отображающее хронологический список всех изменений статуса заказа.
*   **Звонок клиенту:**
    1.  Пользователь нажимает на номер телефона клиента.
    2.  Открывается системное приложение для совершения звонка.

## 4. Навигация

*   **На экран "Оставить отзыв" (`/orders/:orderId/review`):**
    *   **Условие:** Нажатие на кнопку "Оставить отзыв".
*   **Возврат на предыдущий экран:**
    *   **Условие:** Нажатие кнопки "назад" в AppBar.
*   **Диплинки:** На этот экран можно попасть по путям:
    *   `/home/orders/:orderId`
    *   `/orders/:orderId`
    *   `/stats/orders/:orderId`

## 5. Отображаемые Данные

*   **Типы данных:**
    *   `OrderDetails`: Полная информация о заказе.
    *   `List<Item>`: Список товаров в заказе.
    *   `List<HistoricalStatus>`: История изменения статусов.
    *   `List<StatusForChange>`: Список доступных для установки статусов.
*   **Источник данных:**
    *   **API:**
        *   `GET /v2/orders/details`
        *   `POST /v2/orders/status/change`
        *   `POST /v1/orders/items/error/create`
    *   **Локальное хранилище:** Не используется.

## 6. Особые Состояния/Логика

*   **Состояние загрузки:** Во время загрузки данных или смены статуса отображается индикатор `DeclarativeRefreshIndicator` или `CircularProgressIndicator` на кнопке.
*   **Ошибка загрузки:** Если заказ не найден или произошла ошибка, отображается страница с ошибкой (`ErrorPageWidget`).
*   **Частичная выдача:** Если пользователь выбирает статус, который подразумевает изменение состава заказа (`status.forItemsChange == true`), появляется дополнительный диалог для редактирования количества товаров.
*   **Внешний заказ (`isExternal`):** Если `isExternal` равно `true` (например, при переходе со сканера), это может влиять на логику получения данных, но в данном коде основное влияние - это начальный параметр для контроллера.
*   **Обработка ошибок смены статуса:** При неудачной смене статуса отображается диалоговое окно с ошибкой.
