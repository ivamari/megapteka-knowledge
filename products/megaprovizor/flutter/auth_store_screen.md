# Экран: Авторизация в аптеке (ScreenAuthStore)

## 1. Обзор Экрана

*   **Назначение:** Этот экран является ключевым шагом в процессе авторизации пользователя. Он подтверждает, что пользователь действительно является сотрудником выбранной аптеки, путем создания и проверки тестового заказа.
*   **Основные функции:**
    *   Отображение информации о выбранной аптеке.
    *   Создание тестового заказа для верификации.
    *   Ввод номера тестового заказа для завершения авторизации.
    *   Отображение таймера до следующей попытки создания заказа.
    *   Возможность сменить выбранную аптеку.

## 2. Элементы Пользовательского Интерфейса (UI Elements)

*   **Заголовок ("Выберите аптеку"):**
    *   **Назначение:** Информирует пользователя о контексте.
    *   **Состояния:** Статичный текст.
    *   **Взаимодействие:** Нет.
*   **Ссылка "Сменить аптеку":**
    *   **Назначение:** Позволяет пользователю вернуться к экрану выбора аптеки.
    *   **Состояния:** Активна.
    *   **Взаимодействие:** Нажатие возвращает на экран `ScreenAuthStores`.
*   **Карточка аптеки (`StoreCard`):**
    *   **Назначение:** Отображает детальную информацию о выбранной аптеке.
    *   **Состояния:** Статичное отображение.
    *   **Взаимодействие:** Нет.
*   **Секция "Тестовый заказ":**
    *   **Назначение:** Управляет процессом создания и подтверждения тестового заказа.
    *   **Состояния:**
        *   **Готовность к созданию:** Отображается кнопка "Отправить тестовый заказ".
        *   **Заказ создан:** Отображается информация о заказе (имя, телефон, состав) и поле для ввода номера заказа.
        *   **Ожидание:** Отображается таймер, показывающий время до следующей возможной отправки заказа.
*   **Кнопка "Отправить тестовый заказ":**
    *   **Назначение:** Инициирует создание тестового заказа.
    *   **Состояния:**
        *   **Активна:** Доступна для нажатия.
        *   **Неактивна/Загрузка:** Во время отправки запроса или если отправка временно невозможна.
    *   **Взаимодействие:** Нажатие отправляет запрос на создание тестового заказа.
*   **Таймер обратного отсчета:**
    *   **Назначение:** Показывает, через какое время можно будет снова отправить тестовый заказ.
    *   **Состояния:** Отображается, если с момента последней попытки прошел менее часа.
    *   **Взаимодействие:** Нет.
*   **Карточка с деталями тестового заказа (`_OrderWidget`):**
    *   **Назначение:** Отображает информацию о созданном тестовом заказе (имя покупателя, телефон, состав заказа).
    *   **Состояния:** Отображается после успешного создания тестового заказа.
    *   **Взаимодействие:** Нет.
*   **Поле ввода "Номер заказа":**
    *   **Назначение:** Позволяет пользователю ввести номер тестового заказа.
    *   **Состояния:**
        *   **Обычное:** Готово к вводу.
        *   **Ошибка:** Отображается, если введен неверный номер.
    *   **Взаимодействие:** Ввод текста.
*   **Кнопка "Отправить":**
    *   **Назначение:** Подтверждает введенный номер заказа и завершает процесс авторизации.
    *   **Состояния:** Активна, неактивна (во время проверки).
    *   **Взаимодействие:** Нажатие отправляет введенный номер на проверку.

## 3. Пользовательские Сценарии (User Flows)

*   **Успешная авторизация:**
    1.  Пользователь попадает на экран после выбора аптеки.
    2.  Нажимает "Отправить тестовый заказ".
    3.  Система создает заказ и отображает его детали.
    4.  Пользователь видит тестовый заказ в своей системе управления заказами, копирует его номер.
    5.  Вводит номер в поле "Номер заказа" в приложении.
    6.  Нажимает "Отправить".
    7.  Система проверяет номер. Если он верен, пользователь успешно авторизуется и перенаправляется на главный экран (`/home`).
*   **Неверный номер заказа:**
    1.  Пользователь вводит неверный номер заказа и нажимает "Отправить".
    2.  Под полем ввода отображается сообщение об ошибке.
*   **Повторная отправка заказа:**
    1.  Пользователь нажимает "Отправить тестовый заказ", но с момента последней попытки прошло меньше часа.
    2.  Кнопка неактивна, отображается таймер до следующей попытки.
    3.  По истечении времени на таймере кнопка становится активной.

## 4. Навигация

*   **Переход на экран "Выбор аптеки" (`/sign_in/auth_stores`):**
    *   **Условие:** Нажатие на ссылку "Сменить аптеку".
    *   **Метод:** `context.go('/sign_in/auth_stores')`.
*   **Переход на главный экран (`/home`):**
    *   **Условие:** Успешная авторизация после ввода правильного номера тестового заказа. Этот переход обрабатывается `redirect` в `GoRouter` после изменения состояния `isAuthenticated`.
*   **Диплинки:** На этот экран можно попасть по пути `/sign_in/auth_stores/:storeId`, где `:storeId` - ID выбранной аптеки.

## 5. Отображаемые Данные

*   **Типы данных:**
    *   `AuthStore`: Информация о выбранной аптеке и возможности создания заказа.
    *   `AuthOrder`: Детали созданного тестового заказа (имя, телефон, состав).
    *   `OrderFingerprint`: Результат создания тестового заказа.
*   **Источник данных:**
    *   **API:**
        *   `GET /v1/auth/store`
        *   `POST /v1/auth/order/create`
        *   `POST /v1/auth/login`
    *   **Локальное хранилище:** Не используется.

## 6. Особые Состояния/Логика

*   **Ограничение на создание заказа:** Тестовый заказ можно отправлять не чаще одного раза в час. Контроллер `ControllerAuthStore` отслеживает это состояние (`canCreateOrder` и `nextTry`).
*   **Обработка ошибок:**
    *   Если не удалось создать тестовый заказ, отображается диалоговое окно с ошибкой.
    *   Если введен неверный номер заказа, под полем ввода отображается текст ошибки.
*   **Pull-to-refresh:** Пользователь может потянуть экран вниз для обновления информации о статусе тестового заказа (например, если таймер истек).
