# Live Activity заказа — виджет отслеживания заказа (OrderWidgetView)

## 1. Описание и назначение
Виджет Live Activity предназначен для отображения статуса заказа пользователя на экране блокировки и в Dynamic Island устройства. Он позволяет отслеживать этапы выполнения заказа, видеть основную информацию о заказе, его статус, сумму, количество товаров, а также быстро перейти к деталям заказа или оставить оценку после завершения.

## 2. Общая иерархия
Виджет реализован на SwiftUI, основной контейнер — `OrderWidgetView`. Внутри используются кастомные вью и стандартные компоненты SwiftUI. В зависимости от состояния заказа, некоторые элементы могут быть скрыты или заменяться другими. 

**Цвета оформления большинства элементов (фон, текст, индикаторы) автоматически меняются в зависимости от светлой или тёмной темы оформления системы (ColorScheme).**

---

## 3. Основная область (OrderWidgetView)

### 3.1. Секции и их элементы

#### 3.1.1. Индикатор статуса заказа (Circle + statusColor)
- **Описание:** Круглый индикатор слева вверху карточки, цвет зависит от статуса заказа (`statusColor`).
- **Особенности:** Цвет меняется в зависимости от статуса (например, жёлтый для "Новый", серый для "Выдан"). Цвет индикатора адаптируется под светлую/тёмную тему.
- **Логика отображения:** Всегда отображается.
- **Взаимодействие:** Нет.

#### 3.1.2. Основная карточка заказа (VStack)
- **Описание:** Основной контейнер с информацией о заказе.
- **Вложенные элементы:**
  - **Заголовок заказа (Text, displayNumber):**
    - Показывает номер заказа. Если номер отсутствует — дефолтный текст.
    - **Особенности:** Две строки, жирный шрифт. Цвет текста адаптируется под тему.
    - **Взаимодействие:** Нет.
  - **Статус заказа (Text, statusName):**
    - Текстовое поле с названием статуса заказа (например, "Новый", "В обработке", "Готов к выдаче", "Выдан").
    - **Особенности:** Цвет фона соответствует статусу (`statusColor`), скруглённые края, белый текст. Цвет фона и текста адаптируется под тему.
    - **Логика отображения:** Показывается только если статус присутствует.
    - **Взаимодействие:** Нет.
  - **Блок информации о магазине (VStack):**
    - **Название аптеки (Text, storeBrand):**
      - Жирный шрифт, одна строка. Цвет текста адаптируется под тему.
    - **Адрес аптеки (Text, storeAddress):**
      - Средний шрифт, одна строка. Цвет текста адаптируется под тему.
    - **Взаимодействие:** Нет.
  - **Блок информации о товарах и сумме (HStack):**
    - **Количество товаров (Text, quantityItems):**
      - Средний шрифт, серая подпись. Цвет текста адаптируется под тему.
    - **Сумма заказа (Text, amount):**
      - Жирный шрифт, крупнее, выравнивание по левому краю. Цвет текста адаптируется под тему.
    - **Взаимодействие:** Нет.
  - **Блок изображений товаров (HStack):**
    - **Миниатюры товаров (OrderImageItemWidgetView):**
      - До 4 изображений товаров, круглые миниатюры с тенью.
      - **Особенности:** Если изображение отсутствует — не отображается. Цвет обводки и тени адаптируется под тему.
    - **Иконка перехода (OrderImageNextWidgetView):**
      - Круглая иконка со стрелкой, всегда последняя справа. Цвет иконки и фона адаптируется под тему.
      - **Взаимодействие:** Нет.

#### 3.1.3. Блок этапов заказа или оценки (ниже основной информации)
- **Описание:** В зависимости от состояния заказа отображается либо прогресс-бар этапов, либо блок оценки.
- **Логика отображения:**
  - Если заказ завершён и доступна оценка (`canRate == true`):
    - **Блок оценки (HStack, 5 звёзд, Link):**
      - 5 интерактивных звёзд (иконки), каждая — ссылка для выставления оценки (deeplink с параметром rate).
      - **Особенности:** Цвет звёзд и фона адаптируется под тему.
      - **Взаимодействие:** Нажатие на звезду отправляет deeplink с оценкой.
  - Если заказ не завершён и есть несколько этапов (`numberOfStages > 1`):
    - **Прогресс-бар этапов (ZStack):**
      - Линия прогресса с цветными и неактивными сегментами.
      - Кружки-этапы (OrderStageWidgetView), текущий этап выделен цветом статуса, последний этап — с иконкой finishStageIndicator.
      - **Особенности:** Цвета прогресса и кружков адаптируются под тему.
      - **Взаимодействие:** Нет.
  - Если ни одно из условий не выполнено — блок не отображается.

---

## 4. Открываемые экраны при взаимодействии с элементами

### 4.1. Интерактивные элементы и открываемые экраны
- **Вся карточка заказа (OrderWidgetView):**
  - **Взаимодействие:** Нажатие на карточку открывает экран заказа по deeplink (ma://megapteka.ru/orders?id=...).
  - **Открывает:** Экран заказа (`OrderDetailVC`).
- **Звёзды оценки (Link):**
  - **Взаимодействие:** Нажатие на звезду отправляет deeplink с параметром оценки (action=rate-N).
  - **Открывает:** Экран заказа с выставленной оценкой (`OrderDetailVC`).

---

## 5. Схематичное дерево иерархии
```
Виджет Live Activity заказа (OrderWidgetView)
│
├── Индикатор статуса заказа (Circle)
│
├── Основная карточка заказа (VStack)
│   ├── Заголовок заказа (Text, displayNumber)
│   ├── Статус заказа (Text, statusName)
│   ├── Блок информации о магазине (VStack)
│   │   ├── Название аптеки (Text, storeBrand)
│   │   └── Адрес аптеки (Text, storeAddress)
│   ├── Блок информации о товарах и сумме (HStack)
│   │   ├── Количество товаров (Text, quantityItems)
│   │   └── Сумма заказа (Text, amount)
│   └── Блок изображений товаров (HStack)
│       ├── Миниатюры товаров (OrderImageItemWidgetView)
│       └── Иконка перехода (OrderImageNextWidgetView)
│
├── Блок этапов заказа или оценки
│   ├── Прогресс-бар этапов (ZStack, OrderStageWidgetView) [если numberOfStages > 1 и canRate == false]
│   └── Блок оценки (HStack, 5 звёзд, Link) [если canRate == true]
│
└── [Вся карточка кликабельна, открывает deeplink на заказ]
```