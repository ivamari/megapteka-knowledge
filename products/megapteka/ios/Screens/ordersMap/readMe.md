# Экран «Активные заказы на карте» (OrdersMapVC)

## Описание и назначение экрана
Экран предназначен для отображения всех активных заказов пользователя на карте города с возможностью просмотра информации о каждом заказе, построения маршрута до аптеки, а также получения подробностей по каждому заказу. Основная задача — быстрое визуальное определение расположения заказов и удобная навигация между ними.

## Общая иерархия экрана
Экран реализован на базе UIViewController (`OrdersMapVC`). Основные области:
- Верхняя панель с заголовком
- Основная область с картой и маркерами заказов
- Всплывающая карточка аптеки/заказа (ViBottomSheet, `OrdersMapStoreView`)
- Кнопки управления картой (компас, локация, зум)
- Кнопка «Построить маршрут по всем аптекам»

---

## 1. Верхняя панель
### 1.1. Назначение и элементы
- **Заголовок** (navigationItem.title, `TextProvider.Order.Map.screenTitle`): «Активные заказы на карте»
- **Кнопка закрытия экрана** (системная, слева, если предусмотрена навигацией)

---

## 2. Основная область (карта)
- **Карта** (`mapMarkersAdapter?.mapView`, компонент ViGisMapAdapter)
  - Отображает город и маркеры аптек с заказами
  - Маркеры (`OrdersMapMarkerView`) показывают количество заказов и статусы (цветные индикаторы)
  - Маркеры кликабельны: при нажатии открывается карточка заказа
- **Кнопки управления картой** (StackViewPassthroughHit, вертикальный стек справа):
  - **Компас** (`CompassButton`): сброс ориентации карты
  - **Кнопка локации** (`buttonLocation`): переход к текущей геолокации пользователя
  - **Кнопка зума +** (`buttonZoomIn`): увеличить масштаб карты
  - **Кнопка зума –** (`buttonZoomOut`): уменьшить масштаб карты
- **Кнопка «Построить маршрут по всем аптекам»** (`buttonRouteAllStores`):
  - Находится внизу экрана, по центру
  - При нажатии строит маршрут через все аптеки с заказами

### 2.1. Маркеры на карте
- **Маркеры заказов** (`OrdersMapMarkerView`):
  - Заголовок с количеством заказов (например, «2 заказа»)
  - Цветные индикаторы статусов заказов (stackViewStatuses)
  - Внешний вид меняется при выборе (выделение)
  - При нажатии открывает карточку заказа

---

## 3. Всплывающая карточка заказа/аптеки (ViBottomSheet, OrdersMapStoreView)
Карточка появляется при выборе маркера на карте. Реализована через ViBottomSheet (`OrdersMapStoreCardWorker` + `OrdersMapStoreView`).

### 3.1. Структура карточки (OrdersMapStoreView)
- **Коллекция заказов** (`collectionViewOrders`): горизонтальный список заказов с миниатюрами товаров, статусами и ценой
- **Адрес аптеки** (`labelAddress`)
- **Бренд аптеки** (`imageViewBrand`, `labelBrand`)
- **Ближайшее метро** (`stackViewMetro`)
- **Расстояние до аптеки** (`labelDistance`, `labelDistanceTime`)
- **Иконка доступности** (`viewAccessibility`)
- **График работы** (`labelSchedule`)
- **Описание графика** (`textViewScheduleDescr`)
- **Время сборки заказа** (`labelBuildTime`)
- **Срок брони** (`labelReservationDays`)
- **Ворнинги/предупреждения** (`stackViewWarnings`): например, сообщение о перерыве
- **Кнопка «Построить маршрут»** (`buttonRoute`): открывает построение маршрута до аптеки
- **Кнопка «Как найти вход?»** (`buttonShowEntrance`): открывает экран с информацией о входе

#### Особенности отображения:
- Некоторые элементы (например, ворнинги, кнопка «Как найти вход?») отображаются только при наличии соответствующих данных
- Карточка может быть свернута или развернута свайпом
- При скрытии карточки снимается выделение с маркера

#### Взаимодействие:
- Нажатие на заказ в коллекции — открывает подробности заказа (OrderDetailVC)
- Нажатие на «Построить маршрут» — открывает алерт с выбором стороннего приложения для построения маршрута (см. ниже)
- Нажатие на «Как найти вход?» — открывает экран входа в аптеку

##### Логика выбора стороннего приложения для маршрута
При нажатии на кнопку «Построить маршрут» отображается системный алерт с выбором одного из поддерживаемых приложений для навигации. Список формируется динамически, исходя из наличия приложений на устройстве пользователя. Поддерживаются:
- **Apple Maps**
- **Google Maps**
- **Яндекс Карты**
- **2ГИС**

Пользователь выбирает нужное приложение, после чего происходит переход с передачей координат аптеки. Если ни одно из приложений не установлено, маршрут не строится.

---

## 4. Нижняя навигационная панель
На экране отсутствует отдельная нижняя навигационная панель. Кнопка «Построить маршрут по всем аптекам» располагается поверх карты в нижней части экрана.

---

## 5. Открываемые экраны при взаимодействии с элементами
- **Маркеры на карте** — открывают карточку заказа (ViBottomSheet, OrdersMapStoreView)
- **Карточка заказа**:
  - Кнопка «Построить маршрут» — открывает алерт выбора приложения (Apple Maps, Google Maps, Яндекс Карты, 2ГИС)
  - Кнопка «Как найти вход?» — открывает экран информации о входе (StoreEntranceVC)
  - Заказ в коллекции — открывает подробности заказа (OrderDetailVC)

---

## 6. Схематичное дерево иерархии экрана
```
Экран «Активные заказы на карте» (OrdersMapVC)
├── Верхняя панель (UINavigationBar)
│   └── Заголовок (navigationItem.title)
├── Основная область (UIView)
│   ├── Карта (ViGisMapAdapter.MapView)
│   │   └── Маркеры заказов (OrdersMapMarkerView)
│   ├── Кнопки управления картой (StackViewPassthroughHit)
│   │   ├── Компас (CompassButton)
│   │   ├── Кнопка локации (UIButton)
│   │   ├── Кнопка зума + (UIButton)
│   │   └── Кнопка зума – (UIButton)
│   └── Кнопка «Построить маршрут по всем аптекам» (UIButton)
├── Всплывающая карточка заказа/аптеки (ViBottomSheet, OrdersMapStoreView)
│   ├── Коллекция заказов (UICollectionView)
│   ├── Адрес аптеки (UILabel)
│   ├── Бренд аптеки (UIImageView, UILabel)
│   ├── Ближайшее метро (UIStackView)
│   ├── Расстояние до аптеки (UILabel)
│   ├── Иконка доступности (StoreAccessibilityView)
│   ├── График работы (UILabel)
│   ├── Описание графика (UITextView)
│   ├── Время сборки заказа (UILabel)
│   ├── Срок брони (UILabel)
│   ├── Ворнинги/предупреждения (UIStackView)
│   ├── Кнопка «Построить маршрут» (UIButton)
│   └── Кнопка «Как найти вход?» (UIButton)
```

---

## [Нужно дополнить]
- Не хватает информации о точных названиях экранов, которые открываются по кнопкам «Построить маршрут» и «Как найти вход?» (используются роутеры, но кодовые имена не указаны явно)
- Не все состояния карточки заказа (например, ошибки, алерты) можно описать без дополнительной информации о моделях данных
- Не описаны возможные состояния загрузки/ошибок карты 