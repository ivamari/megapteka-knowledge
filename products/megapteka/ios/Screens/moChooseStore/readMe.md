# Экран выбора аптеки (MOChooseStoreVC)

## Описание и назначение экрана
Экран предназначен для выбора аптеки, в которой пользователь может оформить или забрать заказ. Он решает задачи поиска, фильтрации, сравнения аптек по цене, расстоянию, наличию товаров, а также позволяет выбрать оптимальный вариант или оформить заказ со склада. Экран отображает различные состояния: список аптек, карта, отсутствие подходящих аптек, предупреждения, детали заказа и др.

## Общая иерархия экрана
Экран построен на UIViewController с использованием кастомных UIView-компонентов, UITableView для списка аптек и UIStackView для отображения предупреждений. В режиме карты используется компонент с интеграцией карты и маркерами аптек. Разметка реализована через XIB-файлы для каждого крупного блока.

---

## 1. Верхняя панель (MOChooseStoreVC)
### 1.1. Назначение и элементы
- **Кнопка назад** (слева, иконка стрелки)
  - Возвращает на предыдущий экран
- **Заголовок**: "Выберите аптеку"
- **Поле поиска** (иконка лупы справа)
  - Открывает экран поиска аптек

---

## 2. Основная область (основной контент)

### 2.1. Переключатель режимов и фильтры
- **Переключатель режимов** (UISegmentedControl или кастомные кнопки):
  - "Список" — отображает список аптек
  - "Карта" — отображает карту с аптеками

#### 2.1.1. Фильтры (MOStoresFilterModel и связанные классы)
Фильтры реализованы с помощью модели `MOStoresFilterModel` и соответствующих view-компонентов. Каждый фильтр представлен в виде кнопки или тега, часть фильтров поддерживает раскрытие списка или множественный выбор.

**Доступные фильтры:**
- **Город** (`FilterItem.ActionModel`)
  - Назначение: выбор города, в котором осуществляется поиск аптек
  - Отображение: на выборе аптек из наличия
  - Взаимодействие: нажатие открывает модальное окно выбора города (`CityChooserVC`)
- **Рядом с адресом** (`FilterItem.AddressesModel`)
  - Назначение: сортировка или фильтрация аптек от выбранного адреса на карте
  - Отображение: на выборе аптек из наличия, со склада, предзаказа и при заказе уценки
  - Взаимодействие: нажатие открывает модальное окно с выпадающим списком адресов (`FilterAddressesVC`)
- **Все в наличии** (`FilterItem.BoolModel`)
  - Назначение: фильтрация аптек по наличию всех товаров заказа
  - Отображение: на выборе аптек из наличия
  - Взаимодействие: нажатие включает/выключает фильтр, дополнительное окно не открывается
- **Цена** (`FilterItem.PriceModel`)
  - Назначение: сортировка аптек по цене (например, по возрастанию/убыванию)
  - Отображение: на выборе аптек из наличия
  - Взаимодействие: нажатие открывает модальное окно с выбором диапазона цены (`MOPriceSelectorVC`)
- **Открыто** (`FilterItem.BoolModel`)
  - Назначение: фильтрация только по открытым аптекам
  - Отображение: на выборе аптек из наличия и при заказе уценки
  - Взаимодействие: нажатие включает/выключает фильтр, дополнительное окно не открывается
- **Круглосуточно** (`FilterItem.BoolModel`)
  - Назначение: фильтрация только по круглосуточным аптекам
  - Отображение: на выборе аптек из наличия и при заказе уценки
  - Взаимодействие: нажатие включает/выключает фильтр, дополнительное окно не открывается
- **Для маломобильных** (`FilterItem.BoolModel`)
  - Назначение: фильтрация аптек, доступных для маломобильных граждан
  - Отображение: на выборе аптек из наличия, со склада, предзаказа и при заказе уценки
  - Взаимодействие: нажатие включает/выключает фильтр, дополнительное окно не открывается

**Особенности взаимодействия:**
- Фильтры могут быть комбинированы: пользователь может выбрать несколько фильтров одновременно
- В случае пустого результата после применения фильтров сброс всех фильтров может быть осуществлен отдельной кнопкой "Сбросить фильтры"
- При изменении фильтра происходит обновление списка/карты аптек

**Визуализация:**
- Все фильтры отображаются в единой горизонтальной строке над списком/картой аптек
- Активные фильтры визуально выделяются (например, цветом или заливкой)
- Фильтры открывающие модальные окна имеют иконку стрелки вниз

### 2.2. Список аптек (MOChooseStoreListView)
- **UITableView** (tableViewStores)
  - Секции:
    - **Секция предупреждений** (WarningsTCM)
      - Отображает предупреждения, ворнинги, информационные сообщения (например, "Мало аптек для заказа", "Нет аптек для заказа", "Обратите внимание на режим работы" и др.)
      - Может содержать кнопку действия (например, "Заказать со склада", "Сбросить фильтры", "Вернуться в корзину")
      - Особенности: появляется только при определённых условиях (нет аптек, мало аптек, фильтры не дали результатов и т.д.)
    - **Секции аптек** (MakeOrderStoresCellModel)
      - Для каждой аптеки отображается карточка с подробной информацией:
        - **Название и адрес аптеки**
        - **Название сети**
        - **Расстояние до аптеки**
        - **График работы** (например, "Круглосуточно")
        - **Время сборки заказа**
        - **Срок брони**
        - **Цена заказа**
        - **Кнопка "Выбрать"** — выбирает аптеку для оформления заказа
        - **Список товаров заказа** (MakeOrderStoreItemView) — раскрывается по нажатию, отображает товары, их количество, цену, возможность замены
        - **Блок "Уже есть заказ в этой аптеке"** (MOStoreHasOrdersView) — отображается, если в аптеке уже есть заказ пользователя, раскрывается для просмотра деталей
        - **Бейджи, рейтинги, иконки доступности, метки метро** — отображаются при наличии соответствующих данных
        - **Ворнинги и информационные сообщения** — могут появляться внутри карточки аптеки (например, "В аптеке перерыв", "Срок брони всего 1 день", "Оплата только наличными")
        - **Кнопка "Показать на карте"** — открывает карту с выбранной аптекой
        - **Кнопка "Все товары"** — раскрывает список товаров заказа
        - **Кнопка "Заменить"** — позволяет заменить товар (открывает экран замены)
        - **Информация о бонусах, скидках, условиях оплаты** — отображается при наличии
        - **Особые состояния**: если аптека не может выполнить заказ, отображается соответствующее сообщение
      - **Карточка товара в заказе** (MakeOrderStoreItemView):
        - Название, количество, цена, причина скидки, кнопка "Заменить" (если товар недоступен)
        - Взаимодействие: раскрытие подробностей, замена товара

### 2.3. Карта аптек (MOChooseStoreMapView)
- **UIView с картой** (mapMarkersAdapter)
  - Отображает маркеры аптек с ценами, количеством товаров, статусами
  - Маркеры могут быть выделены (выбранная аптека)
  - Кластеризация маркеров при большом количестве аптек
- **UIStackView предупреждений** (stackViewWarnings)
  - Аналогично секции предупреждений в списке, отображает ворнинги и кнопки действий
- **Панель управления картой** (UIStackView)
  - **Кнопка компаса** (CompassButton) — сбрасывает направление карты
  - **Кнопка "Мое местоположение"** — центрирует карту на пользователе
  - **Кнопки зума** — увеличивают/уменьшают масштаб карты
- **Карточка выбранной аптеки** (MakeOrderStoreMapView)
  - Отображается при выборе аптеки на карте
  - Содержит ту же информацию, что и карточка аптеки в списке, с возможностью выбрать аптеку, посмотреть детали заказа, раскрыть список товаров и т.д.

### 2.4. Карточка товара из каталога (MOChooseStoreCatalogueItemView)
- **MOChooseStoreCatalogueItemView** отображается поверх основной области (над списком и картой аптек)
  - **Изображение товара**
  - **Название товара**
  - **Минимальная стоимость товаров с учетом количества (labelAmount)**
  - **Цена за штуку (labelPrice)**
  - **Счетчик количества (ProductCounterView)** с кнопками увеличения/уменьшения
  - **Тултип с лимитом (ColoredTooltipView)**, появляется при попытке превысить maxQuantity
  - **Особенности отображения:**
    - Показывается только при заказе 1 позиции заказа товара из каталга (предзаказ, заказ уценки)
    - Цена за штуку скрывается при количестве 1
  - **Взаимодействие:**
    - Изменение количества при нажатии на "+" или "-"
    - Отображение тултипа при достижении лимита и нажатии на кнопку увеличения количества

### 2.5. Динамика отображения элементов в зависимости от типа заказа
- **Заказ из наличия (StoreOrderingObject):**
  - Показываются все товары, их количество, доступность, возможность замены
  - Срок брони, время сборки, график работы отображаются стандартно
  - В карточке аптеки есть возможность раскрыть список товаров (при частичном наличии список раскрывается автоматически)
- **Заказ со склада (StockOrderingObject):**
  - Такая же логика как в StoreOrderingObject, за исключением следующих пунктов:
    - Всегда свернут график работы (forceCollapseSchedule = true)
    - В карточке аптеки может отображаться дата поступления товара (arrivalDate)
    - Срок брони может быть меньше (например, 2 дня)
    - Ворнинги: минимальная сумма заказа, предложение увеличить сумму для большего выбора аптек
- **Предзаказ (PreorderOrderingObject):**
  - Такая же логика как в StoreOrderingObject, за исключением следующих пунктов:
    - Всегда свернут график работы (forceCollapseSchedule = true)
    - В карточке аптеки отображается дата поступления товара (arrivalDate), если она известна, иначе статус "уточнит аптека"
    - Список товаров может быть скрыт (hideItemsInStoreCard = true), если количество доступных и запрошенных товаров совпадает
    - Кнопка раскрытия списка товаров отображается если доступное количество для заказа меньше, чем запрашивоемое
    - Ворнинги: особые статусы, например, "Дату поставки уточнит аптека"
- **Заказа уцененного товара (discounted):**
  - Такая же логика как в StoreOrderingObject, за исключением следующих пунктов:
    - Отображается срок годности товара
    - Список товаров всегда раскрыт
- **Общие особенности:**
  - Для всех типов заказа могут отображаться индивидуальные ворнинги, условия оплаты, бонусы, бейджи, а также блок "Уже есть заказ в этой аптеке"
  - В зависимости от типа заказа меняется текст, цвет иконок, условия отображения кнопок и секций

---

## 3. Всплывающие и дополнительные элементы
- **Ворнинги и информационные сообщения** (WarningView)
  - Появляются поверх основного контента, могут содержать кнопки действий
  - Примеры: "Мало аптек для заказа", "Нет аптек для заказа", "Минимальная сумма заказа со склада", "Обратите внимание на режим работы аптек"
  - Условия показа: зависят от состояния фильтров, наличия аптек, времени и т.д.
- **Модальные окна**
  - Открываются при выборе определённых действий (например, замена товара, подробности о товаре)
- **Тултипы** (ColoredTooltipView)
  - Появляются при попытке превысить лимит количества товара

---

## 4. Нижняя навигационная панель
- На экране отсутствует постоянная нижняя навигационная панель, но в некоторых состояниях появляется крупная кнопка действия внизу (например, "Вернуться в корзину", "Заказать со склада", "Сбросить фильтры").

---

## 5. Открываемые экраны при взаимодействии с элементами

- **Кнопка "Выбрать"** (в карточке аптеки или на карте)
  - Открывает: Экран оформления заказа (`MOConfirmVC`)
- **Кнопка "Показать на карте"**
  - Открывает: Экран карты с выбранной аптекой (`MOChooseStoreMapView`)
- **Кнопка "Все товары"**
  - Раскрывает список товаров заказа (`MakeOrderStoreItemView`)
- **Кнопка "Заменить"**
  - Открывает: Экран замены товара (`MOReplaceItemVC`)
- **Кнопка "Заказать со склада"**
  - Открывает: Экран заказа со склада (`MOChooseStoreVC`)
- **Кнопка "Сбросить фильтры"**
  - Сбрасывает активные фильтры, обновляет список аптек
- **Кнопка "Вернуться в корзину"**
  - Открывает: Экран корзины (`CartVC`)

---

## 6. Схематичное дерево иерархии экрана
```
Экран выбора аптеки (MOChooseStoreVC)
├── Верхняя панель
│   ├── Кнопка назад
│   ├── Заголовок "Выберите аптеку"
│   ├── Кнопка поиска
├── Основная область
│   ├── Переключатель режимов (Список/Карта)
│   ├── Фильтры (Город, Сортировка, Наличие, Активные фильтры)
│   ├── Список аптек (MOChooseStoreListView)
│   │   ├── UITableView (tableViewStores)
│   │   │   ├── Секция предупреждений (WarningsTCM)
│   │   │   ├── Секции аптек (MakeOrderStoresCellModel)
│   │   │   │   ├── Карточка аптеки (MakeOrderStoreMapView)
│   │   │   │   │   ├── Название, адрес, сеть, метро, рейтинг, доступность
│   │   │   │   │   ├── График работы, время сборки, срок брони
│   │   │   │   │   ├── Цена заказа
│   │   │   │   │   ├── Кнопка "Выбрать"
│   │   │   │   │   ├── Кнопка "Показать на карте"
│   │   │   │   │   ├── Кнопка "Все товары"
│   │   │   │   │   ├── Список товаров заказа (MakeOrderStoreItemView)
│   │   │   │   │   ├── Кнопка "Заменить"
│   │   │   │   │   ├── Блок "Уже есть заказ в этой аптеке" (MOStoreHasOrdersView)
│   │   │   │   │   ├── Ворнинги, бейджи, бонусы, условия оплаты
│   ├── Карта аптек (MOChooseStoreMapView)
│   │   ├── UIView с картой (mapMarkersAdapter)
│   │   ├── UIStackView предупреждений (stackViewWarnings)
│   │   ├── Панель управления картой (компас, местоположение, зум)
│   │   ├── Карточка выбранной аптеки (MakeOrderStoreMapView)
├── Карточка товара из каталога (MOChooseStoreCatalogueItemView) [поверх основной области]
├── Всплывающие элементы
│   ├── Ворнинги и информационные сообщения (WarningView)
│   ├── Модальные окна (замена товара, детали)
│   ├── Тултипы (ColoredTooltipView)
├── Нижняя панель действий (динамически)
│   ├── Кнопка "Вернуться в корзину" / "Заказать со склада" / "Сбросить фильтры"
```

---

## [Нужно дополнить]
- Не полностью раскрыта логика отображения некоторых ворнингов и условий их появления.
- Не все состояния карточки аптеки и их особенности отображения можно однозначно определить по коду и скриншотам (например, все варианты бейджей, бонусов, условий оплаты).
- Не указаны точные названия моделей данных для некоторых элементов (например, для секций аптек в списке).
- Не описаны все возможные модальные окна и их кодовые имена.

--- 