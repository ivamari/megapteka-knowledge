# Экран оформления заказа с разделением на несколько аптек (MOMultiConfirmVC)

## Описание и назначение экрана
Экран предназначен для подтверждения оформления заказа, который будет разделён на несколько частей для самовывоза из разных аптек. Пользователь видит список аптек, товары в каждой из них, детали оплаты, информацию о себе, итоговую сумму, экономию, а также подтверждает согласие с условиями. Экран завершает сценарий оформления заказа, предоставляя финальную точку для проверки и подтверждения всех данных.

**Особенности:**
- Позволяет оформить заказ сразу в несколько аптек, если все товары нельзя забрать в одной.
- Отображает отдельные блоки для каждой аптеки, их статусы, адреса, условия оплаты, сроки и предупреждения.
- Вся логика и структура экрана построена по аналогии с экраном MOConfirmVC (одна аптека), но с поддержкой множественных аптек и связанных с этим особенностей.

## Общая иерархия экрана
Экран реализован на основе UIViewController (`MOMultiConfirmVC`) с использованием UITableView для отображения секций и элементов. В нижней части экрана находится фиксированная панель с кнопкой подтверждения заказа и предупреждением о необходимости согласия с условиями.

---

## 1. Верхняя панель
### 1.1. Назначение и элементы
- **Заголовок** (navigationItem.title): «Оформление заказа»
  - Отображается в верхней панели навигации.
- **Кнопка назад** (стандартная кнопка UINavigationController)
  - Возвращает на предыдущий экран.

---

## 2. Основная область (UITableView)
Основная область реализована через UITableView, секции и ячейки формируются динамически в зависимости от состояния заказа и данных.

### 2.1. Секции и их элементы (в порядке отображения)

- **Секция: Общие предупреждения** (`MOConfirmWarningView`)
  - Показывает информационный баннер, если заказ будет разделён на несколько аптек. Текст и стиль зависят от количества аптек.
  - Неинтерактивный элемент.
  - **Пример:** «Товары будут разделены на 2 заказа и их нужно будет забирать в разных аптеках».

- **Секция: Список аптек**
  - **Заголовок секции** (`SectionNameHeaderView`): «Аптеки для самовывоза»
  - Для каждой аптеки:
    - **Карточка аптеки** (`MOConfirmStoreView`)
      - Название аптеки, адрес, расстояние, доступность для маломобильных, бренд, метро, режим работы, дата и время готовности заказа, срок брони, иконка доступности.
      - **Особенности:**
        - Отображает разные статусы (например, «Открыто круглосуточно», «Срок брони 3 дня»).
        - Может содержать предупреждения (например, «В аптеке перерыв до 14:50»).
      - **Взаимодействие:**
        - Нажатие на адрес или иконку карты открывает экран с картой одной аптеки (`StoresMapVC`).
    - **Список предупреждений по аптеке** (`MOConfirmWarningView`)
      - Например, ограничения по оплате, бонусам, перерывы в работе и т.д.
      - Неинтерактивные.
    - **Список товаров в аптеке** (`MOConfirmItemView`)
      - Для каждого товара: изображение, название, производитель, цена, количество, причина скидки.
      - Неинтерактивные.

- **Секция: Карта аптек** (`MOMultiConfirmMapView`)
  - Отображает карту с пинами всех аптек, участвующих в заказе.
  - Карта не интерактивна (isUserInteractionEnabled = false), но вся область кликабельна.
  - При нажатии открывается экран с картой всех аптек (`StoresMapVC`).

- **Секция: Оплата**
  - **Заголовок секции** (`SectionNameHeaderView`): «Способ оплаты»
  - **Информация об оплате** (`MOConfirmTextView`)
    - Текстовое описание способа оплаты (например, «В аптеке при получении», «Оплата только наличными»).
    - Может содержать предупреждения (например, «В аптеке перерыв, оплата недоступна»).
    - Неинтерактивно.

- **Секция: Информация о покупателе**
  - **Заголовок секции** (`SectionNameHeaderView`): «Информация о покупателе»
  - **Поля для ввода** (`MOConfirmUserInfoView`)
    - Имя (UITextField)
    - Телефон (UITextField)
      - Валидация номера, возможна отправка и подтверждение кода (если требуется, появляется дополнительное поле для кода и кнопка отправки/повторной отправки).
      - Кнопка для запроса кода подтверждения (если требуется).
      - **Особенности:** поддержка повторной отправки кода, обратный отсчёт, автоматический переход к следующему полю.
    - Email (MOConfirmEmailView, UITextField)
      - Валидация email, может быть необязательным.
      - **Особенности:** если e-mail отсутствует, блок скрыт; если есть — предзаполнен.
    - Все поля поддерживают скроллинг к себе при ошибке.
    - **Взаимодействие:** ввод данных, отправка и подтверждение кода, автоматический переход к следующему полю.

- **Секция: Итоговая сумма** (`MOConfirmTotalView`)
  - Показывает количество товаров и итоговую сумму заказа.
  - Неинтерактивно.

- **Секция: Экономия** (`EconomyView`)
  - Показывает сумму экономии по заказу, если есть (например, если экономия больше 30 рублей).
  - Неинтерактивно.

- **Секция: Согласие с условиями** (`MOConfirmAgreementsView`)
  - Чекбокс согласия с пользовательским соглашением, политикой конфиденциальности и подтверждением наличия рецепта.
  - Ссылки на документы открываются по нажатию (открытие внешнего URL или WebVC).
  - Без согласия кнопка подтверждения заказа неактивна, а внизу отображается предупреждение.
  - **Взаимодействие:** нажатие на чекбокс, переход по ссылкам.

---

## 3. Всплывающие и дополнительные элементы
- **Ворнинги/алерты** (`MOConfirmWarningView`, `AlertModel`)
  - Все ворнинги определяются на сервере и приходят через API. Примеры: ошибки, неверные данные, специальные условия (например, перерыв в аптеке, неверный e-mail, не подтверждён телефон).
  - **Алерты о недоступности товаров и изменении суммы заказа:**
    - **Алерт "Часть товаров недоступна"**: появляется, если после выбора аптек часть товаров стала недоступна для заказа. Содержит заголовок, поясняющий текст и кнопку "OK" для закрытия.
    - **Алерт "Сумма заказа увеличилась/уменьшилась"**: появляется, если после выбора аптек сумма заказа изменилась. Содержит заголовок, поясняющий текст и кнопку "OK" для закрытия. В тексте может быть призыв оформить заказ по выгодной цене.
    - Все эти алерты отображаются в виде модального окна с затемнением фона, не позволяют продолжить оформление заказа, пока пользователь не нажмёт "OK".
    - Условия показа определяются логикой сравнения актуального состояния заказа с моментом выбора аптек (например, если изменилась доступность товаров или их стоимость).
- **Валидация полей**
  - При ошибке валидации (имя, телефон, email) появляется алерт с описанием ошибки и фокус на соответствующее поле.
- **Ввод и подтверждение кода**
  - Если требуется подтверждение телефона, появляется дополнительное поле для ввода кода и кнопка отправки/повторной отправки.

---

## 4. Нижняя навигационная панель
- **Контейнер с кнопкой и предупреждением** (`viewBottomContainer`)
  - Фиксирован внизу экрана, не скроллится вместе с таблицей.
  - **Кнопка подтверждения заказа** (`buttonConfirm`)
    - Активна только при принятии всех соглашений и корректном заполнении полей.
    - При нажатии отправляет заказ и переходит на экран успешного оформления (`MOSuccessVC`).
    - При ошибках — алерты/ворнинги.
  - **Предупреждение о необходимости согласия** (`labelRequirements`)
    - Показывается, если чекбокс согласия не отмечен.
    - Скрывается при принятии соглашений.
    - Красный фон, белый текст.

---

## 5. Открываемые экраны при взаимодействии с элементами

- **Адрес аптеки/иконка карты**
  - Открывает: Экран карты с одной аптекой (**StoresMapVC**)
- **Карта аптек**
  - Открывает: Экран карты со всеми аптеками (**StoresMapVC**)
- **Ссылки на соглашения**
  - Открывает: Внешний браузер по URL или WebVC
- **Кнопка подтверждения заказа**
  - Открывает: Экран успешного оформления заказа (**MOSuccessVC**)
  - При ошибках — алерты/ворнинги
- **Ошибки валидации**
  - Скроллит к соответствующему полю и показывает алерт

---

## 6. Схематичное дерево иерархии экрана
```
Экран оформления заказа (MOMultiConfirmVC)
├── Верхняя панель (UINavigationBar)
│   ├── Заголовок: Оформление заказа
│   └── Кнопка назад
├── Основная область (UITableView)
│   ├── Секция: Общие предупреждения (MOConfirmWarningView)
│   ├── Секция: Список аптек
│   │   ├── Заголовок секции (SectionNameHeaderView)
│   │   └── Для каждой аптеки:
│   │       ├── Карточка аптеки (MOConfirmStoreView)
│   │       │   ├── Адрес (нажатие — карта одной аптеки)
│   │       │   ├── Иконка карты (нажатие — карта одной аптеки)
│   │       │   └── Список предупреждений (MOConfirmWarningView)
│   │       └── Список товаров (MOConfirmItemView)
│   ├── Секция: Карта аптек (MOMultiConfirmMapView)
│   │   └── Карта (нажатие — карта всех аптек)
│   ├── Секция: Оплата
│   │   ├── Заголовок секции (SectionNameHeaderView)
│   │   └── Информация об оплате (MOConfirmTextView)
│   ├── Секция: Информация о покупателе
│   │   ├── Заголовок секции (SectionNameHeaderView)
│   │   ├── Поля для ввода (MOConfirmUserInfoView)
│   │   │   ├── Имя
│   │   │   ├── Телефон (с подтверждением)
│   │   │   └── Email (MOConfirmEmailView)
│   ├── Секция: Итоговая сумма (MOConfirmTotalView)
│   ├── Секция: Экономия (EconomyView)
│   └── Секция: Согласие с условиями (MOConfirmAgreementsView)
├── Всплывающие элементы
│   ├── Ворнинги/алерты (MOConfirmWarningView, AlertModel)
│   │   └── Алерты о недоступности товаров и изменении суммы заказа (AlertModel)
│   └── Валидация полей
└── Нижняя панель (viewBottomContainer)
    ├── Кнопка подтверждения заказа (buttonConfirm)
    └── Предупреждение о необходимости согласия (labelRequirements)
```

---

## [Нужно дополнить]
- Не хватает информации о точном составе и структуре некоторых ячеек (например, MOConfirmStoreView, MOConfirmItemView, MOConfirmUserInfoView, MOConfirmAgreementsView), так как их внутреннее устройство не раскрыто в предоставленных файлах.
- Не полностью раскрыта логика отображения и скрытия некоторых предупреждений и алертов — требуется уточнение условий их появления.
- Неизвестно, какие дополнительные состояния могут быть у полей для ввода (например, ошибки, подсказки, маски ввода).
- Не раскрыта логика отображения и взаимодействия с бонусами и экономией, если они есть.
- Не описаны возможные ошибки и сценарии их обработки при отправке заказа. 