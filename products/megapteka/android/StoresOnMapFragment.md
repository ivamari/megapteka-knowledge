# StoresOnMapFragment

## 1. Обзор Экрана

Экран "Аптека на карте" (StoresOnMapFragment) предназначен для отображения одной или нескольких аптек на интерактивной карте. Он позволяет пользователю просматривать детали выбранной аптеки, строить маршруты, а также управлять отображением карты. Этот экран часто используется для визуализации местоположения аптек, найденных в результате поиска или связанных с заказом.

**Основные функции:**
*   Отображение аптек на карте в виде маркеров.
*   Кластеризация маркеров при отображении нескольких аптек.
*   Отображение детальной информации о выбранной аптеке в нижней панели.
*   Построение маршрута до выбранной аптеки.
*   Отображение информации о доступности аптеки.
*   Управление масштабом карты и центрированием по местоположению пользователя.

## 2. Элементы Пользовательского Интерфейса (UI Elements)

*   **MapView (map):**
    *   **Назначение/Функция:** Интерактивная карта, на которой отображаются маркеры аптек.
    *   **Взаимодействие пользователя:** Перемещение, масштабирование карты. Нажатие на маркер аптеки открывает нижнюю панель с деталями.
*   **View (bottom):**
    *   **Назначение/Функция:** Нижняя панель (BottomSheet), которая отображает детальную информацию о выбранной аптеке.
    *   **Взаимодействие пользователя:** Может быть свернута/развернута. Содержит информацию об аптеке.
*   **TextView (includeItemStore.address):**
    *   **Назначение/Функция:** Отображает адрес выбранной аптеки.
    *   **Взаимодействие пользователя:** Неинтерактивный элемент.
*   **TextView (includeItemStore.metro):**
    *   **Назначение/Функция:** Отображает информацию о ближайшем метро (если применимо).
    *   **Взаимодействие пользователя:** Неинтерактивный элемент.
*   **ImageView (includeItemStore.brandIcon):**
    *   **Назначение/Функция:** Отображает логотип бренда аптеки.
    *   **Взаимодействие пользователя:** Неинтерактивный элемент.
*   **TextView (includeItemStore.brand):**
    *   **Назначение/Функция:** Отображает название бренда аптеки.
    *   **Взаимодействие пользователя:** Неинтерактивный элемент.
*   **TextView (includeItemStore.scheduleText):**
    *   **Назначение/Функция:** Отображает краткое расписание работы аптеки. При нажатии может разворачивать полное расписание.
    *   **Взаимодействие пользователя:** Нажатие переключает видимость полного расписания.
*   **TextView (includeItemStore.schedule):**
    *   **Назначение/Ф��нкция:** Отображает полное расписание работы аптеки. Видимо, если `scheduleText` развернут.
    *   **Взаимодействие пользователя:** Нажатие сворачивает полное расписание.
*   **TextView (includeItemStore.distance):**
    *   **Назначение/Функция:** Отображает расстояние до аптеки от текущего местоположения пользователя.
    *   **Взаимодействие пользователя:** Неинтерактивный элемент.
*   **TextView (includeItemStore.buildTime):**
    *   **Назначение/Функция:** Отображает примерное время в пути до аптеки.
    *   **Взаимодействие пользователя:** Неинтерактивный элемент.
*   **Button (includeItemStore.route):**
    *   **Назначение/Функция:** Кнопка для построения маршрута до выбранной аптеки.
    *   **Возможные состояния:** Видима, если доступна точка на карте для аптеки.
    *   **Взаимодействие пользователя:** Нажатие открывает внешнее приложение для построения маршрута.
*   **Button (includeItemStore.accessibility):**
    *   **Назначение/Функция:** Кнопка для просмотра информации о доступности аптеки для людей с ограниченными возможностями.
    *   **Возможные состояния:** Видима, если информация о доступности доступна.
    *   **Взаимодействие пользователя:** Нажатие открывает всплывающее окно с деталями доступности.
*   **ImageView (includeItemStore.isAccessible):**
    *   **Назначение/Функция:** Иконка, указывающая на статус доступности аптеки (зеленая галочка/красный крест).
    *   **Взаимодействие пользователя:** Неинтерактивный элемент.
*   **ImageView (mapOrientation):**
    *   **Назначение/Функция:** Кнопка для изменения ориентации карты.
    *   **Взаимодействие пользователя:** Нажатие изменяет ориентацию карты.
*   **ImageView (userLocation):**
    *   **Назначение/Функция:** Кнопка для центрирования карты по текущему местоположению пользователя.
    *   **Взаимодействие пользователя:** Нажатие центрирует карту.
*   **ImageView (plus, minus):**
    *   **Назначение/Функция:** Кнопки для увеличения/уменьшения масштаба карты.
    *   **Взаимодействие пользователя:** Нажатие изменяет масштаб карты.

## 3. Пользовательские Сценарии (User Flows)

*   **Просмотр аптек на карте:**
    1.  Пользователь открывает экран "Аптека на карте", передавая список аптек (`args.stores`).
    2.  Маркеры аптек отображаются на карте. Если аптека одна, она выбирается и ее детали отображаются в нижней панели.
    3.  Если аптек несколько, они кластеризуются.
*   **Просмотр деталей аптеки:**
    1.  Пользователь нажимает на маркер аптеки на карте.
    2.  Нижняя панель (`bottom`) раз��орачивается, отображая информацию о выбранной аптеке.
*   **Построение маршрута:**
    1.  Пользователь нажимает кнопку "Маршрут" на нижней панели.
    2.  Открывается внешнее приложение для построения маршрута до выбранной аптеки.
    3.  Регистрируется аналитическое событие `AnEvent.routeToStore()`.
*   **Просмотр информации о доступности:**
    1.  Пользователь нажимает на кнопку "Доступность" на нижней панели.
    2.  Отображается всплывающее окно с подробной информацией о доступности аптеки для людей с ограниченными возможностями.
*   **Управление расписанием:**
    1.  Пользователь нажимает на краткое расписание (`scheduleText`).
    2.  Отображается полное расписание (`schedule`).
    3.  Повторное нажатие на полное расписание сворачивает его.
*   **Управление картой:**
    1.  Пользова��ель нажимает кнопки `+` или `-` для изменения масштаба карты.
    2.  Пользователь нажимает кнопку "Мое местоположение" для центрирования карты по текущему местоположению.
    3.  Пользователь нажимает кнопку "Ориентация" для изменения ориентации карты.

## 4. Навигация

С экрана "Аптека на карте" возможны следующие переходы:

*   **Назад к предыдущему экрану:** При нажатии кнопки "Назад" в тулбаре или системной кнопки "Назад".
*   **Внешние карты (Google Maps, Yandex Maps):** Для построения маршрута.
*   **Диалоговые окна:** Для отображения информации о доступности.

### Deep Links

На этот экран нет прямых deep links.

## 5. Отображаемые Данные

*   **Типы данных:**
    *   `List<StoreMappable>`: Список объектов `StoreMappable`, каждый из которых содержит информацию об аптеке (адрес, бренд, расписание, доступность, координаты, логотип).
*   **Источник данных:**
    *   **Входящие аргументы (`navArgs`):** Список аптек (`args.stores`) и источник перехода (`args.source`). Эти данные, как правило, получены из следующих источников:
        *   **API:**
            *   `ApiService.checkStockOrder` (REST метод: `GET /app/v4/stock/orders/check`) - для получения списка аптек при заказе со склада.
            *   `ApiService.getOrdersOnMap` (REST метод: `GET /app/v1/orders/map`) - для получения списка аптек, связанных с заказами на карте.
        *   **Локальное хранилище:** Таблица `ChosenStore` в `StoresDao` (для сохранения выбранной аптеки, но не для списка отображаемых на карте).
    *   **Внешние SDK:** `DGis SDK` (для отображения карты и маркеров).

## 6. Особые Состояния/Логика

*   **Кластеризация маркеров:** Используется `ClusterViewProvider` для группировки близко расположенных маркеров аптек в кластеры, что улучшает читаемость карты.
*   **Динамическое заполнение нижней панели:** Информация о выбранной аптеке динамически заполняет нижнюю панель при нажатии на маркер.
*   **Управление расписанием:** Расписание аптеки может быть развернуто/свернуто для отображения полной информации.
*   **Логирование аналитики:** Построение маршрутов логируется с помощью `AnUtils.logEvent`.
*   **Выбор одной аптеки:** Если в аргументах передана только одна аптека, она автоматичес��и выбирается и центрируется на карте.
