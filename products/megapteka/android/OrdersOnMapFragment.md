# OrdersOnMapFragment

## 1. Обзор Экрана

Экран "Заказы на карте" (OrdersOnMapFragment) предназначен для визуализации местоположения аптек, в которых оформлены заказы пользователя, на интерактивной карте. Он позволяет просматривать детали аптеки и заказов, связанных с ней, строить маршруты, а также управлять отображением карты.

**Основные функции:**
*   Отображение аптек с активными заказами на карте в виде маркеров.
*   Кластеризация маркеров для удобства просмотра при большом количестве аптек.
*   Отображение детальной информации о выбранной аптеке и связанных с ней заказах в нижней панели.
*   Построение маршрута до выбранной аптеки или до всех ��птек с заказами.
*   Отображение информации о доступности аптеки.
*   Переход к деталям заказа.
*   Управление масштабом карты и центрированием по местоположению пользователя.

## 2. Элементы Пользовательского Интерфейса (UI Elements)

*   **MapView (map):**
    *   **Назначение/Функция:** Интерактивная карта, на которой отображаются маркеры аптек с заказами.
    *   **Взаимодействие пользователя:** Перемещение, масштабирование карты. Нажатие на маркер аптеки открывает нижнюю панель с деталями.
*   **ProgressBar (progress):**
    *   **Назначение/Функция:** Индикатор загрузки, отображаемый во время загрузки данных о заказах.
    *   **Возможные состояния:** Видимый во время загрузки, скрытый в других состояниях.
*   **View (bottom):**
    *   **Назначение/Функция:** Нижняя панель (BottomSheet), которая отображает детальную информацию о выбранной аптеке и ее заказах.
    *   **Взаимодействие пользователя:** Может быть свернута/развернута. Содержит информацию об аптеке и список заказов.
*   **TextView (includeItemStore.address):**
    *   **Назначение/Функция:** Отображает адрес выбранной аптеки.
    *   **Взаимодействие пользователя:** Неинтерактивный элемент.
*   **TextView (includeItemStore.metro):**
    *   **Назначение/Функция:** Отображает информацию о ближайшем метро (если применимо).
    *   **Взаимодействие пользователя:** Неинтерактивный элемент.
*   **ImageView (includeItemStore.brandIcon):**
    *   **Назначение/Функция:** Отображает логотип бренда аптеки.
    *   **Взаимодействие пользователя:** Неинтерактивный элемент.
*   **TextView (includeItemStore.brand):**
    *   **Назначение/Функция:** Отображает название бренда аптеки.
    *   **Взаимодей��твие пользователя:** Неинтерактивный элемент.
*   **TextView (includeItemStore.scheduleText):**
    *   **Назначение/Функция:** Отображает краткое расписание работы аптеки. При нажатии может разворачивать полное расписание.
    *   **Взаимодействие пользователя:** Нажатие переключает видимость полного расписания.
*   **TextView (includeItemStore.schedule):**
    *   **Назначение/Функция:** Отображает полное расписание работы аптеки. Видимо, если `scheduleText` развернут.
    *   **Взаимодействие пользователя:** Нажатие сворачивает полное расписание.
*   **TextView (includeItemStore.distance):**
    *   **Назначение/Функция:** Отображает расстояние до аптеки от текущего местоположения пользователя.
    *   **Взаимодействие пользователя:** Неинтерактивный элемент.
*   **TextView (includeItemStore.buildTime):**
    *   **Назначение/Функция:** Отображает пр��мерное время в пути до аптеки.
    *   **Взаимодействие пользователя:** Неинтерактивный элемент.
*   **Button (includeItemStore.route):**
    *   **Назначение/Функция:** Кнопка для построения маршрута до выбранной аптеки.
    *   **Возможные состояния:** Видима, если доступна точка на карте для аптеки.
    *   **Взаимодействие пользователя:** Нажатие открывает внешнее приложение для построения маршрута.
*   **Button (includeItemStore.accessibility):**
    *   **Назначение/Функция:** Кнопка для просмотра информации о доступности аптеки для людей с ограниченными возможностями.
    *   **Возможные состояния:** Видима, если информация о доступности доступна.
    *   **Взаимодействие пользователя:** Нажатие открывает всплывающее окно с деталями доступности.
*   **ImageView (includeItemStore.isAccessible):**
    *   **Назначение/Функция:** Иконка, указывающая на статус доступности аптеки (зеленая галочка/красный крест).
    *   **Взаимодействие пользователя:** Неинтерактивный элемент.
*   **RecyclerView (viewBinding.recyclerView):**
    *   **Назначение/Функция:** Горизонтальный список для отображения заказов, связанных с выбранной аптекой (`OrdersSection`).
    *   **Взаимодействие пользователя:** Горизонтальная прокрутка. Нажатие на заказ переводит на экран деталей заказа.
*   **Button (buttonRoutes):**
    *   **Назначение/Функция:** Кнопка для построения маршрутов до всех аптек с заказами.
    *   **Взаимодействие пользователя:** Нажатие открывает внешнее приложение для построения маршрутов.
*   **ImageView (mapOrientation):**
    *   **Назначение/Функция:** Кнопка для изменения ориентации карты.
    *   **Взаимодействие пользователя:** Нажатие изменяет ор��ентацию карты.
*   **ImageView (userLocation):**
    *   **Назначение/Функция:** Кнопка для центрирования карты по текущему местоположению пользователя.
    *   **Взаимодействие пользователя:** Нажатие центрирует карту.
*   **ImageView (plus, minus):**
    *   **Назначение/Функция:** Кнопки для увеличения/уменьшения масштаба карты.
    *   **Взаимодействие пользователя:** Нажатие изменяет масштаб карты.

## 3. Пользовательские Сценарии (User Flows)

*   **Просмотр заказов на карте:**
    1.  Пользователь открывает экран "Заказы на карте".
    2.  Отображается индикатор загрузки (`progress`).
    3.  ViewModel загружает список аптек с активными заказами.
    4.  Маркеры аптек отображаются на карте. Если аптек много, они кластеризуются.
    5.  При успешной загрузке, индикатор скрывается.
*   **Просмотр деталей аптеки и з��казов:**
    1.  Пользователь нажимает на маркер аптеки на карте.
    2.  Нижняя панель (`bottom`) разворачивается, отображая информацию о выбранной аптеке и список связанных заказов.
*   **Построение маршрута:**
    1.  Пользователь нажимает кнопку "Маршрут" на нижней панели.
    2.  Открывается внешнее приложение для построения маршрута до выбранной аптеки.
    3.  (Альтернативно) Пользователь нажимает кнопку "Построить маршруты" (`buttonRoutes`) для построения маршрутов до всех аптек с заказами.
*   **Просмотр информации о доступности:**
    1.  Пользователь нажимает на кнопку "Доступность" на нижней панели.
    2.  Отображается всплывающее окно с подробной информацией о доступности аптеки для людей с ограниченными возможностями.
*   **Переход к деталям заказа:**
    1.  Пользователь нажимает на любой заказ в горизонтальном списке на нижней панели.
    2.  Происходит навигация к экрану деталей заказа (`OrderDetailFragment`).
*   **Управление картой:**
    1.  Пользователь нажимает кнопки `+` или `-` для изменения масштаба карты.
    2.  Пользователь нажимает кнопку "Мое местоположение" для центрирования карты по текущему местоположению.
    3.  Пользователь нажимает кнопку "Ориентация" для изменения ориентации карты.

## 4. Навигация

С экрана "Заказы на карте" возможны следующие переходы:

*   **`OrderDetailFragment`:** Для просмотра детальной информации о заказе.
*   **Внешние карты (Google Maps, Yandex Maps):** Для построения маршрутов.
*   **Диалоговые окна:** Для отображения информации о доступности.

### Deep Links

На этот экран нет прямых deep links.

## 5. Отображаемые Данные

*   **Типы данных:**
    *   `List<StoreAndOrders>`: Список объектов, каждый из которых содержит информацию об аптеке (`Store`) и список заказов (`orders`), связанных с этой аптекой.
    *   `Store`: Информация об аптеке (адрес, бренд, расписание, доступность, координаты).
    *   `Order`: Информация о заказе (ID, номер, статус).
*   **Источник данных:**
    *   **API:** `ApiService.getOrdersOnMap` (REST метод: `GET /app/v1/orders/map`) - для получения списка аптек с заказами.
    *   **Внешние SDK:**
        *   `DGis SDK` (для отображения карты и маркеров).
        *   `SuspendLocationProvider` (для получения текущего местоположения пользователя).

## 6. Особые Состояния/Логика

*   **Кластеризация маркеров:** Используется `ClusterViewProvider` для группировки близко расположенных маркеров аптек в кластеры, что улучшает читаемость карты.
*   **Динамическое заполнение нижней панели:** Информация о выбра��ной аптеке и ее заказах динамически заполняет нижнюю панель при нажатии на маркер.
*   **Обработка расписания:** Расписание аптеки может быть развернуто/свернуто для отображения полной информации.
*   **Построение маршрутов:** Используется вспомогательная функция `buildRoute` для открытия внешнего приложения карт с предустановленными точками маршрута.
*   **Логирование аналитики:** Построение маршрутов логируется с помощью `AnUtils.logEvent`.
*   **Обработка ошибок:** Ошибки загрузки данных отображаются через `progress`.
*   **Отступы карты:** Карта настраивается с динамическими отступами (`getCurrentCameraPadding`) для учета нижней панели и других элементов UI.