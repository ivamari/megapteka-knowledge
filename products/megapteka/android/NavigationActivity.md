# NavigationActivity

## 1. Обзор Экрана

`NavigationActivity` является основной активностью приложения "Мегаптека", которая управляет общей навигацией между главными разделами приложения с помощью нижней навигационной панели (BottomNavigationView) и `NavController`. Она также отвечает за обработку глубоких ссылок, управление обновлениями приложения, запросы разрешений на уведомления, отображение предупреждений и подсказок, связанных с изменением города, а также за отображение счетчиков товаров в корзине и непрочитанных сообщений.

**Основные функции:**
*   Управление навигацией между основными разделами приложения (Главная, Каталог, Корзина, Заказы, Меню).
*   Обработка глубоких ссылок (deeplinks) для навигации к конкретным экранам.
*   Отображение и скрытие Toolbar и BottomNavigationView в зависимости от текущего экрана.
*   Отображение количества товаров в корзине и непрочитанных сообщений в виде бейджей на нижней навигационной панели.
*   Предложение пользователю изменить город, если обнаружен более подходящий.
*   Запрос разрешений на отправку уведомлений.
*   Обработка обновлений приложения (In-app updates).
*   Отображение предупреждений приложения.
*   Интеграция с кнопкой чата поддержки.

## 2. Элементы Пользовательского Интерфейса (UI Elements)

*   **Toolbar (через `IncludeAppBarBinding`):**
    *   **Назначение/Функция:** Отображает заголовок текущего экрана и кнопку "Назад". Его видимость может изменяться в зависимости от текущего фрагмента.
    *   **Взаимодействие пользователя:** Нажатие на кнопку "Назад" осуществляет навигацию назад по стеку. Заголовок может быть пустым для некоторых экранов.
*   **NavHostFragment (navHostContainer):**
    *   **Назначение/Функция:** Контейнер для размещения фрагментов, управляемых `NavController`. Это основной элемент, который отображает содержимое текущего экрана.
    *   **Взаимодействие пользователя:** Не имеет прямых интерактивных элементов, служит для отображения контента текущего фрагмента навигации.
*   **BottomNavigationView (bottomNav):**
    *   **Назначение/Функция:** Нижняя навигационная панель с иконками для перехода к основным разделам приложения (Главная, Каталог, Корзина, Заказы, Меню).
    *   **Возможные состояния:** Видима/скрыта в зависимости от текущего экрана и видимости клавиатуры. ��тображает бейджи с количеством товаров в корзине и неп��очитанных сообщений.
    *   **Взаимодействие пользователя:** Нажатие на иконку переключает на соответствующий раздел. При повторном нажатии на текущий раздел может инициировать прокрутку к началу списка.
*   **ChatButton (includedChatButton.chatButton):**
    *   **Назначение/Функция:** Кнопка для быстрого доступа к чату поддержки.
    *   **Взаимодействие пользователя:** Нажатие открывает экран чата.

## 3. Пользовательские Сценарии (User Flows)

*   **Запуск приложения и навигация:**
    1.  Пользователь запускает приложение.
    2.  Инициализируется `NavController` и `BottomNavigationView`.
    3.  Отображается начальный экран (например, "Главная").
    4.  Пользователь может переключаться между основными разделами с помощью нижней навигационной панели.
*   **Обработка глубоких ссылок:**
    1.  Приложение запу��кается или получает новый `Intent` с глубокой ссылкой.
    2.  `NavController` обрабатывает глубокую ссылку и переходит к соответствующему экрану.
*   **Предложение смены города:**
    1.  При запуске активности (если не через deep-ссылку и не отключено) `viewModel.checkCity()` проверяет, есть ли более подходящий город.
    2.  Если есть, отображается диалог с предложением сменить город. Пользователь может согласиться или отказаться.
    3.  Если пользователь соглашается, город меняется. Если отказывается, или если текущий город удален, может быть предложен ручной выбор города.
*   **Управление бейджами:**
    1.  При изменении количества товаров в корзине (`viewModel.cartCount`) или количества непрочитанных сообщений (`viewModel.unreadCount`), на соответствующих иконках `BottomNavigationView` появляются/обновляют��я бейджи.
*   **Запрос разрешений на уведомления:**
    1.  Если требуется разрешение на отправку уведомлений, оно запрашивается у пользователя.
*   **Обновление приложения:**
    1.  Приложение проверяет наличие обновлений через Google Play Core Library.
    2.  Если доступно гибкое обновление, оно загружается в фоновом режиме.
    3.  После загрузки отображается диалог с предложением установить обновление. Пользователь может установить его сразу или отложить.
*   **Отображение предупреждений приложения:**
    1.  При получении предупреждения (`AppWarning`), оно отображается, и может быть открыта соответствующая веб-страница.
*   **Скрытие/отображение навигации при клавиатуре:**
    1.  При появлении/скрытии клавиатуры, `BottomNavigationView` автоматически скрывается/отображается.
*   **Оценка приложения:**
    1.  При определенных условиях (например, после завершения заказа) может быть предложено оценить приложение через системный диалог.

## 4. Навигация

`NavigationActivity` является корневой активностью для большинства навигационных потоков. Возможны следующие переходы:

*   **Внутренняя навигация:** Между фрагментами, определенными в `bottom_nav_graph` (Главная, Каталог, Корзина, Заказы, Меню) и их подграфами.
*   **`CityChooseActivity`:** Для ручного выбора города.
*   **Внешний браузер:** Для открытия веб-страниц, связанных с предупреждениями приложения.
*   **Системные диалоги:** Для запроса разрешений, подтверждения смены города, установки обновления, оценки приложения.
*   **Экран чата:** При нажатии на кнопку чата.

### Deep Links

На этот экран нет прямых deep links.

## 5. Отображаемые Данные

*   **Типы данных:**
    *   `Int`: Количество товаров в корзине (`viewModel.cartCount`).
    *   `Int`: Количество непрочитанных сообщений (`viewModel.unreadCount`).
    *   `City`: Текущий город и ближайший город (`viewModel.changedNearestCity`).
    *   `AppUpdateResult`: Результат проверки обновления приложения.
    *   `ReviewInfo`: Информация для запроса оценки приложения.
    *   `AppWarning`: Предупреждение приложения.
*   **Источник данных:**
    *   **API:**
        *   `ApiService.appAlert` (REST метод: `GET /app/v1/alert`) - для получения предупреждений приложения и информации об оценке.
        *   `ApiService.telemetry` (REST метод: `PUT /ma/site/v1/auth/telemetry`) - для отправки телеметрии при смене города.
        *   `ApiService.getGuessedCity` (REST метод: `GET /app/v1/cities/locate`) - для определения ближайшего города.
        *   `ApiService.getUnreadCount` (REST метод: `GET /app/v1/manufacturer/dialogs/messages/unread-count`) - для получения количества непрочитанных сообщений.
        *   `ApiService.notificationOpened` (REST метод: `POST notifications/view`) - для отметки уведомления как открытого.
        *   `ApiService.appRatingShow` (REST метод: `PUT /app/v1/alert/app-rating`) - для отметки показа запроса на оценку приложения.
        *   `ApiService.appWarningShow` (REST метод: `PUT /app/v1/alert/warning`) - для отметки показа предупреждения приложения.
    *   **Локальное хранилище:**
        *   Таблица `CitiesDao` (для получения текущего города и сохранения нового).
        *   Таблица `ItemsDao` (для получения количества товаров в корзине).
        *   `SharedPreferences` (через `AppRepository` для `needShowUpdate`, `setNextDayUpdate`, `resetNextDayUpdate`, `getAppStartCount`).
    *   **Внешние SDK:**
        *   `Google Play Core Library` (`AppUpdateManagerFactory`, `ReviewManagerFactory`) - для работы с обновлениями приложения и запросами на оценку.

## 6. Особые Состояния/Лог��ка

*   **Dagger Android Injection:** Используется для инъекции зависимостей в активность и ф��агменты.
*   **FragmentFactory:** Устанавливается для корректного создания фрагментов, инжектированных Dagger.
*   **Обработка Insets:** Активность корректно обрабатывает системные отступы (status bar, navigation bar, IME) для правильного отображения UI.
*   **NavController и Navigation Graph:** Используется Android Navigation Component для управления навигацией, что обеспечивает структурированную и предсказуемую навигацию.
*   **OuterNavigator:** Пользовательский навигатор, который позволяет обрабатывать навигацию, выходящую за пределы текущего графа (например, переход к другой активности).
*   **Скрытие/отображение Toolbar и BottomNavigationView:** Видимость этих элементов управляется в `addOnDestinationChangedListener` в зависимости от аргументов навигации (`no_toolbar`, `no_bottom_nav`).
*   **Сохранение состояния:** Состояние `NavController` и флаг `updateInProgress` ��охраняются при изменении конфигурации.
*   **Обработка уведомлений:** При открытии приложения по уведомлению, уведомление отменяется, и его открытие логируется.
*   **Логирование аналитики:** Изменения города и другие важные события логируются с помощью `AnUtils.logEvent`.
*   **Гибкие обновления:** Поддерживаются гибкие обновления приложения, которые загружаются в фоновом режиме и могут быть установлены позже.