# ConfirmCodeActivity

## 1. Обзор Экрана

Экран "Подтверждение кода" (ConfirmCodeActivity) предназначен для верификации пользователя путем ввода кода, полученного по SMS или другим способом. Этот экран используется в сценариях регистрации, входа в систему или восстановления пароля. Он включает таймер для повторной отправки кода и обработку подтверждения.

**Основные функции:**
*   Ввод и подтверждение кода верификации.
*   Таймер обратного отсчета для повторной отправки кода.
*   Возможность повторной отправки кода после истечения таймера.
*   Валидация введенного кода.
*   Обработка успешного подтверждения и ошибок.
*   Интеграция с кнопкой чата поддержки.

## 2. Элементы Пользовательского Интерфейса (UI Elements)

*   **Toolbar (через `IncludeAppBarBinding`):**
    *   **Назначение/Функция:** Отображает заголовок экрана (например, "Подтверждение кода") и кнопку "Назад" для навигации.
    *   **Взаимодействие пользователя:** Нажатие на кнопку "Назад" закрывает экран.
*   **TextInputLayout (codeInput):**
    *   **Назначение/Функция:** Поле для ввода 5-значного кода верификации.
    *   **Взаимодействие пользователя:** Ввод текста. Имеет `InputFilter` для ограничения длины до 5 символов. При вводе 5 символов или нажатии "Готово" на клавиатуре инициирует подтверждение кода.
*   **TextView (resendCode):**
    *   **Назначение/Функция:** Отображает таймер обратного отсчета до возможности повторной отправки кода. После истечения таймера становится кликабельной ссылкой для повторной отправки.
    *   **Возможные состояния:** Отображает время до повторной отправки; становится кликабельной ссылкой "Отправить код повторно" после истечения времени.
    *   **Взаимодействие пользователя:** Нажатие на ссылку "Отправить код повторно" инициирует запрос на повторную отправку кода.
*   **Button (confirm):**
    *   **Назначение/Функция:** Кнопка для подтверждения введенного кода.
    *   **Взаимодействие пользователя:** Нажатие инициирует процесс подтверждения кода.
*   **ChatButton (includedChatButton.chatButton):**
    *   **Назначение/Функция:** Кнопка для быстрого доступа к чату поддержки.
    *   **Взаимодействие пользователя:** Нажатие открывает экран чата.

## 3. Пользовательские Сценарии (User Flows)

*   **Ввод и подтверждение кода:**
    1.  Пользователь открывает экран "Подтверждение кода" (с переданным `session` ID).
    2.  Запускается таймер обратного отсчета для повторной отправки кода.
    3.  Пользователь вводит 5-значный код в поле.
    4.  При вводе 5 символов, нажатии "Готово" на клавиатуре или нажатии кнопки "Подтвердить", инициируется валидация и отправка кода.
    5.  Если код подтвержден успешно (`Resource.Status.SUCCESS`), и если это сценарий восстановления пароля (т.е. получен `ConfirmToken`), происходит переход на `ChangePasswordActivity` с токеном восстановления.
    6.  При ошибке подтверждения отображается диалог с сообщением об ошибке.
*   **Повторная отправка кода:**
    1.  Пользователь ждет истечения таймера.
    2.  Текст `resendCode` меняется на кликабельную ссылку "Отправить код повторно".
    3.  Пользователь нажимает на ссылку.
    4.  Отправляется запрос на повторную отправку кода.
    5.  При успехе отображается сообщение "Пароль отправлен", и таймер запускается заново.
    6.  При ошибке отображается диалог с сообщением об ошибке.

## 4. Навигация

С экрана "Подтверждение кода" возможны следующие переходы:

*   **`ChangePasswordActivity`:** Если подтверждение кода связано с восстановлением пароля.
*   **Назад к предыдущему экрану:** При нажатии кнопки "Назад" в тулбаре.
*   **Диалоговые окна:** Для отображения сообщений об ошибках или подтверждения отправки кода.
*   **Экран чата:** При нажатии на кнопку чата.

### Deep Links

На этот экран нет прямых deep links.

## 5. Отображаемые Данные

*   **Типы данных:**
    *   Строка для кода верификации.
    *   `Resource<ConfirmToken>`: Для отслеживания статуса подтверждения кода.
    *   `Resource<Unit>`: Для отслеживания статуса повторной отправки кода.
*   **Источник данных:**
    *   **API:**
        *   `ApiService.forgotConfirm` (REST метод: `PUT auth/forgot/confirm`) - для подтверждения кода.
        *   `ApiService.forgotResendCode` (REST метод: `PUT auth/forgot/resend`) - для повторной отправки кода.
    *   **Локальное хранилище:** Нет прямого использования локального хранилища для этих операций.

## 6. Особые Состояния/Логика

*   **Обработка Insets:** Экран корректно обрабатывает системные отступы (status bar, navigation bar, IME) для правильного отображения UI.
*   **Таймер обратного отсчета:** `CountDownTimer` управляет отображением времени до повторной отправки кода и делает ссылку активной по истечении времени.
*   **Сохранение состояния таймера:** Значение таймера сохраняется при изменении конфигурации (например, поворот экрана) и восстанавливается.
*   **Валидация кода:** Используется `validateCode` для проверки корректности введенного кода и `ErrorResetWatcher` для сброса ошибок.
*   **Скрытие клавиатуры:** Клавиатура автоматически скрывается после попытки подтверждения кода.