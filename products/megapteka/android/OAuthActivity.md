# OAuthActivity

## 1. Обзор Экрана

Экран "Авторизация" (OAuthActivity) предназначен для выполнения OAuth-авторизации через внешний веб-интерфейс (например, социальные сети, сторонние сервисы). Он загружает веб-страницу авторизации, обрабатывает перенаправления и подтверждает авторизацию, а также интегрируется с SMS Retriever API для автоматического получения OTP-кодов.

**Основные функции:**
*   Загрузка веб-страницы для OAuth-авторизации.
*   Обработка перенаправлений после успешной авторизации.
*   Подтверждение OAuth-авторизации с передачей необходимых параметров.
*   Автоматическое получение SMS-кодов (OTP) для верификации.
*   Запрос разрешений на отправку ув��домлений после успешной авторизации.
*   Обработка ош��бок загрузки веб-страницы и ошибок авторизации.

## 2. Элементы Пользовательского Интерфейса (UI Elements)

*   **Toolbar (через `IncludeAppBarBinding`):**
    *   **Назначение/Функция:** Отображает заголовок экрана (пустой по умолчанию) и кнопку "Назад" для навигации.
    *   **Взаимодействие пользователя:** Нажатие на кнопку "Назад" закрывает активность.
*   **WebView (в `webContainer`):**
    *   **Назначение/Функция:** Основной компонент для отображения веб-страницы авторизации. Позволяет взаимодействовать с внешним сервисом.
    *   **Взаимодействие пользователя:** Взаимодействие с элементами веб-страницы (ввод данных, нажатие кнопок).
*   **ProgressBar (progress):**
    *   **Назначение/Функция:** Индикатор загрузки, отображаемый во время загрузки веб-��траницы или выполнения операций авторизации.
    *   **Возможные состояния:** Видимый во время загрузки, скрытый в других состояниях.

## 3. Пользовательские Сценарии (User Flows)

*   **Инициализация и загрузка OAuth-страницы:**
    1.  Активность запускается с `authCode`.
    2.  ViewModel инициирует процесс OAuth (`viewModel.initOauth()`).
    3.  Отображается индикатор загрузки (`progress`).
    4.  При успешной инициализации, `WebView` загружает URL для авторизации (`oauthInit.linkUrl`).
*   **Взаимодействие с веб-страницей:**
    1.  Пользователь взаимодействует с элементами на веб-странице (например, вводит логин/пароль, подтверждает доступ).
    2.  При перенаправлении на один из `redirectUrls`, `OAuthClient` перехватывает URL.
    3.  Вызывается `viewModel.confirmOAuth()` с `authCode`, `encryptedState` и `redirectUrl`.
*   **Подтверждение OAuth-авторизации:**
    1.  По��ле успешного подтверждения (`Resource.Status.SUCCESS`), если требуе��ся разрешение на уведомления, оно запрашивается.
    2.  Затем активность завершается с `RESULT_OK`.
    3.  При ошибке авторизации отображается диалог с сообщением об ошибке, и активность завершается с `RESULT_CANCELED`.
*   **Автоматическое получение SMS-кода (OTP):**
    1.  При создании активности запускается `SmsRetriever` для прослушивания SMS-сообщений.
    2.  При получении SMS с OTP-кодом, `smsVerificationReceiver` перехватывает его.
    3.  Если SMS содержит OTP, он может быть автоматически скопирован в буфер обмена.
*   **Обработка ошибок SSL:**
    1.  При возникновении ошибок SSL во время загрузки веб-страницы, ошибка логируется в Crashlytics, обработчик отменяется, и активность завершается с `RESULT_CANCELED`.

## 4. Навигация

С экрана "Авторизация" воз��ожны следующие действия:

*   **Закрытие активности:** После успешной авторизации, при ошибках, или при нажатии кнопки "Назад" в тулбаре.
*   **Внешние приложения:** Если `WebView` пытается открыть URL с нестандартной схемой (например, `vk://`), открывается соответствующее приложение через `Intent.createChooser`.
*   **Системные диалоги:** Для запроса разрешений на уведомления.

### Deep Links

На этот экран нет прямых deep links.

## 5. Отображаемые Данные

*   **Типы данных:**
    *   `OAuthInit`: Объект, содержащий URL для авторизации и список `redirectUrls`.
    *   `Client`: Объект, представляющий данные клиента после успешной авторизации.
    *   `Resource<OAuthInit>` и `Resource<Client>`: Для отслеживания статуса операций.
*   **Источник данных:**
    *   **API:**
        *   `ApiService.initOAuth` (REST метод: `POST /app/v1/auth/oauth/init`) - для инициализации OAuth.
        *   `ApiService.confirmOAuth` (REST метод: `POST /app/v1/auth/oauth/confirm`) - для подтверждения OAuth.
        *   `ApiService.getClient` (REST метод: `GET /app/v1/clients`) - для получения данных клиента после успешной авторизации.
    *   **Локальное хранилище:** Таблица `ClientDao` (для сохранения данных клиента после успешной авторизации).
    *   **Внешние SDK:** `SMS Retriever API` (для автоматического получения SMS-кодов).

## 6. Особые Состояния/Логика

*   **Обработка Insets:** Активность корректно обрабатывает системные отступы (status bar, navigation bar, IME) для правильного отображения UI.
*   **Настройка WebView:** `WebView` настраивается для поддержки JavaScript и, при необходимости, устанавливается пользовательский `UserAgent` для совместимости с определенными сервисами (например, VK).
*   **`WebViewClient` и `WebChromeClient`:** Используются для управления поведением `WebView` (обработка загрузки страниц, ��шибок, перенаправлений).
*   **Обработка перенаправлений:** `shouldOverrideUrlLoading` перехватывает URL-адреса и проверяет, соответствуют ли они `redirectUrls` для подтверждения OAuth.
*   **Логирование ошибок:** Ошибки SSL и другие исключения логируются в Firebase Crashlytics.
*   **Запрос разрешений на уведомления:** После успешной авторизации, если требуется, запрашивается разрешение на отправку уведомлений.
*   **Аналитика:** Статус авторизации (успех/неудача) логируется с помощью `AnUtils.logEvent`.