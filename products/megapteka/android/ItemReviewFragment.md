# ItemReviewFragment

## 1. Обзор Экрана

Экран "Оценить товар" (ItemReviewFragment) позволяет пользователю оставить отзыв о приобретенном товаре, выставить оценку, написать комментарий, прикрепить фотографию и указать свое имя. Экран также поддерживает редактирование уже существующего отзыва.

**Основные функции:**
*   Выставление оценки товару (звездочки).
*   Ввод имени пользователя.
*   Написание текстового комментария к отзыву.
*   Прикрепление фотографии к отзыву (с возможностью выбора из галереи или съемки на камеру).
*   Удаление прикрепленной фотографии.
*   Отправка нового отзыва или редактирование существующего.
*   Отображение информации о товаре (название, производитель, изображение).
*   Согла��ие с условиями пользовательского соглашения.
*   Обработка состояний загрузки, успеха и ошибки при отправке/редактировании отзыва.

## 2. Элементы Пользовательского Интерфейса (UI Elements)

*   **TextView (title):**
    *   **Назначение/Функция:** Отображает заголовок экрана ("Оценить товар" или "Редактировать отзыв").
    *   **Взаимодействие пользователя:** Неинтерактивный элемент.
*   **ImageView (itemImage):**
    *   **Назначение/Функция:** Отображает изображение товара, который оценивается.
    *   **Взаимодействие пользователя:** Неинтерактивный элемент.
*   **TextView (tvName):**
    *   **Назначение/Функция:** Отображает название товара.
    *   **Взаимодействие пользователя:** Неинтерактивный элемент.
*   **TextView (tvManufacturer):**
    *   **Назначение/Функция:** Отображает название производителя товара.
    *   **Взаимодействие пользователя:** Неинтерактивный элемент.
*   **RatingBar (rating):**
    *   **Назначение/Функция:** Позволяет пользователю выставить оценку товару в виде звездочек.
    *   **Взаимодействие пользователя:** Выбор количества звездочек. При нулевой оценке может быть анимирован (shake) для привлечения внимания.
*   **TextInputLayout (nameInput):**
    *   **Назначение/Функция:** Поле для ввода имени пользователя. Скрыто при редактировании отзыва.
    *   **Взаимодействие пользователя:** Ввод текста. Валидируется на пустоту.
*   **EditText (comment):**
    *   **Назначение/Функция:** Поле для ввода текстового комментария к отзыву.
    *   **Взаимодействие пользователя:** Ввод текста. Валидируется на пустоту.
*   **TextView (pickMedia):**
    *   **Назначение/Функция:** Кнопка для выбора или съемки фотографии для отзыва. Скрыта при редактировании отзыва или если фотография уже выбрана.
    *   **Взаимодействие пользователя:** Нажатие открывает диалог выбора источника изображения (камера/галерея).
*   **LinearLayout (imageContainer):**
    *   **Назначение/Функция:** Контейнер для отображения выбранной фотографии. Видим, если фотография выбрана.
    *   **Взаимодействие пользователя:** Неинтерактивный элемент.
*   **ImageView (image):**
    *   **Назначение/Функция:** Отображает выбранную фотографию.
    *   **Взаимодействие пользователя:** Неинтерактивный элемент.
*   **ImageView (removeMedia):**
    *   **Назначение/Функция:** Кнопка для удаления выбранной фотографии.
    *   **Взаимодействие пользователя:** Нажатие удаляет фотографию и скрывает `imageContainer`.
*   **CheckBox (agreement):**
    *   **Назначение/Функция:** Флажок согласия с условиями пользовательского соглашения.
    *   **Взаимодействие пользователя:** Установка/снятие флажка. Кнопка "Отправить" становится активной только при установленном флажке.
*   **TextView (warning):**
    *   **Назначение/Функция:** Отображает предупреждение, если пользователь не согласился с условиями.
    *   **Возможные состояния:** Видима, если флажок `agreement` не установлен; скрыта в противном случае.
    *   **Взаимодействие пользователя:** Неинтерактивный элемент.
*   **Button (rate):**
    *   **Назначение/Функция:** Кнопка для отправки отзыва.
    *   **Возможные состояния:** Активна, если все поля валидны и флажок согласия установлен. Отображает индикатор загрузки во время отправки.
    *   **Взаимодействие пользователя:** Нажатие инициирует процесс отправки/редактирования от��ыва.

## 3. Пользовательские Сценарии (User Flows)

*   **Оставление нового отзыва:**
    1.  Пользователь открывает экран "Оценить товар", передавая информацию о товаре и, возможно, начальную оценку.
    2.  Пользователь выставляет оценку с помощью звездочек.
    3.  Вводит свое имя (если это не редактирование).
    4.  Пишет комментарий.
    5.  (Опционально) Нажимает "Прикрепить фото", выбирает или делает снимок, и фото отображается.
    6.  Устанавливает флажок согласия с условиями.
    7.  Нажимает кнопку "Отправить".
    8.  Если все поля валидны, отправляется запрос на отправку отзыва.
    9.  При успехе отображается диалог "Спасибо за отзыв", и экран закрывается.
    10. При ошибке отображается диалог с сообщением об ошибке.
*   **Редактирование существующего отзыва:**
    1.  ��ользователь открывает экран "Оценить товар" с предзаполненными данными существующего отзыва (включая `feedbackId` и `text`).
    2.  Поле для имени скрыто.
    3.  Пользователь изменяет оценку или текст комментария.
    4.  Нажимает кнопку "Отправить".
    5.  Отправляется запрос на редактирование отзыва.
    6.  При успехе отображается диалог "Спасибо за отзыв", и экран закрывается.
*   **Прикрепление/удаление фото:**
    1.  Пользователь нажимает "Прикрепить фото".
    2.  Запрашивается разрешение на камеру, если его нет.
    3.  Открывается системный выбор источника фото (камера/галерея).
    4.  После выбора фото, оно отображается, и кнопка "Прикрепить фото" скрывается, появляется кнопка "Удалить фото".
    5.  Нажатие на "Удалить фото" очищает выбранное фото.
*   **Валидация ��олей:**
    1.  При попытке отправить отзыв, проверяется, что оценка не равна 0, а поля имени и комментария не пустые.
    2.  Если какое-либо поле невалидно, отображается ошибка, и фокус переходит к этому полю.
    3.  Если флажок согласия не установлен, кнопка "Отправить" неактивна, и отображается предупреждение.

## 4. Навигация

С экрана "Оценить товар" возможны следующие переходы:

*   **Назад к предыдущему экрану:** После успешной отправки/редактиров��ния отзыва или при нажатии кнопки "Назад" в тулбаре.
*   **`ItemDetailsFragment`:** При нажатии на карточку товара в верхней части экрана.
*   **Внешний браузер:** Для просмотра пользовательского соглашения.
*   **Системный выбор изображения:** Для выбора фото из галереи или съемки на камеру.
*   **Диалоговые окна:** Для отобр��жения сообщений об успехе или ошибках.

### Deep Links

На этот экран нет прямых deep links.

## 5. Отображаемые Данные

*   **Типы данных:**
    *   `ItemForReview`: Объект, представляющий товар, который нужно оценить (ID, название, производитель, URL изображения).
    *   Строки для имени, комментария.
    *   `Uri`: Для выбранной фотографии.
    *   `Resource<Unit>`: Для отслеживания статуса отправки/редактирования отзыва.
    *   `Resource<Client?>`: Для получения имени пользователя.
*   **Источник данных:**
    *   **API:**
        *   `ApiService.getClient` (REST метод: `GET /app/v1/clients`) - для получения данных клиента.
        *   `ApiService.sendReview` (REST метод: `POST /app/v2/items/feedback`) - для отправки нового отзыва.
        *   `ApiService.editReview` (REST метод: `POST /app/v2/items/feedback/edit`) - для редактирования отзыва.
    *   **Локальное хранилище:** Таблица `ClientDao` (для получения данных клиента).

## 6. Особые Состоян��я/Логика

*   **Режим редактирования:** Флаг `isEdit` определяет, находится ли экран в режиме создания нового отзыва или редактирования существующего, что влияет на видимость поля имени и логику отправки.
*   **Сохранение URI камеры:** `cameraUri` сохраняется при изменении конфигурации для корректной работы с камерой.
*   **Валидация:** Используются `validateFields` и `shake` для визуальной индикации ошибок валидации.
*   **Управление видимостью кнопки "Отправить":** Кнопка "Отправить" становится видимой/невидимой в зависимости от состояния флажка согласия и статуса загрузки.
*   **Обработка разрешений:** Запрашивается разрешение на камеру перед ее использованием.
*   **Скрытие клавиатуры:** Клавиатура автоматически скрывается после отправки отзыва.