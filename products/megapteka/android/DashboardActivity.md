# DashboardActivity

## 1. Обзор Экрана

Экран "Авторизация по почте" (DashboardActivity) предоставляет пользователю возможность войти в существующий аккаунт или зарегистрировать новый, используя адрес электронной почты и пароль. Экран также включает функциональность для восстановления пароля и ссылки на пользовательское соглашение.

**Основные функции:**
*   Вход в систему для зарегистрированных пользователей.
*   Регистрация новых пользователей.
*   Переключение между режимами "Вход" и "Регистрация".
*   Валидация введенных данных (email, пароль).
*   Переход к экрану восстановления пароля.
*   Отображение пользовательского соглашения.
*   Обработка различных состояний авторизации (загрузка, успех, ошибка).
*   Интеграция с кнопкой чата поддержки.

## 2. Элементы Пользовательского Интерфейса (UI Elements)

*   **Toolbar (через `IncludeAppBarBinding`):**
    *   **Назначение/Функция:** Отображает заголовок экрана "Авторизация" и кнопку "Назад" для навигации.
    *   **Взаимодействие пользователя:** Нажатие на кнопку "Назад" закрывает экран.
*   **TabLayout (tabLayout):**
    *   **Назначение/Функция:** Предоставляет две вкладки: "Вход" и "Регистрация", для переключения между режимами авторизации.
    *   **Возможные состояния:** Выбрана одна из вкладок.
    *   **Взаимодействие пользователя:** Нажатие на вкладку переключает UI для входа или регистрации.
*   **TextView (topLabel):**
    *   **Назначение/Функция:** Отображает пояснительный текст над полями ввода, зависящий от выбранной вкладки (например, "Введите почт�� и пароль для входа").
    *   **Взаимодействие пользователя:** Неинтерактивный элемент.
*   **TextInputLayout (emailInput):**
    *   **Назначение/Функция:** Поле для ввода адреса электронной почты.
    *   **Взаимодействие пользователя:** Ввод текста. Имеет `ErrorResetWatcher` для сброса ошибок. Валидируется на корректность формата email.
*   **TextInputLayout (passwordInput):**
    *   **Назначение/Функция:** Поле для ввода пароля.
    *   **Взаимодействие пользователя:** Ввод текста. Имеет `ErrorResetWatcher` для сброса ошибок. Имеет иконку для скрытия/отображения пароля.
*   **TextView (forgot):**
    *   **Назначение/Функция:** Ссылка "Забыли пароль?". Видима только на вкладке "Вход".
    *   **Взаимодействие пользователя:** Нажатие открывает экран восстановления пароля (`ForgotPasswordActivity`).
*   **TextView (agreement):**
    *   **Назначение/Функция:** Тек��т с ссылкой на пользовательское соглашение.
    *   **Взаимодействие пользователя:** Нажатие на ссылку открывает `WebActivity` с пользовательским соглашением.
*   **Button (confirm):**
    *   **Назначение/Функция:** Кнопка для подтверждения входа или регистрации. Текст кнопки меняется в зависимости от выбранной вкладки.
    *   **Возможные состояния:** Активна, если поля заполнены и валидны; неактивна в противном случае. Отображает индикатор загрузки во время выполнения операции.
    *   **Взаимодействие пользователя:** Нажатие инициирует процесс входа или регистрации.
*   **ProgressBar (progress):**
    *   **Назначение/Функция:** Индикатор загрузки, отображаемый во время выполнения операций входа/регистрации.
    *   **Возможные состояния:** Видимый во время загрузки, скрытый в других состо��ниях.
*   **ChatButton (includedChatButton.chatButton):**
    *   **Назначение/Функция:** Кнопка для быстрого доступа к чату поддержки.
    *   **Взаимодействие пользователя:** Нажатие открывает экран чата.

## 3. Пользовательские Сценарии (User Flows)

*   **Вход в аккаунт:**
    1.  Пользователь выбирает вкладку "Вход".
    2.  Вводит email и пароль.
    3.  Нажимает кнопку "Войти" или "Готово" на клавиатуре.
    4.  Если данные валидны, отправляется запрос на вход.
    5.  При успехе, если требуется разрешение на уведомления, запрашивается разрешение, затем происходит переход на главный экран (`NavigationActivity`).
    6.  При ошибке (например, неверные учетные данные), отображается диалог с сообщением об ошибке. Если ошибка указывает на отсутствие пользователя, предлагается перейти на вкладку "Регистрация".
*   **Регистрация нового аккаунта:**
    1.  Пользователь выбирает вкладку "Регистрация".
    2.  Вводит email и пароль.
    3.  Нажимает кнопку "Зарегистрироваться" или "Готово" на клавиатуре.
    4.  Если данные валидны, отправляется запрос на регистрацию.
    5.  При успехе, если требуется разрешение на уведомления, запрашивается разрешение, затем происходит переход на главный экран (`NavigationActivity`).
    6.  При ошибке отображается диалог с сообщением об ошибке.
*   **Восстановление пароля:**
    1.  На вкладке "Вход" пользователь нажимает на ссылку "Забыли пароль?".
    2.  Происходит переход на экран `ForgotPasswordActivity`.
*   **Просмотр пользовательского соглашения:**
    1.  Пользователь нажимает на ссылку "пользовательского соглашения".
    2.  Открывается `WebActivity` с текстом соглашения.

## 4. Навигация

С экрана "Авторизация по почте" возможны следующие переходы:

*   **`ForgotPasswordActivity`:** Для восстановления пароля.
*   **`WebActivity`:** Для просмотра пользовательского соглашения.
*   **`NavigationActivity`:** Главный экран приложения, после успешного входа или регистрации.
*   **Диалоговые окна:** Для отображения сообщений об ошибках или предложений.
*   **Экран чата:** При нажатии на кнопку чата.

### Deep Links

На этот экран нет прямых deep links.

## 5. Отображаемые Данные

*   **Типы данных:**
    *   Строки для email и пароля.
    *   `Resource<Client>`: Для отслеживания статуса операций входа/регистрации.
*   **Источник данных:**
    *   **API:**
        *   `ApiService.signIn` (REST метод: `PUT auth/login`) - для входа в систему.
        *   `ApiService.signUp` (REST метод: `PUT auth/register`) - для регистрации.
        *   `ApiService.getClient` (REST метод: `GET /app/v1/clients` или `GET /app/v1/clients`) - для получения данных клиента после входа/регистрации.
    *   **Локальное хранилище:** Таблица `ClientDao` (для сохранения данных клиента после успешного входа/регистрации).

## 6. Особые Состояния/Логика

*   **Обработка Insets:** Экран корректно обрабатывает системные отступы (status bar, navigation bar, IME) для правильного отображения UI.
*   **Сохранение состояния вкладки:** Выбранная вкладка сохраняется при изменении конфигурации (например, поворот экрана) и восстанавливается.
*   **Валидация полей:** Используются `validateFields` и `validateEmail` для проверки заполненности и корректности email, а также `ErrorResetWatcher` для сброса ошибок.
*   **Условная видимость элементов:** Ссылка "Забыли пароль?" и текст кнопки "Подтвердить" меняются в зависимости от выбранной вкладки.
*   **Обработка ошибок API:** Ошибки, возвращаемые API, обрабатываются, и в случае `NO_SUCH_USER` предлагается перейти на вкладку регистрации.
*   **Запрос разрешений на уведомления:** После успешной авторизации, если требуется, запрашивается разрешение на отправку уведомлений.
*   **Аналитика:** Статус авторизации (успех/неудача) и переключение вкладок логируются с помощью `AnUtils.logEvent`.