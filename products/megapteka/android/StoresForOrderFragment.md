# StoresForOrderFragment

## 1. Обзор Экрана

Экран "Выбор аптеки" (StoresForOrderFragment) предназначен для выбора аптеки, из которой будет оформлен заказ на товары из наличия. Он предоставляет пользователю два режима просмотра: список аптек и карту аптек. Пользователь может применять различные фильтры (по городу, расстоянию, цене, маршруту) и искать аптеки.

**Основные функции:**
*   Отображение списка аптек, доступных для заказа из наличия.
*   Отображение аптек на интерактивной карте.
*   Переключение между режимами списка и карты.
*   Применение фильтров к списку аптек (по городу, адресу, цене, маршруту).
*   Поиск аптек.
*   Выбор аптеки для оформления з��каза.
*   Обработка разрешений на доступ к местоположению.

## 2. Элементы Пользовательского Интерфейса (UI Elements)

*   **TabLayout (tabs):**
    *   **Назначение/Функция:** Предоставляет две вкладки: "Список" и "Карта", для переключения между различными представлениями аптек.
    *   **Возможные состояния:** Выбрана одна из вкладок.
    *   **Взаимодействие пользователя:** Нажатие на вкладку переключает отображаемый фрагмент (`StoresForOrderListFragment` или `StoresForOrderMapFragment`).
*   **RecyclerView (filtersRecyclerView):**
    *   **Назначение/Функция:** Отображает доступные фильтры для списка аптек (`FiltersSection`).
    *   **Взаимодействие пользователя:** Нажатие на фильтр (например, "Город", "Адрес", "Цена", "Маршрут") открывает соответствующий диалог или экран для выбора параметров фильтрации.
*   **FrameLayout (consumerContainer):**
    *   **Назначение/Функция:** Контейнер для динамической загрузки фрагментов списка и карты аптек в зависимости от выбранной вкладки.
    *   **Взаимодействие пользователя:** Не имеет прямых интерактивных элементов, служит для отображения контента выбранной вкладки.

## 3. Пользовательские Сценарии (User Flows)

*   **Просмотр аптек:**
    1.  Пользователь открывает экран "Выбор аптеки".
    2.  По умолчанию выбрана одна из вкладок (например, "Список").
    3.  Отображается список аптек или карта аптек.
*   **Переключение между режимами:**
    1.  Пользователь нажимает на вкладку "Список" или "Карта".
    2.  Соответствующий фрагмент (`StoresForOrderListFragment` или `StoresForOrderMapFragment`) отображается в `consumerContainer`.
*   **Применение фильтров:**
    1.  Пользователь нажимает на фильтр в `filtersRecyclerView`.
    2.  В зависимости от типа фильтра, открывается диалог выбора адреса (`AddressesDialog`), выбора на карте (`SelectOnMapFragment`), выбора цены (`PriceFilterDialog`), или построения маршрута (`RouteFragment`).
    3.  После выбора параметров фильтрации, они применяются к списку аптек через `viewModel.applyAddressFilter()`, `viewModel.applyPricesFilter()` или `viewModel.applyRouteFilter()`.
    4.  Список аптек обновляется в соответствии с фильтрами.
    5.  Регистрируется аналитическое событие `AnEvent.applyStoreFilters()`.
*   **Поиск аптек:**
    1.  Пользователь нажимает на иконку поиска в тулбаре.
    2.  Происходит навигация к экрану подсказок поиска аптек (`StoresSearchSuggestionsFragment`).
    3.  После выбора подсказки, она применяется как фильтр адреса.
*   **Выбор аптеки для заказа:**
    1.  Пользователь выбирает аптеку из списка или на карте.
    2.  Если аптека закры��а, отображается диалог с предупреждением, предлагающий подтвердить выбор.
    3.  Выбранная аптека передается в ViewModel через `viewModel.chooseStore()`.
    4.  Происходит навигация к экрану подтверждения заказа (`OrderConfirmFragment`).
*   **Обработка разрешений на местоположение:**
    1.  При создании фрагмента запрашивается разрешение `Manifest.permission.ACCESS_FINE_LOCATION`.
    2.  Результат запроса передается в ViewModel.

## 4. Навигация

С экрана "Выбор аптеки" возможны следующие переходы:

*   **Внутренние переключения фрагментов:** Между `StoresForOrderListFragment` и `StoresForOrderMapFragment`.
*   **`AddressesDialog`:** Для выбора адреса.
*   **`AddEditAddressFragment`:** Для добавления/редактирования адреса (из `AddressesDialog`).
*   **`SelectOnMapFragment`:** Для выбора адреса на карте (из `AddressesDialog` или `RouteFragment`).
*   **`PriceFilterDialog`:** Для применения ценового фильтра.
*   **`StoresSearchSuggestionsFragment`:** Для поиска аптек.
*   **`RouteFragment`:** Для построения маршрута.
*   **`OrderConfirmFragment`:** Для подтверждения заказа после выбора аптеки.
*   **Навигация по DeepLink:** Если кнопка в предупреждении имеет deep-ссылку.

### Deep Links

На этот экран нет прямых deep links.

## 5. Отображаемые Данные

*   **Типы данных:**
    *   `List<CheckFilterable>`: Список доступных фильтров для аптек.
    *   `Address`: Выбранный адрес для фильтрации.
    *   `Prices`: Выбранный ценовой диапазон для фильтрации.
    *   `StoreSearchSuggest`: Подсказка для поиска аптек.
    *   `Check`: Выбранная аптека для заказа.
*   **Источник данных:**
    *   **API:**
        *   `ApiService.checkOrder` (REST метод: `GET /app/v4/orders/check`) - для получения списка аптек и проверки заказа.
        *   `ApiService.getRegionsWithCities` (REST метод: `GET /app/v1/cities`) или `ApiService.getGuessedCity` (REST метод: `GET /app/v1/cities/locate`) - для получения информации о текущем городе.
        *   `ApiService.getAddresses` (REST метод: `GET clients/addresses`) - для получения списка адресов пользователя.
        *   `ApiService.getRoutes` (REST метод: `POST /app/v1/routing/car`) - для построения маршрутов.
        *   `ApiService.getStoresSearchSuggestions` (REST метод: `GET /app/v1/stores/search-suggestions`) - для получения подсказок по поиску аптек.
    *   **Локальное хранилище:**
        *   Таблица `CitiesDao` (для получения текущего города).
        *   Таблица `AddressDao` (для кэширования адресов).
    *   **Входящие аргументы (`navArgs`):** UUID заказа (`args.orderUuid`), ID предыдущего заказа (`args.prevOrderId`), источник перехода (`args.source`).
    *   **`FragmentResultListener`:** Для получения результатов из диалогов выбора адреса, цены и маршрута.

## 6. Особые Состояния/Логика

### 6.1. Логика Фильтрации
Экран использует абстрактный класс `Filterable` для представления различных типов фильтров. Для фильтрации аптек применяются различные реализации `CheckFilterable`, такие как `CityFilterable` (по городу), `AvailabilityFilterable` (по наличию), `DistanceFilterable` (по расстоянию), `OpennessFilterable` (по открытости), `AroundTheClockFilterable` (круглосуточные), `PriceFilterable` (по цене) и `AccessibilityFilterable` (по доступности). Управление фильтрами происходит через `FiltersSection`, ко��орый позволяет пользователю выбирать и применять значения фильтров, обновляя список аптек.

*   **Сохранение состояния вкладки:** Выбранная вкладка сохраняется при изменении конфигурации (например, поворот экрана) и восстанавливается.
*   **Динамическая загрузка фрагментов:** Фрагменты списка и карты динамически добавляются/скрываются в `consumerContainer`.
*   **Производительность на слабых устройствах:** Для устройств с низкой производительностью аниматор элементов `RecyclerView` отключается.
*   **Обработка исключений маршрута:** Если при построении маршрута возникает ошибка, отображается диалог с сообщением.
*   **Логирование аналитики:** Примене��ие фильтров и выбор аптеки логируются с помощью `AnUtils.logEvent`.
*   **Передача данных для подтверждения заказа:** В `OrderConfirmFragment` передаются выбранная аптека, тип заказа (`OrderType.STORE`), флаг необходимости верификации Protek, UUID заказа и ID предыдущего заказа.
*   **Обработка предупреждений:** Если аптека закрыта, перед подтверждением выбора отображается диалог с предупреждением.
