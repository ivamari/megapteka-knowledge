# OrderConfirmFragment

## 1. Обзор Экрана

Экран "Подтверждение заказа" (OrderConfirmFragment) предназначен для финального подтверждения заказа, собранного из одной аптеки. На этом экране пользователь просматривает детали заказа, вводит свои контактные данные, соглашается с условиями и подтверждает оформление. Экран также отображает предупреждения, связанные с заказом, и информацию о возможной экономии.

**Основные функции:**
*   Отображение информации о выбранной аптеке.
*   Отображение предупреждений, связанных с аптекой или товарами.
*   Ввод и валидация контактных данных пользователя (имя, телефон, email).
*   Отображение списка товаров в заказе.
*   Отображение сводки по заказу (общая стоимость, скидки).
*   Отображение информации об экономии.
*   Согласие с пользовательским соглашением.
*   Подтверждение и оформление заказа.
*   Обработка предупреждений и ошибок, связанных с заказом.
*   Перенаправление на экран успешного оформления заказа.
*   Верификация номера телефона по SMS (при необходимости).

## 2. Элементы Пользовательского Интерфейса (UI Elements)

*   **RecyclerView:**
    *   **Назначение/Функция:** Основной контейнер для отображения всех секций экрана: `StoreSection`, `WarningsSection`, `ClientSection`, `ItemsHeaderSection`, `ItemsSection`, `SummarySection`, `EconomySection`, `AgreementSection`.
    *   **Взаимодействие пользователя:** Вертикальная прокрутка для просмотра содержимого.
*   **StoreSection:**
    *   **Назначение/Функция:** Отображает информацию о выбранной аптеке (название, адрес, время работы). Может содержать кнопку дл���� просмотра аптеки на карте.
    *   **Взаимодействие пользователя:** Нажатие на адрес аптеки или кнопку "Показать на карте" переводит на экран `StoresOnMapFragment`.
*   **WarningsSection (StoreWarningsSection):**
    *   **Назначение/Функция:** Отображает предупреждения, связанные с выбранной аптекой или товарами в ней.
    *   **Взаимодействие пользователя:** Неинтерактивный элемент.
*   **ClientSection:**
    *   **Назначение/Функция:** Поля для ввода контактных данных пользователя: имя, телефон, email (опционально). Также может содержать поля для ввода и подтверждения SMS-кода.
    *   **Взаимодействие пользователя:** Ввод текста. Валидация полей. Флажок для согласия на получение уведомлений по email. Кнопки для запроса и подтверждения SMS-кода.
*   **ItemsHeaderSection:**
    *   **Назначение/Функция:** Заголовок для секц��и товаров в заказе ("Состав заказа").
    *   **Взаимодействие пользователя:** Неинтерактивный элемент.
*   **ItemsSection:**
    *   **Назначение/Функция:** Отображает список товаров, входящих в заказ. Каждый элемент, вероятно, включает название, количество и цену товара.
    *   **Взаимодействие пользователя:** Неинтерактивный элемент.
*   **SummarySection:**
    *   **Назначение/Функция:** Отображает сводку по заказу, включая общую стоимость, скидки и т.д.
    *   **Взаимодействие пользователя:** Неинтерактивный элемент.
*   **EconomySection:**
    *   **Назначение/Функция:** Отображает информацию о возможной экономии при оформлении заказа.
    *   **Взаимодействие пользователя:** Неинтерактивный элемент.
*   **AgreementSection:**
    *   **Назначение/Функция:** Флажок согласия с условиями пользовательского сог��а��ения.
    *   **Взаимодействие пользователя:** Установка/снятие флажка. Кнопка "Подтвердить заказ" становится активной только при установленном флажке.
*   **Button (confirm):**
    *   **Назначение/Функция:** Кнопка для подтверждения и оформления заказа.
    *   **Возможные состояния:** Активна, если все поля валидны и флажок согласия установлен. Отображает индикатор загрузки во время выполнения операции.
    *   **Взаимодействие пользователя:** Нажатие инициирует процесс оформления заказа.
*   **TextView (warning):**
    *   **Назначение/Функция:** Отображает предупреждение, если пользователь не согласился с условиями соглашения.
    *   **Возможные состояния:** Видима, если флажок `agreement` не установлен; скрыта в противном случае.
    *   **Взаимодействие пользователя:** Неинтерактивный э��емент.

## 3. Пользовательские Сценарии (User Flows)

*   **Просмотр деталей заказа:**
    1.  Пользователь открывает экран "Подтверждение заказа", передавая данные о выбранной аптеке (`Check`).
    2.  Отображается индикатор загрузки.
    3.  ViewModel загружает данные о заказе, включая аптеку, товары, сводку и предупреждения.
    4.  При успешной загрузке, индикатор скрывается, и все секции отображают соответствующие данные.
*   **Ввод контактных данных:**
    1.  Пользователь вводит свое имя, телефон и, опционально, email в `ClientSection`.
    2.  Поля валидируются. Если поля невалидны, кнопка "Подтвердить заказ" неактивна.
*   **Верификация телефона (при необходимости):**
    1.  Если требуется верификация телефона, пользователь нажимает кнопку "Запросить код".
    2.  Вводит полученн��й SMS-код.
    3.  Нажимает кнопку "Подтвердить код".
    4.  При успешной верификации, поле для кода скрывается.
*   **Согласие с условиями:**
    1.  Пользователь устанавливает флажок в `AgreementSection`.
    2.  Кнопка "Подтвердить заказ" становится активной.
*   **Оформление заказа:**
    1.  Пользователь нажимает кнопку "Подтвердить заказ".
    2.  Скрывается клавиатура.
    3.  Отправляется запрос на оформление заказа через `viewModel.confirmOrder()`.
    4.  Отображается индикатор загрузки.
    5.  При успехе, пользователь перенаправляется на экран успешного оформления заказа (`OrderSuccessFragment`).
    6.  При ошибке отображается диалог с сообщением об ошибке. В зависимости от типа ошибки, могут быть предложены действия (например, перезагрузка данных, переход к списку заказов, исключение аптеки).
*   **П��осмотр аптеки на карте:**
    1.  Пользователь нажимает на адрес аптеки или кнопку "Показать на карте" в `StoreSection`.
    2.  Происходит навигация к экрану `StoresOnMapFragment`, где отображается выбранная аптека.
*   **Просмотр информации о доступности:**
    1.  Пользователь нажимает на иконку доступности в `StoreSection`.
    2.  Отображается всплывающее окно с подробной информацией о доступности аптеки для людей с ограниченными возможностями.
*   **Обработка изменений в заказе:**
    1.  Если в процессе загрузки или обновления данных о заказе обнаруживаются изменения (например, изменение количества товаров, суммы), отображается диалог с информацией об этих изменениях.

## 4. Навигация

С экрана "Подтверждение заказа" возможны следующие переходы:

*   **`StoresOnMapFragment`:** Дл�� просмотра аптеки на карте.
*   **`OrderSuccessFragment`:** После успешного оформления заказа.
*   **`OrdersFragment`:** В случае некоторых ошибок оформления заказа.
*   **Назад к предыдущему экрану:** При нажатии кнопки "Назад" в тулбаре или системной кнопки "Назад".
*   **Диалоговые окна:** Для отображения предупреждений, ошибок или информации об изменениях в заказе.

### Deep Links

На этот экран нет прямых deep links.

## 5. Отображаемые Данные

*   **Типы данных:**
    *   `Check`: Объект, содержащий полную информацию о заказе из одной аптеки, включая данные об аптеке, товары, общую сумму и предупреждения.
    *   `Client`: Информация о профиле пользователя (имя, телефон, email).
    *   `Economy`: Информация об экономии.
    *   `OrderingResult`: Результат оформления заказа.
    *   `PhoneVerification`: Статус верификации телефона.
    *   `Session`: Сессия для запроса SMS-кода.
*   **��сточник данных:**
    *   **API:**
        *   `ApiService.getClient` (REST метод: `GET /app/v1/clients`) - для получения данных клиента.
        *   `ApiService.verifyPhone` (REST метод: `GET /app/v1/phone-verification`) - для верификации телефона.
        *   `ApiService.requestCode` (REST метод: `POST /app/v1/phone-verification/protek/request-code`) - для запроса SMS-кода.
        *   `ApiService.confirmCode` (REST метод: `POST /app/v1/phone-verification/protek/confirm`) - для подтверждения SMS-кода.
        *   `ApiService.checkOrder` (REST метод: `GET /app/v4/orders/check`) - для проверки заказа (для `OrderType.STORE`).
        *   `ApiService.checkStockOrder` (REST метод: `GET /app/v4/stock/orders/check`) - для проверки заказа (для `OrderType.STOCK`).
        *   `ApiService.checkPreorderOrder` (REST метод: `GET /app/v1/preorders/check`) - для проверки заказа (для `OrderType.PREORDER`).
        *   `ApiService.checkDiscountedOrder` (REST метод: `GET /app/v1/discounted/orders/check`) - для проверки заказа (для `OrderType.DISCOUNTED`).
        *   `ApiService.getParameters` (REST метод: `GET parameters`) - для получе��ия параметров (например, для расчета экономии).
        *   `ApiService.createOrder` (REST метод: `POST /app/v1/orders/create`) - для создания заказа (для `OrderType.STORE`).
        *   `ApiService.createStockOrder` (REST метод: `POST /app/v1/stock/orders/create`) - для создания заказа (для `OrderType.STOCK`).
        *   `ApiService.createPreorderOrder` (REST метод: `POST /app/v1/preorders/create`) - для создания заказа (для `OrderType.PREORDER`).
        *   `ApiService.createDiscountedOrder` (REST метод: `POST /app/v1/discounted/orders/create`) - для создания заказа (для `OrderType.DISCOUNTED`).
        *   `ApiService.subscribeOrderTracker` (REST метод: `POST /app/v1/orders/tracker/subscribe`) - для подписки на отслеживание заказа.
    *   **Локальное хранилище:**
        *   Таблица `ClientDao` (для получения данных клиента и сохранения введенных контактных данных).
        *   Таблица `ParametersDao` (для кэширования параметров).
        *   Таблица `StoresDao` (для очистки выбранного магазина).
        *   Табли��а `ItemsDao` (для обновления количества товаров в корзине).
        *   `SavedStateHandle` (для временного хранения `Check`, `OrderType`, `prevOrderId`, `needProtekVerification`, `orderUuid`, `session`, `nextTryEndsMillis`).

## 6. Особые Состояния/Лог��ка

*   **Производительность на слабых устройствах:** Для устройств с низкой производительностью аниматор элементов `RecyclerView` отключается (`viewBinding.recyclerView.itemAnimator = null`).
*   **Валидация полей:** Испол��зуется `clientSection.checkIsValid()` и `clientSection.checkIsNeedVerification()` для валидации контактных данных и статуса верификации телефона перед оформлением заказа.
*   **Условная видимость кнопки "Подтвердить заказ":** Кнопка активна только при валидных данных и согласии с условиями.
*   **Обработка ошибок API:** Ошибк��, возвращаемые API, обрабатываются, и в зависимости от типа ошибки могут быть предложены специфические действия (например, перезагрузка данных, переход к списку заказов, исключение аптеки из выбора).
*   **Сохранение данных клиента:** Введенные пользователем контактные данные и статус верификации сохраняются в `clientSection.clientInfo` и восстанавливаются при изменении конфигурации.
*   **Аналитика:** Оформление заказа логируется с помощью `AnEvent.confirmOrder`.
*   **Перезагрузка данных:** В случае некоторых ошибок, связанных с изменением данных в аптеке, может быть инициирована перезагрузка данных в ViewModel, управляющей выбором аптек (`StoresForOrderViewModel`, `StockStoresForOrderViewModel`, `UniqueStoresForOrderViewModel`).