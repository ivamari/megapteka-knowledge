# OrderRateFragment

## 1. Обзор Экрана

Экран "Оценка заказа" (OrderRateFragment) позволяет пользователю оценить свой недавний заказ, выставить общую оценку, выбрать темы для отзыва, написать комментарий и прикрепить фотографию. Экран динамически отображает информацию о заказе и управляет процессом отправки отзыва.

**Основные функции:**
*   Выставление общей оценки заказу (звездочки).
*   Выбор тем для отзыва из предложенного списка.
*   Написание текстового комментария к отзыву.
*   Прикрепление фотографии к отзыву (с возможностью выбора из галереи или съемки на камеру).
*   Удаление прикрепленной фотографии.
*   Отправка отзыва о заказе.
*   Отображение информации о заказе (номер, аптека, сумма, товары).
*   Согласие с условиями пользовательского соглашения.
*   Обработка состояний загрузки, успеха и ошибки при отправке отзыва.
*   Предложение поделиться приложением при высокой оценке.

## 2. Элементы Пользовательского Интерфейса (UI Elements)

*   **ProgressBar (progress):**
    *   **Назначение/Функция:** Индикатор загрузки, отображаемый во время загрузки информации о заказе.
    *   **Возможные состояния:** Видимый во время загрузки, скрытый в других состояниях.
*   **CardView (orderCard):**
    *   **Назначение/Функция:** Карточка, отображающая краткую информацию о заказе: номер заказа, бренд аптеки, сумма заказа и изображения товаров.
    *   **Взаимодействие пользователя:** Неинтерактивный элемент.
*   **TextView (orderId):**
    *   **Назначение/Функция:** Отображает номер заказа.
    *   **Взаимодействие пользователя:** Неинтерактивный элемент.
*   **TextView (storeBrand):**
    *   **Назначение/Функция:** Отображает бренд аптеки, из которой был сделан заказ.
    *   **Взаимодействие пользователя:** Неинтерактивный элемент.
*   **TextView (amount):**
    *   **Назначение/Функция:** Отображает общую сумму заказа.
    *   **Взаимодействие пользователя:** Неинтерактивный элемент.
*   **RecyclerView (itemsRecyclerView):**
    *   **Назначение/Функция:** Горизонтальный список для отображения изображений товаров, входящих в заказ (`OrderItemsCircleSection`).
    *   **Взаимодействие пользователя:** Горизонтальная прокрутка для просмотра всех изображений товаров.
*   **RatingBar (rating):**
    *   **Назначение/Функция:** Позволяет пользователю выставить общую оценку заказу в виде звездочек.
    *   **Взаимодействие пользователя:** Выбор количества звездочек. Изменение оценки обновляет ViewModel.
*   **RecyclerView (recyclerView):**
    *   **Назначение/Функция:** Основной контейнер для отображения секций `HeaderSection` и `SubjectsSection`.
    *   **Взаимодействие пользователя:** Вертикальная прокрутка для просмотра содержимого.
*   **HeaderSection:**
    *   **Назначение/Функция:** Отображает заголовок для секции тем отзыва.
    *   **Взаимодействие пользователя:** Неинтерактивный элемент.
*   **SubjectsSection:**
    *   **Назначение/Функция:** Отображает список тем, которые пользователь может выбрать для отзыва (например, "Качество обслуживания", "Скорость доставки").
    *   **Взаимодействие пользователя:** Выбор одной или нескольких тем.
*   **EditText (comment):**
    *   **Назначение/Функция:** Поле для ввода текстового комментария к отзыву.
    *   **Взаимодействие польз����вателя:** Ввод текста.
*   **TextView (pickMedia):**
    *   **Назначение/Функция:** Кнопка для выбора или съемки фотографии для отзыва. Скрыта, если фотография уже выбрана.
    *   **Взаимодействие пользователя:** Нажатие открывает диалог выбора источника изображения (камера/галерея).
*   **LinearLayout (imageContainer):**
    *   **Назначение/Функция:** Контейнер для отображения выбранной фотографии. Видим, если фотография выбрана.
    *   **Взаимодействие пользователя:** Неинтерактивный элемент.
*   **ImageView (image):**
    *   **Назначение/Функция:** Отображает выбранную фотографию.
    *   **Взаимодействие пользователя:** Неинтерактивный элемент.
*   **ImageView (removeMedia):**
    *   **Назначение/Функция:** Кнопка для удаления выбранной фотографии.
    *   **Взаимодействие пользователя:** Нажатие удаляет фотографию �� скрывает `imageContainer`.
*   **CheckBox (agreement):**
    *   **Назначение/Функция:** Флажок согласия с условиями пользовательского соглашения.
    *   **Взаимодействие пользователя:** Установка/снятие флажка. Кнопка "Отправить" становится активной только при установленном флажке.
*   **TextView (warning):**
    *   **Назначение/Функция:** Отображает предупреждение, если пользователь не согласился с условиями.
    *   **Возможные состояния:** Видима, если флажок `agreement` не установлен; скрыта в противном случае.
    *   **Взаимодействие пользователя:** Неинтерактивный элемент.
*   **Button (rate):**
    *   **Назначение/Функция:** Кнопка для отправки отзыва о заказе.
    *   **Возможные состояния:** Активна, если все поля валидны и флажок согласия установлен. Отображает индикатор загрузки во время отправки.
    *   **Взаимодействие пользователя:** Нажатие инициирует процесс отправки отзыва.

## 3. Пользовательские Сценарии (User Flows)

*   **Оставление отзыва о заказе:**
    1.  Пользователь открывает экран "Оценка заказа", передавая `orderId` и, возможно, начальную оценку (`rating`).
    2.  ViewModel загружает информацию о заказе и темы для отзыва.
    3.  Отображается информация о заказе, поле для оценки, темы и поле для комментария.
    4.  Пользователь выставляет оценку с помощью звездочек.
    5.  Выбирает одну или несколько тем для отзыва.
    6.  Пишет комментарий.
    7.  (Опционально) Нажимает "Прикрепить фото", выбирает или делает снимок, и фото отображается.
    8.  Устанавливает флажок согласия с условиями.
    9.  Нажимает кнопку "Отправить".
    10. Если все поля валидны, отправляется запрос на отправку отзыва.
    11. При успехе, если оценка 5 звезд, предлагается поделиться приложением (`ShareAppDialog`). В противном случае, отображается диалог "Спасибо за отзыв", и экран закрывается.
    12. При ошибке отображается диалог с сообщением об ошибке.
*   **Прикрепление/удаление фото:**
    1.  Пользователь нажимает "Прикрепить фото".
    2.  Запрашивается разрешение на камеру, если его нет.
    3.  Открывается системный выбор источника изображения (камера/галерея).
    4.  После выбора фото, оно отображается, и кнопка "Прикрепить фото" скрывается, появляется кнопка "Удалить фото".
    5.  Нажатие на "Удалить фото" очищает выбранное фото.
*   **Просмотр пользовательского соглашения:**
    1.  Пользователь нажимает на ссылку "пользовательского соглашения" в `agreement`.
    2.  Открывается веб-страница с текстом соглашения.

## 4. Навигация

С экрана "Оценка заказа" возможны следующие переходы:

*   **Назад к предыдущему экрану:** После успешной отправки отзыва или при нажатии кнопки "Назад" в тулбаре/системной кнопки "Назад".
*   **`ShareAppDialog`:** Если оценка заказа 5 звезд.
*   **Внешний браузер:** Для просмотра пользовательского соглашения.
*   **Системный выбор изображения:** Для выбора фото из галереи или съемки на камеру.
*   **Диалоговые окна:** Для отображения сообщений об успехе или ошибках.

### Deep Links

На этот экран нет прямых deep links.

## 5. Отображаемые Данные

*   **Типы данных:**
    *   `OrderRateInfo`: Информация о заказе для оценки (номер, аптека, сумма, URL изображений товаров).
    *   `OrderRatesSubjects`: Темы для отзыва.
    *   `Uri`: Для выбранной фотографии.
    *   `Resource<OrderRateResult>`: Результат отправки отзыва.
*   **Источник данных:**
    *   **API:**
        *   `ApiService.getOrdersRates` (REST метод: `GET /app/v2/orders/rate`) - для получения информации о заказе для оценки и тем для отзыва.
        *   `ApiService.rateOrder` (REST метод: `POST /app/v2/orders/rate/create`) - для отправки отзыва о заказе.
        *   `ApiService.getParameters` (REST метод: `GET parameters`) - для получения параметров (например, текст для обмена).
    *   **Локальное хранилище:**
        *   Таблица `ParametersDao` (для кэширования параметров).
        *   `SavedStateHandle` (для временного хранения `orderId`, `rating`, `cameraUri`).

## 6. Особые Состояния/Логика

*   **Сохранение URI камеры:** `cameraUri` сохраняется при изменении конфигурации для корректной работы с камерой.
*   **Динамическое отображение информации о заказе:** Информация о заказе загружается и отображается в `orderCard`.
*   **Обработка ошибок ��агрузки заказа:** Если информация о заказе не может быть загружена, отображается диалог с ошибкой, и экран закрывается.
*   **Валидация:** Кнопка "Отправить" активна только при установленном флажке согласия. Если оценка 0, `rating` анимируется.
*   **Обработка разрешений:** Запрашивается разрешение на камеру перед ее использованием.
*   **Условная навигация после отправки:** После успешной отправки отзыва, навигация зависит от выставленной оценки (5 звезд -> `ShareAppDialog`, иначе -> диалог "Спасибо за отзыв").
*   **Скрытие клавиатуры:** Клавиатура автоматически скрывается после отправки отзыва.