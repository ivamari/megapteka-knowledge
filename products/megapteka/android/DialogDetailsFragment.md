# DialogDetailsFragment

## 1. Обзор Экрана

Экран "Диалог с производителем" (DialogDetailsFragment) предназначен для просмотра и ведения переписки в рамках конкретного диалога, например, с производителем товара или службой поддержки. Он отображает историю сообщений, позволяет отправлять новые сообщения и показывает информацию о диалоге.

**Основные функции:**
*   Отображение истории сообщений в диалоге с пагинацией.
*   Отправка новых текстовых сообщений.
*   Отображение заголовка, подзаголовка и изображения, связанных с диалогом.
*   Автоматическая прокрутка к последнему сообщению.
*   Обработка состояний загрузки, ошибок и пустого списка сообщений.

## 2. Элементы Пользовательского Интерфейса (UI Elements)

*   **TextView (title):**
    *   **Назначение/Функция:** Отображает заголовок текущего диалога (например, название производителя).
    *   **Взаимодействие пользователя:** Неинтерактивный элемент.
*   **TextView (subtitle):**
    *   **Назначение/Функция:** Отображает подзаголовок диалога (например, краткое описание).
    *   **Взаимодействие пользователя:** Неинтерактивный элемент.
*   **ImageView (image):**
    *   **Назначение/Функция:** Отображает изображение, связанное с диалогом (например, логотип производителя).
    *   **Взаимодействие пользователя:** Неинтерактивный элемент.
*   **RecyclerView:**
    *   **Назначение/Функция:** Основной контейнер для отображения секций `MessagesSection`, `StateSection` и `FocusSection`.
    *   **Взаимодействие пользователя:** Вертикальная прокрутка для просмотра истории сообщений.
*   **MessagesSection:**
    *   **Назначение/Функция:** Адаптер для `RecyclerView`, который управляет отображением отдельных сообщений в диалоге.
    *   **Взаимодействие пользователя:** Отображает сообщения. При изменении количества страниц автоматически прокручивается к последнему сообщению.
*   **StateSection:**
    *   **Назначение/Функция:** Отображает состояния загрузки, ошибки или пустого состояния данных для списка сообщений.
    *   **Возможные состояния:**
        *   `LOADING`: Показывает индикатор прогресса и сообщение "Загрузка сообщений".
        *   `ERROR`: Показывает сообщение об ошибке и кнопку "Повторить".
        *   `HIDDEN`: Скрыт, когда данные успешно загружены и отображаются.
    *   **Взаимодействие пользователя:** Нажатие на кнопку "Повторить" (в состоянии ошибки) для повторной попытки загрузки сообщений.
*   **EditText (message):**
    *   **Назначение/Функция:** Поле для ввода нового сообщения.
    *   **Взаимодействие пользователя:** Ввод текста. Нажатие "Отправить" на клавиатуре или кнопки "Отправить" инициирует отправку сообщения.
*   **ImageButton (send):**
    *   **Назначение/Функция:** Кнопка для отправки введенного сообщения.
    *   **Взаимодействие пользователя:** Нажатие отправляет сообщение.

## 3. Пользовательские Сценарии (User Flows)

*   **Просмотр истории диалога:**
    1.  Пользователь открывает экран "Диалог с производителем", передавая `itemId` диалога.
    2.  Загружается информация о диалоге (заголовок, подзаголовок, изображение).
    3.  Загружаются и отображаются сообщения диалога с пагинацией.
    4.  Список авто��атически прокручивается к последнему сообщению.
*   **Отправка нового сообщения:**
    1.  Пользователь вводит текст в поле `message`.
    2.  Нажимает кнопку "Отправить" или "Отправить" на клавиатуре.
    3.  Сообщение отправляется через `viewModel.sendMessage`.
    4.  При успешной отправке поле ввода очищается. Если это было первое сообщение в диалоге, список сообщений обновляется.
    5.  При ошибке отправки отображается диалог с сообщением об ошибке.
*   **Обработка ошибок загрузки сообщений:**
    1.  При возникновении ошибки загрузки сообщений, `StateSection` отображает сообщение об ошибке и кнопку "Повторить".
    2.  Нажатие на кнопку "Повторить" инициирует повторную попытку загрузки сообщений.

## 4. Навигация

С экрана "Диалог с производителем" возможны следующие действия:

*   **Назад к предыдущему экрану:** При нажатии кнопки "Назад" в тулбаре.
*   **Диалоговые окна:** Для отображения сообщений об ошибках.

### Deep Links

На этот экран можно попасть по следующим deep links:

*   `ma://{host}/manufacturer/dialogs/{item_id}`

## 5. Отображаемые Данные

*   **Типы данных:**
    *   `Dialog`: Объект, содержащий информацию о диалоге (заголовок, подзаголовок, URL изображения).
    *   `PagingData<Message>`: Для отображения списка сообщений, где `Message` представляет собой отдельное сообщение.
    *   `Resource<Unit>`: Для отслеживания статуса отправки сообщения.
*   **Источник данных:**
    *   **API:**
        *   `ApiService.getDialog` (REST метод: `GET /app/v1/manufacturer/dialogs/detail`) - для получения информации о диалоге.
        *   `ApiService.getDialogMessages` (REST метод: `GET /app/v1/manufacturer/dialogs/messages`) - для получения списка сообщений.
        *   `ApiService.readDialog` (REST метод: `POST /app/v1/manufacturer/dialogs/read`) - для отметки сообщений как прочитанных.
        *   `ApiService.sendMessage` (REST метод: `POST /app/v1/manufacturer/dialogs/messages/send`) - для отправки нового сообщения.
        *   `ApiService.getUnreadCount` (REST метод: `GET /app/v1/manufacturer/dialogs/messages/unread-count`) - для получения количества непрочитанных сообщений.
    *   **Локальное хранилище:** Нет.

## 6. Особые Состояния/Логика

*   **Производительность на слабых устройствах:** Для устройств с низкой производительностью аниматор элементов `RecyclerView` отключается (`viewBinding.recyclerView.itemAnimator = null`).
*   **Автоматическая прокрутка:** При обновлении страниц сообщений, если пользователь находится в конце списка, список автоматически прокручивается к последнему сообщению.
*   **Обработка ошибок:** Ошибки загрузки и отправки сообщений отображаются в виде диалоговых окон.
*   **Заголовок экрана:** Заголовок экрана динамически ус��анавливается из данных диалога.