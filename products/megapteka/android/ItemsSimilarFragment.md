# ItemsSimilarFragment

## 1. Обзор Экрана

Экран "Похожие товары" (ItemsSimilarFragment) предназначен для отображения списка товаров, похожих на заданный исходный товар. Он предоставляет пользователю возможность искать товары, сканировать штрих-коды, а также просматривать и взаимодействовать с похожими товарами. Экран поддерживает пагинацию и обработку различных состояний загрузки данных.

**Основные функции:**
*   Отображение списка похожих товаров с пагинацией.
*   Поиск товаров по текстовому запросу.
*   Голосовой поиск товаров.
*   Сканирование штрих-кодов для поиска товаров.
*   Добавление товаров в корзину и изменение их количества.
*   Добавление/удаление товаров из избранного.
*   Обработка состоя��ий загрузки, ошибок и пустого списка товаров.

## 2. Элементы Пользовательского Интерфейса (UI Elements)

*   **SearchBar (includedItemsSearchBar):**
    *   **Назначение/Функция:** Содержит поле для ввода поискового запроса, кнопку голосового поиска и кнопку сканирования штрих-кода.
    *   **Взаимодействие пользователя:** Нажатие на поле поиска: Переход к экрану поиска товаров. Нажатие на кнопку голосового поиска: Активация голосового ввода. Нажатие на кнопку сканирования: Переход к экрану сканирования штрих-кода.
*   **RecyclerView:**
    *   **Назначение/Функция:** Основной контейнер для отображения секций `ItemsUnlimitedSection` и `StateSection`.
    *   **Взаимодействие пользователя:** Вертикальная прокрутка для просмотра содержимого.
*   **ItemsUnlimitedSection (itemsSection):**
    *   **Назначение/Функция:** Отображает спис��к похожих товаров с пагинацией. Каждый элемент включает изображение, название, цену, кнопки `+`/`-`, иконку избранного и другие элементы взаимодействия.
    *   **Взаимодействие пользователя:** Нажатие на товар для перехода к его деталям. Изменение количества товара в корзине, добавление/удаление из избранного.
*   **StateSection:**
    *   **Назначение/Функция:** Отображает состояния загрузки, ошибки или пустого состояния данных для списка товаров.
    *   **Возможные состояния:**
        *   `LOADING`: Показывает индикатор прогресса и сообщение "Загрузка товаров".
        *   `ERROR`: Показывает сообщение об ошибке и кнопку "Повторить".
        *   `EMPTY`: Показывает сообщение о пустом результате поиска с возможностью сброса фильтров или перехода по ссылке.
        *   `HIDDEN`: Скрыт, когда данные успешно загружены и отображаются.
    *   **Взаимодействие пользователя:** Нажатие на кнопку "Повторить" (в состоянии ошибки) для повторной попытки загрузки данных. Нажатие на кнопку в пустом состоянии для сброса фильтров или навигации.
*   **FiltersSection (includedFilters.filtersRecyclerView):**
    *   **Назначение/Функция:** Отображает доступные фильтры для списка похожих товаров.
    *   **Взаимодействие пользователя:** Нажатие на фильтр открывает диалог `FiltersDialog` для выбора значений фильтра.

## 3. Пользовательские Сценарии (User Flows)

*   **Просмотр похожих товаров:**
    1.  Пользователь открывает экран "Похожие товары", передавая `similarId` исходного товара.
    2.  Отображается индикатор загрузки (`StateSection`).
    3.  ViewModel запрашивает список похожих товаров.
    4.  При успешной загрузке, инди��атор скрывается, и `ItemsUnlimitedSection` отображает список товаров.
    5.  Если список товаров пуст, отображается `StateSection` с сообщением о пустом списке.
*   **Поиск товаров:**
    1.  Пользователь вводит текст в поисковую строку.
    2.  Инициируется поиск товаров, и результаты отображаются в списке.
*   **Голосовой поиск:**
    1.  Пользователь нажимает на иконку микрофона.
    2.  Активируется системный распознаватель речи.
    3.  Пользователь произносит запрос.
    4.  Результат распознавания текста автоматически вставляется в поисковую строку, и инициируется поиск.
*   **Сканирование штрих-кода:**
    1.  Пользователь нажимает на иконку сканера.
    2.  Переходит на экран `ItemsScanActivity`.
*   **Применение фильтров:**
    1.  Пользователь нажимает на фильтр в `FiltersSection`.
    2.  Открывается д��алог `FiltersDialog`.
    3.  Пользователь выбирает значения фильтров.
    4.  Список похожих товаров обновляется в соответствии с выбранными фильтрами.
*   **Переход к деталям товара:**
    1.  Пользователь нажимает на любой товар в списке.
    2.  Происходит навигация к экрану `ItemDetailsFragment` с передачей ID выбранного товара.
*   **Добавление/изменение количества товара в корзине:**
    1.  Пользователь нажимает кнопки `+` или `-` на карточке товара.
    2.  Количество товара в корзине обновляется.
*   **Добавление/удаление из избранного:**
    1.  Пользователь нажимает на иконку избранного на карточке товара.
    2.  Статус избранного обновляется.

## 4. Навигация

С экрана "Похожие товары" возможны следующие переходы:

*   **`ItemsSearchFragment`:** Для текстового или голосового поиска товаров.
*   **`ItemsScanActivity`:** Для поиска товаров по штрих-коду.
*   **`ItemDetailsFragment`:** Для просмотра детальной информации о товаре.
*   **`FiltersDialog`:** Для применения фильтров.
*   **Навигация по DeepLink:** Если кнопка в пустом состоянии имеет deep-ссылку.

### Deep Links

На этот экран нет прямых deep links.

## 5. Отображаемые Данные

*   **Типы данных:**
    *   `PagingData<Item>`: Для отображения списка похожих товаров.
    *   `Meta`: Метаданные, включая информацию для пустого состояния.
*   **Источник данных:**
    *   **API:** `ApiService.getSimilarItems` (REST метод: `GET /app/v3/items/similar`) - для получения списка похожих товаров.
    *   **Локальное хранилище:** Таблица `ItemsDao` (для кэширования товаров).

## 6. Особые Состояния/Логика

### 6.1. Логика Фильтрации
Экран использует абстрактный класс `Filterable` для представления различных типов фильтров. Для фильтрации похожих товаров применяется `ItemFilterable.SortFilterable` для сортировки. Управление фильтрами происходит через `FiltersDialog`, который позволяет пользователю выбирать и применять значения фильтров, обновляя список похожих товаров.

*   **Производительность на слабых устройствах:** Для устройств с низкой производительностью аниматор элементов `RecyclerView` отключается (`viewBinding.recyclerView.itemAnimator = null`).
*   **Динамическая видимость голосового поиска:** Кнопка голосового поиска видна только если функция распознавания речи доступна на устройстве.
*   **Анимация голосового поиска:** Иконка микрофона анимируется с использованием `AnimatedVectorDrawableCompat` во время записи голоса.
*   **Обработка ошибок Paging:** `handleLoadStates` обрабатывает различные состояния загрузки (начальная загрузка, добавление, ошибка) и отображает соответствующий UI через `StateSection`.
*   **Синхронизация корзины и избранного:** Методы `quantitiesChanged` и `favsChanged` позволяют обновлять UI списка товаров при изменении количества в корзине или статуса избранного из других частей приложения.
*   **Обработка пустого состояния:** В случае пустого списка похожих товаров, `StateSection` отображает кастомизированно�� сообщение и кнопку, которая может сбросить фильтры или выполнить навигацию по deep-ссылке.