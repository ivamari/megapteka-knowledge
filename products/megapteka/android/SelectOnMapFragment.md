# SelectOnMapFragment

## 1. Обзор Экрана

Экран "Указать точку на карте" (SelectOnMapFragment) позволяет пользователю выбрать конкретную точку на карте. Он отображает интерактивную карту с маркером в центре, который указывает на выбранное местоположение. Пользователь может перемещать карту, масштабировать ее и центрировать по своему текущему местоположению, а затем сохранить выбранную точку.

**Основные функции:**
*   Отображение интерактивной карты с центральным маркером.
*   Перемещение карты для выбора местоположения.
*   Масштабирование карты (увеличение/уменьшение).
*   Центрирование карты по текущему местоположению пользователя.
*   Сохранение выбранной точки на карте и возврат ее на предыдущий ��кран.
*   Запрос разрешений на доступ к местоположению.

## 2. Элементы Пользовательского Интерфейса (UI Elements)

*   **Toolbar (через MenuProvider):**
    *   **Назначение/Функция:** Отображает заголовок экрана (например, "Указать точку на карте") и кнопку "Сохранить" для подтверждения выбора.
    *   **Взаимодействие пользователя:** Нажатие на кнопку "Сохранить" инициирует сохранение выбранной точки и закрытие экрана.
*   **MapView (map):**
    *   **Назначение/Функция:** Основной компонент, отображающий интерактивную карту.
    *   **Взаимодействие пользователя:** Перемещение карты изменяет центральную точку, которая будет сохранена. Масштабирование карты с помощью жестов.
*   **ImageView (placemark):**
    *   **Назначение/Функция:** Маркер, расположенный в центре карты, указывающий на выбранную точку. Его изображение может быть настроено.
    *   **Взаимодействие пользователя:** Неинтерактивный элемент, визуально отображает выбранную точку.
*   **ImageView (plus):**
    *   **Назначение/Функция:** Кнопка для увеличения масштаба карты.
    *   **Взаимодействие пользователя:** Нажатие увеличивает масштаб карты.
*   **ImageView (minus):
    *   **Назначение/Функция:** Кнопка для уменьшения масштаба карты.
    *   **Взаимодействие пользователя:** Нажатие уменьшает масштаб карты.
*   **ImageView (userLocation):
    *   **Назначение/Функция:** Кнопка для центрирования карты по текущему местоположению пользователя.
    *   **Взаимодействие пользователя:** Нажатие запрашивает разрешения на местоположение (если необходимо) и центрирует карту.

## 3. Пользовательские Сценарии (User Flows)

*   **Выбор точки на карте:**
    1.  Пользователь открывает экран "Указать точку на карте", передавая начальное местоположение (`args.location`), радиус (`args.radius`), заголовок (`args.titleResId`) и изображение маркера (`args.placemarkResId`).
    2.  Карта центрируется по переданному местоположению (если оно есть) или по умолчанию.
    3.  Пользователь перемещает карту, чтобы установить маркер на нужную точку.
    4.  Пользователь может использовать кнопки `+`/`-` для масштабирования или `userLocation` для центрирования по своему местоположению.
    5.  Пользователь нажимает кнопку "Сохранить" в тулбаре.
    6.  Координаты центра карты сохраняются как `NearPointAddress` и передаются обратно на предыдущий экран через `setFragmentResult`.
    7.  Экран закрывается.
*   **Центрирование по текущему местоположению:**
    1.  Пользователь нажимае�� кнопку "Мое местоположение".
    2.  Если разрешения на местоположение не предоставлены, они запрашиваются.
    3.  Если разрешения есть, карта центрируется по текущему местоположению пользователя.

## 4. Навигация

С экрана "Указать точку на карте" возможны следующие переходы:

*   **Назад к предыдущему экрану:** После сохранения выбранной точки или при нажатии кнопки "Назад" в тулбаре/системной кнопки "Назад".

### Deep Links

На этот экран нет прямых deep links.

## 5. Отображаемые Данные

*   **Типы данных:**
    *   `Location`: Объект, представляющий широту и долготу начального местоположения.
    *   `NearPointAddress`: Объект, представляющий выбранную точку на карте с координатами.
*   **Источник данных:**
    *   **Входящие аргументы (`navArgs`):** Начальное местоположение (`args.location`), радиус (`args.radius`), ID ресурса заголовка (`args.titleResId`), ID ресурса изображения маркера (`args.placemarkResId`).
    *   **Внешние SDK:** `DGis SDK` (для отображения карты и получения координат центра).
    *   **Системные службы:** `SuspendLocationProvider` (для получения текущего местоположения пользователя).

## 6. Особые Состояния/Логика

*   **Динамический заголовок и маркер:** Заголовок тулбара и изображение маркера динамически устанавливаются на основе аргументов, переданных при запуске фрагмента.
*   **Обработка разрешений:** Перед использованием местоположения пользователя запрашиваются необходимые разрешения (`Manifest.permission.ACCESS_COARSE_LOCATION`, `Manifest.permission.ACCESS_FINE_LOCATION`).
*   **Передача результатов:** Выбранный адрес и радиус передаются обратно на предыдущий экран через `setFragmentResult` с использованием `REQUEST_KEY_SELECT_ON_MAP_ADDRESS`, `RESULT_KEY_SELECT_ON_MAP_ADDRESS` и `RESULT_KEY_SELECT_ON_MAP_RADIUS`.