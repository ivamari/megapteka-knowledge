# StoresForOrderMapFragment

## 1. Обзор Экрана

`StoresForOrderMapFragment` является частью экрана выбора аптеки для заказа из наличия. Он отображает аптеки на интерактивной карте, в которых доступны товары из корзины, а также предупреждения, связанные с этими аптеками или товарами. Пользователь может выбрать аптеку, просмотреть ее детали и связанные товары, а также построить маршрут.

**Основные функции:**
*   Отображение аптек, доступных для заказа из наличия, на карте в виде маркеров.
*   Кластеризация маркеров по цене.
*   Отображение детальной информации о выбранной аптеке и ее товарах в нижней панели.
*   Построение маршрута до выбранной аптеки.
*   Отображение предупреждений, связанных с аптеками или товарами.
*   Выбор аптеки для оформления заказа.
*   Просмотр информации о доступности аптеки.
*   Управление масштабом карты и центрированием по местоположению пользователя.
*   Отображение маршрутов на карте.
*   Выделение аптеки с лучшей ценой в видимой области карты.

## 2. Элементы Пользовательского Интерфейса (UI Elements)

*   **MapView (map):**
    *   **Назначение/Функция:** Интерактивная карта, на которой отображаются маркеры аптек с товарами из наличия.
    *   **Взаимодействие пользователя:** Перемещение, масштабирование карты. Нажатие на маркер аптеки открывает нижнюю панель с деталями.
*   **ProgressBar (progress):**
    *   **Назначение/Функция:** Индикатор загрузки, отображаемый во время загрузки данных об аптеках.
    *   **Возможные состояния:** Видимый во время загрузки, скрытый в других состояниях.
*   **View (bottomSheet):**
    *   **Назначение/Функция:** Нижняя панель (BottomSheet), которая отображает детальную информацию о выбранной аптеке и ее товарах.
    *   **Взаимодействие пользователя:** Может быть свернута/развернута. Содержит информацию об аптеке и список товаров.
*   **RecyclerView (warningsRV):**
    *   **Назначение/Функция:** Отображает предупреждения, связанные с проверкой заказа (`CheckWarningsSection`).
    *   **Взаимодействие пользователя:** Нажатие на кнопку в предупреждении может инициировать действие (например, навигацию по deep-ссылке).
*   **RecyclerView (bottomSheetRV):**
    *   **Назначение/Функция:** Контейнер для отображения секций `StoreSection` и `ItemsSection` внутри нижней панели.
    *   **Взаимодействие пользователя:** Вертикальная прокрутка для просмотра содержимого аптеки и товаров.
*   **StoreSection:**
    *   **Назначение/Функция:** Отображает информацию о выбранной аптеке (название, адрес, расписание, цена, кнопки).
    *   **Взаимодействие пользователя:** Нажатие на кнопку "Выбрать" инициирует выбор аптеки. Нажатие на расписание может разворачивать/сворачивать его. Нажатие на иконку доступности показывает информацию о доступности. Нажатие на количество товаров в аптеке переключает состояние нижней панели (свернуть/развернуть).
*   **ItemsSection:**
    *   **Назначение/Функция:** Отображает список товаров, доступных в выбранной аптеке. Может содержать кнопки для замены товаров.
    *   **Взаимодействие пользователя:** Нажатие на кнопку "Заменить" для замены товара.
*   **ImageView (mapOrientation):**
    *   **Назначение/Функция:** Кнопка для изменения ориентации карты.
    *   **Взаимодействие пользователя:** Нажатие изменяет ориентацию карты.
*   **ImageView (userLocation):**
    *   **Назначение/Функция:** Кнопка для центрирования карты по текущему местоположению пользователя.
    *   **Взаимодействие пользователя:** Нажатие центрирует карту.
*   **ImageView (plus, minus):**
    *   **Назначение/Функция:** Кнопки для увеличения/уменьшения масштаба карты.
    *   **Взаимодействие пользователя:** Нажатие изменяет масштаб карты.

## 3. Пользовательские Сценарии (User Flows)

*   **Просмотр аптек на карте:**
    1.  Пользователь открывает `StoresForOrderMapFragment`.
    2.  Отображается индикатор загрузки (`progress`).
    3.  ViewModel запрашивает список аптек для заказа из наличия и связанные предупреждения.
    4.  Маркеры аптек отображаются на карте. Маркеры кластеризуются по цене.
    5.  При успешной загрузке, индикатор скрывается.
*   **Просмотр деталей аптеки и товаров:**
    1.  Пользователь нажимает на маркер аптеки на карте.
    2.  Нижняя панель (`bottomSheet`) сворачивается, отображая информацию о выбранной аптеке и список связанных товаров.
    3.  Пользователь может развернуть нижнюю панель, чтобы увидеть все товары, нажав на количество товаров в аптеке.
*   **Выбор аптеки:**
    1.  Пользователь нажимает кнопку "Выбрать" на нижней панели.
    2.  Выбранная аптека передается в ViewModel через `viewModel.chooseStore()`.
    3.  Происходит навигация к экрану подтверждения заказа (`OrderConfirmFragment`).
*   **Просмотр информации о доступности:**
    1.  Пользователь нажимает на иконку доступности на нижней панели.
    2.  Отображается всплывающее окно с подробной информацией о доступности аптеки для людей с ограниченными возможностями.
*   **Замена товара:**
    1.  Пользователь нажимает на кнопку "Заменить" рядом с товаром в списке аптеки на нижней панели.
    2.  Происходит навигация к диалогу замены товара (`ItemReplaceDialog`) с передачей ID товара и ID аптеки.
*   **Взаимодействие с предупреждениями:**
    1.  Пользователь нажимает на кнопку в предупреждении в `CheckWarningsSection`.
    2.  Происходит навигация по deep-ссылке, связанной с кнопкой.
*   **Построение маршрута:**
    1.  На карте могут отображаться маршруты до аптек, если они доступны через фильтры.
*   **Управление картой:**
    1.  Пользователь нажимает кнопки `+` или `-` для изменения масштаба карты.
    2.  Пользователь нажимает кнопку "М��е местоположение" для центрирования карты по текущему местоположению.
    3.  Пользователь нажимает кнопку "Ориентация" для изменения ориентации карты.
*   **Выделение аптеки с лучшей ценой:**
    1.  При изменении видимой области карты, система определяет аптеку с лучшей ценой среди видимых и выделяет ее маркер.
    2.  Если выбранная аптека совпадает с аптекой с лучшей ценой, ее детали в нижней панели также обновляются для отображения выделения.

## 4. Навигация

С экрана `StoresForOrderMapFragment` возможны следующие переходы:

*   **`OrderConfirmFragment`:** Для подтверждения заказа после выбора аптеки.
*   **`ItemReplaceDialog`:** Для замены товара.
*   **Навигация по DeepLink:** Если кнопка в предупреждении имеет deep-ссылку.

### Deep Links

На этот экран нет прямых deep links.

## 5. Отображаемые Данные

*   **Типы данных:**
    *   `List<Check>`: Список объектов `Check`, каждый из которых содержит информацию об аптеке (`Store`) и товарах, доступных в ней.
    *   `List<CheckWarning>`: Список предупреждений, связанных с проверкой заказа.
    *   `CheckFilterable.DistanceFilterable`: Информация о фильтре по расстоянию и маршрутах.
    *   `ItemInStore`: Информация о товаре в аптеке.
*   **Источник данных:**
    *   **API:**
        *   `ApiService.checkOrder` (REST метод: `GET /app/v4/orders/check`) - для получения списка аптек и проверки заказа.
        *   `ApiService.getOrderAnalogs` (REST метод: `GET /app/v2/items/order-analogs`) - для получения товаров-заменителей.
        *   `ApiService.syncCartItems` (REST метод: `POST /app/v1/cart/online`) - для синхронизации корзины.
    *   **Локальное хранилище:**
        *   Таблица `ItemsDao` (для кэширования товаров в корзине и избранного).
        *   Таблица `StoresDao` (для сохранения выбранной аптеки).
    *   **Внешние SDK:** `DGis SDK` (для отображения карты, маркеров и маршрутов).

## 6. Особые Состояния/Логика

*   **Кластеризация маркеров по цене:** Используются `PriceViewProvider` и `PriceClusterViewProvider` для отображения маркеров и кластеров с учетом цены, что помогает пользователю быстро оценить стоимость заказа в разных аптеках.
*   **Динамическое заполнение нижней панели:** Информация о выбранной аптеке и ее товарах динамически заполняет нижнюю панель при нажатии на маркер.
*   **Управление высотой нижней панели:** Высота нижней панели (`bottomSheetBehavior.setPeekHeight`) динамически регулируется в зависимости от содержимого, чтобы обеспечить оптимальное отображение.
*   **Отображение маршрутов:** Если доступны данные о маршрутах, они отображаются на карте с помощью `RouteMapObject`.
*   **Обработка ошибок:** Ошибки загрузки данных отображаются через `progress`.
*   **Сброс фильтров:** При нажатии на кнопку в предупреждении, ViewModel может сбросить примененные фильтры.
*   **Фокусировка на аптеке:** Метод `focusPin()` используется для центрирования карты на выбранной аптеке и ее выделения.
*   **Обработка разрешений:** Запрашивается разрешение на доступ к местоположению.
*   **Выделение лучшей цены:** Логика `handleVisibleRectChanged` определяет аптеку с самой низкой ценой в текущей видимой области карты и визуально выделяет ее маркер и информацию в нижней панели.
