# ProductsSearchFragment

## 1. Обзор Экрана

Экран "Поиск продуктов" (ProductsSearchFragment) предназначен для поиска лекарственных препаратов или других продуктов. Он предоставляет пользователю возможность искать продукты по текстовому запросу, использовать голосовой ввод, сканировать штрих-коды, а также выбирать найденные продукты для дальнейшего использования (например, для проверки совместимости).

**Основные функции:**
*   Поиск продуктов по текстовому запросу.
*   Голосовой поиск продуктов.
*   Сканирование штрих-кодов для поиска продуктов.
*   Отображение списка найденных продуктов.
*   Выбор продукта и возврат его на предыдущий экран.
*   Обработка состояний загрузки, ошибок и пустого списка при поиске продуктов.

## 2. Элементы Пользовательского Интерфейса (UI Elements)

*   **Toolbar (через MenuProvider):**
    *   **Назначение/Функция:** Содержит поисковую строку (`SearchView`), кнопку голосового поиска (`action_speech`) и кнопку сканирования (`action_scan`).
    *   **Взаимодействие пользователя:** Ввод текста в `SearchView` инициирует поиск. Нажатие на иконку микрофона активирует голосовой ввод. Нажатие на иконку сканера переводит на экран сканирования.
*   **SearchView (action_search в меню):**
    *   **Назначение/Функция:** Поле для ввода поискового запроса. Всегда видимо и не сворачивается.
    *   **Взаимодействие пользователя:** Ввод текста для фильтрации списка продуктов. Запросы отправляются с задержкой (debounce) для оптимизации производительност����. При потере фокуса или отправке запроса, клавиатура скрывается.
*   **ImageButton (action_speech в меню):**
    *   **Назначение/Функция:** Кнопка для активации голосового поиска.
    *   **Возможные состояния:** Видима, если распознавание речи доступно на устройстве.
    *   **Взаимодействие пользователя:** Нажатие инициирует голосовой ввод. Иконка анимируется во время записи голоса.
*   **ImageButton (action_scan в меню):**
    *   **Назначение/Функция:** Кнопка для перехода к сканированию штрих-кода.
    *   **Взаимодействие пользователя:** Нажатие переводит на экран `ItemsScanActivity`.
*   **RecyclerView:**
    *   **Назначение/Функция:** Основной контейнер для отображения секций `ProductsSection` и `StateSection`.
    *   **Взаимодействие пользователя:** Вертикальная прокрутка для просмотра содержимого.
*   **ProductsSection:**
    *   **Н��значение/Функция:** Адаптер для `RecyclerView`, который управляет отображением отдельных карточек продуктов. Каждый элемент, вероятно, включает изображение, название и другую информацию.
    *   **Взаимодействие пользователя:** Нажатие на продукт выбирает его и возвращает на предыдущий экран.
*   **StateSection:**
    *   **Назначение/Функция:** Отображает состояния загрузки, ошибки или пустого состояния данных для списка продуктов.
    *   **Возможные состояния:**
        *   `LOADING`: Показывает индикатор прогресса и сообщение "Загрузка товаров".
        *   `ERROR`: Показывает сообщение об ошибке и кнопку "Повторить".
        *   `EMPTY`: Показывает сообщение о пустом результате поиска.
        *   `HIDDEN`: Скрыт, когда данные успешно загружены и отображаются.
    *   **Взаимодействие пользователя:** Нажатие на кнопку "Повторить" (в состоянии ошибки) для повторной попытки загрузки данных.

## 3. Пользовательские Сценарии (User Flows)

*   **Поиск продукта по текстовому запросу:**
    1.  Пользователь открывает экран "Поиск продуктов".
    2.  Вводит текст в поисковую строку.
    3.  ViewModel инициирует поиск продуктов.
    4.  Отображается индикатор загрузки (`StateSection`).
    5.  При получении результатов, `ProductsSection` отображает найденные продукты.
    6.  Если результатов нет, отображается `StateSection` с сообщением о пустом поиске.
*   **Голосовой поиск:**
    1.  Пользователь нажимает на иконку микрофона.
    2.  Активируется системный распознаватель речи.
    3.  Пользователь произносит запрос.
    4.  Результат распознавания текста автоматически вставляется в поисковую строку, и инициируется поиск.
*   **Сканирование штрих-кода:**
    1.  Пользователь нажимает на иконку сканера.
    2.  Переходит на экран `ItemsScanActivity`.
    3.  После успешного сканирования и получения продукта, он возвращается на `ProductsSearchFragment` и передается на предыдущий экран.
*   **Выбор продукта:**
    1.  Пользователь нажимает на любой продукт в списке результатов.
    2.  Выбранный продукт передается обратно на предыдущий экран через `setFragmentResult`, и экран "Поиск продуктов" закрывается.

## 4. Навигация

С экрана "Поиск продуктов" возможны следующие переходы:

*   **`ItemsScanActivity`:** Для сканирования штрих-кодов.
*   **Назад к предыдущему экрану:** После выбора продукта или при нажатии кнопки "Назад" в тулбаре/системной кнопки "Назад".

### Deep Links

На этот экран нет прямых deep links.

## 5. Отображаемые Данные

*   **Типы данных:**
    *   `List<Product>`: Список объектов `Product`, каждый из которых представляет найденный продукт (например, ID, название, URL изображения).
*   **Источник данных:**
    *   **API:**
        *   `ApiService.searchProducts` (REST метод: `GET /app/v1/compatibility/search`) - для поиска продуктов.
        *   `ApiService.getProductByBarcode` (REST метод: `GET /app/v1/compatibility/search/barcode`) - для получения продукта по штрих-коду (используется в `ItemsScanActivity`, результат которой передается сюда).
    *   **Локальное хранилище:** Нет.

## 6. Особые Состояния/Логика

*   **Производительность на слабых устройствах:** Для устройств с низкой производительностью аниматор элементов `RecyclerView` отключается (`viewBinding.recyclerView.itemAnimator = null`).
*   **Динамическая видимость голосового поиска:** Кнопка голосового поиска видна только если функция распознавания речи доступна на устрой��тве.
*   **Анимация голосового поиска:** Иконка микрофона анимируется с использованием `AnimatedVectorDrawableCompat` во время записи голоса.
*   **Обработка ошибок:** Ошибки загрузки продуктов отображаются через `StateSection`.
*   **Сохранение состояния запроса:** Последний поисковый запрос сохраняется при изменении конфигурации и восстанавливается.
*   **Передача результатов:** Выбранный продукт и его позиция передаются обратно на предыдущий экран через `setFragmentResult` с использованием `REQUEST_KEY_PRODUCT`, `RESULT_KEY_PRODUCT_POSITION` и `RESULT_KEY_PRODUCT`.