# ItemReplaceDialog

## 1. Обзор Экрана

`ItemReplaceDialog` — это нижний диалог (BottomSheetDialogFragment), который позволяет пользователю выбрать товар на замену для отсутствующего или неподходящего товара в заказе. Диалог отображает список доступных товаров-заменителей и позволяет добавить их в избранное или выбрать для замены.

**Основные функции:**
*   Отображение списка товаров, доступных для замены.
*   Возможность добавить товар-заменитель в избранное.
*   Выбор товара для замены и закрытие диалога.
*   Обработка состояний загрузки, ошибок и пустого списка товаров.

## 2. Элементы Пользовательского Интерфейса (UI Elements)

*   **TextHeaderSection (headerSection):**
    *   **Назначение/Функция:** Отображает заголовок диалога, например, "Замена товара".
    *   **Взаимодействие пользователя:** Неинтерактивный элемент.
*   **RecyclerView:**
    *   **Назначение/Функция:** Основной контейнер для отображения секций `StateSection` и `ItemsSection`.
    *   **Взаимодействие пользователя:** Вертикальная прокрутка для просмотра содержимого.
*   **StateSection:**
    *   **Назначение/Функция:** Отображает состояния загрузки, ошибки или пустого состояния данных для списка товаров.
    *   **Возможные состояния:**
        *   `LOADING`: Показывает индикатор прогресса и сообщение "Загрузка товаров".
        *   `ERROR`: Показывает сообщение об ошибке и кнопку "Повторить".
        *   `EMPTY`: Показывает сообщение о пустом списке товаров.
        *   `HIDDEN`: Скрыт, когда данные успешно загружены и отображаются.
    *   **Взаимодействие пользователя:** Нажатие на кнопку "Повторить" (в состоянии ошибки) для повторной попытки загрузки данных.
*   **ItemsSection:**
    *   **Назначение/Функция:** Адаптер для `RecyclerView`, который управляет отображением отдельных карточек товаров-заменителей. Каждая карточка, вероятно, включает изображение, название, цену, иконку избранного и кнопку "Заменить".
    *   **Взаимодействие пользователя:** Нажатие на иконку избранного для изменения статуса товара. Нажатие на кнопку "Заменить" для выбора товара и закрытия диалога.

## 3. Пользовательские Сценарии (User Flows)

*   **Просмотр товаров-заменителей:**
    1.  Пользователь открывает `ItemReplaceDialog`, передавая `itemId` и `storeId`.
    2.  Отображается индикатор загрузки (`StateSection`).
    3.  ViewModel запрашивает список товаров-з��менителей.
    4.  При успешной загрузке, индикатор скрывается, и `ItemsSection` отображает список товаров.
    5.  Если список товаров пуст, отображается `StateSection` с сообщением о пустом списке.
*   **Добавление/удаление из избранного:**
    1.  Пользователь нажимает на иконку избранного на карточке товара.
    2.  Статус избранного обновляется через `viewModel.updateFavorite()`.
*   **Выбор товара для замены:**
    1.  Пользователь нажимает на кнопку "Заменить" на карточке товара.
    2.  Регистрируется аналитическое событие `AnEvent.replaceItem`.
    3.  Выбранный товар передается в ViewModel через `viewModel.replace()`.
    4.  Диалог закрывается (`findNavController().popBackStack()`).
*   **Обработка ошибок загрузки:**
    1.  При возникновении ошибки загрузки данных, `StateSection` отображает сообщение об ошибке и кнопку "Повторить".
    2.  Нажатие на кнопку "Повторить" инициирует повторную попытку загрузки данных.

## 4. Навигация

С диалога `ItemReplaceDialog` возможны следующие действия:

*   **Закрытие диалога:** При выборе товара для замены, при нажатии кнопки "Назад" на устройстве, или при нажатии на кнопку "Повторить" в состоянии ошибки.

### Deep Links

На этот экран нет прямых deep links.

## 5. Отображаемые Данные

*   **Типы данных:**
    *   `PagingData<Item>`: Для отображения списка товаров, где `Item` представляет собой объект товара (например, ID, название, изображение, цена, статус избранного).
*   **Источник данных:**
    *   **API:**
        *   `ApiService.getOrderAnalogs` (REST метод: `GET /app/v2/items/order-analogs`) - для получения списка товаров-заменителей.
        *   `ApiService.putFavoriteItems` (REST метод: `PUT /ma/v3/items/favorites`) - для обновления статуса избранного.
        *   `ApiService.syncCartItems` (REST метод: `POST /app/v1/cart/online`) - для синхронизации корзины после замены товара.
    *   **Локальное хранилище:** Таблица `ItemsDao` (для получения/обновления количества товаров в корзине, статуса избранного и синхронизации корзины).

## 6. Особые Состояния/Логика

*   **Производительность на слабых устройствах:** Для устройств с низкой производительностью аниматор элементов `RecyclerView` отключается (`viewBinding.recyclerView.itemAnimator = null`).
*   **BottomSheetBehavior:** Диалог всегда развернут (`BottomSheetBehavior.STATE_EXPANDED`) при открытии.
*   **Декорация элементов:** Используется `DividerSectionItemDecoration` для добавления разделителей между элементами в `RecyclerView`.
*   **Аналитика:** Выбор товара для замены логируется с помощью `AnUtils.logEvent`.