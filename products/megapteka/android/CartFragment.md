# CartFragment

## 1. Обзор Экрана

Экран "Корзина" (CartFragment) предназначен для управления товарами, добавленными пользователем в корзину. Он позволяет просматривать список товаров, изменять их количество, удалять, добавлять в избранное, а также переходить к оформлению заказа. Экран также отображает предупреждения, связанные с товарами в корзине, и общую сводку по заказу.

**Основные функции:**
*   Отображение списка товаров в корзине.
*   Изменение количества каждого товара в корзине.
*   Удаление отдельных товаров или всех выбранных товаров из корзины.
*   Добавление/удаление товаров из избранного.
*   Отображение предупреждений, связанных с товарами (например, отсутствие в наличии).
*   Отображение сводки по заказу (общая стоимость, скидки).
*   Переход к выбору аптеки для оформления заказа.
*   Возможность поделиться содержимым корзины.
*   Обработка состояний загрузки, ошибок и пустого списка товаров.

## 2. Элементы Пользовательского Интерфейса (UI Elements)

*   **Toolbar (через MenuProvider):**
    *   **Назначение/Функция:** Содержит кнопку "Поделиться" для обмена содержимым корзины.
    *   **Взаимодействие пользователя:** Нажатие на кнопку "Поделиться" открывает системное диалоговое окно для обмена.
*   **RecyclerView:**
    *   **Назначение/Функция:** Основной контейнер для отображения секций `StateSection`, `WarningsSection`, `SelectAllSection`, `CartItemsSection` и `SummarySection`.
    *   **Взаимодействие пользователя:** Вертикальная прокрутка для просмотра содержимого.
*   **StateSection:**
    *   **Назначение/Функция:** Отображает состояния загрузки, ошибки или пустого состояния данных для списка товаров в корзине.
    *   **Возможные состояния:**
        *   `LOADING`: Показывает индикатор прогресса и сообщение "Загрузка товаров".
        *   `ERROR`: Показывает сообщение об ошибке и кнопку "Повторить".
        *   `EMPTY`: Показывает сообщение о пустой корзине с кнопкой "Перейти в топ".
        *   `HIDDEN`: Скрыт, когда данные успешно загружены и отображаются.
    *   **Взаимодействие пользователя:** Нажатие на кнопку "Повторить" (в состоянии ошибки) для повторной попытки загрузки данных. Нажатие на кнопку в пустом состоянии для перехода на главный экран.
*   **WarningsSection:**
    *   **Назначение/Функция:** Отображает список предупреждений, связанных с товарами в корзине (например, "Некоторые товары отсу��ствуют").
    *   **Взаимодействие пользователя:** Нажатие на предупреждение может открыть диалог с подробной информацией. Кнопка в предупреждении может инициировать действие (например, перенос товаров в избранное).
*   **SelectAllSection:**
    *   **Назначение/Функция:** Предоставляет флажок "Выбрать все" и кнопку "Удалить выбранные".
    *   **Возможные состояния:** Флажок может быть установлен/снят. Кнопка "Удалить выбранные" активна, если есть выбранные товары.
    *   **Взаимодействие пользователя:** Установка/снятие флажка "Выбрать все" изменяет статус выбора всех товаров. Нажатие на "Удалить выбранные" вызывает диалог подтверждения и удаляет товары.
*   **CartItemsSection:**
    *   **Назначение/Функция:** Отображает список отдельных товаров в корзине. Каждый элемент вклю��ает изображение, название, цену, количество, кнопки `+`/`-`, кнопку удаления и флажок выбора.
    *   **Взаимодействие пользователя:** Изменение количества товара, удаление товара, выбор/снятие выбора товара, добавление/удаление из избранного, переход к деталям товара.
*   **SummarySection:**
    *   **Назначение/Функция:** Отображает сводку по заказу, включая общую стоимость, скидки и т.д.
    *   **Возможные состояния:** Видима, если корзина не пуста.
    *   **Взаимодействие пользователя:** Неинтерактивный элемент.
*   **Button (checkout):**
    *   **Назначение/Функция:** Кнопка для перехода к оформлению заказа (выбору аптеки).
    *   **Возможные состояния:** Активна, если есть товары, которые можно заказать.
    *   **Взаимодействие пользователя:** Нажатие инициирует переход к экрану выбора аптеки.
*   **TextView (warning):**
    *   **Назначение/Функция:** Отображает предупреждение, связанное с оформлением заказа (например, "Не все товары доступны").
    *   **Возможные состояния:** Видима, если есть предупреждение; скрыта в противном случае.
    *   **Взаимодействие пользователя:** Неинтерактивный элемент.

## 3. Пользовательские Сценарии (User Flows)

*   **Просмотр корзины:**
    1.  Пользователь открывает экран "Корзина".
    2.  Отображается индикатор загрузки (`StateSection`).
    3.  ViewModel запрашивает товары в корзине, предупреждения и сводку.
    4.  При успешной загрузке, индикатор скрывается, и отображаются все секции с данными.
    5.  Если корзина пуста, отображается `StateSection` с сообщением о пустой корзине.
*   **Изменение количества товара:**
    1.  Пользователь нажимает `+` или `-` на карточке товара.
    2.  Количество товара обновляется, и пересчитывается сводка.
*   **Удаление товара:**
    1.  Пользователь нажимает на иконку "Удалить" на карточке товара.
    2.  Товар удаляется из корзины, и пересчитывается сводка.
*   **Выбор/снятие выбора товаров:**
    1.  Пользователь устанавливает/снимает флажок на карточке товара.
    2.  Статус выбора товара обновляется. Кнопка "Поделиться" в тулбаре и кнопка "Удалить выбранные" в `SelectAllSection` обновляют свою видимость/активность.
*   **Выбрать/Удалить все:**
    1.  Пользователь нажимает флажок "Выбрать все". Все товары в корзине выбираются/снимаются с выбора.
    2.  Пользователь нажимает "Удалить выбранные". Появляется диалог подтверждения, после которого выбранные товары удаляются.
*   **Переход к оф��рмлению заказа:**
    1.  Пользователь нажимает кнопку "Оформить заказ" (`checkout`).
    2.  В зависимости от типа заказа (`STORE` или `STOCK`), происходит навигация к соответствующему экрану выбора аптеки (`StoresForOrderFragment` или `StockStoresForOrderFragment`).
    3.  Регистрируются аналитические события.
*   **Поделиться корзиной:**
    1.  Пользователь нажимает на иконку "Поделиться" в тулбаре.
    2.  Открывается системное диалоговое окно для обмена текстом, содержащим информацию о товарах в корзине.
*   **Взаимодействие с предупреждениями:**
    1.  Пользователь нажимает на предупреждение. Может открыться диалог с подробной информацией.
    2.  Пользователь нажимает на кнопку в предупреждении (например, "Перенести в избранное"). Выполняется соответствующее действие.

## 4. Навигация

С экр��на "Корзина" возможны следующие переходы:

*   **`StoresForOrderFragment`:** Для выбора аптеки при заказе из наличия.
*   **`StockStoresForOrderFragment`:** Для выбора аптеки при заказе со склада.
*   **`ItemDetailsFragment`:** При нажатии на товар в списке корзины.
*   **`HomeFragment`:** При нажатии на кнопку "Перейти в топ" в пустом состоянии корзины.
*   **Системное диалоговое окно "Поделиться":** Для обмена содержимым корзины.
*   **Диалоговые окна:** Для подтверждения удаления, отображения ошибок или подробной информации о предупреждениях.
*   **Навигация по DeepLink:** Если кнопка предупреждения имеет deep-ссылку.

### Deep Links

На этот экран можно попасть по следующим deep links:

*   `{scheme}://{host}/cart`
*   `{scheme}://{host}/basket`

## 5. Отображаемые Данные

*   **Типы данных:**
    *   `List<Item>`: Список товаров в корзине.
    *   `List<Warning>`: Список предупреждений, связанных с корзиной.
    *   `CartViewModel.CartSummary`: Объект, содержащий ��водную информацию о корзине (стоимость, скидки).
    *   `Pair<CharSequence?, Boolean?>`: Текст предупреждения о заказе и флаг возможности оформления.
*   **Источник данных:**
    *   **API:** `ApiService.getCartItems` (REST метод: `GET /app/v6/cart/items`)
    *   **Локальное хранилище:** Таблицы Room, управляемые `ItemsDao` (для кэширования и локального управления элементами корзины).

## 6. Особые Состояния/Логика

*   **Производительность на слабых устройствах:** Для устройств с низкой производительностью аниматор элементов `RecyclerView` отключается (`viewBinding.recyclerView.itemAnimator = null`).
*   **Динамическая видимость элементов:** Кнопка "Оформить заказ", секции предупреждений, выбора всех товаров и сводки динамически изменяют свою видимость в зависимости от состояния корзины (пустая/не пустая, наличие предупреждений).
*   **Синхронизация избранного:** Метод `favsChanged` позволяет обновлять UI списка товаров при изменении статуса избранного из других частей приложения.
*   **Логирование аналитики:** Многие действия пользователя (выбор/снятие выбора товаров, очистка корзины, переход к оформлению, перенос в избранное) логируются с помощью `AnUtils.logEvent`.
*   **Обработка ошибок:** Ошибки загрузки данных и выполнения операций отображаются в виде диалоговых окон.
*   **Перенос в избранное:** Специальная логика для переноса товаров из корзины в избранное по нажатию кнопки в предупреждении.
