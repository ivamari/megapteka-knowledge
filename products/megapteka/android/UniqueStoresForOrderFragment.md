# UniqueStoresForOrderFragment

## Обзор Экрана
`UniqueStoresForOrderFragment` — это основной экран для выбора аптеки при оформлении заказа на уникальный товар (предзаказ или проверка наличия). Он предоставляет пользователю два режима просмотра: список аптек и карту аптек, между которыми можно переключаться с помощью вкладок. Фрагмент управляет применением фильтров (по адресу, маршруту), запросом разрешений на местоположение и навигацией к другим экранам для выбора адреса или подтверждения заказа.

## Элементы Пользовательского Интерфейса (UI Elements)
*   **TabLayout (Вкладки `tabs`)**:
    *   **Назначение/Функция**: Позволяет пользователю переключаться между режимами просмотра списка аптек (`UniqueStoresForOrderListFragment`) и карты аптек (`UniqueStoresForOrderMapFragment`).
    *   **Возможные состояния**: Активная вкладка "Список", активная вкладка "Карта".
    *   **Взаимодействие пользователя**: Нажатие на вкладку для переключения режима просмотра.
*   **Toolbar (Панель инструментов)**:
    *   **Назначение/Функция**: Отображает заголовок экрана (например, "Предзаказ" или "Проверка наличия") и кнопку поиска.
    *   **Возможные состояния**: Активная.
    *   **Взаимодействие пользователя**: Нажатие на кнопку поиска для перехода к поиску аптек.
*   **Список фильтров (RecyclerView `filtersRecyclerView` через `FiltersSection`)**:
    *   **Назначение/Функция**: Отображает примененные фильтры (например, по адресу, по маршруту) и позволяет взаимодействовать с ними.
    *   **Возможные состояния**: О��ображение активных фильтров, пустое состояние.
    *   **Взаимодействие пользователя**: Нажатие на фильтр для его изменения или сброса.
*   **Контейнер для фрагментов (FrameLayout `consumerContainer`)**:
    *   **Назначение/Функция**: Динамически загружает и отображает либо `UniqueStoresForOrderListFragment`, либо `UniqueStoresForOrderMapFragment` в зависимости от выбранной вкладки.
    *   **Возможные состояния**: Отображение списка или карты.
    *   **Взаимодействие пользователя**: Нет прямого взаимодействия, управляется выбором вкладки.

## Пользовательские Сценарии (User Flows)
*   **Выбор режима просмотра**: Пользователь выбирает, просматривать ли аптеки в виде списка или на карте.
*   **Применение фильтров**: Пользователь может применять фильтры по адресу или маршруту, чтобы сузить список или область поиска ��птек.
*   **Поиск аптек**: Пользователь может использовать кнопку поиска в тулбаре для поиска аптек по названию или адресу.
*   **Выбор аптеки и переход к оформлению заказа**: После выбора аптеки (как из списка, так и с карты) пользователь переходит на экран подтверждения заказа.
*   **Изменение адреса/маршрута**: Пользователь может изменить адрес доставки или задать маршрут для поиска аптек по пути следования.

## Навигация
*   **Переход на `UniqueStoresForOrderFragment`**:
    *   Осуществляется из корзины или других экранов, где инициируется заказ уникального товара.
    *   Условия перехода: Передача типа заказа (`type`), `prevOrderId` и `source` через аргументы навигации (`navArgs`).
*   **Переход с `UniqueStoresForOrderFragment`**:
    *   На экран `StoresSearchSuggestionsFragment`: При нажатии на кнопку поиска в тулбаре (`action_search`).
    *   На экран `AddressesDialog` или `AddEditAddressFragment` или `SelectOnMapFragment`: При нажатии на фильтр адреса для его изменения.
    *   На экран `RouteFragment`: При нажатии на фильтр маршрута для его изменения.
    *   На экран `OrderConfirmFragment`: После выбора аптеки (`actionToOrderConfirm`) с передачей выбранной аптеки, типа заказа, `orderUuid` и `prevOrderId`.

### Deep Links

На этот экран нет прямых deep links.

## Отображаемые Данные
*   **Типы данных**: Список фильтров (`CheckFilterable`), информация о текущем городе, товарах в корзине, выбранной аптеке.
*   **Источники данных**:
    *   **API:**
        *   `ApiService.checkPreorderOrder` (REST метод: `GET /app/v1/preorders/check`) - для проверки предзаказа.
        *   `ApiService.checkDiscountedOrder` (REST метод: `GET /app/v1/discounted/orders/check`) - для проверки уцененного заказа.
        *   `ApiService.getAddresses` (REST метод: `GET clients/addresses`) - для получения списка адресов.
        *   `ApiService.getRoutes` (REST метод: `POST /app/v1/routing/car`) - для построения маршрутов.
        *   `ApiService.getStoresSearchSuggestions` (REST метод: `GET /app/v1/stores/search-suggestions`) - для получения подсказок по поиску аптек.
    *   **Локальное хранилище:**
        *   Таблица `AddressDao` (для кэширования адресов).
        *   Таблица `CitiesDao` (для пол��чения текущего города).
        *   `SavedStateHandle` (для хранения `type`, `prevOrderId`).

## Особые Состояния/Логика

### 6.1. Логика Фильтрации
Экран использует абстрактный класс `Filterable` для представления различных типов фильтров. Для фильтрации аптек применяются различные реализации `CheckFilterable`, такие как `DistanceFilterable` (по расстоянию), `OpennessFilterable` (по открытости), `AroundTheClockFilterable` (круглосуточные) и `AccessibilityFilterable` (по доступности). Управление фильтрами происходит через `FiltersSection`, который позволяет пользователю выбирать и применять значения фильтров, обновляя список аптек.

*   **Управление вкладками**: Фрагмент динамически добавляет и скрывает дочерние фрагменты (`UniqueStoresForOrderListFragment` и `UniqueStoresForOrderMapFragment`) в зависимости от выбранной вкладки, используя `childFragmentManager`.
*   **Сохранение состояния**: Выбранная вкладка сохраняется при изменении конфигурации (например, повороте экрана) с помощью `onSaveInstanceState`.
*   **Обработка результатов из других фрагментов**: Фрагмент слушает результаты из `AddressesDialog`, `AddEditAddressFragment`, `SelectOnMapFragment`, `StoresSearchSuggestionsFragment` и `RouteFragment` для применения соответствующих фильтров.
*   **Разрешения на местоположение**: Запрашивает разрешение `ACCESS_FINE_LOCATION` при создании фрагмента.
*   **Обработка ошибок маршрута**: При возникновении ошибки при построении маршрута отображается диалог с сообщением.
*   **Аналитика**: Отслеживаются события изменения состояния экрана (переключение вкладок), нажатия на фильтры, применения фильтров и выбора аптеки.
*   **ViewModel Scope**: Фрагмент использует `navGraphViewModels` для получения `UniqueStoresForOrderViewModel`, что позволяет ему разделять данные и логику с дочерними фрагментами.
