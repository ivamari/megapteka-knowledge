# RouteFragment

## 1. Обзор Экрана

Экран "Маршрут" (RouteFragment) позволяет пользователю построить маршрут между двумя точками: точкой А (начало маршрута) и точкой Б (конец маршрута). Пользователь может выбрать эти точки из списка сохраненных адресов или указать их на карте. После выбора точек маршрут может быть построен с использованием внешних картографических приложений.

**Основные функции:**
*   Выбор начальной и конечной точек маршрута.
*   Выбор точек из списка сохраненных адресов.
*   Возможность указать точку на карте.
*   Построение маршрута с использованием внешних картографических приложений.
*   Обработка состояний выбора точек и валидация.

## 2. Элементы Пользовательского Интерфейса (UI Elements)

*   **Toolbar (через MenuProvider):**
    *   **Назначение/Функция:** Содержит кнопку "Сохранить" (или "Построить маршрут") для подтверждения выбора точек и построения маршрута.
    *   **Взаимодействие пользователя:** Нажатие на кнопку инициирует валидацию и построение маршрута.
*   **RecyclerView:**
    *   **Назначение/Функция:** Основной контейнер для отображения секций `HeaderSection`, `DestinationsSection`, `AddressesHeaderSection` и `AddressesSection`.
    *   **Взаимодействие пользователя:** Вертикальная прокрутка для просмотра содержимого.
*   **HeaderSection:**
    *   **Назначение/Функция:** Отображает заголовок экрана "Построить маршрут".
    *   **Взаимодействие пользователя:** Неинтерактивный элемент.
*   **DestinationsSection:**
    *   **Назначение/Функция:** Отображает выбранные точки А и Б. Позволяет выбрать, какую точку по��ьзователь хочет установить следующей.
    *   **Взаимодействие пользователя:** Нажатие на элемент (например, "Точка А") активирует его для выбора адреса. При выборе адреса, он отображается в соответствующем поле.
*   **AddressesHeaderSection:**
    *   **Назначение/Функция:** Отображает заголовок для списка адресов, который меняется в зависимости от того, какую точку (А или Б) пользователь выбирает.
    *   **Взаимодействие пользователя:** Неинтерактивный элемент.
*   **AddressesSection:**
    *   **Назначение/Функция:** Отображает список сохраненных адресов пользователя, из которых можно выбрать точку маршрута.
    *   **Взаимодействие пользователя:** Нажатие на адрес выбирает его как текущую точку маршрута. Если адрес является `NearPointAddress`, происходит навигация к экрану выбора на карте.
*   **Button (buildRoute):**
    *   **Назначение/Функция:** Кнопка для построения маршрута.
    *   **Возможные состояния:** Активна, если обе точки маршрута выбраны.
    *   **Взаимодействие пользователя:** Нажатие инициирует валидацию и построение маршрута.

## 3. Пользовательские Сценарии (User Flows)

*   **Выбор точек маршрута:**
    1.  Пользователь открывает экран "Маршрут".
    2.  По умолчанию, одна из точек (например, Точка А) может быть активна для выбора.
    3.  Пользователь выбирает точку (А или Б) в `DestinationsSection`.
    4.  Заголовок `AddressesHeaderSection` меняется, указывая, какую точку нужно выбрать.
    5.  Пользователь выбирает адрес из `AddressesSection`.
    6.  Если выбранный адрес является `NearPointAddress`, происходит навигация к экрану `SelectOnMapFragment` для точного указания на карте.
    7.  После выбора адрес��, он отображается в соответствующем поле `DestinationsSection`.
    8.  Пользователь повторяет процесс для второй точки.
*   **Построение маршрута:**
    1.  После выбора обеих точек, пользователь нажимает кнопку "Построить маршрут" (`buildRoute`) или кнопку "Сохранить" в тулбаре.
    2.  Происходит валидация: если одна из точек не выбрана, отображается диалог с предупреждением.
    3.  Если обе точки выбраны, их координаты передаются обратно на предыдущий экран через `setFragmentResult`, и экран закрывается.

## 4. Навигация

С экрана "Маршрут" возможны следующие переходы:

*   **`SelectOnMapFragment`:** Для выбора адреса на карте (если выбран адрес типа `NearPointAddress`).
*   **Назад к предыдущему экрану:** После успешного построения маршрута или при нажатии кнопки "Назад" в тулбаре/системной кнопки "Назад".
*   **Диалоговые окна:** Для отображения предупреждений (например, о невыбранных точках).

### Deep Links

На этот экран нет прямых deep links.

## 5. Отображаемые Данные

*   **Типы данных:**
    *   `Address`: Объект, представляющий адрес, который может быт�� `NearMeAddress` (текущее местоположение) или `NearPointAddress` (адрес с координатами).
    *   `List<Address>`: Список сохраненных адресов пользователя.
*   **Источник данных:**
    *   **API:** `ApiService.getAddresses` (REST метод: `GET clients/addresses`) - для получения списка сохраненных адресов пользователя.
    *   **Локальное хранилище:** Таблица `AddressDao` (для кэширования адресов).
    *   **Входящие аргументы (`navArgs`):** Радиус (`args.radius`).
    *   **`FragmentResultListener`:** Для получения выбранного адреса с экрана `SelectOnMapFragment`.

## 6. Особые Состояния/Логика

*   **Производительность на слабых устройствах:** Для устройств с низкой производительностью анима��ор элементов `RecyclerView` отключается (`viewBinding.recyclerView.itemAnimator = null`).
*   **Динамическое обновление заголовка:** Заголовок `AddressesHeaderSection` меняется в зависимости от того, какую точку (А или Б) пользователь выбирает.
*   **Валидация:** Перед построением маршрута проверяется, что обе точки выбраны. Если нет, отображается предупреждение.
*   **Передача результатов:** Выбранные точки А и Б передаются обратно на предыдущий экран через `setFragmentResult` с использованием `REQUEST_KEY_ROUTE`, `RESULT_KEY_DESTINATION_A` и `RESULT_KEY_DESTINATION_B`.
*   **Декорация элементов:** Используется `DividerSectionItemDecoration` для добавления разделителей между секциями в `RecyclerView`.
