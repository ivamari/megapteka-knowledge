# StoresSearchSuggestionsFragment

## 1. Обзор Экрана

Экран "Поиск адреса аптеки" (StoresSearchSuggestionsFragment) предназначен для помощи пользователю в поиске аптек путем предоставления поисковой строки и отображения подсказок по мере ввода текста. Он также информирует пользователя о наличии метро в текущем городе и обрабатывает выбор подсказок для дальнейшей навигации.

**Основные функции:**
*   Поиск адресов аптек по текстовому запросу.
*   Отображение подсказок по мере ввода текста.
*   Информирование о наличии метро в текущем городе.
*   Выбор подсказки и возврат ее на предыдущий экран.
*   Обработка состояний загрузки, ошибок и пустого списка под��казок.

## 2. Элементы Пользовательского Интерфейса (UI Elements)

*   **Toolbar (через MenuProvider):**
    *   **Назначение/Функция:** Содержит поисковую строку (`SearchView`) для ввода запроса.
    *   **Взаимодействие пользователя:** Ввод текста в `SearchView` инициирует поиск подсказок.
*   **SearchView (action_search в меню):**
    *   **Назначение/Функция:** Поле для ввода поискового запроса. Всегда видимо и не сворачивается.
    *   **Взаимодействие пользователя:** Ввод текста для фильтрации списка подсказок. Запросы отправляются с задержкой (debounce) для оптимизации производительности. При отправке запроса, клавиатура скрывается.
*   **RecyclerView:**
    *   **Назначение/Функция:** Основной контейнер для отображения секций `NoticeSection`, `SuggestionsSection` и `StateSection`.
    *   **Взаимодействие пользователя:** Вертикальная прокрут��а для просмотра содержимого.
*   **StateSection:**
    *   **Назначение/Функция:** Отображает состояния загрузки, ошибки или пустого состояния данных для списка подсказок.
    *   **Возможные состояния:**
        *   `LOADING`: Показывает индикатор прогресса и сообщение "Загрузка адресов".
        *   `ERROR`: Показывает сообщение об ошибке и кнопку "Повторить".
        *   `EMPTY`: Показывает сообщение о пустом результате поиска с возможностью сброса фильтров или перехода по ссылке.
        *   `HIDDEN`: Скрыт, когда данные успешно загружены и отображаются.
    *   **Взаимодействие пользователя:** Нажатие на кнопку "Повторить" (в состоянии ошибки) для повторной попытки загрузки данных.
*   **NoticeSection:**
    *   **Назначение/Функция:** Отображает информационное сообщение о поиске аптек, зависящее от нали��ия метро в текущем городе.
    *   **Возможные состояния:** Видима, если поисковая строка пуста; скрыта при вводе текста.
    *   **Взаимодействие пользователя:** Неинтерактивный элемент.
*   **SuggestionsSection:**
    *   **Назначение/Функция:** Отображает список подсказок адресов аптек по мере ввода текста.
    *   **Возможные состояния:** Видима, если есть подсказки; скрыта в противном случае.
    *   **Взаимодействие пользователя:** Нажатие на подсказку выбирает ее и возвращает на предыдущий экран.
*   **TextView (hint):**
    *   **Назначение/Функция:** Отображает подсказку, когда клавиатура скрыта.
    *   **Возможные состояния:** Видима, если клавиатура скрыта; скрыта в противном случае.
    *   **Взаимодействие пользователя:** Неинтерактивный элемент.

## 3. Пользовательские Сценарии (User Flows)

*   **Поиск адреса аптеки:**
    1.  Пользователь открывает экран "Поиск адреса аптеки".
    2.  Отображается информационное сообщение (`NoticeSection`) и, возможно, подсказка (`hint`).
    3.  Пользователь вводит текст в поисковую строку.
    4.  По мере ввода, ViewModel запрашивает подсказки (`viewModel.setQuery()`).
    5.  Отображается индикатор загрузки (`StateSection`).
    6.  При получении результатов, `SuggestionsSection` отображает найденные подсказки.
    7.  Если результатов нет, отображается `StateSection` с сообщением о пустом поиске.
    8.  Регистрируется аналитическое событие `AnEvent.storesSearchTextChanged()`.
*   **Выбор подсказки:**
    1.  Пользователь нажимает на любую подсказку в списке.
    2.  Регистрируется аналитическое событие `AnEvent.storeSuggestClick()`.
    3.  Клавиатура скрывается.
    4.  Выбранная подсказка передается о��ратно на предыдущий экран через `setFragmentResult`, и экран "Поиск адреса аптеки" закрывается.
*   **Обработка ошибок загрузки:**
    1.  При возникновении ошибки загрузки данных, `StateSection` отображает сообщение об ошибке и кнопку "Повторить".
    2.  Нажатие на кнопку "Повторить" инициирует повторную попытку загрузки данных.

## 4. Навигация

С экрана "Поиск адреса аптеки" возможны следующие переходы:

*   **Назад к предыдущему экрану:** После выбора подсказки или при нажатии кнопки "Назад" в тулбаре/системной кнопки "Назад".

### Deep Links

На этот экран нет прямых deep links.

## 5. Отображаемые Данные

*   **Типы данных:**
    *   `List<StoreSearchSuggest>`: Список объектов `StoreSearchSuggest`, каждый из которых представляет подсказку адреса аптеки.
    *   `City`: Текущий город пользователя.
    *   `Resource<SingleListResponse<StoreSearchSuggest>>`: Для отслеживания статуса загрузки подсказок.
*   **Источник данных:**
    *   **API:**
        *   `ApiService.getStoresSearchSuggestions` (REST метод: `GET /app/v1/stores/search-suggestions`) - для получения подсказок адресов аптек.
        *   `ApiService.getRegionsWithCities` (REST метод: `GET /app/v1/cities`) или `ApiService.getGuessedCity` (REST метод: `GET /app/v1/cities/locate`) - для получения информации о текущем городе.
    *   **Локальное хранилище:** Таблица `CitiesDao` (для получения текущего города).
    *   **Ввод пользователя:** Текстовый ввод в поисковую строку.

## 6. Особые Состояния/Логика

*   **Производительность на слабых устройствах:** Для устройств с низкой производительностью аниматор элементов `RecyclerView` отключается (`viewBinding.recyclerView.itemAnimator = null`).
*   **Динамическая ширина `SearchView`:** Максимальная ширина `SearchView` динамически рассчитывается, чтобы она не перекрывала другие элементы меню.
*   **Оптимизация поиска:** Используется `debounce` и `distinctUntilChanged` для предотвращения частых з��просов при вводе текста в `SearchView`.
*   **Динамическая видимость элементов:** `NoticeSection` и `hint` отображаются/скрываются в зависимости от того, пуста ли поисковая строка и видна ли клавиатура.
*   **Обработка ошибок:** Ошибки загрузки подсказок отображаются через `StateSection`.
*   **Передача результатов:** Выбранная подсказка передается обратно на предыдущий экран через `setFragmentResult` с использованием `REQUEST_KEY_SUGGEST` и `RESULT_KEY_SUGGEST`.
*   **Логирование аналитики:** Поиск и выбор подсказок логируются с помощью `AnUtils.logEvent`.
