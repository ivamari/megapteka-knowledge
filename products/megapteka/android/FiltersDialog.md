# FiltersDialog

## 1. Обзор Экрана

`FiltersDialog` — это нижний диалог (BottomSheetDialogFragment), который предоставляет пользователю возможность применять фильтры к списку товаров. Он динамически отображает доступные фильтры и их значения, позволяя пользователю выбирать нужные опции и сбрасывать их. Этот диалог тесно связан с экранами, отображающими списки товаров (например, `BaseItemsFragment`).

**Основные функции:**
*   Динамическое отображение списка фильтров и их значений.
*   Выбор/снятие выбора значений фильтров.
*   Применение выбранных фильтров к списку товаров.
*   Сброс всех примененных фильтров.
*   Обработка состояний UI в зависимости от наличия фильтров.

## 2. Элементы Пользовательского Интерфейса (UI Elements)

*   **RecyclerView:**
    *   **Назначение/Функция:** Основной контейнер для динамического отображения секций заголовков фильтров (`TextHeaderSection`) и секций значений фильтров (`FilterValuesSection`).
    *   **Взаимодействие пользователя:** Вертикальная прокрутка для просмотра всех фильтров.
*   **TextHeaderSection:**
    *   **Назначение/Функция:** Отображает название каждой категории фильтров (например, "Производитель", "Форма выпуска").
    *   **Взаимодействие пользователя:** Неинтерактивный элемент.
*   **FilterValuesSection:**
    *   **Назначение/Функция:** Отображает список доступных значений для конкретного фильтра (например, "Таблетки", "Капсулы"). Поддерживает выбор нескольких значений.
    *   **Возможные состояния:** Список значений, выбранные/н��выбранные значения.
    *   **Взаимодействие пользователя:** Нажатие на значение для его выбора или снятия выбора. Изменения немедленно применяются к ViewModel.
*   **Button (show):**
    *   **Назначение/Функция:** Кнопка "Показать", которая закрывает диалог и, по сути, подтверждает применение фильтров (хотя применение происходит по мере выбора).
    *   **Возможные состояния:** Видима, если есть доступные фильтры; скрыта в противном случае.
    *   **Взаимодействие пользователя:** Нажатие закрывает диалог.
*   **Button (reset):**
    *   **Назначение/Функция:** Кнопка "Сбросить", которая очищает все выбранные фильтры и закрывает диалог.
    *   **Взаимодействие пользователя:** Нажатие сбрасывает фильтры и закрывает диалог.

## 3. Пользовательские Сценарии (User Flows)

*   **Применение фильтров:**
    1.  Пользователь открывает `FiltersDialog` (обычно с экрана списка товаров).
    2.  Диалог загружает метаданные фильтров из ViewModel родительского фрагмента (`BaseItemsViewModel`).
    3.  Отображаются категории фильтров и их значения.
    4.  Пользователь выбирает одно или несколько значений в различных категориях.
    5.  При каждом изменении выбора, `viewModel.applyFilterValuesCodes()` вызывается для немедленного применения фильтров к данным.
    6.  Пользователь нажимает кнопку "Показать" для закрытия диалога.
*   **Сброс фильтров:**
    1.  Пользователь нажимает кнопку "Сбросить".
    2.  Все выбранные значения фильтров очищаются через `viewModel.applyFilterValuesCodes(null)`.
    3.  Диалог закрывается.

## 4. Навигация

С диалога `FiltersDialog` возможны следующие действия:

*   **Закрытие диалога:** При нажатии кнопок "Показать" или "Сбросить", а также при нажатии кнопки "Назад" на устройстве.

### Deep Links

На этот экран нет прямых deep links.

## 5. Отображаемые Данные

*   **Типы данных:**
    *   `Meta`: Объект, содержащий метаданные, включая информацию о доступных фильтрах (`itemsMeta.filters`). Каждый фильтр имеет `name` и `values`, где каждое значение имеет `code` и `isSelected`.
*   **Источник данных:**
    *   **API:** Различные методы `ApiService`, которые возвращают `Meta` с информацией о фильтрах (например, `ApiService.getSearchItemsByQuery`, `ApiService.getCatalogItems`, `ApiService.getFavoriteItems`, `ApiService.getAnalogsItems`, `ApiService.getGoodsItems`, `ApiService.getOrderedItems`, `ApiService.getItemsForReview`, `ApiService.getRatedItems`).
    *   **Локальное хранилище:** Нет прямого использования локального хранилища для самих фильтров.

## 6. Особые Состояния/Логика

*   **Динамическое построение UI:** Интерфейс фильтров полностью строится динамически на основе данных, полученных из `Meta` объекта. Для каждого фильтра создается заголовок и секция значений.
*   **Производительность на слабых устройствах:** Для устройств с низкой производительностью аниматор элементов `RecyclerView` отключается (`viewBinding.recyclerView.itemAnimator = null`).
*   **BottomSheetBehavior:** Диалог всегда развернут (`BottomSheetBehavior.STATE_EXPANDED`) при открытии.
*   **Обновление адаптера:** При получении новых метаданных фильтров, `RecyclerView` обновляется с помощью `swapAdapter` для эффективного перестроения списка.
*   **Декорация элементов:** Используется `DividerSectionItemDecoration` для добавления разделителей между секциями фильтров.
*   **Синхронизация с ViewModel:** Изменения выбора фильтров немедленно передаются в ViewModel через `onCheckChanged` колбэк, что позволяет ViewModel обновить список товаров в фоновом режиме.