# AddEditAddressFragment

## 1. Обзор Экрана

Экран "Добавить/Редактировать адрес" (AddEditAddressFragment) позволяет пользователю добавлять новый адрес или редактировать существующий. Экран включает в себя интерактивную карту для выбора местоположения, поля для ввода названия и адреса, а также функциональность для сохранения или удаления адреса. Он поддерживает автоматическое определение местоположения и подсказки по адресу.

**Основные функции:**
*   Добавление нового адреса.
*   Редактирование существующего адреса.
*   Выбор адреса на карте с возможностью геокодирования.
*   Автоматическое определение текущего местоположения пользователя.
*   Предоставление подсказок при вводе адреса.
*   Сохранение �� удаление адресов.
*   Обработка разрешений на доступ к местоположению.

## 2. Элементы Пользовательского Интерфейса (UI Elements)

*   **Toolbar:**
    *   **Назначение/Функция:** Отображает заголовок экрана ("Добавить адрес" или "Редактировать адрес") и содержит кнопку меню для удаления адреса.
    *   **Взаимодействие пользователя:** Нажатие на кнопку меню "Очистить" (если адрес существует) вызывает диалог подтверждения удаления.
*   **MapView (DGis):**
    *   **Назначение/Функция:** Интерактивная карта для выбора местоположения адреса. Отображает маркер в центре карты.
    *   **Взаимодействие пользователя:** Перемещение карты изменяет центральную точку, которая используется для геокодирования адреса. Кнопки `+` и `-` для масштабирования карты. Кнопка определения местоположения пользователя.
*   **TextInputLayout (nameInput):**
    *   **Назначение/Функция:** Поле для ввода названия адреса (например, "Дом", "Работа", "Мой адрес").
    *   **Возможные состояния:** Активное/неактивное, с текстом/пустое. Может иметь иконку "Редактировать" или "Очистить текст".
    *   **Взаимодействие пользователя:** Ввод текста, нажатие на иконку для редактирования/очистки.
*   **TextInputLayout (addressInput):**
    *   **Назначение/Функция:** Поле для ввода самого адреса. Используется для отображения геокодированного адреса или для ручного ввода.
    *   **Возможные состояния:** Активное/неактивное, с текстом/пустое, с ошибкой (красный текст).
    *   **Взаимодействие пользователя:** Ввод текста, нажатие на иконку для редактирования/очистки. При потере фокуса происходит геокодирование, есл�� адрес не выбран из подсказок.
*   **RecyclerView (для SuggestionsSection):**
    *   **Назначение/Функция:** Отображает список подсказок адресов при вводе текста в поле адреса.
    *   **Взаимодействие пользователя:** Выбор подсказки из списка для автоматического заполнения поля адреса и перемещения карты.
*   **BottomSheet (bottomSheet):**
    *   **Назначение/Функция:** Нижняя панель, содержащая поля ввода адреса и кнопку сохранения. Может быть свернута или развернута.
    *   **Взаимодействие пользователя:** Свайп вверх/вниз для разворачивания/сворачивания. При сворачивании скрывает клавиатуру и инициирует геокодирование центра карты.
*   **Button (button):**
    *   **Назначение/Функция:** Кнопка для сохранения изменений или добавления нового адреса.
    *   **Возможные состояния:** Активная/неактивная (зависит от заполненности полей).
    *   **Взаимодействие пользователя:** Нажатие для сохранения адреса.
*   **ImageView (plus, minus):**
    *   **Назначение/Функция:** Кнопки для увеличения/уменьшения масштаба карты.
    *   **Взаимодействие пользователя:** Нажатие для изменения масштаба карты.
*   **ImageView (userLocation):**
    *   **Назначение/Функция:** Кнопка для центрирования карты по текущему местоположению пользователя.
    *   **Взаимодействие пользователя:** Нажатие для запроса разрешений на местоположение и перемещения карты.
*   **TextView (hint, error):**
    *   **Назначение/Функция:** Отображают подсказки или сообщения об ошибках под полем адреса.
    *   **Возможные состояния:** Видимые/скрытые в зависимости от состояния ввода и наличия ошибки.

## 3. Пользовательские Сценарии (User Flows)

*   **Добавление нового адреса:**
    1.  Пользователь открывает экран "Добавить адрес".
    2.  Карта центрируется по текущему местоположению или местоположению текущего города.
    3.  Пользователь вводит название адреса (если не "Дом"/"Работа").
    4.  Пользователь вводит адрес в поле, получает подсказки и выбирает один из них, или перемещает карту для выбора местоположения.
    5.  Кнопка "Сохранить адрес" становится активной.
    6.  Пользователь нажимает "Сохранить адрес".
    7.  Адрес сохраняется, и экран закрывается.
*   **Редактирование существующего адреса:**
    1.  Пользователь открывает экран "Редактировать адрес" с предзаполненными данными.
    2.  Пользователь изменяет название или местоположение адреса.
    3.  Кнопка "Сохранить изменения" становится акти��ной.
    4.  Пользователь нажимает "Сохранить изменения".
    5.  Изменения сохраняются, и экран закрывается.
*   **Удаление адреса:**
    1.  На экране редактирования пользователь нажимает на иконку меню в тулбаре.
    2.  Выбирает "Очистить".
    3.  Появляется диалог подтверждения.
    4.  Пользователь подтверждает удаление.
    5.  Адрес удаляется, и экран закрывается.
*   **Использование текущего местоположения:**
    1.  Пользователь нажимает кнопку "Мое местоположение".
    2.  Если разрешения не предоставлены, запрашиваются разрешения на доступ к местоположению.
    3.  Если разрешения предоставлены, карта центрируется по текущему местоположению пользователя.
*   **Взаимодействие с картой:**
    1.  Пользователь перемещает карту.
    2.  При остановке движения карты (CameraState.FREE) происходит геокодирование центральной точки карты.
    3.  Результат геокодирования отображается в поле адреса.

## 4. Навигация

С экрана "Добавить/Редактировать адрес" возможны следующие переходы:

*   **Назад к предыдущему экрану:** После успешного сохранения/удаления адреса или при нажатии кнопки "Назад" в тулбаре.
*   **Системные настройки приложения:** Если пользователь отказывает в предоставлении разрешений на местоположение и нажимает кнопку "Перейти в настройки" в диалоге.

### Deep Links

На этот экран нет прямых deep links.

## 5. Отображаемые Данные

*   **Типы данных:**
    *   `Address`: Объект, представляющий адрес, включающий название, широту, долготу и текстовое представление адреса.
    *   `AddressSuggest`: Объект, представляющий подсказку адреса, содержащий название, широту и долготу.
*   **Ист��чник данных:**
    *   **API:**
        *   `ApiService.getAddressSuggestions` (REST метод: `GET /app/v1/geocode/suggestions`) - для получения подсказок адресов.
        *   `ApiService.sendAddress` (REST метод: `POST clients/addresses` или `PUT clients`) - для сохранения адреса.
        *   `ApiService.deleteAddress` (REST метод: `DELETE clients/addresses`) - для удаления адреса.
        *   `ApiService.getCoordinatesSuggest` (REST метод: `GET /app/v1/geocode/address`) - для геокодирования координат.
    *   **Локальное хранилище:** Таблица `AddressDao` (для сохранения и удаления адресов локально).

## 6. Особые Состояния/Логика

*   **Обработка разрешений на местоположение:** При попытке получить текущее местоположение, приложение запрашивает необходимые разрешения. Если разрешения постоянно отклонены, пользователю предлагается перейти в системные настройки.
*   **Состояния BottomSheet:** Нижняя панель автоматичес��и сворачивается при потере фокуса полем адреса и разворачивается при его получении. Это также влияет на видимость кнопки "На карту".
*   **Валидация полей:** Кнопка сохранения/добавления адреса активируется только при наличии названия и выбранной подсказки адреса (или геокодированного адреса).
*   **Обработка ошибок сохранения/удаления:** При ошибке сохранения адреса отображается диалог с сообщением об ошибке. При ошибке удаления адреса также отображается диалог.
*   **Автоматическое заполнение названия:** Если адрес помечен как "Дом" или "Работа", поле названия автоматически заполняется и становится нередактируемым.
*   **Редактирование выбранного адреса:** После выбора подсказки адреса, поле адреса становится неактивным с иконкой "Редактировать". Нажатие на иконку позволяет снова редактировать адрес, очищая текущую подсказку.