# OrderSuccessFragment

## 1. Обзор Экрана

Экран "Успешно оформленный заказ" (OrderSuccessFragment) отображается после успешного оформления заказа. Он информирует пользователя о статусе заказа, предлагает дополнительные действия (например, перейти к заказам, включить уведомления, подписаться на Telegram-канал) и может показывать специальные предложения.

**Основные функции:**
*   Подтверждение успешного оформления заказа.
*   Отображение заголовка и сообщения, зависящих от типа заказа.
*   Отображение информации о сроке годности (для уцененных товаров) и необходимости рецепта.
*   Предложение подписаться на Telegram-канал.
*   Отображение специальных предложений (offer).
*   Возможность перейти к списку заказов.
*   Предложение включить уведомления, если они отключены.
*   Возможность поделиться информацией о заказе.
*   Обработка запроса разрешений на уведомления.

## 2. Элементы Пользовательского Интерфейса (UI Elements)

*   **Toolbar (через MenuProvider):**
    *   **Назначение/Функция:** Содержит кнопку "Поделиться" для обмена информацией о заказе.
    *   **Взаимодействие пользователя:** Нажатие на кнопку "Поделиться" открывает системное диалоговое окно для обмена.
*   **ImageView (successImage):**
    *   **Назначение/Функция:** Отображает изображение, символизирующее успешное оформление заказа. Скрыто, если есть специальное предложение.
    *   **Взаимодействие пользователя:** Неинтерактивный элемент.
*   **LinearLayout (offer):**
    *   **Назначение/Функция:** Контейнер для отображения специального предложения (например, от Flocktory). Видим, если есть предложение.
    *   **Взаимодействие пользователя:** Неинтерактивный элемент.
*   **TextView (offerText):**
    *   **Назначение/Функция:** Отображает текст специального предложения.
    *   **Взаимодействие пользователя:** Неинтерактивный элемент.
*   **Button (offerButton):**
    *   **Назначение/Функция:** Кнопка действия для специального предложения.
    *   **Взаимодействие пользователя:** Нажатие переводит по ссылке, связанной с предложением.
*   **TextView (title):**
    *   **Назначение/Функция:** Отображает основной заголовок экрана (например, "Заказ оформлен!"). Текст зависит от типа заказа.
    *   **Взаимодействие пользователя:** Неинтерактивный элемент.
*   **TextView (shelf):**
    *   **Назначение/Функция:** Отображает информацию о сроке годности для уцененных товаров.
    *   **Возможные состояния:** Видима, если тип заказа `DISCOUNTED`; скрыта в противном случае.
    *   **Взаимодействие пользователя:** Неинтерактивный элемент.
*   **TextView (recipe):**
    *   **Назначение/Функция:** Отображает информацию о необходимости рецепта для товаров в заказе.
    *   **Возможные состояния:** Видима, если заказ содержит товары по рецепту; скрыта в противном случае.
    *   **Взаимодействие пользователя:** Неинтерактивный элемент.
*   **TextView (subscribeTelegram):**
    *   **Назначение/Функция:** Кнопка-ссылка для подписки на Telegram-канал.
    *   **Возможные состояния:** Видима, если доступен URL Telegram-каканала.
    *   **Взаимодействие пользователя:** Нажатие переводит по ссылке Telegram.
*   **TextView (message):**
    *   **Назначение/Функция:** Отображает основное сообщение о благодарности за заказ, а также предложения включить уведомления и подписаться на Telegram-канал.
    *   **Взаимодействие пользователя:** Содержит кликабельные части текста для перехода к списку заказов или системным настройкам уведомлений.
*   **Button (close):**
    *   **Назначение/Функция:** Кнопка для закрытия экрана.
    *   **Взаимодействие пользователя:** Нажатие закрывает экран и, в зависимости от предыдущего состояния, может вернуться в корзину или на главный экран.

## 3. Пользовательские Сценарии (User Flows)

*   **Просмотр подтверждения заказа:**
    1.  Пользователь открывает экран "Успешно оформленный заказ", передавая `OrderingResult` и тип заказа.
    2.  Отображается заголовок и сообщение, зависящие от типа заказа.
    3.  Отображается информация о сроке годности (если применимо) и рецепте.
    4.  Если есть специальное предложение, оно отображается вместо изображения успеха.
    5.  Если доступен Telegram-канал, отображается кнопка для подписки.
    6.  Если уведомления отключены, в сообщении предлагается их включить.
*   **Переход к списку заказов:**
    1.  Пользователь нажимает на кликабельную часть текста в сообщении ("Мои заказы").
    2.  Происходит навигация к экрану списка заказов (`OrdersFragment`).
*   **Включение уведомлений:**
    1.  Пользователь нажимает на кликабельную часть текста в сообщении ("Включить уведомления").
    2.  Открываются системные настройки уведомлений для приложения.
*   **Подписка на Telegram:**
    1.  Пользователь нажимает на кнопку "Подписаться на Telegram" или на кликабельную част���� текста в сообщении.
    2.  Происходит навигация по ссылке Telegram.
*   **Взаимодействие со специальным предложением:**
    1.  Пользователь нажимает на кнопку действия в секции предложения.
    2.  Происходит навигация по ссылке, связанной с предложением.
*   **Закрытие экрана:**
    1.  Пользователь нажимает кнопку "Закрыть".
    2.  Экран закрывается. Если заказ был оформлен из корзины и в корзине остались товары, происходит возврат в корзину. В противном случае, происходит переход на главный экран.
*   **Поделиться информацией о заказе:**
    1.  Пользователь нажимает на иконку "Поделиться" в тулбаре.
    2.  Открывается системное диалоговое окно для обмена текстом, содержащим информацию о заказе.
*   **Запрос разрешений на уведомления:**
    1.  При создании экрана, если требуется разрешение на отправку уведомлений, оно запрашивается у пользователя.

## 4. Навигация

С экрана "Успешно оформленный заказ" возможны следующие переходы:

*   **`OrdersFragment`:** Для просмотра списка заказов.
*   **`HomeFragment`:** Для перехода на главный экран.
*   **`CartFragment`:** Для возврата в корзину (если остались товары).
*   **Системные настройки уведомлений:** Для управления разрешениями на уведомления на уровне ОС.
*   **Внешние приложения (Telegram, браузер):** Для перехода по ссылкам.
*   **Системное диалоговое окно "Поделиться":** Для обмена информацией о заказе.
*   **Навигация по DeepLink:** Если предложение или ссылка Telegram имеют deep-ссылку.

### Deep Links

На этот экран нет прямых deep links.

## 5. Отображаемые Данные

*   **Типы данных:**
    *   `OrderingResult`: Объект, содержащий результат оформления заказа (заголовок успеха, сообщение для обмена, список успешных заказов, предложение, URL Telegram, флаг `isNorecipe`).
    *   `OrderType`: Тип оформленного заказа.
    *   `Boolean`: Статус системных уведомлений (`viewModel.notificationsEnabled()`).
*   **Источник данных:**
    *   **Входящие аргументы (`navArgs`):** Результат оформления заказа (`args.orderingResult`), тип заказа (`args.type`), ID предыдущего заказа (`args.prevOrderId`).
    *   **Локальное хранилище:** Таблица `ItemsDao` (для проверки наличия товаров в корзине).
    *   **Системные службы:** `NotificationManagerCompat` (для проверки статуса системных уведомлений).

## 6. Особые Состояния/Логика

*   **Доступность:** Экран устанавливает фокус доступности на корневой элемент и отправляет событие `TYPE_VIEW_SELECTED` для улучшения работы скринридеров.
*   **Динамический текст:** Заголовок и сообщение экрана динамически формируются в зависимости от типа заказа и наличия уведомлений/Telegram-ссылки.
*   **Условная видимость элементов:** Изображение успеха или секция предложения отображаются в зависимости от наличия предложения. Кнопка подписки на Telegram видна, если URL доступен.
*   **Кликабельные части текста:** Используется `addTextViewWordClickable` для создания кликабельных частей текста в сообщении, которые инициируют навигацию.
*   **Логирование аналитики:** Все действия пользователя (закрытие экрана, переход к заказам, включение уведомлений, подписка на Telegram, выбор предложения, обмен) логируются с помощью `AnUtils.logEvent`.
*   **Обработка разрешений:** Запрашивается разрешение на отправку уведомлений, если оно еще не предоставлено.