# SpecialDetailFragment

## 1. Обзор Экрана

Экран "Детальная мегасовета" (SpecialDetailFragment) предназначен для отображения подробной информации о специальных предложениях или акциях (мегасоветах). Он представляет собой динамически генерируемую страницу, состоящую из различных блоков контента, таких как текст, изображения, видео и списки товаров. Пользователь может просматривать контент, добавлять мегасовет в избранное, делиться им и взаимодействовать с элементами внутри блоков.

**Основные функции:**
*   Отображение детальной информации о мегасовете, включая заголовок и контентные блоки.
*   Динамическое отображение различных типов контентных блоков (HTML, изображения, видео, товары).
*   Добавление/у��аление мегасовета из избранного.
*   Возможность поделиться ссылкой на мегасовет.
*   Просмотр изображений в полноэкранном режиме.
*   Переход к поиску товаров из блока товаров.
*   Навигация по оглавлению к определенным блокам контента.
*   Обработка состояний загрузки и ошибок.

## 2. Элементы Пользовательского Интерфейса (UI Elements)

*   **Toolbar (через MenuProvider):**
    *   **Назначение/Функция:** Содержит кнопку "Поделиться" для обмена ссылкой на мегасовет.
    *   **Взаимодействие пользователя:** Нажатие на кнопку "Поделиться" открывает системное диалоговое окно для обмена.
*   **RecyclerView:**
    *   **Назначение/Функция:** Основной контейнер для динамического отображения всех секций экрана: `StateSection`, `HeadSection`, `ContentHeaderSection`, `ContentSection`, а также различных `BlockSection` (HTML, Image, Video, Products).
    *   **Взаимодействие пользователя:** Вертикальная прокрутка для просмотра содержимого.
*   **StateSection:**
    *   **Назначение/Функция:** Отображает состояния загрузки, ошибки или пустого состояния данных для мегасовета.
    *   **Возможные состояния:**
        *   `LOADING`: Показывает индикатор прогресса.
        *   `ERROR`: Показывает сообщение об ошибке и кнопку "Повторить".
        *   `EMPTY`: Показывает сообщение о пустом контенте.
        *   `HIDDEN`: Скрыт, когда данные успешно загружены и отображаются.
    *   **Взаимодействие пользователя:** Нажатие на кнопку "Повторить" (в состоянии ошибки) для повторной попытки загрузки данных.
*   **HeadSection:**
    *   **Назначение/Функция:** Отображает заголовок мегасовета, его краткое опис��ние и кнопку "Избранное".
    *   **Взаимодействие пользовате��я:** Нажатие на кнопку "Избранное" добавляет/удаляет мегасовет из избранного.
*   **ContentHeaderSection:**
    *   **Назначение/Функция:** Заголовок для секции оглавления ("Содержание").
    *   **Возможные состояния:** Видима, если есть блоки контента.
    *   **Взаимодействие пользователя:** Неинтерактивный элемент.
*   **ContentSection:**
    *   **Назначение/Функция:** Отображает оглавление мегасовета, позволяя быстро перейти к определенным блокам контента.
    *   **Взаимодействие пользователя:** Нажатие на элемент оглавления прокручивает экран к соответствующему блоку.
*   **BlockSection (HtmlBlockSection, ImageBlockSection, VideoBlockSection, ProductsBlockSection):**
    *   **Назначение/Функция:** Динамически создаваемые секции, отображающие различные типы конт��нта мегасовета.
        *   `HtmlBlockSection`: Отображает HTML-текст.
        *   `ImageBlockSection`: Отображает изображения. Нажатие на изображение открывает его в полноэкранном режиме.
        *   `VideoBlockSection`: Отображает видео.
        *   `ProductsBlockSection`: Отображает список товаров. Нажатие на товар переводит к его поиску.
    *   **Взаимодействие пользователя:** Зависит от типа блока (просмотр, нажатие, прокрутка).

## 3. Пользовательские Сценарии (User Flows)

*   **Просмотр деталей мегасовета:**
    1.  Пользователь открывает экран "Детальная мегасовета", передавая `specialId` или `specialCode`.
    2.  Отображается индикатор загрузки (`StateSection`).
    3.  ViewModel запрашивает подробную информацию о мегасовете.
    4.  При успешной загрузке, индикатор скрывается, и динамически создаются и отображаются секции `HeadSection`, `ContentSection` и различные `BlockSection` в зависимости от контента мегасове��а.
*   **Добавление/удаление из избранного:**
    1.  Пользователь нажимает на иконку "Избранное" в `HeadSection`.
    2.  Статус избранного обновляется через `viewModel.updateFavorite()`.
*   **Обмен мегасоветом:**
    1.  Пользователь нажимает на иконку "Поделиться" в тулбаре.
    2.  Открывается системное диалоговое окно для обмена ссылкой на мегасовет.
*   **Просмотр изображений:**
    1.  Пользователь нажимает на изображение в `ImageBlockSection`.
    2.  Открывается полноэкранный просмотр изображений (`showOverlayImages`), позволяющий пролистывать все изображения в блоке.
*   **Переход к товарам:**
    1.  Пользователь нажимает на товар в `ProductsBlockSection`.
    2.  Происходит навигация к экрану поиска товаров (`ItemsSearchFragment`) с предзаполненным запро��ом по названию товара.
*   **Навигация по оглавлению:**
    1.  Польз��ватель нажимает на элемент в `ContentSection`.
    2.  Экран прокручивается к соответствующему блоку контента.
*   **Обработка ошибок загрузки:**
    1.  При возникновении ошибки загрузки данных, `StateSection` отображает сообщение об ошибке и кнопку "Повторить".
    2.  Нажатие на кнопку "Повторить" инициирует повторную попытку загрузки данных.

## 4. Навигация

С экрана "Детальная мегасовета" возможны следующие переходы:

*   **Назад к предыдущему экрану:** При нажатии кнопки "Назад" в тулбаре или системной кнопки "Назад".
*   **Системное диалоговое окно "Поделиться":** Открывается для обмена ссылкой на мегасовет.
*   **Полноэкранный просмотр изображений:** Открывается при нажатии на изображение в `ImageBlockSection`.
*   **`ItemsSearchFragment`:** Для поиска товаров, если пользователь нажи��ает на товар в `ProductsBlockSection`.

### Deep Links

На этот экран можно попасть по следующим deep links:

*   `{scheme}://{host}/specials/{specialCode}`
*   `{scheme}://{host}/specials/{specialCode}#{cut}`
*   `{scheme}://{host}/specials/{specialId}`

## 5. Отображаемые Данные

*   **Типы данных:**
    *   `SpecialDetailed`: Объект, содержащий полную информацию о мегасовете (заголовок, URL для обмена, список блоков контента, список элементов оглавления).
    *   `SpecialBlock`: Базовый класс для различных типов контентных блоков (HTML, Image, Video, Products).
*   **Источник данных:**
    *   **API:**
        *   `ApiService.getSpecialDetailed` (REST метод: `GET /ma/v5/specials/detail`) - для получения детальной информации о мегасовете.
        *   `ApiService.putFavoriteSpecial` (REST метод: `PUT /app/v1/specials/favorites`) - для обновления статуса избранного.
    *   **Локальное хранилище:** Нет.

## 6. Особые Состояния/Логика

*   **Производительность на слабых устройствах:** Для устройств с низкой производительностью аниматор элементов `RecyclerView` отключается (`viewBinding.recyclerView.itemAnimator = null`).
*   **Динамическое построение UI:** Интерфейс мегасовета полностью строится динамически на основе списка `SpecialBlock`, полученных из ViewModel. Для каждого типа блока создается соответствующая секция.
*   **Обработка скриншотов:** При создании скриншота экрана, пользователю предлагается поделиться им.
*   **Синхронизация избранного:** Изменения в статусе избранного мегасовета, сделанные на этом экране, синхронизируются с другими частями приложения через `globalViewModel.specialChanges`.
*   **Логирование аналитики:** Обмен информацией и клики по товарам логируются с помощью `AnEvent.shareLink` и `AnEvent.itemPropertyClick`.
*   **Прокрутка к блоку:** Метод `scrollToBlock` позволяет программно прокрутить `RecyclerView` к определенному блоку контент��, используя его смещение.