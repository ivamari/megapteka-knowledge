# ChangePasswordActivity

## 1. Обзор Экрана

Экран "Смена пароля" (ChangePasswordActivity) позволяет пользователю изменить свой текущий пароль или установить новый пароль, если он был забыт и используется токен восстановления. Экран обеспечивает ввод старого и нового паролей, валидацию полей и обработку результатов смены пароля.

**Основные функции:**
*   Смена существующего пароля пользователя.
*   Установка нового пароля с использованием токена восстановления (для сценария "Забыли пароль").
*   Валидация введенных паролей.
*   Отображение ошибок при некорректном вводе или неудачной смене пароля.
*   Интеграция с кнопкой чата поддержки.

## 2. Элементы Пользовательского Интерфейса (UI Elements)

*   **Toolbar (через `IncludeAppBarBinding`):**
    *   **Назначение/Функция:** Отображает заголовок экрана "Новый пароль" и кнопку "Назад" для навигации.
    *   **Взаимодействие пользователя:** Нажатие на кнопку "Назад" закрывает экран.
*   **TextInputLayout (oldPasswordInput):**
    *   **Назначение/Функция:** Поле для ввода текущего (старого) пароля. Видимо только при смене пароля, скрыто при восстановлении по токену.
    *   **Взаимодействие пользователя:** Ввод текста. Имеет иконку для скрытия/отображения пароля. При потере фокуса или нажатии "Далее" на клавиатуре переходит к следующему полю.
*   **TextInputLayout (newPasswordInput):**
    *   **Назначение/Функция:** Поле для ввода нового пароля.
    *   **Взаимодействие пользователя:** Ввод текста. Имеет иконку для скрытия/отображения пароля. При потере фокуса или нажатии "Готово" на клавиатуре инициирует смену пароля.
*   **Button (change):**
    *   **Назначение/Функция:** Кнопка для подтверждения смены или установки нового пароля.
    *   **Взаимодействие пользователя:** Нажатие инициирует процесс смены пароля.
*   **ChatButton (includedChatButton.chatButton):**
    *   **Назначение/Функция:** Кнопка для быстрого доступа к чату поддержки.
    *   **Взаимодействие пользователя:** Нажатие открывает экран чата.

## 3. Пользовательские Сценарии (User Flows)

*   **Смена существующего пароля:**
    1.  Пользователь открывает экран "Смена пароля".
    2.  Поля "Старый пароль" и "Новый пароль" видны.
    3.  Пользователь вводит старый пароль и новый пароль.
    4.  Нажимает кнопку "Изменить" или "Готово" на клавиатуре.
    5.  Если валидация успешна, отправляется запрос на смену пароля.
    6.  При ��спехе экран закрывается.
    7.  При ошибке отображается диалог с сообщением об ошибке.
*   **Установка нового пароля по токену восстановления:**
    1.  Пользователь открывает экран "Смена пароля" с переданным `restoreToken`.
    2.  Поле "Старый пароль" скрыто.
    3.  Пользователь вводит новый пароль.
    4.  Нажимает кнопку "Изменить" или "Готово" на клавиатуре.
    5.  Если валидация успешна, отправляется запрос на установку нового пароля с токеном.
    6.  При успехе пользователь перенаправляется на главный экран (`NavigationActivity`).
    7.  При ошибке отображается диалог с сообщением об ошибке.
*   **Валидация ввода:**
    1.  При вводе текста в поля паролей, ошибки валидации сбрасываются (`ErrorResetWatcher`).
    2.  При попытке смены пароля, поля проверяются на заполненность. Если поля п��стые, отображается ошибка и фокус переходит к первому пустому полю.

## 4. Навигация

С экрана "Смена пароля" возможны следующие переходы:

*   **Назад к предыдущему экрану:** При успешной смене пароля (без токена восстановления) или при нажатии кнопки "Назад" в тулбаре.
*   **`NavigationActivity`:** При успешной установке нового пароля по токену восстановления.
*   **Диалоговые окна:** Для отображения сообщений об ошибках.
*   **Экран чата:** При нажатии на кнопку чата.

### Deep Links

На этот экран нет прямых deep links.

## 5. Отображаемые Данные

*   **Типы данных:**
    *   Строки для старого и нового паролей.
    *   `Resource<Client>` или `Resource<Unit>` для отслеживания статуса операций смены/обновления пароля.
*   **Источник данных:**
    *   **API:**
        *   `ApiService.setNewPassword` (REST метод: `PUT auth/password`) - для установки нового пароля по токену.
        *   `ApiService.changePassword` (REST метод: `PUT clients`) - для смены существующего пароля.
    *   **Локальное хранилище:** Таблица `ClientDao` (для сохранения данных клиента после успешной установки нового пароля по токену).

## 6. Особые Состояния/Логика

*   **Обработка Insets:** Экран корректно обрабатывает системные отступы (status bar, navigation bar, IME) для правильного отображения UI.
*   **Условная видимость поля старого пароля:** Поле "Старый пароль" скрывается, если активность запущена с токеном восстановления, что указывает на сценарий сброса забытого пароля.
*   **Валидация полей:** Используется `validateFields` для проверки заполненности полей и `ErrorResetWatcher` для сброса ошибок при изменении текста.
*   **Обработка ошибок:** Ошибки, возвращаемые ViewModel, отображаются в виде диалоговых окон.
*   **С��рытие клавиатуры:** Клавиатура автоматически скрывается после успешной смены пароля.