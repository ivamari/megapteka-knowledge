# ProfileEditFragment

## 1. Обзор Экрана

Экран "Мой профиль" (ProfileEditFragment) позволяет пользователю просматривать и редактировать свои личные данные, такие как имя и номер телефона. Он также предоставляет возможности для управления способами авторизации (email, социальные сети), выхода из аккаунта и удаления профиля.

**Основные функции:**
*   Просмотр и редактирование имени и номера телефона пользователя.
*   Управление привязанными способами авторизации (email, OAuth-провайдеры).
*   Выход из аккаунта.
*   Удаление профиля.
*   Валидация введенных данных.
*   Обработка состояний загрузки, успеха и ошибки при обновлении профиля или выходе.

## 2. Элемент�� Пользовательского Интерфейса (UI Elements)

*   **Toolbar (через MenuProvider):**
    *   **Назначение/Функция:** Содержит кнопку "Сохранить" для сохранения изменений в профиле.
    *   **Взаимодействие пользователя:** Нажатие на кнопку "Сохранить" инициирует процесс обновления профиля.
*   **RecyclerView:**
    *   **Назначение/Функция:** Основной контейнер для отображения секции `AuthSection`.
    *   **Взаимодействие пользователя:** Вертикальная прокрутка для просмотра содержимого.
*   **AuthSection:**
    *   **Назначение/Функция:** Отображает список доступных способов авторизации (например, "Email", "ВКонтакте"). Каждый элемент может быть нажат для управления этим способом авторизации.
    *   **Взаимодействие пользователя:** Нажатие на элемент авторизации (например, "Email") переводит на экран редактир��вания email (`EmailEditFragment`) или на экран OAuth-авторизации (`OAuthActivity`).
*   **EditText (name):**
    *   **Назначение/Функция:** Поле для ввода имени пользователя.
    *   **Взаимодействие пользователя:** Ввод текста. Использует `capitalizeFormatter` для автоматического преобразования первой буквы в заглавную и `errorResetWatch` для сброса ошибок.
*   **EditText (phone):**
    *   **Назначение/Функция:** Поле для ввода номера телефона пользователя.
    *   **Взаимодействие пользователя:** Ввод текста. Использует `phoneFormatter` для автоматического форматирования номера и `errorResetWatch` для сброса ошибок. Валидируется на корректность номера.
*   **Button (signOut):**
    *   **Назначение/Функция:** Кнопка для выхода из аккаунта.
    *   **Взаимодействие пользователя:** Нажатие вызывает диалог подтверждения выхода, после которого происход��т выход из аккаунта.
*   **Button (removeProfile):**
    *   **Назначение/Функция:** Кнопка для удаления профиля.
    *   **Взаимодействие пользователя:** Нажатие переводит на экран удаления профиля (`ProfileRemoveFragment`).

## 3. Пользовательские Сценарии (User Flows)

*   **Просмотр и редактирование профиля:**
    1.  Пользователь открывает экран "Мой профиль".
    2.  ViewModel загружает информацию о клиенте (`viewModel.client`) и его способах авторизации (`viewModel.hasAccount`).
    3.  Отображаются текущие имя и телефон пользователя, а также список привязанных способов авторизации.
    4.  Пользователь изменяет имя или телефон.
    5.  Нажимает кнопку "Сохранить" в тулбаре.
    6.  Если данные валидны, отправляется запрос на обновление профиля (`viewModel.updateClient()`).
    7.  При успехе экран закрывается.
    8.  При ошибке отображается диалог с сообщением об ошибке.
*   **Управление способами авторизации:**
    1.  Пользователь нажимает на элемент в `AuthSection` (например, "Email").
    2.  Если это email, происходит навигация к `EmailEditFragment`. Если это OAuth-провайдер, запускается `OAuthActivity` для привязки/отвязки аккаунта.
*   **Выход из аккаунта:**
    1.  Пользователь нажимает кнопку "Выйти".
    2.  Появляется диалог подтверждения.
    3.  Пользователь подтверждает выход.
    4.  Происходит выход из аккаунта (`viewModel.signOut()`), и экран закрывается.
    5.  Регистрируется аналитическое событие `AnEvent.logout()`.
*   **Удаление профиля:**
    1.  Пользователь нажимает кнопку "Удалить профиль".
    2.  Происходит навигация к экрану удаления профиля (`ProfileRemoveFragment`).
*   **Валидация полей:**
    1.  При вводе текста в поля имени и телефона, о��ибки сбрасываются.
    2.  При попытке сохранения, поле те����ефона валидируется на корректность.

## 4. Навигация

С экрана "Мой профиль" возможны следующие переходы:

*   **`EmailEditFragment`:** Для редактирования email.
*   **`OAuthActivity`:** Для управления OAuth-авторизацией.
*   **`ProfileRemoveFragment`:** Для удаления профиля.
*   **`SignInActivity`:** Если пользователь не авторизован и пытается получить доступ к профилю.
*   **Назад к предыдущему экрану:** После успешного сохранения изменений или выхода из аккаунта, или при нажатии кнопки "Назад" в тулбаре/системной кнопки "Назад".
*   **Диалоговые окна:** Для подтверждения выхода или отображения ошибок.

### Deep Links

На этот экран можно попасть по следующим deep links:

*   `{scheme}://{host}/lk/profile`

## 5. Отображаемые Данные

*   **Типы данных:**
    *   `Client`: Информация о профиле пользователя (имя, телефон, email, список способов авторизации).
    *   `Boolean`: Статус авторизации (`viewModel.hasAccount`).
    *   `Resource<Client>` и `Resource<Unit>`: Для отслеживания статуса операций обновления профиля и выхода.
    *   `Auth`: Объект, представляющий способ авторизации.
*   **Источник данных:**
    *   **API:**
        *   `ApiService.logout` (REST метод: `PUT auth/logout`) - для выхода из аккаунта.
        *   `ApiService.saveClient` (REST метод: `PUT clients`) - для обновления данных клиента.
        *   `ApiService.getClient` (REST метод: `GET /app/v1/clients`) - для получения данных клиента.
    *   **Локальное хранилище:**
        *   `SharedPreferences` (через `AccountRepository` для проверки наличия аккаунта).
        *   Таблица `ClientDao` (для сохранения данных клиента).
        *   Таблица `OrdersDao` (для удаления всех заказов при выходе).
        *   Таблица `AddressDao` (для удаления адресов при выходе).
        *   Таблица `ItemsDao` (для очистки чувствительных данных аккаунта при выходе).
        *   Таблица `StoresDao` (для очистки выбранного магазина при выходе).
        *   Таблица `FetchHelperDao` (для очистки кэша, чувствительного к авторизации).

## 6. Особые Состояния/Логика

*   **Обработка кнопки "Назад":** Переопределен `OnBackPressedCallback` для обработки изменений в профиле. Если есть несохраненные изменения, при нажатии "Назад" они сохраняются. В противном случае, происходит обычный возврат.
*   **Динамическая видимость:** Разделы профиля и кнопки авторизации отображаются в зависимости от статуса авторизации пользователя.
*   **Форматирование ввода:** Используются `capitalizeFormatter` для имени и `phoneFormatter` для телефона для улучшения пользовательского опыта.
*   **Валидация:** Поле телефона валидируется на корректность.
*   **Скрытие клавиатуры:** Клавиатура автоматически скрывается после успешного выхода или сохранения.
*   **Логирование аналитики:** Выход из аккаунта логируется с помощью `AnUtils.logEvent`.