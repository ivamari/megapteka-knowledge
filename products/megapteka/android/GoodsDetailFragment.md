# GoodsDetailFragment

## 1. Обзор Экрана

Экран "Детальная мегатовара" (GoodsDetailFragment) предназначен для отображения подробной информации о конкретном товаре, а также списка связанных товаров (например, аналоги, сопутствующие товары). Он предоставляет пользователю возможность просматривать детали товара, добавлять его в корзину, управлять избранным, применять фильтры к списку связанных товаров и делиться информацией о товаре.

**Основные функции:**
*   Отображение детальной информации о товаре (название, описание, изображения, цена).
*   Отображение списка связанных товаров с пагинацией.
*   Добавление товаров в корзину и изменение их количества.
*   Добавление/удаление товаров из избранного.
*   Пр��менение фильтров к списку связанных товаров.
*   Возможность поделиться ссылкой на товар.
*   Обработка состояний загрузки, ошибок и пустого списка.

## 2. Элементы Пользовательского Интерфейса (UI Elements)

*   **Toolbar (через MenuProvider):**
    *   **Назначение/Функция:** Содержит кнопку "Поделиться" для обмена ссылкой на товар.
    *   **Взаимодействие пользователя:** Нажатие на кнопку "Поделиться" открывает системное диалоговое окно для обмена.
*   **RecyclerView:**
    *   **Назначение/Функция:** Основной контейнер для отображения секций `GoodsSection`, `FiltersSectionWrapper`, `ItemsUnlimitedSection` и `StateSection`.
    *   **Взаимодействие пользователя:** Вертикальная прокрутка для просмотра содержимого.
*   **GoodsSection:**
    *   **Назначение/Функция:** Отображает основную информацию о товаре (изображения, название, описание, цена, кнопки добавления в корзину/избранное).
    *   **Взаимодействие пользователя:** Взаимодействие с элементами товара (например, изменение количества, добавление в избранное).
*   **FiltersSectionWrapper:**
    *   **Назначение/Функция:** Обертка для `FiltersSection`, которая, вероятно, управляет горизонтальным отображением фильтров.
    *   **Взаимодействие пользователя:** Не имеет прямых интерактивных элементов, служит для компоновки фильтров.
*   **FiltersSection:**
    *   **Назначение/Функция:** Отображает доступные фильтры для списка связанных товаров.
    *   **Взаимодействие пользователя:** Нажатие на фильтр открывает диалог `FiltersDialog` для выбора значений фильтра.
*   **ItemsUnlimitedSection:**
    *   **Назначение/Функция:** Отображает список связанных товаров с пагинацией.
    *   **Взаимодей��твие пользователя:** Нажатие на товар для перехода к его деталям. Изменение количества товара в корзине, добавление/удаление из избранного.
*   **StateSection:**
    *   **Назначение/Функция:** Отображает состояния загрузки, ошибок или пустого состояния данных для списка связанных товаров.
    *   **Возможные состояния:**
        *   `LOADING`: Показывает индикатор прогресса.
        *   `ERROR`: Показывает сообщение об ошибке и кнопку "Повторить".
        *   `EMPTY`: Показывает сообщение о пустом списке с возможностью сброса фильтров или перехода по ссылке.
        *   `HIDDEN`: Скрыт, когда данные успешно загружены и отображаются.
    *   **Взаимодействие пользователя:** Нажатие на кнопку "Повторить" (в состоянии ошибки) для повторной попытки загрузки данных. Нажатие на кнопку в пустом состояни�� для сброса фильтров или навигации.

## 3. Пользовательские Сценарии (User Flows)

*   **Просмотр деталей товара:**
    1.  Пользователь открывает экран "Детальная мегатовара".
    2.  Загружается и отображается информация о товаре (`GoodsSection`).
    3.  Загружаются и отображаются связанные товары (`ItemsUnlimitedSection`).
*   **Добавление/изменение количества товара в корзине:**
    1.  Пользователь нажимает кнопки `+` или `-` на карточке товара.
    2.  Количество товара в корзине обновляется.
*   **Добавление/удаление из избранного:**
    1.  Пользователь нажимает на иконку избранного на карточке товара.
    2.  Статус избранного обновляется.
*   **Применение фильтров:**
    1.  Пользователь нажимает на фильтр в `FiltersSection`.
    2.  Открывается `FiltersDialog`.
    3.  Пользователь выбирает значения фильтров.
    4.  Список связанных товаров обновляется в соответствии с выбранными фильтрами.
*   **Поделиться товаром:**
    1.  Пользователь нажимает на иконку "Поделиться" в тулбаре.
    2.  Открывается системное диалоговое окно для обмена ссылкой на товар.
*   **Обработка ошибок загрузки:**
    1.  При возникновении ошибки загрузки данных, `StateSection` отображает сообщение об ошибке и кнопку "Повторить".
    2.  Нажатие на кнопку "Повторить" инициирует повторную попытку загрузки данных.
*   **Пустой список связанных товаров:**
    1.  Если связанных товаров нет, `StateSection` отображает сообщение о пустом списке с возможностью сброса фильтров или перехода по ссылке.

## 4. Навигация

С экрана "Детальная мегатовара" возможны следующие переходы:

*   **`FiltersDialog`:** Для применения фил��тров к списку связанных товаров.
*   **Другие экраны товаров:** При нажатии на связанный товар в списке.
*   **Системное диалоговое окно "Поделиться":** Открывается для обмена ссылкой на товар.
*   **Навигация по DeepLink:** Если в пустом состоянии есть кнопка с deep-ссылкой.

### Deep Links

На этот экран можно попасть по следующим deep links:

*   `{scheme}://{host}/goods/{id}`
*   `{scheme}://{host}/goods/{code}`

## 5. Отображаемые Данные

*   **Типы данных:**
    *   `Goods`: Объект, содержащий детальную информацию о товаре (название, изображения, цена, URL для обмена).
    *   `PagingData<Item>`: Для отображения списка связанных товаров, где `Item` представляет собой краткую информацию о товаре.
    *   `Meta`: Объект, содержащий метаданные, включая информацию о доступных фильтрах и информацию для пустого состояния.
*   **Источник данных:**
    *   **API:**
        *   `ApiService.getGoodsDetail` (REST метод: `GET /app/v1/goods/detail`) - для получения детальной информации о товаре.
        *   `ApiService.getGoodsItems` (REST метод: `GET /app/v5/goods/items`) - для получения списка связанных товаров и метаданных (включая фильтры).
    *   **Локальное хранилище:** Нет прямого использования локального хранилища для этих данных.

## 6. Особые Состояния/Логика

### 6.1. Логика Фильтрации
Экран использует абстрактный класс `Filterable` для представления различных типов фильтров. В частности, для связанных товаров применяется `ItemFilterable.DistanceFilterable` для фильтрации по расстоянию. Управление фильтрами происходит через `FiltersDialog`, который позволяет пользователю выбирать и применять значения фильтров, обновляя список связанных товаров.

*   **Общий пул представлений:** Использу��тся `RecycledViewPool` для оптимизации производительности `RecyclerView`, особенно при наличии нескольких секций с похожими элементами.
*   **Динамическая видимость кнопки "Поделиться":** Кнопка "Поделиться" в тулбаре становится видимой только после успешной загрузки информации о товаре и наличии `shareUrl`.
*   **Обработка пустого состояния:** В случае пустого списка связанных товаров, `StateSection` отображает кастомизированное сообщение и кнопку, которая может сбросить фильтры или выполнить навигацию по deep-ссылке.
*   **Синхронизация корзины и избранного:** Методы `quantitiesChanged` и `favsChanged` позволяют обновлять UI списка товаров при изменении количества в корзине или статуса избранного из других частей приложения.