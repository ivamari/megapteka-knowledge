# ItemsFavsFragment

## 1. Обзор Экрана

Экран "Избранное" (ItemsFavsFragment) позволяет пользователю управлять списком избранных товаров. Он предоставляет функциональность для поиска по избранным товарам, применения фильтров, просмотра рекомендаций, а также управления уведомлениями о наличии товаров.

**Основные функции:**
*   Отображение списка избранных товаров с пагинацией.
*   Поиск товаров в избранном по текстовому запросу.
*   Применение фильтров к списку избранных товаров.
*   Отображение рекомендаций товаров "Для вас".
*   Управление уведомлениями о наличии товаров.
*   Обновление списка товаров с помощью "потяни-чтобы-обновить" (pull-to-refresh).
*   Обработка состояний загрузки, ошибок и пустого списка.

## 2. Элементы Пользовательского Интерфейса (UI Elements)

*   **Toolbar (через MenuProvider):**
    *   **Назначение/Функция:** Содержит поисковую строку (`SearchView`) для фильтрации избранных товаров.
    *   **Взаимодействие пользователя:** Ввод текста в `SearchView` инициирует поиск по избранным товарам.
*   **SearchView (action_search в меню):**
    *   **Назначение/Функция:** Поле для ввода поискового запроса для избранных товаров.
    *   **Взаимодействие пользователя:** Ввод текста для фильтрации списка товаров. Запросы отправляются с задержкой (debounce) для оптимизации производительности.
*   **SwipeRefreshLayout (swipeRefresh):**
    *   **Назначение/Функция:** Позволяет пользователю обновить списки избранных товаров и рекомендаций, потянув экран вниз.
    *   **Взаимодействие пользователя:** Свайп вниз для обновления данных.
*   **RecyclerView:**
    *   **Назначение/Функция:** Основной контейнер для отображения секций `WarningsSection`, `ButtonsSection`, `FiltersWrapper`, `ToNotificationsSection`, `ItemsUnlimitedSection` (для избранных), `StateSection` и `ItemsUnlimitedSection` (для рекомендаций).
    *   **Взаимодействие пользователя:** Вертикальная прокрутка для просмотра содержимого.
*   **WarningsSection:**
    *   **Назначение/Функция:** Отображает предупреждения, связанные с избранными товарами (например, о недоступности).
    *   **Взаимодействие пользователя:** Нажатие на кнопку в предупреждении может инициировать действие (например, переход в настройки уведомлений).
*   **ButtonsSection:**
    *   **Назначение/Функция:** Содержит кнопки для быстрого доступа к другим разделам, таким как "Советы" и "Акции".
    *   **Взаимодействие пользователя:** Нажатие на кнопку переводит на соответствующий экран.
*   **FiltersWrapper / FiltersSection:**
    *   **Назначение/Функция:** Отображает доступные фильтры для списка избранных товаров.
    *   **Возможные состояния:** Видима, если есть избранные товары.
    *   **Взаимодействие пользователя:** Нажатие на фильтр открывает диалог `FiltersDialog` для выбора значений фильтра.
*   **ToNotificationsSection:**
    *   **Назначение/Функция:** Карточка с предложением перейти в настройки уведомлений.
    *   **Возможные состояния:** Видима, если есть избранные товары.
    *   **Взаимодействие пользователя:** Нажатие переводит на экран уведомлений.
*   **ItemsUnlimitedSection (для избранных):**
    *   **Назначение/Функция:** Отображает список избранных товаров с пагинацией.
    *   **Взаимодействие пользователя:** Нажатие на товар для перехода к его деталям. Изменение количества товара в корзине, добавление/удаление из избранного.
*   **StateSection:**
    *   **Назначение/Функция:** Отображает состояния загрузки, ошибки или пустого состояния данных для списка избранных товаров.
    *   **Возможные состояния:**
        *   `LOADING`: Показывает индикатор прогресса.
        *   `ERROR`: Показывает сообщение об ошибке и кнопку "Повторить".
        *   `EMPTY`: Показывает сообщение о пустом списке избранных товаров или пустом результате поиска.
        *   `HIDDEN`: Скрыт, когда данные успешно загружены и отображаются.
    *   **Взаимодействие пользователя:** Нажатие на кнопку "Повторить" (в состоянии ошибки) для повторной попытки загрузки данных. Нажатие на кнопку в пустом состоянии может инициировать навигацию.
*   **RecommendationsHeaderSection:**
    *   **Назначение/Функция:** Заголовок для секции "Для вас" (рекомендации).
    *   **Возможные состояния:** Видима, если есть рекомендации.
    *   **Взаимодействие пользователя:** Неинтерактивный элемент.
*   **ItemsUnlimitedSection (для рекомендаций):**
    *   **Назначение/Функция:** Отображает список рекомендованных товаров с пагинацией.
    *   **Взаимодействие пользователя:** Нажатие на товар для перехода к его деталям. Изменение количества товара в корзине, добавление/удаление из избранного.

## 3. Пользовательские Сценарии (User Flows)

*   **Просмотр избранных товаров:**
    1.  Пользователь открывает экран "Избранное".
    2.  Отображается индикатор загрузки (`StateSection`).
    3.  ViewModel запрашивает избранные товары и рекомендации.
    4.  При ус����ешной загрузке, индикатор скрывается, и отображаются списки избранных товаров и рекомендаций.
    5.  Если избранных товаров нет, отображается `StateSection` с сообщением о пустом списке.
*   **Поиск по избранным товарам:**
    1.  Пользователь вводит текст в поисковую строку в тулбаре.
    2.  Список избранных товаров фильтруется по запросу.
*   **Применение фильтров:**
    1.  Пользователь нажимает на фильтр в `FiltersSection`.
    2.  Открывается диалог `FiltersDialog`.
    3.  Пользователь выбирает значения фильтров.
    4.  Список избранных товаров обновляется в соответствии с выбранными фильтрами.
*   **Обновление списка:**
    1.  Пользователь выполняет жест "потяни-чтобы-обновить".
    2.  Списки избранных товаров и рекомендаций перезагружаются.
*   **Переход к деталям товара:**
    1.  П��л��зователь нажимает на любой товар в списках избранного или рекомендаций.
    2.  Происходит навигация к экрану `ItemDetailsFragment` с передачей ID выбранного товара.
*   **Управление уведомлениями:**
    1.  Пользователь нажимает на кнопку в предупреждении, связанном с уведомлениями, или на карточку `ToNotificationsSection`.
    2.  Может быть инициировано обновление настроек уведомлений или переход на экран уведомлений.
*   **Переход к другим разделам:**
    1.  Пользователь нажимает на кнопки в `ButtonsSection`.
    2.  Происходит навигация к экранам "Советы" (`AdvicesFragment`) или "Акции" (`SpecialsFragment`).

## 4. Навигация

С экрана "Избранное" возможны следующие переходы:

*   **`ItemDetailsFragment`:** Для просмотра детальной информации о товаре.
*   **`FiltersDialog`:** Для применения фильтров.
*   **`AdvicesFragment`:** Для п��осм��тра советов провизора (с выбранной вкладкой "Избранные").
*   **`SpecialsFragment`:** Для просмотра акций (с выбранной вкладкой "Избранные").
*   **`NotificationsFragment`:** Для управления уведомлениями.
*   **Навигация по DeepLink:** Если кнопка предупреждения имеет deep-ссылку.

### Deep Links

На этот экран можно попасть по следующим deep links:

*   `{scheme}://{host}/favorites`
*   `{scheme}://{host}/lk/favourites`

## 5. Отображаемые Данные

*   **Типы данных:**
    *   `PagingData<Item>`: Для отображения списков избранных товаров и рекомендаций.
    *   `List<Warning>`: Список предупреждений.
    *   `NotificationSetting`: Настройки уведомлений.
    *   `TitleText`: Заголовок и текст для диалога обновления настроек.
*   **Источник данных:**
    *   **API:**
        *   `ApiService.getFavoriteItems` (REST метод: `GET /app/v3/items/favorites`) - для получения списка избранных товаров.
        *   `ApiService.getFavoriteRecommendationsItems` (REST метод: `GET /app/v3/items/favorites/recommendations`) - для получения списка рекомендованных избранных товаров.
        *   `ApiService.updateNotificationsSettings` (REST метод: `POST notifications/settings`) - для обновления настроек уведомлений.
    *   **Локальное хранилище:**
        *   Таблица `ItemsDao` (для кэширования избранных товаров).
        *   `SharedPreferences` (для удаления предупреждений).

## 6. Особые Состояния/Логика

*   **Производительность на слабых устройствах:** Для устройств с низкой производительностью аниматор элементов `RecyclerView` отключается (`viewBinding.recyclerView.itemAnimator = null`).
*   **Оптимизация поиска:** Используется `debounce` и `distinctUntilChanged` для предотвращения частых запросов при вводе текста в `SearchView`.
*   **Динамическая видимость секций:** Секции фильтров, уведомлений и рекомендаций отображаются/скрываются в зависимости от наличия избранных товаров или результатов поиска.
*   **Обработка ��шибок Paging:** `handleLoadStates` обрабатывает различные состояния загрузки (начальная загрузка, добавление, ошибка) и отображает соответствующий UI через `StateSection`.
*   **Синхронизация корзины и избранного:** Методы `quantitiesChanged` и `favsChanged` позволяют обновлять UI списка товаров при изменении количества в корзине или статуса избранного из других частей приложения.
*   **Обновление настроек уведомлений:** При изменении настроек уведомлений через предупреждение, отображается диалог с подтверждением, и список избранных товаров обновляется.