# CatalogFragment

## 1. Обзор Экрана

Экран "Каталог" (CatalogFragment) является центральным узлом для навигации по ассортименту товаров в приложении "Мегаптека". Он предоставляет пользователю возможность искать товары, сканировать штрих-коды, а также просматривать товары, сгруппированные по различным категориям: по локализации (для человека) и по классификации (по группам товаров).

**Основные функции:**
*   Поиск товаров по текстовому запросу.
*   Голосовой поиск товаров.
*   Сканирование штрих-кодов для поиска товаров.
*   Переключение между двумя основными режимами просмотра каталога: "По локализации" (HumanFragment) и "По классификации" (GroupsFragment).
*   Навигация по иерархии групп товаров.

## 2. Элементы Пользовательского Интерфейса (UI Elements)

*   **SearchBar (includedItemsSearchBar):**
    *   **Назначение/Функция:** Содержит поле для ввода поискового запроса, кнопку голосового поиска и кнопку сканирования штрих-кода.
    *   **Взаимодействие пользователя:**
        *   Нажатие на поле поиска: Переход к экрану поиска товаров (`ItemsSearchFragment`).
        *   Нажатие на кнопку голосового поиска: Активация голосового ввода для поиска.
        *   Нажатие на кнопку сканирования: Переход к экрану сканирования штрих-кода (`ItemsScanActivity`).
*   **TabLayout (tabs):**
    *   **Назначение/Функция:** Предоставляет две вкладки: "По локализации" и "По классификации", для переключения между различными представлениями каталога.
    *   **Возможные состояния:** Выбрана одна из вкладок.
    *   **Взаимодействие пользователя:** Нажатие ��а вкладку переключает отображаемый фрагмент (HumanFragment или GroupsFragment).
*   **FrameLayout (consumerContainer):**
    *   **Назначение/Функция:** Контейнер для динамической загрузки фрагментов `HumanFragment` или `GroupsFragment` в зависимости от выбранной вкладки.
    *   **Взаимодействие пользователя:** Не имеет прямых интерактивных элементов, служит для отображения контента выбранной вкладки.

## 3. Пользовательские Сценарии (User Flows)

*   **Поиск товара:**
    1.  Пользователь нажимает на поле поиска.
    2.  Переходит на экран поиска товаров (`ItemsSearchFragment`).
    3.  (Альтернативно) Пользователь нажимает на иконку микрофона.
    4.  Произносит поисковый запрос.
    5.  Результат голосового распознавания передается на экран поиска товаров.
*   **Сканирование штрих-кода:**
    1.  Пользователь нажимает на иконк�� сканера.
    2.  Переходит на экран сканирования штрих-кода (`ItemsScanActivity`).
*   **Переключение между вкладками каталога:**
    1.  Пользователь нажимает на вкладку "По локализации" или "По классификации".
    2.  Соответствующий фрагмент (`HumanFragment` или `GroupsFragment`) отображается в `consumerContainer`.
    3.  Состояние выбранной вкладки сохраняется.
*   **Навигация по группам товаров (вкладка "По классификации"):**
    1.  Пользователь выбирает группу товаров.
    2.  Если группа является конечной (`group.isLast`), происходит навигация к списку товаров (`ItemsFragment`) с фильтром по этой группе.
    3.  Если группа содержит подгруппы, ViewModel расширяет текущую группу, и отображаются новые подгруппы.

## 4. Навигация

С экрана "Каталог" возможны следующие переходы:

*   **`ItemsSearchFragment`:** Для текстового ��ли голосового поиска товаров.
*   **`ItemsScanActivity`:** Для поиска товаров по штрих-коду.
*   **`ItemsFragment`:** Для отображения списка товаров, если выбрана конечная группа в каталоге.
*   **Внутренние переключения фрагментов:** Между `HumanFragment` и `GroupsFragment` в зависимости от выбранной вкладки.

### Deep Links

На этот экран можно попасть по следующим deep links:

*   `{scheme}://{host}/catalog`
*   `{scheme}://{host}/catalog/{groupCode}`
*   `{scheme}://{host}/catalog/{groupCode}/tag_{tag}`

## 5. Отображаемые Данные

*   **Типы данных:**
    *   `Group`: Объект, представляющий категорию или группу товаров, с полями `code`, `name` и `isLast` (указывает, является ли группа конечной).
    *   `Body`: Объект, представляющий данные о теле (для вкладки "По локализации").
    *   `BodyPart`: Объект, представляющий данные о части тела.
*   **Источник данных:**
    *   **API:**
        *   `ApiService.getGroups` (REST метод: `GET /app/v1/groups`) - для получения списка групп.
        *   `ApiService.getGroup` (REST метод: `GET /ma/site/v2/groups` или `GET /app/v1/groups`) - для получения ��нформации о конкретной группе.
        *   `ApiService.getBody` (REST метод: `GET /app/v2/body`) - для получения данных о теле.
        *   `ApiService.getBodyPart` (REST метод: `GET /app/v1/body/part`) - для получения данных о части тела.
    *   **Локальное хранилище:** Нет прямого использования локального хранилища для кэширования или управления данными о группах/теле в этих методах.

## 6. Особые Состояния/Логика

*   **Доступность голосового поиска:** Кнопка голосового поиска видна только если функция распознавания речи доступна на устройстве (`isSpeechRecognitionAvailable()`).
*   **Анимация голосового поиска:** При активации/деактивации голосового поиска иконка микрофона анимируется с использованием `AnimatedVectorDrawableCompat`.
*   **Сохранение состояния вкладки:** Выбранная вкладка сохраняется в ViewModel, чтобы при возвращении на ��кран "Каталог" отображалась последняя активная вкладка.
*   **Обработка ошибок загрузки групп:** Ошибки при загрузке групп товаров обрабатываются, но не приводят к отображению сообщения об ошибке на этом экране.
*   **Аналитика:** Переключение вкладок, начало поиска и сканирования штрих-кодов логируются с помощью `AnUtils.logEvent`.