# StoresForMultiOrderMapFragment

## Обзор Экрана
`StoresForMultiOrderMapFragment` — это фрагмент, который отображает карту с аптеками, доступными для оформления мультизаказа (заказа из нескольких аптек). Он позволяет пользователю просматривать аптеки на карте, выбирать наборы аптек, фокусироваться на них, а также просматривать детали выбранного набора в нижней выдвигающейся панели. Фрагмент также управляет запросом разрешений на определение местоположения и навигацией к экрану подтверждения мультизаказа.

## Элементы Пользовательского Интерфейса (UI Elements)
*   **Карта (MapView `map`)**:
    *   **Назначение/Функция**: Отображает географическую карту с маркерами аптек. Позволяет взаимодействовать с картой (перемещение, масштабирование).
    *   **Возможные состояния**: Загрузка карты, отображение маркеров, изменение масштаба/положения.
    *   **Взаимодействие пользователя**: Перемещение по карте, изменение масштаба (кнопками или жестами), нажатие на маркер аптеки.
*   **Кнопка "Ориентация карты" (ImageView `mapOrientation`)**:
    *   **Назначение/Функция**: Изменяет ориентацию карты (например, с севера вверх на текущее направление движения).
    *   **Возможные состояния**: Активная.
    *   **Взаимодействие пользователя**: Нажатие изменяет ориентацию карты.
*   **Кнопка "Мое местоположение" (ImageView `userLocation`)**:
    *   **Назначение/Функция**: Центрирует карту на текущем местоположении пользователя.
    *   **Возможные состояния**: Активная.
    *   **Взаимодействие пользователя**: Нажатие центрирует карту.
*   **Кнопки масштабирования (ImageView `plus`, `minus`)**:
    *   **Назначение/Функция**: Увеличивают или уменьшают масштаб карты.
    *   **Возможные состояния**: Активные.
    *   **Взаимодействие пользователя**: Нажатие изменяет масштаб карты.
*   **Горизонтальный список наборов аптек (RecyclerView `setsRV`)**:
    *   **Назначение/Функция**: Отображает горизонтально прокручиваемый список наборов аптек, доступных для мультизаказа.
    *   **Возможные состояния**: Отображение наборов, пустое состояние.
    *   **Взаимодействие пользователя**: Прокрутка списка, нажатие на набор для его фокусировки на карте.
*   **Нижний лист (BottomSheet `bottomSheet`)**:
    *   **Назначение/Функция**: Выдвигающаяся панель снизу экрана, отображающая детали выбранного н��бора аптек (количество аптек, общая сумма, список аптек в на��оре).
    *   **Возможные состояния**: Скрыт, свернут, развернут.
    *   **Взаимодействие пользователя**: Свайп для изменения состояния, нажатие на кнопку "Подробнее" для разворачивания.
*   **Кнопка "Показать все" (TextView `showAll`)**:
    *   **Назначение/Функция**: Сбрасывает фокус с текущего набора аптек и отображает все доступные наборы на карте.
    *   **Возможные состояния**: Видимая (когда набор сфокусирован), скрытая.
    *   **Взаимодействие пользователя**: Нажатие сбрасывает фокус.
*   **Кнопка "Выбрать" (Button `topButtonChoose`, `bottomButtonChoose`)**:
    *   **Назначение/Функция**: Переходит к экрану подтверждения мультизаказа с выбранным набором аптек.
    *   **Возможные состояния**: Активная.
    *   **Взаимодействие пользователя**: Нажатие переходит к подтверждению заказа.
*   **Индикатор прогресса (ProgressBar `progress`)**:
    *   **Назначение/Функция**: Визуально информирует о загрузке данных.
    *   **Возможные состояния**: Видимый (во время загрузки), скрытый.
    *   **Взаимодействие пользователя**: Нет прямого взаимодействия.

## Пользовательские Сценарии (User Flows)
*   **Просмотр аптек для мультизаказа**: Пользователь открывает экран карты, чтобы выбрать аптеки для своего мультизаказа.
*   **Выбор набора аптек**: Пользователь нажимает на маркер на карте или на элемент в горизонтальном списке, чтобы сфокусироваться на конкретном наборе аптек.
*   **Просмотр деталей набора**: После выбора набора, нижний лист отображает подробную информацию о нем, включая список аптек и общую стоимость.
*   **Развора��ивание нижнего листа**: Пользователь может развернуть нижний лист для полного просмотра списка аптек в наборе.
*   **Сброс фокуса**: Пользователь нажимает кнопку "Показать все", чтобы вернуться к отображению всех доступных наборов аптек на карте.
*   **Подтверждение выбора**: Пользователь нажимает кнопку "Выбрать", чтобы перейти к оформлению мультизаказа с выбранным набором аптек.

## Навигация
*   **Переход на `StoresForMultiOrderMapFragment`**:
    *   Осуществляется из корзины или других экранов, где инициируется мультизаказ.
    *   Условия перехода: Передача `orderUuid` и `prevOrderId` через аргументы навигации (`navArgs`).
*   **Переход с `StoresForMultiOrderMapFragment`**:
    *   На экран `MultiOrderConfirmFragment`: При нажатии на кнопку "Выбрать" (`StoresForMultiOrderMapFragmentDirections.actionToMultiOrderConfirm`) с передачей выбранного набора аптек, `orderUuid` и `prevOrderId`.

### Deep Links

На этот экран нет прямых deep links.

## Отображаемые Данные
*   **Типы данных**: Наборы аптек (`MultiCheck`), содержащие информацию о магазинах (`Store`) и их доступности, а также данные о товарах в корзине и текущем городе для аналитики.
*   **Источники данных**:
    *   **API:** `ApiService.checkMultiOrder` (REST метод: `GET /app/v1/orders/multi-stores/check`) - для получения наборов аптек для мультизаказа.
    *   **Внешние SDK:** `DGis SDK` (для отображения карты, маркеров).
    *   **Локальное хранилище:** Нет прямого использования локального хранилища для списка аптек, но данные о выбранной аптеке могут быть сохранены через `StoresDao` в родительском фрагменте.

## Особые Состояния/Логика
*   **Управление картой**: Фрагмент наследуется от `BaseMapFragment`, предоставляя базовую функциональность работы с картой (DGis SDK), включая добавление маркеров, центрирование, управление масштабом и ориента��ией.
*   **Разрешения на местоположение**: Запрашивает разрешение `ACCESS_FINE_LOCATION` при создании фрагмента.
*   **Фокусировка на наборе аптек**: При выборе набора аптек карта центрируется н�� этих аптеках, отображаются только маркеры выбранного набора, а нижний лист заполняется деталями.
*   **Динамическая высота нижнего листа**: Высота `peekHeight` нижнего листа динамически обновляется в зависимости от содержимого.
*   **Анимации переходов**: Используется `AutoTransition` для плавных изменений UI при фокусировке/сбросе фокуса с набора аптек.
*   **Аналитика**: Отслеживаются события выбора набора аптек (`AnEvent.storesSetClick`), нажатия на кнопку "Показать все" (`AnEvent.allStoresSetsClick`) и выбора набора для подтверждения (`AnEvent.chooseStoresSet`).
*   **Вложенность**: Фрагмент является вложенным и получ��ет `ViewModel` от родительского навигационного графа (`R.id.storesForMultiOrderFragment`).
