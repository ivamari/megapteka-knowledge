# MultiOrderConfirmFragment

## 1. Обзор Экрана

Экран "Подтверждение заказа" (MultiOrderConfirmFragment) предназначен для финального подтверждения мультизаказа, то есть заказа, состоящего из товаров, собираемых из нескольких аптек. На этом экране пользователь просматривает детали заказа, вводит свои контактные данные, соглашается с условиями и подтверждает оформление. Экран также отображает предупреждения, связанные с заказом, и информацию о возможной экономии.

**Основные функции:**
*   Отображение списка аптек, участвующих в мультизаказе, и товаров из каждой аптеки.
*   Отображение карты с местоположением аптек.
*   Ввод и валидация контактных данных пользователя (имя, телефон, email).
*   Отображение сводки по заказу (общая стоимость, скидки).
*   Отображение информации об экономии.
*   Согласие с пользовательским соглашением.
*   Подтверждение и оформление заказа.
*   Обработка предупреждений и ошибок, связанных с заказом.
*   Перенаправление на экран успешного оформления заказа.

## 2. Элементы Пользовательского Интерфейса (UI Elements)

*   **RecyclerView:**
    *   **Назначение/Функция:** Основной контейнер для отображения всех секций экрана: `WarningSection`, `StoresSection`, `MapSnippetSection`, `ClientSection`, `SummarySection`, `EconomySection`, `AgreementSection`.
    *   **Взаимодействие пользователя:** Вертикальная прокрутка для просмотра содержимого.
*   **WarningSection:**
    *   **Назначение/Функция:** Отображает предупреждения, связанные с мультизаказом (например, измен����ния в наличии товаров).
    *   **Взаимодействие пользователя:** Неинтерактивный элемент.
*   **StoresSection:**
    *   **Назначение/Функция:** Отображает список аптек, из которых собирается заказ, и товары, доступные в каждой аптеке.
    *   **Взаимодействие пользователя:** Неинтерактивный элемент.
*   **MapSnippetSection:**
    *   **Назначение/Функция:** Отображает небольшой фрагмент карты с местоположением аптек, участвующих в заказе.
    *   **Взаимодействие пользователя:** Нажатие на карту переводит на экран `StoresOnMapFragment` для более детального просмотра аптек на карте.
*   **ClientSection:**
    *   **Назначение/Функция:** Поля для ввода контактных данных пользователя: имя, телефон, email (опционально).
    *   **Взаимодействие пользователя:** Ввод текста. Валидация полей. Флажок для согласия на пол��ч��ние уведомлений по email.
*   **SummarySection:**
    *   **Назначение/Функция:** Отображает сводку по заказу, включая общую стоимость, скидки и т.д.
    *   **Взаимодействие пользователя:** Неинтерактивный элемент.
*   **EconomySection:**
    *   **Назначение/Функция:** Отображает информацию о возможной экономии при оформлении заказа.
    *   **Взаимодействие пользователя:** Неинтерактивный элемент.
*   **AgreementSection:**
    *   **Назначение/Функция:** Флажок согласия с условиями пользовательского соглашения.
    *   **Взаимодействие пользователя:** Установка/снятие флажка. Кнопка "Подтвердить заказ" становится активной только при установленном флажке.
*   **Button (confirm):**
    *   **Назначение/Функция:** Кнопка для подтверждения и оформления заказа.
    *   **Возможные состояния:** Активна, если все поля ва��идны и флажок согласия установлен. Отображает индикатор загрузки во время выполнения операции.
    *   **Взаимодействие пользователя:** Нажатие инициирует процесс оформления заказа.
*   **TextView (warning):**
    *   **Назначение/Функция:** Отображает предупреждение, если пользователь не согласился с условиями соглашения.
    *   **Возможные состояния:** Видима, если флажок `agreement` не установлен; скрыта в противном случае.
    *   **Взаимодействие пользователя:** Неинтерактивный элемент.

## 3. Пользовательские Сценарии (User Flows)

*   **Просмотр деталей мультизаказа:**
    1.  Пользователь открывает экран "Подтверждение заказа", передавая данные о мультизаказе (`MultiCheck`).
    2.  Отображается индикатор загрузки.
    3.  ViewModel загружает данные о заказе, включая аптеки, товары, сводку �� предупреждения.
    4.  При успешной загрузке, индикатор скрывается, и все секции отображают соответствующие данные.
*   **Ввод контактных данных:**
    1.  Пользователь вводит свое имя, телефон и, опционально, email в `ClientSection`.
    2.  Поля валидируются. Если поля невалидны, кнопка "Подтвердить заказ" неактивна.
*   **Согласие с условиями:**
    1.  Пользователь устанавливает флажок в `AgreementSection`.
    2.  Кнопка "Подтвердить заказ" становится активной.
*   **Оформление заказа:**
    1.  Пользователь нажимает кнопку "Подтвердить заказ".
    2.  Скрывается клавиатура.
    3.  Отправляется запрос на оформление заказа через `viewModel.confirmOrder()`.
    4.  Отображается индикатор загрузки.
    5.  При успехе, пользователь перенаправляется на экран успешного оформления заказа (`OrderSuccessFragment`).
    6.  При ошибке отображается диалог с сообщением об ошибке. В зависимости от типа ошибки, могут быть предложены действия (например, перезагрузка данных, переход к списку заказов).
*   **Просмотр аптек на карте:**
    1.  Пользователь нажимает на фрагмент карты в `MapSnippetSection`.
    2.  Происходит навигация к экрану `StoresOnMapFragment`, где отображаются все аптеки, участвующие в заказе.
*   **Обработка изменений в заказе:**
    1.  Если в процессе загрузки или обновления данных о заказе обнаруживаются изменения (например, изменение количества товаров, суммы), отображается диалог с информацией об этих изменениях.

## 4. Навигация

С экрана "Подтверждение заказа" возможны следующие переходы:

*   **`StoresOnMapFragment`:** Для просмотра аптек на карте.
*   **`OrderSuccessFragment`:** После ус��ешного оформления заказа.
*   **`OrdersFragment`:** В случае некоторых ошибок оформления заказа.
*   **Назад к предыдущему экрану:** При нажатии кнопки "Назад" в тулбаре или системной кнопки "Назад".
*   **Диалоговые окна:** Для отображения предупреждений, ошибок или информации об изменениях в заказе.

### Deep Links

На этот экран нет прямых deep links.

## 5. Отображаемые Данные

*   **Типы данных:**
    *   `MultiCheck`: Объект, содержащий полную информацию о мультизаказе, включая список аптек (`checks`), товары в каждой аптеке, общую сумму и предупреждения.
    *   `Client`: Информация о профиле пользователя (имя, телефон, email).
    *   `Economy`: Информация об экономии.
    *   `MultiOrderingResult`: Результат оформления мультизаказа.
*   **Источник данных:**
    *   **API:**
        *   `ApiService.getClient` (REST метод: `GET /app/v1/clients`) - для получения данных клиента.
        *   `ApiService.checkMultiOrder` (REST метод: `GET /app/v1/orders/multi-stores/check`) - для проверки мультизаказа.
        *   `ApiService.getParameters` (REST метод: `GET parameters`) - для получения параметров (например, для расчета экономии).
        *   `ApiService.createMultiOrder` (REST метод: `POST /app/v1/orders/multi-stores/create`) - для создания мультизаказа.
        *   `ApiService.subscribeOrderTracker` (REST метод: `POST /app/v1/orders/tracker/subscribe`) - для подписки на отслеживание заказа.
    *   **Локальное хранилище:**
        *   Таблица `ClientDao` (для сохранения данных клиента).
        *   Таблица `ParametersDao` (для кэширования параметров).
        *   `SavedStateHandle` (для хранения `MultiCheck` и `prevOrderId`).

## 6. Особые Состояния/Логика

*   **Производительность на слабых устройствах:** Для устройств с низкой производительностью аниматор элементов `RecyclerView` отключается (`viewBinding.recyclerView.itemAnimator = null`).
*   **Валидация полей:** Испол��зуется `clientSection.checkIsValid()` и `clientSection.checkIsNeedVerification()` для валидации контактных данных перед оформлением заказа.
*   **Условная видимость кнопки "Подтвердить заказ":** Кнопка активна только при валидных данных и согласии с условиями.
*   **Обработка ошибок API:** Ошибки, возвращаемые API, обрабатываются, и в зависимости от типа ошибки могут быть предложены специфические действия (например, перезагрузка данных, переход к списку заказов).
*   **Сохранение данных клиента:** Введенные пользователем контактные данные сохраняются в `clientSection.clientInfo` и восстанавливаются при изменении конфигурации.
*   **Аналитика:** Оформление заказа логируется с помощью `AnEvent.confirmOrder`.
*   **Перезагрузка данных:** В случае некоторых ошибок, связанных с изменением данных в аптеках, может быть инициирована перезагрузка данных в `StoresForMultiOrderViewModel`.