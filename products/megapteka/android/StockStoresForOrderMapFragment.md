# StockStoresForOrderMapFragment

## 1. Обзор Экрана

`StockStoresForOrderMapFragment` является частью экрана выбора аптеки для заказа со склада. Он отображает аптеки на интерактивной карте, в которых доступны товары из корзины, а также предупреждения, связанные с этими аптеками или товарами. Пользователь может выбрать аптеку, просмотреть ее детали и связанные товары, а также построить маршрут.

**Основные функции:**
*   Отображение аптек, доступных для заказа со склада, на карте в виде маркеров.
*   Кластеризация маркеров по цене.
*   Отображение детальной информации о выбранной аптеке и ее товарах в нижней панели.
*   Построение маршрута до выбранной аптеки.
*   Отображение предупреждений, связанных с аптеками или товарами.
*   Выбор аптеки для оформления заказа.
*   Просмотр информации о доступности аптеки.
*   Управление масштабом карты и центрированием по местоположению пользователя.
*   Отображение маршрутов на карте.

## 2. Элементы Пользовательского Интерфейса (UI Elements)

*   **MapView (map):**
    *   **Назначение/Функция:** Интерактивная карта, на которой отображаются маркеры аптек с товарами со склада.
    *   **Взаимодействие пользователя:** Перемещение, масштабирование карты. Нажатие на маркер аптеки открывает нижнюю панель с деталями.
*   **ProgressBar (progress):**
    *   **Назначение/Функция:** Индикатор загрузки, отображаемый во время загрузки данных об аптеках.
    *   **Возможные состояния:** Видимый во время загрузки, скрытый в других состояниях.
*   **View (bottomSheet):**
    *   **Назначение/Фу��кция:** Нижняя панель (BottomSheet), которая отображает детальную информацию о выбранной аптеке и ее товарах.
    *   **Взаимодействие пользователя:** Может быть свернута/развернута. Содержит информацию об аптеке и список товаров.
*   **RecyclerView (warningsRV):**
    *   **Назначение/Функция:** Отображает предупреждения, связанные с проверкой заказа (`CheckWarningsSection`).
    *   **Взаимодействие пользователя:** Нажатие на кнопку в предупреждении может инициировать действие (например, сброс фильтров или навигацию по deep-ссылке).
*   **RecyclerView (bottomSheetRV):**
    *   **Назначение/Функция:** Контейнер для отображения секций `StoreSection` и `ItemsSection` внутри нижней панели.
    *   **Взаимодействие пользователя:** Вертикальная прокрутка для просмотра содержимого аптеки и товаров.
*   **StoreSection:**
    *   **Назначение/��ункция:** Отображает информацию о выбранной аптеке (название, адрес, расписание, цена, кнопки).
    *   **Взаимодействие пользователя:** Нажатие на кнопку "Выбрать" инициирует выбор аптеки. Нажатие на расписание может разворачивать/сворачивать его. Нажатие на иконку доступности показывает информацию о доступности.
*   **ItemsSection:**
    *   **Назначение/Функция:** Отображает список товаров, доступных в выбранной аптеке.
    *   **Взаимодействие пользователя:** Неинтерактивный элемент. При разворачивании нижней панели может прокручиваться к последнему элементу.
*   **ImageView (mapOrientation):**
    *   **Назначение/Функция:** Кнопка для изменения ориентации карты.
    *   **Взаимодействие пользователя:** Нажатие изменяет ориентацию карты.
*   **ImageView (userLocation):**
    *   **Назначение/Функ��ия:** Кнопка для центрирования карты по текущему местоположению пользователя.
    *   **Взаимодействие пользователя:** Нажатие центрирует карту.
*   **ImageView (plus, minus):**
    *   **Назначение/Функция:** Кнопки для увеличения/уменьшения масштаба карты.
    *   **Взаимодействие пользователя:** Нажатие изменяет масштаб карты.

## 3. Пользовательские Сценарии (User Flows)

*   **Просмотр аптек на карте:**
    1.  Пользователь открывает `StockStoresForOrderMapFragment`.
    2.  Отображается индикатор загрузки (`progress`).
    3.  ViewModel запрашивает список аптек для заказа со склада и связанные предупреждения.
    4.  Маркеры аптек отображаются на карте. Маркеры кластеризуются по цене.
    5.  При успешной загрузке, индикатор скрывается.
*   **Просмотр деталей аптеки и товаров:**
    1.  Пользователь нажимает на маркер аптеки на карте.
    2.  Нижняя панель (`bottomSheet`) сворачивается, отображая информацию о выбранной аптеке и список связанных товаров.
    3.  Пользователь может развернуть нижнюю панель, чтобы увидеть все товары.
*   **Выбор аптеки:**
    1.  Пользователь нажимает кнопку "Выбрать" на нижней панели.
    2.  Выбранная аптека передается в ViewModel через `viewModel.chooseStore()`.
    3.  Происходит навигация к экрану подтверждения заказа (`OrderConfirmFragment`).
*   **Просмотр информации о доступности:**
    1.  Пользователь нажимает на иконку доступности на нижней панели.
    2.  Отображается всплывающее окно с подробной информацией о доступности аптеки для людей с ограниченными возможностями.
*   **Взаимодействие с предупреждениями:**
    1.  Пользователь нажимает на кнопку в предупреждении �� `CheckWarningsSection`.
    2.  Если ссылка кнопки "ma://resetfilters", происходит сброс фильтров в ViewModel. В противном случае, происходит навигация по deep-ссылке.
*   **Построение маршрута:**
    1.  На карте могут отображаться маршруты до аптек, если они доступны через фильтры.
*   **Управление картой:**
    1.  Пользователь нажимает кнопки `+` или `-` для изменения масштаба карты.
    2.  Пользователь нажимает кнопку "Мое местоположение" для центрирования карты по текущему местоположению.
    3.  Пользователь нажимает кнопку "Ориентация" для изменения ориентации карты.

## 4. Навигация

С экрана `StockStoresForOrderMapFragment` возможны следующие переходы:

*   **`OrderConfirmFragment`:** Для подтверждения заказа после выбора аптеки.
*   **Навигация по DeepLink:** Если кнопка в предупреждении имеет deep-ссылку.

### Deep Links

На этот экран нет прямых deep links.

## 5. Отображаемые Данные

*   **Типы данных:**
    *   `List<Check>`: Список объектов `Check`, каждый из которых содержит информацию об аптеке (`Store`) и товарах, доступных в ней.
    *   `List<CheckWarning>`: Список предупреждений, связанных с проверкой заказа.
    *   `CheckFilterable.DistanceFilterable`: Информация о маршрутах.
*   **Источник данных:**
    *   **API:**
        *   `ApiService.checkStockOrder` (REST метод: `GET /app/v4/stock/orders/check`) - для получения списка аптек и проверки заказа.
        *   `ApiService.getRoutes` (REST метод: `POST /app/v1/routing/car`) - для построения маршрутов.
    *   **Локальное хранилище:** Таблица `StoresDao` (для сохранения выбранной аптеки).
    *   **Внешние SDK:** `DGis SDK` (для отображения карты, маркеров и маршрутов).

## 6. Особые Состояния/Логика

*   **Кластеризация маркеров по цене:** Используются `PriceViewProvider` и `PriceClusterViewProvider` для отображения маркеров и кластеров с учетом цены, что помогает пользователю быстро оценить стоимость заказа �� разных аптеках.
*   **Динамическое заполнение нижней панели:** Информация о выбранной аптеке и ее товарах динамически заполняет нижнюю панель при нажатии на маркер.
*   **Управление высотой нижней панели:** Высота нижней панели (`bottomSheetBehavior.setPeekHeight`) динамически регулируется в зависимости от содержимого, чтобы обеспечить оптимальное отображение.
*   **Отображение маршрутов:** Если доступны данные о маршрутах, они отображаются на карте с помощью `RouteMapObject`.
*   **Обработка ошибок:** Ошибки загрузки данных отображаются через `progress`.
*   **Сброс фильтров:** При нажатии на кнопку "Сбросить фильтры" в предупреждении, ViewModel сбрасывает примененные фильтры.
