# StoresControlMapFragment

## 1. Обзор Экрана

`StoresControlMapFragment` является частью экрана "Аптечный контроль". Он отображает аптеки, которые пользователь может контролировать или проверять, на интерактивной карте. Пользователь может выбрать аптеку на карте, чтобы просмотреть ее детали, выбрать ее для дальнейших действий или загрузить фотографии.

**Основные функции:**
*   Отображение аптек для контроля на карте в виде маркеров.
*   Кластеризация маркеров при отображении нескольких аптек.
*   Отображение детальной информации о выбранной аптеке в нижней панели.
*   Построение маршрута до выбранной аптеки.
*   Выбор аптеки для дальнейших действий.
*   Возможность загрузки фотографий для выбранной аптеки.
*   Управление масштабом карты и центрированием по местоположению пользователя.

## 2. Элементы Пользовательского Интерфейса (UI Elements)

*   **MapView (map):**
    *   **Назначение/Функция:** Интерактивная карта, на которой отображаются маркеры аптек.
    *   **Взаимодействие пользователя:** Перемещение, масштабирование карты. Нажатие на маркер аптеки открывает нижнюю панель с деталями.
*   **ProgressBar (progress):**
    *   **Назначение/Функция:** Индикатор загрузки, отображаемый во время загрузки данных об аптеках.
    *   **Возможные состояния:** Видимый во время загрузки, скрытый в других состояниях.
*   **RecyclerView (bottomSheetRV):**
    *   **Назначение/Функция:** Нижняя панель (BottomSheet), которая отображает детальную информацию о выбранной аптеке (`StoreSection`).
    *   **Взаимодействие пользователя:** Может быть свернута/развернута. Содержит информацию об аптеке.
*   **StoreSection:**
    *   **Назначение/Функция:** Отображает информацию о выбранной аптеке (название, адрес, кнопки действий).
    *   **Взаимодействие пользователя:** Нажатие на адрес аптеки открывает внешнее приложение для построения маршрута. Нажатие на кнопку "Выбрать" инициирует выбор аптеки. Нажатие на кнопку "Фотографии" инициирует загрузку фотографий.
*   **ImageView (mapOrientation):**
    *   **Назначение/Функция:** Кнопка для изменения ориентации карты.
    *   **Взаимодействие пользователя:** Нажатие изменяет ориентацию карты.
*   **ImageView (userLocation):**
    *   **Назначение/Функция:** Кнопка для центрирования карты по текущему местоположению пользователя.
    *   **Взаимодействие пользователя:** Нажатие центрирует карту.
*   **ImageView (plus, minus):**
    *   **Назначение/Функция:** Кнопки для увеличения/уменьшения масштаба карты.
    *   **Взаимодействие пользователя:** Нажатие изменяет масштаб карты.

## 3. Пользовательские Сценарии (User Flows)

*   **Просмотр аптек на карте:**
    1.  Пользователь открывает `StoresControlMapFragment`.
    2.  Отображается индикатор загрузки (`progress`).
    3.  ViewModel запрашивает список аптек для контроля.
    4.  Маркеры аптек отображаются на карте. Если аптек много, они кластеризуются.
    5.  При успешной загрузке, индикатор скрывается.
*   **Просмотр деталей аптеки:**
    1.  Пользователь нажимает на маркер аптеки на карте.
    2.  Нижняя панель (`bottomSheetRV`) разворачивается, отображая информацию о выбранной аптеке.
*   **Построение маршрута:**
    1.  Пользователь нажимает на адрес аптеки в нижней панели.
    2.  Открывается внешнее приложение для построения маршрута до выбранной аптеки.
*   **Выбор аптеки для действия:**
    1.  Пользователь нажимает на кнопку "Выбрать" на нижней панели.
    2.  Выбранная аптека передается в ViewModel через `viewModel.chooseStore()`.
    3.  (Предполагается, что это может привести к переходу на экран с деталями выбранной аптеки для дальнейших действий).
*   **Загрузка фотографий:**
    1.  Пользователь нажимает на кнопку "Фотографии" на нижней панели.
    2.  ID аптеки передается в ViewModel через `viewModel.loadPhotos()`.
    3.  (Предполагается, что это может открыть диалог или экран для загрузки фотографий).
*   **Управление картой:**
    1.  Пользователь нажимает кнопки `+` или `-` для изменения масштаба карты.
    2.  Пользователь нажимает кнопку "Мое местополож��ние" для центрирования карты по текущему местоположению.
    3.  Пользователь нажимает кнопку "Ориентация" для изменения ориентации карты.

## 4. Навигация

С экрана `StoresControlMapFragment` возможны следующие переходы:

*   **Внешние карты (Google Maps, Yandex Maps):** Для построения маршрута.
*   **Внутренняя навигация:** К другим частям экрана "Аптечный контроль" (например, к экрану загрузки фото), управляемым `StoresControlViewModel`.

### Deep Links

На этот экран нет прямых deep links.

## 5. Отображаемые Данные

*   **Типы данных:**
    *   `List<StoreForControl>`: Список объектов `StoreForControl`, каждый из которых содержит информацию об аптеке для контроля.
    *   `CheckFilterable.DistanceFilterable`: Информация о филь��ре по расстоянию.
*   **Источник данных:**
    *   **API:**
        *   `ApiService.getStoresForControl` (REST метод: `GET /app/v1/control/stores`) - для получения списка аптек для контроля.
        *   `ApiService.getStorePhotos` (REST метод: `GET /app/v1/control/store/images`) - для получения фотографий аптеки.
        *   `ApiService.getRoutes` (REST метод: `POST /app/v1/routing/car`) - для построения маршрутов.
    *   **Локальное хранилище:** Таблица `StoresDao` (для сохранения выбранной аптеки).
    *   **Внешние SDK:** `DGis SDK` (для отображения карты и маркеров).

## 6. Особые Состояния/Логика

*   **Кластеризация маркеров:** Используется `ClusterViewProvider` для группировки близко расположенных маркеров аптек в кластеры.
*   **Динамическое заполнение нижней панели:** Информация о выбранной аптеке динамически заполняет нижнюю панель при нажатии на маркер.
*   **Обработка ошибок:** Ошибки загрузки данных отображаются через `progress`.
*   **Фокусировка на аптеке:** Метод `focusPin()` используется для центрирования карты на выбранной аптеке и ее выделения.
*   **Фильтрация по расстоянию:** Карта может быть отфильтрована по расстоянию, и это влияет на отображение аптек.
