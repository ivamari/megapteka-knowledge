# LoadStorePhotosDialog

## 1. Обзор Экрана

`LoadStorePhotosDialog` — это нижний диалог (BottomSheetDialogFragment), который позволяет пользователю загружать фотографии для конкретной аптеки и добавлять к ним комментарий. Этот диалог используется в рамках функциональности "Аптечный контроль" для сбора визуальной информации об аптеках.

**Основные функции:**
*   Выбор нескольких фотографий из галереи или съемка на камеру.
*   Отображение выбранных фотографий.
*   Удаление выбранных фотографий.
*   Добавление текстового комментария к фотографиям.
*   Отправка фотографий и комментария.
*   Запрос разрешений на доступ к камере.
*   Обработка состояний загрузки, успеха и ошибки при отправке фотографий.

## 2. Элементы Пользовательского Интерфейса (UI Elements)

*   **RecyclerView:**
    *   **Назначение/Функция:** Горизонтальный список для отображения выбранных фотографий (`PhotosSection`).
    *   **Взаимодействие пользователя:** Горизонтальная прокрутка для просмотра всех фотографий. Нажатие на иконку "крестик" на фотографии удаляет ее из списка.
*   **EditText (comment):**
    *   **Назначение/Функция:** Поле для ввода текстового комментария к загружаемым фотографиям.
    *   **Взаимодействие пользователя:** Ввод текста.
*   **Button (pickMedia):**
    *   **Назначение/Функция:** Кнопка для выбора или съемки фотографий.
    *   **Взаимодействие пользователя:** Нажатие инициирует запрос разрешения на камеру (если необходимо) и затем открывает системный диалог для выбора и����точника изображения (камера/галерея).
*   **Button (send):**
    *   **Назначение/Функция:** Кнопка для отправки выбранных фотографий и комментария.
    *   **Возможные состояния:** Активна, если выбраны фотографии. Отображает индикатор загрузки во время выполнения операции.
    *   **Взаимодействие пользователя:** Нажатие инициирует процесс отправки фотографий.
*   **ImageButton (close):**
    *   **Назначение/Функция:** Кнопка для закрытия диалога.
    *   **Взаимодействие пользователя:** Нажатие закрывает диалог.

## 3. Пользовательские Сценарии (User Flows)

*   **Выбор и отправка фотографий:**
    1.  Пользователь открывает `LoadStorePhotosDialog`, передавая `storeId`.
    2.  Пользователь нажимает кнопку "Выбрать фото" (`pickMedia`).
    3.  Если разрешение на камеру не предоставлено, запрашивается разрешение.
    4.  Открывается системный диалог для выбора источника изображения (сделать фото или выбрать из галереи).
    5.  Пользователь выбирает одну или несколько фотографий.
    6.  Выбранные фотографии отображаются в горизонтальном списке (`PhotosSection`).
    7.  Пользователь может удалить ненужные фотографии, нажав на "крестик".
    8.  Пользователь вводит комментарий в поле `comment`.
    9.  Нажимает кнопку "Отправить" (`send`).
    10. Отображается индикатор загрузки.
    11. При успехе отображается диалог "Спасибо за контроль аптеки", фотографии очищаются, и диалог закрывается.
    12. При ошибке отображается диалог с сообщением об ошибке.
*   **Удаление фотографии:**
    1.  Пользователь нажимает на иконку "крестик" на фотографии в списке.
    2.  Фотография удаляется из списка.

## 4. Навигация

С диалога `LoadStorePhotosDialog` возможны следующие действия:

*   **Закрытие диалога:** При успешной отправке фотографий, при нажатии кнопки "Закрыть", или при нажатии кнопки "Назад" на устройстве.
*   **Системный выбор изображения:** Для выбора фото из галереи или съемки на камеру.
*   **Диалоговые окна:** Для отображения сообщений об успехе или ошибках.

### Deep Links

На этот экран нет прямых deep links.

## 5. Отображаемые Данные

*   **Типы данных:**
    *   `List<Uri>`: Список URI выбранных фотографий.
    *   Строка: Текстовый комментарий.
    *   `Resource<Unit>`: Для отслеживания статуса операции отправки фотографий.
*   **Источник данных:**
    *   **API:** `ApiService.sendStorePhotos` (REST метод: `POST /app/v1/control/store/create`) - для отправки фотографий и комментария.
    *   **Локальное хранилище:** `SavedStateHandle` (для временного хранения URI изображен��й).

## 6. Особые Состояния/Логика

*   **BottomSheetBehavior:** Диалог всегда развернут (`BottomSheetBehavior.STATE_EXPANDED`) при открытии.
*   **Сохранение URI камеры:** `cameraUri` сохраняется при изменении конфигурации для корректной работы с камерой.
*   **Обработка разрешений:** Перед использованием камеры запрашивается разрешение `Manifest.permission.CAMERA`.
*   **Множественный выбор изображений:** Используется `PickOrTakePictures` для выбора нескольких изображений.
*   **Очистка полей:** После успешной отправки фотографий, список URI очищается, и поле комментария сбрасывается.
*   **Динамическая видимость кнопки "Отправить":** Кнопка "Отправить" становится невидимой во время загрузки и снова видимой при успехе или ошибке.