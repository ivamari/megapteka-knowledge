# ItemsSearchFragment

## 1. Обзор Экрана

Экран "Поиск товаров" (ItemsSearchFragment) является центральным узлом для поиска товаров в приложении. Он предоставляет пользователю возможность искать товары по текстовому запросу, использовать голосовой ввод, сканировать штрих-коды, просматривать историю поиска, получать подсказки и фильтровать результаты поиска. Экран динамически адаптируется под состояние поиска (фокус на поле ввода, наличие результатов).

**Основные функции:**
*   Поиск товаров по текстовому запросу.
*   Голосовой поиск товаров.
*   Сканирование штрих-кодов для поиска товаров.
*   Отображение истории поисковых запросов и популярных запросов.
*   Предоставление подсказок по мере ввода текс��а (товары, группы).
*   Отображение списка найденных товаров с пагинацией.
*   Применение фильтров к результатам поиска.
*   Обработка состояний загрузки, ошибок и пустого списка при поиске товаров.

## 2. Элементы Пользовательского Интерфейса (UI Elements)

*   **Toolbar (через MenuProvider):**
    *   **Назначение/Функция:** Содержит поисковую строку (`SearchView`), кнопку голосового поиска (`action_speech`) и кнопку сканирования (`action_scan`).
    *   **Взаимодействие пользователя:** Ввод текста в `SearchView` инициирует поиск. Нажатие на иконку микрофона активирует голосовой ввод. Нажатие на иконку сканера переводит на экран сканирования.
*   **SearchView (action_search в меню):**
    *   **Назначение/Функция:** Поле для ввода поискового запроса. Всегда видимо и не сворачивается.
    *   **Взаимодействие пользователя:** Ввод текста для фильтрации списка товаров. Запросы отправляются с задержкой (debounce) для оптимизации производительности. При потере фокуса или отправке запроса, клавиатура скрывается.
*   **ImageButton (action_speech в меню):**
    *   **Назначение/Функция:** Кнопка для активации голосового поиска.
    *   **Возможные состояния:** Видима, если распознавание речи доступно на устройстве.
    *   **Взаимодействие пользователя:** Нажатие инициирует голосовой ввод. Иконка анимируется во время записи голоса.
*   **ImageButton (action_scan в меню):**
    *   **Назначение/Функция:** Кнопка для перехода к сканированию штрих-кода.
    *   **Взаимодействие пользователя:** Нажатие переводит на экран `ItemsScanActivity`.
*   **RecyclerView:**
    *   **Назначение/Функция:** Основной контейнер для отображения всех динамических секций экрана (подсказки, история, результаты поиска).
    *   **Взаимодействие пользователя:** Вертикальная прокрутка для просмотра содержимого.
*   **NoticeSection (paymentPromptSection):**
    *   **Назначение/Функция:** Вероятно, отображает уведомление или подсказку, связанную с оплатой или другими важными аспектами. Скрыта по умолчанию.
    *   **Возможные состояния:** Видима, если есть товары в списке.
    *   **Взаимодействие пользователя:** Неинтерактивный элемент.
*   **SearchQueriesSingleSection:**
    *   **Назначение/Функция:** Отображает список популярных или недавних поисковых запросов.
    *   **Возможные состояния:** Видима, если есть поисковые запросы.
    *   **Взаимодействие пользователя:** Нажатие на запрос инициирует поиск по этому запросу.
*   **SuggestsSection (suggestionItemsSection):**
    *   **Назначение/Функция:** Отображает список подсказок товаров по мере ввода текста в поисковую строку.
    *   **Возможные состояния:** Видима, если поле поиска в фокусе и есть подсказки.
    *   **Взаимодействие пользователя:** Нажатие на подсказку инициирует поиск по этому товару.
*   **TextHeaderSection (headerGroupSection):**
    *   **Назначение/Функция:** Заголовок для секции групп товаров в подсказках ("Категории").
    *   **Возможные состояния:** Видима, если поле поиска в фокусе и есть подсказки групп.
    *   **Взаимодействие пользователя:** Неинтерактивный элемент.
*   **SuggestsSection (suggestionGroupsSection):**
    *   **Назначение/Функция:** Отображает список подсказок групп товаров по мере ввода текста в поисковую строку.
    *   **Возможные состояния:** Видима, если поле поиска в фокусе и есть подсказки групп.
    *   **Взаимодействие пользователя:** Нажатие на подсказку инициирует переход к списку товаров в этой группе.
*   **ClearHistorySection:**
    *   **Назначение/Функция:** Предоставляет кнопку для очистки истории поиска.
    *   **Возможные состояния:** Видима, если есть история поиска.
    *   **Взаимодействие пользователя:** Нажатие очищает историю поиска.
*   **ItemsUnlimitedSection (itemsSection):**
    *   **Назначение/Функция:** Отображает список найденных товаров с пагинацией.
    *   **Возможные состояния:** Видима, если есть результаты поиска и поле поиска не в фокусе.
    *   **Взаимодействие пользователя:** Нажатие на товар для перехода к его деталям. Изменение количества товара в корзине, добавление/удаление из избранного.
*   **StateSection:**
    *   **Назначение/Функция:** Отображает состояния загрузки, ош��бки или пустого состояния данных для списка товаров.
    *   **Возможные состояния:**
        *   `LOADING`: Показывает индикатор прогресса и сообщение "Загрузка товаров".
        *   `ERROR`: Показывает сообщение об ошибке и кнопку "Повторить".
        *   `EMPTY`: Показывает сообщение о пустом результате поиска с возможностью сброса фильтров или перехода по ссылке.
        *   `HIDDEN`: Скрыт, когда данные успешно загружены и отображаются.
    *   **Взаимодействие пользователя:** Нажатие на кнопку "Повторить" (в состоянии ошибки) для повторной попытки загрузки данных. Нажатие на кнопку в пустом состоянии для сброса фильтров или навигации.
*   **FiltersSection (includedFilters.filtersRecyclerView):**
    *   **Назначение/Функция:** Отображает доступные фильтры для результатов поиска.
    *   **Возможные состояния:** Видима, если есть результаты поиска или история поиска.
    *   **Взаимодействие пользователя:** Нажатие на фильтр открывает диалог `FiltersDialog` для выбора значений фильтра.

## 3. Пользовательские Сценарии (User Flows)

*   **Поиск товара по текстовому запросу:**
    1.  Пользователь вводит текст в поисковую строку.
    2.  По мере ввода отображаются подсказки товаров и групп (`suggestionItemsSection`, `suggestionGroupsSection`).
    3.  При отправке запроса (нажатие Enter или потеря фокуса), или если запрос был передан из другого экрана, ViewModel инициирует поиск товаров.
    4.  Отображается индикатор загрузки (`StateSection`).
    5.  При получении результатов, `ItemsUnlimitedSection` отображает найденные товары.
    6.  Если результатов нет, отображается `StateSection` с сообщением о пустом поиске.
*   **Голосовой поиск:**
    1.  Пользователь нажимает на иконку микрофона.
    2.  Активируется системный распознаватель речи.
    3.  Пользователь произносит запрос.
    4.  Результат распознавания текста автоматически вставляется в поисковую строку, и инициируется поиск.
*   **Сканирование штрих-кода:**
    1.  Пользователь нажимает на иконку сканера.
    2.  Переходит на экран `ItemsScanActivity`.
*   **Выбор из истории поиска/популярных запросов:**
    1.  Пользователь нажимает на элемент в `SearchQueriesSingleSection`.
    2.  Поисковая строка заполняется выбранным запросом, и инициируется поиск.
*   **Выбор из подсказок:**
    1.  Пользователь нажимает на подсказку товара или группы.
    2.  Если это товар, инициируется поиск по этому товару. Если это группа, происходит навигация к списку товаров в этой группе.
*   **Очистка ��стории поиска:**
    1.  Пользователь нажимает на кнопку "Очистить историю" в `ClearHistorySection`.
    2.  История поиска удаляется.
*   **Применение фильтров:**
    1.  Пользователь нажимает на фильтр в `FiltersSection`.
    2.  Открывается диалог `FiltersDialog`.
    3.  Пользователь выбирает значения фильтров.
    4.  Список товаров обновляется в соответствии с выбранными фильтрами.

## 4. Навигация

С экрана "Поиск товаров" возможны следующие переходы:

*   **`ItemsScanActivity`:** Для сканирования штрих-кодов.
*   **`ItemDetailsFragment`:** Для просмотра детальной информации о товаре.
*   **`ItemsFragment`:** Для просмотра списка товаров в выбранной группе или по тегу.
*   **`FiltersDialog`:** Для применения фильтров.
*   **Навигация по DeepLink:** Если кнопка в пустом состоянии имеет deep-ссылку.

### Deep Links

На этот экран можно попасть по следующим deep links:

*   `{scheme}://{host}/search`
*   `{scheme}://{host}/search?q={query}`

## 5. Отображаемые Данные

*   **Типы да��ных:**
    *   `PagingData<Item>`: Для отображения списка найденных товаров.
    *   `List<SearchQuery>`: Список поисковых запросов (история, популярные).
    *   `SuggestList`: Объект, содержащий списки подсказок товаров и групп.
    *   `Meta`: Метаданные, включая информацию для пустого состояния.
*   **Источник данных:**
    *   **API:**
        *   `ApiService.getSearchItemsByQuery` (REST метод: `GET /app/v3/search/items`) - для получения списка товаров по поисковому запросу.
        *   `ApiService.getSuggestions` (REST метод: `GET /app/v1/search/suggestions`) - для получения подсказок поиска.
        *   `ApiService.getSearchQueries` (REST метод: `GET /ma/site/v3/search/queries`) - для получения истории поисковых запросов.
    *   **Локальное хранилище:** Нет прямого использования локального хранилища для этих данных.
    *   **Ввод пользователя:** Текстовый и голосовой ввод.

## 6. Особые Состояния/Логика

### 6.1. Логика Фильтрации
Экран использует абстрактный класс `Filterable` для представления различных типов фильтров. Для фильтрации результатов поиска применяются `ItemFilterable.DistanceFilterable` и `ItemFilterable.AllFilterable`. Управление фильтрами происходит через `FiltersDialog`, который позволяет пользователю выбирать и применять значения фильтров, обновляя список найденных товаров.

*   **Производительность на слабых устройствах:** Для ��стройств с низкой производительностью аниматор элементов `RecyclerView` отключается (`viewBinding.recyclerView.itemAnimator = null`).
*   **Динамическая видимость секций:** Видимость секций (подсказки, история, результаты) динамически изменяется в зависимости от того, находится ли поле поиска в фокусе, есть ли поисковый запрос и есть ли результаты.
*   **Оптимизация поиска:** Используется `debounce` и `distinctUntilChanged` для предотвращения частых запросов при вводе текста в `SearchView`.
*   **Анимация голосового поиска:** Иконка микрофона анимируется с использованием `AnimatedVectorDrawableCompat` во время записи голоса.
*   **Обработка ошибок Paging:** `handleLoadStates` обрабатывает различные состояния загрузки (начальная загрузка, добавление, ошибка) и отображает соответствующий UI через `StateSection`.
*   **Синхронизация корзины и избранного:** Методы `quantitiesChanged` и `favsChanged` позволяют обновлять UI списка товаров при изменении количества в корзине или статуса избранного из других частей приложения.
*   **Аналитика:** Действия пользователя (поиск, клики по товарам, добавление в корзину/избранное) логируются с помощью `AnUtils.logEvent`.
*   **Восстановление состояния:** Последний поисковый запрос сохраняется при изменении конфигурации и восстанавливается.
