# StoresControlFragment

## 1. Обзор Экрана

Экран "Аптечный контроль" (StoresControlFragment) предназначен для сотрудников, позволяя им просматривать и взаимодействовать с аптеками, находящимися под контролем. Он предоставляет два режима просмотра: список аптек и карту аптек. Пользователь может применять различные фильтры (по городу, расстоянию, маршруту) и искать аптеки, а также загружать фотографии для выбранной аптеки.

**Основные функции:**
*   Отображение списка аптек для контроля.
*   Отображение аптек на интерактивной карте.
*   Переключение между режимами списка и карты.
*   Применение фильтров к списку аптек (по городу, адресу, маршруту).
*   Поиск аптек по текстовому запросу.
*   Выбор аптеки для загрузки фотографий.
*   Просмотр загруженных фотографий аптеки.
*   Обработка разрешений на доступ к местоположению.

## 2. Элементы Пользовательского Интерфейса (UI Elements)

*   **Toolbar (через MenuProvider):**
    *   **Назначение/Функция:** Содержит поисковую строку (`SearchView`) для фильтрации аптек.
    *   **Взаимодействие пользователя:** Ввод текста в `SearchView` инициирует поиск по аптекам.
*   **SearchView (action_search_view в меню):**
    *   **Назначение/Функция:** Поле для ввода поискового запроса. Всегда видимо и не сворачивается.
    *   **Взаимодействие пользователя:** Ввод текста для фильтрации списка аптек. Запросы отправляются с задержкой (debounce) для оптимизации производительности.
*   **TabLayout (tabs):**
    *   **Назначение/Функция:** Предоставл��ет две вкладки: "Список" и "Карта", для переключения между различными представлениями аптек.
    *   **Возможные состояния:** Выбрана одна из вкладок.
    *   **Взаимодействие пользователя:** Нажатие на вкладку переключает отображаемый фрагмент (`StoresControlListFragment` или `StoresControlMapFragment`).
*   **RecyclerView (filtersRecyclerView):**
    *   **Назначение/Функция:** Отображает доступные фильтры для списка аптек (`FiltersSection`).
    *   **Взаимодействие пользователя:** Нажатие на фильтр (например, "Город", "Адрес", "Маршрут") открывает соответствующий диалог или экран для выбора параметров фильтрации.
*   **FrameLayout (consumerContainer):**
    *   **Назначение/Функция:** Контейнер для динамической загрузки фрагментов `StoresControlListFragment` или `StoresControlMapFragment` в зависимости от выбранной вкладки.
    *   **Взаимодействие пользователя:** Не имеет прямых интерактивных элементов, служит для отображения контента выбранной вкладки.

## 3. Пользовательские Сценарии (User Flows)

*   **Просмотр аптек:**
    1.  Пользователь открывает экран "Аптечный контроль".
    2.  По умолчанию выбрана одна из вкладок (например, "Список").
    3.  Отображается список аптек или карта аптек.
*   **Переключение между режимами:**
    1.  Пользователь нажимает на вкладку "Список" или "Карта".
    2.  Соответствующий фрагмент (`StoresControlListFragment` или `StoresControlMapFragment`) отображается в `consumerContainer`.
*   **Применение фильтров:**
    1.  Пользователь нажимает на фильтр в `filtersRecyclerView`.
    2.  В зависимости от типа фильтра, открывается диалог выбора города (`CityChooseActivity`), выбора адреса (`AddressesDialog`), выбора на карте (`SelectOnMapFragment`), или построения маршрута (`RouteFragment`).
    3.  После выбора параметров фильтрации, они применяются к списку аптек через `viewModel.applyCityFilter()`, `viewModel.applyAddressFilter()` или `viewModel.applyRouteFilter()`.
    4.  Список аптек обновляется в соответствии с фильтрами.
*   **Поиск аптек:**
    1.  Пользователь вводит текст в поисковую строку в тулбаре.
    2.  Список аптек фильтруется по запросу.
*   **Выбор аптеки для загрузки фотографий:**
    1.  Пользователь выбирает аптеку из списка или на карте.
    2.  Выбранная аптека передается в ViewModel через `viewModel.chooseStore()`.
    3.  Происходит навигация к экрану загрузки фотографий (`LoadStorePhotosDialog`).
*   **Просмотр фотографий аптеки:**
    1.  После выбора аптеки и загрузки ее фотографий, они могут быть отображены в полноэкранном режиме (`showOverlayImages`).
*   **Обработка разрешений на местоположе��ие:**
    1.  При создании фрагмента запрашивается разрешение `Manifest.permission.ACCESS_FINE_LOCATION`.
    2.  Результат запроса передается в ViewModel.

## 4. Навигация

С экрана "Аптечный контроль" возможны следующие переходы:

*   **Внутренние переключения фрагментов:** Между `StoresControlListFragment` и `StoresControlMapFragment`.
*   **`CityChooseActivity`:** Для выбора города.
*   **`AddressesDialog`:** Для выбора адреса.
*   **`AddEditAddressFragment`:** Для добавления/редактирования адреса (из `AddressesDialog`).
*   **`SelectOnMapFragment`:** Для выбора адреса на карте (из `AddressesDialog` или `RouteFragment`).
*   **`RouteFragment`:** Для построения маршрута.
*   **`LoadStorePhotosDialog`:** Для загрузки фотографий аптеки.
*   **Полноэкранный просмотр изображений:** Для просмотра загруженных фотографий аптеки.

### Deep Links

На этот экран можно попасть по следующим deep links:

*   `ma://{host}/pharmacy-control/{storeId}`

## 5. Отображаемые Данные

*   **Типы данн��х:**
    *   `List<StoreForControlFilterable>`: Список доступных фильтров для аптек.
    *   `StoreForControl`: Выбранная аптека для контроля.
    *   `List<String>`: Список URL фотографий аптеки.
*   **Источник данных:**
    *   **API:**
        *   `ApiService.getStoresForControl` (REST метод: `GET /app/v1/control/stores`) - для получения списка аптек для контроля.
        *   `ApiService.getStorePhotos` (REST метод: `GET /app/v1/control/store/images`) - для получения фотографий аптеки.
        *   `ApiService.getRegionsWithCities` (REST метод: `GET /app/v1/cities`) или `ApiService.getGuessedCity` (REST метод: `GET /app/v1/cities/locate`) - для получения информации о текущем городе.
        *   `ApiService.getAddresses` (REST метод: `GET clients/addresses`) - для получения списка адресов пользователя.
        *   `ApiService.getRoutes` (REST метод: `POST /app/v1/routing/car`) - для построения маршрутов.
    *   **Локальное хранилище:**
        *   Таблица `CitiesDao` (для получения текущего города).
        *   Таблица `AddressDao` (для кэширования адресов).
    *   **Входящие аргументы (`navArgs`):** ID аптеки (`args.storeId`), если фрагмент запущен для конкретной аптеки.
    *   **`FragmentResultListener`:** Для получения результатов из диалогов выбора города, адреса и маршрута.

## 6. Особые Состояния/Логика

### 6.1. Логика Фильтрации
Экран использует абстрактный класс `Filterable` для представления различных типов фильтров. Для фильтрации аптек применяются различные реализации `StoreForControlFilterable`, такие как `CityFilterable` (по городу), `DistanceFilterable` (по расстоянию) и `NoPhotoFilterable` (без фото). Управление фильтрами происходит через `FiltersSection`, который позволяет пользователю выбирать и применять значения фильтров, обновляя список аптек.

*   **Сохранение состояния вкладки:** Выбранная вкладка сохраняется при изменении конфигурации (например, поворот экрана) и восстанавливается.
*   **Динамиче��кая загрузка фрагментов:** Фрагменты списка и карты динамически добавляются/скрываются в `consumerContainer`.
*   **Производительность на слабых устройствах:** Для устройств с низкой производительностью аниматор элементов `RecyclerView` отключается.
*   **Обработка фокуса поисковой строки:** При получении фокуса поисковой строкой, она может быть очищена.
*   **Оптимизация поиска:** Используется `debounce` для предотвращения частых запросов при вводе текста в `SearchView`.
*   **Автоматическая фокусировка на аптеке:** Если фрагмент запущен с `storeId`, карта автоматически центрируется на этой аптеке.
*   **Обработка разрешений:** Запрашивается разрешение на доступ к местоположению.
