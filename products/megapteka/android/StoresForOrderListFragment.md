# StoresForOrderListFragment

## 1. Обзор Экрана

`StoresForOrderListFragment` является частью экрана выбора аптеки для заказа из наличия. Он отображает список аптек, в которых доступны товары из корзины, а также предупреждения, связанные с этими аптеками или товарами. Пользователь может выбрать аптеку из списка для оформления заказа, просмотреть детали аптеки, развернуть список товаров в аптеке, а также заменить отсутствующие товары.

**Основные функции:**
*   Отображение списка аптек, доступных для заказа из наличия.
*   Отображение предупреждений, связанных с аптеками или товарами.
*   Выбор аптеки для оформления заказа.
*   Просмотр информации о доступности аптеки.
*   Разворачивание/сворачивание списка товар��в в аптеке.
*   Замена отсутствующих товаров.
*   Обработка состояний загрузки, ошибок и пустого списка аптек.

## 2. Элементы Пользовательского Интерфейса (UI Elements)

*   **RecyclerView:**
    *   **Назначение/Функция:** Основной контейнер для отображения секций `StateSection`, `CheckWarningsSection` и `StoresSection`.
    *   **Взаимодействие пользователя:** Вертикальная прокрутка для просмотра содержимого.
*   **StateSection:**
    *   **Назначение/Функция:** Отображает состояния загрузки, ошибки или пустого состояния данных для списка аптек.
    *   **Возможные состояния:**
        *   `LOADING`: Показывает индикатор прогресса и сообщение "Загрузка аптек".
        *   `ERROR`: Показывает сообщение об ошибке и кнопку "Повторить".
        *   `EMPTY`: Показывает сообщение о пустом списке аптек с кнопкой "Вернуться в корзину".
        *   `HIDDEN`: Скрыт, когда данные успешно загружены и отображаются.
    *   **Взаимодействие пользователя:** Нажатие на кнопку "Повторить" (в состоянии ошибки) для повторной попытки загрузки данных. Нажатие на кнопку в пустом состоянии для возврата в корзину.
*   **CheckWarningsSection:**
    *   **Назначение/Функция:** Отображает предупреждения, связанные с проверкой заказа (например, изменения в наличии товаров).
    *   **Взаимодействие пользователя:** Нажатие на кнопку в предупреждении может инициировать действие (например, навигацию по deep-ссылке).
*   **StoresSection:**
    *   **Назначение/Функция:** Отображает список аптек. Каждый элемент аптеки, вероятно, включает название, адрес, цену, иконку доступности, а также список товаров и кнопки действий.
    *   **Взаимодействие пользователя:** Нажатие на карточку аптеки фокусирует ее (выбирает) в ViewModel. Нажатие на кнопку "Выбрать" инициирует выбор аптеки для оформления заказа. Нажатие на иконку доступности показывает информацию о доступности. Нажатие на кнопку "Развернуть/Свернуть" для списка товаров. Нажатие на кнопку "Заменить" для замены товара.

## 3. Пользовательские Сценарии (User Flows)

*   **Просмотр списка аптек:**
    1.  Пользователь открывает `StoresForOrderListFragment`.
    2.  Отображается индикатор загрузки (`StateSection`).
    3.  ViewModel запрашивает список аптек для заказа из наличия и связанные предупреждения.
    4.  При успешной загрузке, индикатор скрывается, и отображаются список аптек (`StoresSection`) и предупреждения (`CheckWarningsSection`).
    5.  Если список аптек пуст и нет предупреждений, отображается `StateSection` с сообщением о пустом списке.
*   **Выбор аптеки:**
    1.  Пользователь нажимает на кнопку "Выбрать" на карточке аптеки.
    2.  Выбранная аптека передается в ViewModel через `viewModel.chooseStore()`.
    3.  Происходит навигация к экрану подтверждения заказа (`OrderConfirmFragment`).
*   **Просмотр информации о доступности:**
    1.  Пользователь нажимает на иконку доступности на карточке аптеки.
    2.  Отображается всплывающее окно с подробной информацией о доступности аптеки для людей с ограниченными возможностями.
*   **Разворачивание/сворачивание товаров в аптеке:**
    1.  Пользователь нажимает на кнопку "Развернуть" (или аналогичную) на карточке аптеки.
    2.  Список товаров в этой аптеке разворачивается/сворачивается.
    3.  ViewModel может запросить детали товаров для развернутого списка (`viewModel.getOrdersInStore()`).
*   **Замена товара:**
    1.  Пользователь нажимает на кнопку "Заменить" рядом с товаром в списке аптеки.
    2.  Происходит навигация к диалогу замены товара (`ItemReplaceDialog`) с передачей ID товара и ID аптеки.
*   **Взаимодействие с предупреждениями:**
    1.  Пользователь нажимает на кнопку в предупреждении в `CheckWarningsSection`.
    2.  Происходит навигация по deep-ссылке, связанной с кнопкой.
*   **Обработка ошибок загрузки:**
    1.  При возникновении ошибки загрузки данных, `StateSection` отображает сообщение об ошибке и кнопку "Повторить".
    2.  Нажатие на кнопку "Повторить" инициирует повторную попытку загрузки данных.
*   **Возврат в корзину:**
    1.  В пустом состоянии списка аптек пользователь нажимает кнопку "Вернуться в корзину".
    2.  Происходит возвр��т на предыдущий экран (корзину).

## 4. Навигация

С экрана `StoresForOrderListFragment` возможны следующие переходы:

*   **`OrderConfirmFragment`:** Для подтверждения заказа после выбора аптеки.
*   **`ItemReplaceDialog`:** Для замены товара.
*   **Назад к предыдущему экрану (корзине):** При нажатии кнопки "Вернуться в корзину" в пустом состоянии или системной кнопки "Назад".
*   **Навигация по DeepLink:** Если кнопка в предупреждении имеет deep-ссылку.

### Deep Links

На этот экран нет прямых deep links.

## 5. Отображаемые Данные

*   **Типы данных:**
    *   `List<Check>`: Список объектов `Check`, каждый из которых содержит информацию об аптеке (`Store`) и товарах, доступных в ней.
    *   `List<CheckWarning>`: Список предупреждений, связанных с проверкой заказа.
    *   `StoreForOrder`: Детали аптеки с развернутыми товарами.
*   **Источник данных:**
    *   **API:**
        *   `ApiService.checkOrder` (REST метод: `GET /app/v4/orders/check`) - для получения списка аптек и проверки заказа.
        *   `ApiService.getOrderAnalogs` (REST метод: `GET /app/v2/items/order-analogs`) - для получения товаров-заменителей.
        *   `ApiService.syncCartItems` (REST метод: `POST /app/v1/cart/online`) - для синхронизации корзины.
        *   `ApiService.getOrdersInStore` (REST метод: `GET /app/v1/orders/store`) - д��я получения списка заказов в конкретной аптеке.
    *   **Локальное хранилище:**
        *   Таблица `ItemsDao` (для кэширования товаров в корзине и избранного).
        *   Таблица `StoresDao` (для сохранения выбранной аптеки).

## 6. Особые Состояния/Логика

*   **Производительность на слабых устройствах:** Для устройств с низкой производительностью аниматор элементов `RecyclerView` отключается (`viewBinding.recyclerView.itemAnimator = null`).
*   **Динамическая видимость секций:** Секции предупреждений и аптек отображаются/скрываются в зависимости от наличия данных.
*   **Обработка ошибок:** Ошибки загрузки данных отображаются через `StateSection`.
*   **Скролл к началу:** При получении события `viewModel.scrollToTop`, список прокручивается к началу.
*   **Обновление аптеки:** При получении `storeForOrder` из ViewModel, соответствующая аптека в списке обновляется.
