# UniqueStoresForOrderMapFragment

## Обзор Экрана
`UniqueStoresForOrderMapFragment` — это фрагмент, который отображает карту с аптеками, где доступен для заказа конкретный уникальный товар. Он предоставляет пользователю визуальное представление аптек на карте, информацию о товаре, предупреждения, а также детальную информацию о выбранной аптеке в нижней выдвигающейся панели. Пользователь может взаимодействовать с картой, изменять количество товара, просматривать маршруты до аптек и выбирать аптеку для оформления заказа.

## Элементы Пользовательского Интерфейса (UI Elements)
*   **Карта (MapView `map`)**:
    *   **Назначение/Функция**: Отображает географическую карту с маркерами аптек, где доступен товар. Поддерживает кластер��зацию маркеров по цене.
    *   **Возможные состояния**: Загрузка карты, отображение маркеров/кластеров, изменение масштаба/положения, отображение маршрутов.
    *   **Взаимодействие пользователя**: Перемещение по карте, изменение масштаба (кнопками или жестами), нажатие на маркер аптеки для фокусировки.
*   **Кнопка "Ориентация карты" (ImageView `mapOrientation`)**:
    *   **Назначение/Функция**: Изменяет ориентацию карты.
    *   **Возможные состояния**: Активная.
    *   **Взаимодействие пользователя**: Нажатие изменяет ориентацию карты.
*   **Кнопка "Мое местоположение" (ImageView `userLocation`)**:
    *   **Назначение/Функция**: Центрирует карту на текущем местоположении пользователя.
    *   **Возможные состояния**: Активная.
    *   **Взаимодействие пользователя**: Нажатие центрирует карту.
*   **Кнопки масштабирования (ImageView `plus`, `minus`)**:
    *   **Назначение/Функция**: Увеличивают или уменьшают масштаб карты.
    *   **Возможные состояния**: Активные.
    *   **Взаимодействие пользователя**: Нажатие изменяет масштаб карты.
*   **Информация о товаре (включенный макет `includedBottomItem`)**:
    *   **Назначение/Функция**: Отображает изображение товара (`itemImage`), название (`itemName`), цену от (`itemAmount`), точную цену (`itemPrice`) и контрол для изменения количества (`itemShopper`).
    *   **Возможные состояния**: Отображение данных товара.
    *   **Взаимодействие пользователя**: Нажатие на кнопки "+" и "-" в `itemShopper` для изменения количества товара.
*   **Предупреждения (RecyclerView `warningsRV` через `CheckWarningsSection`)**:
    *   **Назначение/Функция**: Отображает список предупреждений, связанных с заказом или аптеками.
    *   **Возможные состояния**: Видимые (если есть предупреждения), скрытые.
    *   **Взаимодействие пользователя**: Нажатие на кнопки в предупреждениях (например, "Сбросить фильтры").
*   **Нижний лист (BottomSheet `bottomSheet`)**:
    *   **Назначение/Функция**: Выдвигающаяся панель снизу экрана, отображающая детальную информацию о выбранной аптеке (адрес, график работы, доступность, список товаров в заказе).
    *   **Возможные состояния**: Скрыт, свернут, развернут.
    *   **Взаимодействие пользователя**: Свайп для изменения состояния, нажатие на элементы для разворачивания/сворачивания деталей.
*   **Индикатор прогресса (ProgressBar `progress`)**:
    *   **Назначение/Функция**: Визуально информирует о загрузке данных.
    *   **Возможные состояния**: Видимый (во время загрузки), скрытый.
    *   **Взаимодействие пользователя**: Нет прямого взаимодействия.

## Пользовательские Сценарии (User Flows)
*   **Просмотр аптек на карте**: Пользователь открывает экран карты, чтобы найти аптеку с нужным товаром.
*   **Изменение количества товара**: Пользователь может увеличить или уменьшить количество товара, которое он хочет заказать, и увидеть, как это влияет на доступность аптек.
*   **Фокусировка на аптеке**: Пользователь нажимает на маркер аптеки на карте, чтобы увидеть её детали в нижнем листе.
*   **Просмотр деталей аптеки**: В нижнем листе пользователь может просмотреть адрес аптеки, график работы, информацию о доступности и список товаров, доступных в этой аптеке.
*   **Просмотр маршрута**: Если доступен фильтр по расстоянию, на карте может отображаться маршрут до выбранной аптеки.
*   **Выбор аптеки**: Пользователь нажимает кнопку "Выбрать" в нижнем листе, чтобы оформить заказ в этой аптеке.

## Навигация
*   **Переход на `UniqueStoresForOrderMapFragment`**:
    *   Является частью `UniqueStoresForOrderFragment` и отображается внутри него.
*   **Переход с `UniqueStoresForOrderMapFragment`**:
    *   На экран оформления заказа: При нажатии на кнопку "Выбрать" в нижнем листе.
    *   По диплинку: При нажатии на кнопку в предупреждении (`link?.navigateDeeplink`).

### Deep Links

На этот экран нет прямых deep links.

## Отображаемые Данные
*   **Типы данных**: Объект `UniqueItem` (информация о товаре), список объектов `Check` (информация об аптеках и их предложениях), список объектов `CheckWarning` (предупреждения), данные для построения маршрутов (`Route`).
*   **Источники данных**:
    *   **API:**
        *   `ApiService.checkPreorderOrder` (REST метод: `GET /app/v1/preorders/check`) - для получения списка аптек для предзаказа (данные передаются из родительского ViewModel).
        *   `ApiService.checkDiscountedOrder` (REST метод: `GET /app/v1/discounted/orders/check`) - для получения списка аптек для уцененного заказа (данные передаются из родительского ViewModel).
    *   **Внешние SDK:**
        *   `DGis SDK` (для отображения карты, маркеров и построения маршрутов).
        *   `SuspendLocationProvider` (для получения текущего местоположения пользователя).
    *   **Локальное хранилище:** Нет прямого использования локального хранилища для списка аптек, но данные о выбранной аптеке могут быть сохранены через `StoresDao` в родительском фрагменте.

## Особые Состояния/Логика
*   **Управление картой**: Фрагмент наследуется от `BaseMapFragment`, предоставляя базовую функциональность работы с картой (DGis SDK), включая добавление маркеров, кластеризацию, центрирование, управление масштабом и ориентацией.
*   **Кластеризация по цене**: Маркеры аптек на карте могут быть сгруппированы в кластеры, отображающие диапазон цен на товар в этих аптеках.
*   **Динамическая высота нижнего листа**: Высота `peekHeight` нижнего листа динамически обновляется в зависимости от содержимого.
*   **Обработка состояний данных**: Фрагмент отслеживает состояние ресурсов (`Resource<List<Check>>` и `List<CheckWarning>`) для обновления UI.
*   **Изменение количества товара**: Методы `onQuantityInc` и `onQuantityDec` в `ShopperListener` обрабатывают увеличение/уменьшение количества товара и отправляют соответствующие события в `ViewModel`.
*   **Построение маршрутов**: Если доступен фильтр по расстоянию, фрагмент может отображать маршруты до аптек на карте.
*   **Аналитика**: Отслеживаются события изменения количества уникального товара (`AnEvent.incUniqueItemQuantity`, `AnEvent.decUniqueItemQuantity`).
*   **Вложенность**: Фрагмент является вложенным и получает `ViewModel` от родительского навигационного графа (`R.id.uniqueStoresForOrderFragment`).
