# ItemsSharedDialog

## 1. Обзор Экрана

`ItemsSharedDialog` — это нижний диалог (BottomSheetDialogFragment), который отображает список товаров, полученных через механизм "шэринга" (например, по ссылке). Пользователь может просматривать эти товары, выбирать их, добавлять в корзину, управлять избранным и переходить к оформлению заказа для отдельных товаров.

**Основные функции:**
*   Отображение списка товаров, полученных по ссылке.
*   Возможность выбора всех или отдельных товаров.
*   Добавление выбранных товаров в корзину.
*   Изменение количества товаров.
*   Добавление/удаление товаров из избранного.
*   Переход к деталям товара или к оформлению заказа для отдельных товаров.
*   Отображение общей суммы и количества выбранных товаров.
*   Обработка состояний загрузки, ошибок и пустого списка товаров.
*   Отображение предупреждений при добавлении в корзину.

## 2. Элементы Пользовательского Интерфейса (UI Elements)

*   **RecyclerView:**
    *   **Назначение/Функция:** Основной контейнер для отображения секций `SelectAllSection`, `CheckedItemsSection` и `StateSection`.
    *   **Взаимодействие пользователя:** Вертикальная прокрутка для просмотра содержимого.
*   **StateSection:**
    *   **Назначение/Функция:** Отображает состояния загрузки, ошибки или пустого состояния данных для списка товаров.
    *   **Возможные состояния:**
        *   `LOADING`: Показывает индикатор прогресса и сообщение "Загрузка товаров".
        *   `ERROR`: Показывает сообщение об ошибке и кнопку "Повторить".
        *   `EMPTY`: Показывает сообщение о пустом списке товаров.
        *   `HIDDEN`: Скрыт, когда данные успешно загружены и отображаются.
    *   **Взаимодействие пользователя:** Нажатие на кнопку "Повторить" (в состоянии ошибки) для повторной попытки загрузки данных.
*   **SelectAllSection:**
    *   **Назначение/Функция:** Предоставляет флажок "Выбрать все" и, возможно, кнопку "Удалить выбранные" (хотя в данном контексте используется только выбор).
    *   **Возможные состояния:** Флажок может быть установлен/снят.
    *   **Взаимодействие пользователя:** Установка/снятие флажка "Выбрать все" изменяет статус выбора всех товаров в списке.
*   **CheckedItemsSection (itemsSection):**
    *   **Назначение/Функция:** Отображает список товаров, полученных по ссылке. Каждый элемент включает изображение, назв��ние, цену, количество, кнопки `+`/`-`, флажок выбора и, возможно, кнопку действия.
    *   **Взаимодействие пользователя:** Изменение количества товара, выбор/снятие выбора товара, добавление/удаление из избранного, нажатие на кнопку действия (например, "Предзаказ", "Аналоги").
*   **TextView (quantity):**
    *   **Назначение/Функция:** Отображает общее количество выбранных товаров.
    *   **Взаимодействие пользователя:** Неинтерактивный элемент. Обновляется при изменении выбора или количества товаров.
*   **TextView (amount):**
    *   **Назначение/Функция:** Отображает общую стоимость выбранных товаров.
    *   **Взаимодействие пользователя:** Неинтерактивный элемент. Обновляется при изменении выбора или количества товаров.
*   **Button (addToCart):**
    *   **Назначение/Функция:** Кнопка для добав��ения всех выбранных товаров в корзину.
    *   **Возможные состояния:** Активна, если выбраны товары.
    *   **Взаимодействие пользователя:** Нажатие добавляет товары в корзину и закрывает диалог. Если товары не выбраны, отображается предупреждение.
*   **ImageButton (close):**
    *   **Назначение/Функция:** Кнопка для закрытия диалога.
    *   **Взаимодействие пользователя:** Нажатие закрывает диалог.

## 3. Пользовательские Сценарии (User Flows)

*   **Просмотр общих товаров:**
    1.  Пользователь открывает `ItemsSharedDialog`, передавая токен (`args.token`).
    2.  Отображается индикатор загрузки (`StateSection`).
    3.  ViewModel запрашивает список товаров по токену.
    4.  При успешной загрузке, индикатор скрывается, и `CheckedItemsSection` отображает список товаров.
    5.  Если список товаров пуст, отображается `StateSection` с сообщением о пустом списке.
*   **Выбор товаров:**
    1.  Пользователь устанавливает/снимает флажок на карточке товара.
    2.  Обновляются `quantity` и `amount`.
    3.  (Опционально) Пользователь нажимает флажок "Выбрать все" в `SelectAllSection` для выбора/снятия выбора всех товаров.
*   **Изменение количества товара:**
    1.  Пользователь нажимает `+` или `-` на карточке товара.
    2.  Количество товара обновляется, и пересчитываются `quantity` и `amount`.
*   **Добавление выбранных товаров в корзину:**
    1.  Пользователь нажимает кнопку "Добавить в корзину" (`addToCart`).
    2.  Если выбраны товары, они добавляются в корзину через `viewModel.addToCart()`, и диалог закрывается.
    3.  Если товары не выбраны, отображается диалог с сообщением "Не выбрано ни одного товара".
*   **Взаимодействие с кнопками действий на товаре:**
    1.  Пользователь нажимает на кнопку действия на карточке товара (например, "Предзаказ", "Аналоги").
    2.  Если товар имеет аналоги (`item.hasSimilar == true`), происходит навигация к экрану `ItemsSimilarFragment`.
    3.  В противном случае, если есть предупреждение о добавлении в корзину (`item.addCartWarning`), отображается всплывающее окно с предупреждением. После закрытия предупреждения или если его нет, происходит навигация к экрану оформления уникального заказа (`UniqueStoresForOrderFragment`).
*   **Добавление/удаление из избранного:**
    1.  Пользователь нажимает на иконку избранного на карточке товара.
    2.  Статус избранного обновляется через `viewModel.updateFavorite()`.

## 4. Навигация

С диалога `ItemsSharedDialog` возможны следующие переходы:

*   **Закрытие диалога:** При нажатии кнопки "Закрыть", при добавлении товаров в корзину, или при нажатии кнопки "Назад" на устройстве.
*   **`ItemsSimilarFragment`:** Для просмотра похожих товаров.
*   **`UniqueStoresForOrderFragment`:** Для оформления уникального заказа.
*   **Навигация по DeepLink:** Если кнопка в предупреждении имеет deep-ссылку.
*   **Диалоговые окна:** Для отображения предупреждений или ошибок.

## 5. Отображаемые Данные

*   **Типы данных:**
    *   `List<Item>`: Список товаров, полученных по ссылке. Каждый `Item` содержит информацию о товаре, его количестве в корзине, статусе избранного, типе заказа и предупреждениях.
    *   `AddCartWarning`: Объект, содержащий информацию о предупреждении при добавлении в корзину.
*   **Источник данных:**
    *   **API:**
        *   `ApiService.getSharedItems` (REST метод: `GET /app/v2/items/sharing`) - для получения списка товаров по сс��лке.
        *   `ApiService.syncCartItems` (REST метод: `POST /app/v1/cart/online`) - для синхронизации корзины после добавления товаров.
        *   `ApiService.putFavoriteItems` (REST метод: `PUT /ma/v3/items/favorites`) - для обновления статуса избранного.
    *   **Локальное хранилище:** Таблица `ItemsDao` (для получения/обновления количества товаров в корзине, статуса избранного).

## 6. Особые Состояния/Логика

*   **Производительность на слабых устройствах:** Для устройств с низкой производительностью аниматор элементов `RecyclerView` отключается (`viewBinding.recyclerView.itemAnimator = null`).
*   **BottomSheetBehavior:** Диалог всегда развернут (`BottomSheetBehavior.STATE_EXPANDED`) при открытии.
*   **Динамический расчет суммы и количества:** `handleCheckAndQuantityChanges()` пересчитывает и обновляет общую сумму и количество выбранных товаров при каждом изменении выбора или количества.
*   **Предупреждения при добавлении в корзину:** Метод `showCartWarning()` отображает кастомизированное всплывающее окно с предупреждением, если товар имеет `addCartWarning`. Это предупреждение может содержать кнопку с deep-ссылкой или просто подтверждение.
*   **Логирование аналитики:** Действия пользователя (добавление всех товаров в корзину, выбор/снятие выбора, добавление в избранное, предзаказ/скидка) логируются с помощью `AnUtils.logEvent`.
*   **Закрытие предупреждения:** Предупреждение может быть закрыто пользователем, и в некоторых случаях оно может быть закрыто навсегда (`closesPermanently`).