# OrderBriefFragment

## 1. Обзор Экрана

Экран "Краткая сводка по заказу" (OrderBriefFragment) предназначен для отображения краткой информации о заказе, включая список товаров и связанные предупреждения. Он также предоставляет функциональность для печати или обмена сводкой заказа в формате PDF.

**Основные функции:**
*   Отображение списка товаров, входящих в заказ.
*   Отображение предупреждений, связанных с заказом.
*   Возможность печати или обмена сводкой заказа (PDF).
*   Обработка состояний загрузки, ошибок и доступности файла сводки.

## 2. Элементы Пользовательского Интерфейса (UI Elements)

*   **Toolbar (через MenuProvider):**
    *   **Назначение/Функция:** Содержит кнопку "Поделиться" для обмена сводкой заказа.
    *   **Вз��имодействие пользователя:** Нажатие на кнопку "Поделиться" инициирует процесс загрузки и обмена PDF.
*   **RecyclerView:**
    *   **Назначение/Функция:** Основной контейнер для отображения секций `ItemsSection` и `WarningsSection`.
    *   **Взаимодействие пользователя:** Вертикальная прокрутка для просмотра содержимого.
*   **ItemsSection:**
    *   **Назначение/Функция:** Отображает список товаров, входящих в заказ. Каждый элемент, вероятно, включает название, количество и цену товара.
    *   **Взаимодействие пользователя:** Неинтерактивный элемент.
*   **WarningsSection:**
    *   **Назначение/Функция:** Отображает предупреждения, связанные с заказом (например, изменения в наличии товаров).
    *   **Взаимодействие пользователя:** Нажатие на предупреждение может открыть диалог с подробной информацией.
*   **Button (print):**
    *   **Назначение/Функция:** Кнопка для печати или обмена сводкой заказа.
    *   **Возможные состояния:** Видима, если URL для сводки доступен; скрыта в противном случае. Отображает индикатор загрузки во время загрузки URL.
    *   **Взаимодействие пользователя:** Нажатие инициирует процесс загрузки и обмена PDF.
*   **ProgressBar (progress):**
    *   **Назначение/Функция:** Индикатор загрузки, отображаемый во время загрузки URL сводки заказа.
    *   **Возможные состояния:** Видимый во время загрузки, скрытый в других состояниях.

## 3. Пользовательские Сценарии (User Flows)

*   **Просмотр краткой сводки:**
    1.  Пользователь открывает экран "Краткая сводка по заказу", передавая `orderId`.
    2.  ViewModel запрашивает детали заказа и URL для сводки.
    3.  Отображается индикатор загрузки (`progress`).
    4.  При успешной загрузке, индикатор скрывается, и отображаются список товаров (`ItemsSection`) и предупреждения (`WarningsSection`).
    5.  Если URL для сводки доступен, кнопка "Печать/Поделиться" (`print`) и кнопка "Поделиться" в тулбаре становятся видимыми.
*   **Печать/Обмен сводкой:**
    1.  Пользователь нажимает кнопку "Печать/Поделиться" или кнопку "Поделиться" в тулбаре.
    2.  Если версия Android ниже Q, запрашивается разрешение `WRITE_EXTERNAL_STORAGE`.
    3.  Инициируется загрузка PDF-файла сводки.
    4.  После загрузки открывается системное диалоговое окно для выбора приложения для обмена/печати.
    5.  Регистрируется аналитическое событие `AnEvent.shareBrief()`.
*   **Просмотр деталей предупреждения:**
    1.  Пользователь нажимает на предупреждение в `WarningsSection`.
    2.  Если предупреждение содержит `alert` (заголовок и текст), отображается диалог с подробной информацией.
*   **Обработка ошибок:**
    1.  При возникновении ошибки загрузки данных или URL сводки, отображается диалог с сообщением об ошибке.
    2.  Кнопка "Печать/Поделиться" скрывается.

## 4. Навигация

С экрана "Краткая сводка по заказу" возможны следующие действия:

*   **Назад к предыдущему экрану:** При нажатии кнопки "Назад" в тулбаре или системной кнопки "Назад".
*   **Системное диалоговое окно "Поделиться":** Открывается для обмена PDF-файлом сводки.
*   **Диалоговые окна:** Для отображения подробной информации о предупреждениях или ошибок.

### Deep Links

На этот экран нет прямых deep links.

## 5. Отображаемые Данные

*   **Типы данных:**
    *   `Order`: Объект, содержащий детали заказа, включая список товаров (`items`) и предупреждения (`warnings`).
    *   `OrderBrief`: Объект, содержащий URL для PDF-сводки заказа.
    *   `Warning`: Объект, представляющий предупреждение.
*   **Источник данных:**
    *   **API:**
        *   `ApiService.getDetailedOrder` (REST метод: `GET /app/v2/orders/detail`) - для получения деталей заказа.
        *   `ApiService.getOrderBriefUrl` (REST метод: `GET /app/v1/orders/brief`) - для получения URL PDF-сводки заказа.
    *   **Локальное хранилище:** Таблица `OrdersDao` (для кэширования деталей заказа).

## 6. Особые Состояния/Логика

*   **Производительность на слабых устройствах:** Для устройств с низкой производительностью аниматор элементов `RecyclerView` отключается (`viewBinding.recyclerView.itemAnimator = null`).
*   **Динамическая видимость кнопки "Печать/Поделиться":** Кнопка становится видимой только после успешной загрузки URL сводки.
*   **Обработка разрешений:** Для Android 9 и ниже запрашивается разрешение на запись во внешнее хранилище перед загрузкой фай��а.
*   **Загрузка и обмен PDF:** Используется вспомогательная функция `downloadAndShare` для загрузки PDF-файла и открытия системного диалога для его обмена.
*   **Логирование аналитики:** Обмен сводкой логируется с помощью `AnUtils.logEvent`.