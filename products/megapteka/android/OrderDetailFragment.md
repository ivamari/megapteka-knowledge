# OrderDetailFragment

## 1. Обзор Экрана

Экран "Детальная заказа" (OrderDetailFragment) предоставляет пользователю полную информацию о конкретном заказе. Он отображает статус заказа, детали аптеки, состав заказа, сводку, а также различные действия, доступные в зависимости от текущего статуса заказа (например, отменить, повторить, сменить аптеку, оценить). Экран также поддерживает функции обмена информацией о заказе и отслеживания.

**Основные функции:**
*   Отображение подробной информации о заказе: статус, номер, дата, время.
*   Информация об аптеке: адрес, возможность построения маршрута, информация о доступности.
*   Список товаров в заказе.
*   Св��дка по заказу: общая стоимость, скидки.
*   Динамически отображаемые действия: отмена, повтор, смена аптеки, подтверждение изменений, продление ожидания, удаление, оценка.
*   Возможность поделиться ссылкой на заказ или сводкой в PDF.
*   Отслеживание заказа и подписка на уведомления.
*   Голосовое воспроизведение номера заказа.
*   Обработка состояний загрузки, ошибок и пустого заказа.

## 2. Элементы Пользовательского Интерфейса (UI Elements)

*   **Toolbar (через MenuProvider):**
    *   **Назначение/Функция:** Содержит кнопку "Поделиться" для обмена ссылкой на заказ.
    *   **Взаимодействие пользователя:** Нажатие на кнопку "Поделиться" открывает системное диалоговое окно для обмена.
*   **SwipeRefreshLayout (swipeRefresh):**
    *   **Назначение/Функция:** Позволяет пользователю обновить инф��рмацию о заказе, потянув экран вниз.
    *   **Взаимодействие пользователя:** Свайп вниз для обновления данных.
*   **RecyclerView:**
    *   **Назначение/Функция:** Основной контейнер для отображения всех секций экрана: `StateSection`, `StatusSection`, `RateSection`, `ShareSection`, `StoreSection`, `WarningsSection`, `OrderItemsSection`, `SummarySection`, `IconedActionsSection`, `ActionsSection`.
    *   **Взаимодействие пользователя:** Вертикальная прокрутка для просмотра содержимого.
*   **StateSection:**
    *   **Назначение/Функция:** Отображает состояния загрузки, ошибки или пустого состояния данных для заказа.
    *   **Возможные состояния:**
        *   `LOADING`: Показывает индикатор прогресса и сообщение "Обновление заказа".
        *   `ERROR`: Показывает сообщение об ошибке и кнопку "Повторить".
        *   `EMPTY`: Показывает сообщение о пустом заказе.
        *   `HIDDEN`: Скрыт, когда данные успешно загружены и отображаются.
    *   **Взаимодействие пользователя:** Нажатие на кнопку "Повторить" (в состоянии ошибки) для повторной попытки загрузки данных.
*   **StatusSection:**
    *   **Назначение/Функция:** Отображает текущий статус заказа, его номер, дату и время. Может содержать кнопки для копирования номера, просмотра на карте и голосового воспроизведения номера.
    *   **Взаимодействие пользователя:** Нажатие на номер заказа копирует его в буфер обмена. Нажатие на "лупу" переводит на экран заказа на карте. Нажатие на иконку динамика воспроизводит номер заказа голосом.
*   **RateSection:**
    *   **Назначение/Функция:** Секция для оценки заказа. Видима, если заказ можно оценить.
    *   **Взаимодействие пользователя:** Нажатие на кнопку "Оценить" переводит на экран оценки заказа.
*   **ShareSection:**
    *   **Назначение/Функция:** Секция для обмена приложением или информацией о заказе. Видима, если доступна функция обмена.
    *   **Взаимодействие пользователя:** Нажатие на кнопку "Поделиться" открывает системное диалоговое окно для обмена.
*   **StoreSection:**
    *   **Назначение/Функция:** Отображает информацию об аптеке, из которой оформлен заказ (адрес, телефон, время работы). Может содержать кнопки для построения маршрута, просмотра входа и отслеживания заказа.
    *   **Взаимодействие пользователя:** Нажатие на адрес или кнопку "Показать на карте" открывает карту. Нажатие на "Как найти вход" переводит на экран входа. Нажатие на "Отслеживать" подписывает на уведомления. Нажатие на "Доступность" показывает информацию о доступности.
*   **WarningsSection:**
    *   **Назначение/Функция:** Отображает предупреждения, связанные с заказом.
    *   **Взаимодействие пользователя:** Нажатие на предупреждение может открыть диалог с подробной информацией. Кнопка "Закрыть" скрывает предупреждение.
*   **OrderItemsSection:**
    *   **Назначение/Функция:** Отображает список товаров, входящих в заказ. Может содержать кнопку для просмотра краткой сводки по товару.
    *   **Взаимодействие пользователя:** Нажатие на товар переводит на экран деталей товара. Нажатие на кнопку "Сводка" (если есть) логирует событие.
*   **SummarySection:**
    *   **Назначение/Функция:** Отображает сводку по заказу (общая стоимость, скидки).
    *   **Взаимодействие пользователя:** Неинтерактивный элемент.
*   **IconedActionsSection:**
    *   **Назначение/Функция:** Секция с иконизированными действиями (например, "Сводка", "Завершить").
    *   **Взаимодействие пользователя:** Нажатие на иконку выполняет соответствующее действие.
*   **ActionsSection:**
    *   **Назначение/Функция:** Секция с текстовыми кнопками действий (например, "Сменить аптеку", "Отменить заказ", "Повторить заказ").
    *   **Взаимодействие пользователя:** Нажатие на кнопку выполняет соответствующее действие.

## 3. Пользовательские Сценарии (User Flows)

*   **Просмотр деталей заказа:**
    1.  Пользователь открывает экран "Детальная заказа", передавая `orderId`.
    2.  Отображается индикатор загрузки (`StateSection`).
    3.  ViewModel запрашивает детали заказа.
    4.  При успешной загрузке, индикатор скрывается, и все секции отображают соответствующие данные.
    5.  Если заказ не найден, отображается `StateSection` с сообщением о пустом заказе.
*   **Обновление заказа:**
    1.  Пользователь выполняет жест "потяни-чтобы-обновить".
    2.  Информация о заказе перезагружается.
*   **Взаимодействие со статусом заказа:**
    1.  Пользователь нажимает на номер заказа для копирования.
    2.  Пользователь нажимает на "лупу" для просмотра заказа на карте.
    3.  Пользователь нажимает на иконку динамика для голосового воспроизведения номера заказа.
*   **Оценка заказа:**
    1.  Пользователь нажимает на кнопку "Оценить" в `RateSection`.
    2.  Переходит на экран оценки заказа (`OrderRateFragment`).
*   **Обмен информацией о заказе:**
    1.  Пользователь нажимает на кнопку "Поделиться" в тулбаре или в `ShareSection`.
    2.  Открывается системное диалоговое окно для обмена ссылкой на ��аказ или текстом.
*   **Взаимодействие с аптекой:**
    1.  Пользователь нажимает на кнопку "Маршрут" для построения маршрута к аптеке.
    2.  Пользователь нажимает на "Как найти вход" для просмотра информации о входе.
    3.  Пользователь нажимает на "Отслеживать" для подписки на уведомления о заказе (с запросом разрешений, если необходимо).
    4.  Пользователь нажимает на "Информация о доступности" для просмотра деталей о доступности аптеки.
*   **Выполнение действий с заказом:**
    1.  Пользователь нажимает на одну из кнопок действий (например, "Отменить заказ", "Повторить заказ", "Сменить аптеку").
    2.  Выполняется соответствующая логика: навигация к другому экрану, отправка запроса в API, отображение диалога подтверждения.
    3.  Регистрируются аналитические события.
*   **Обработка предупреждений:**
    1.  Пользователь нажимает на предупреждение в `WarningsSection`.
    2.  Если предупреждение содержит `alert`, отображается диалог с подробной информацией.

## 4. Навигация

С экрана "Детальная заказа" возможны следующие переходы:

*   **`OrderRateFragment`:** Для оценки заказа.
*   **`EntranceFragment`:** Для просмотра информации о входе в аптеку.
*   **`StoresOnMapFragment`:** Для просмотра аптеки на карте.
*   **`OrderBriefFragment`:** Для просмотра краткой сводки по заказу.
*   **`OrderCancelFragment`:** Для отмены заказа.
*   **`StoresForOrderFragment`:** Для смены аптеки.
*   **`UniqueStoresForOrderFragment`:** Для повтора уникального заказа.
*   **`CartFragment`:** Для повтора обычного заказа.
*   **`ItemsDetailsFragment`:** Для просмотра деталей товара из заказа.
*   **`TrackInfoFragment`:** Для просмотра информации об отслеживании з��каза.
*   **Системное диалоговое окно "Поделиться":** Для обмена ссылкой на заказ или текстом.
*   **Внешние карты (Google Maps, Yandex Maps):** Для построения маршрута.
*   **Диалоговые окна:** Для подтверждения действий, отображения предупреждений или ошибок.

### Deep Links

На этот экран можно попасть по следующим deep links:

*   `{scheme}://{host}/orders/{orderId}`
*   `{scheme}://{host}/orders?id={orderId}&action={action}`
*   `{scheme}://{host}/orders?token={orderToken}&action={action}`

## 5. Отображаемые Данные

*   **Типы данных:**
    *   `Order`: Объект, содержащий полную информацию о заказе (статус, аптека, товары, сводка, действия, URL для обмена).
    *   `Economy`: Информация об экономии.
    *   `List<Warning>`: Список предупреждений.
    *   `Parameter`: Общий параметр (например, текст для обмена).
    *   `List<OrderItem>`: Список товаров в заказе.
*   **Источник данных:**
    *   **API:**
        *   `ApiService.getEconomy` (REST метод: `GET /ma/site/v4/orders/benefit`) - для получения информации об экономии.
        *   `ApiService.getParameters` (REST метод: `GET parameters`) - для получения параметров (например, текст для обмена).
        *   `ApiService.getDetailedOrder` (REST метод: `GET /app/v2/orders/detail`) - для получения деталей заказа.
        *   `ApiService.confirmChanges` (REST метод: `POST /app/v2/orders/confirm`) - для подтверждения изменений в заказе.
        *   `ApiService.completeOrder` (REST метод: `POST /app/v2/orders/complete`) - для завершения заказа.
        *   `ApiService.extendWaitOrder` (REST метод: `POST /app/v2/orders/extend-wait`) - для продления ожидания заказа.
        *   `ApiService.deleteOrder` (REST метод: `POST /app/v1/orders/delete`) - для удаления заказа.
        *   `ApiService.subscribeOrderTracker` (REST метод: `POST /app/v1/orders/tracker/subscribe`) - для подписки на отслеживание заказа.
    *   **Локальное хранилище:**
        *   Таблица `OrdersDao` (для кэширования деталей заказа и удаления заказа).
        *   Таблица `ParametersDao` (для кэширования параметров).
        *   `SharedPreferences` (через `AppRepository` для удаления предупреждений).
        *   Таблица `ItemsDao` (для обновления количества товаров в корзине при повторе заказа).

## 6. Особые Состояния/Логика

*   **Производительность на слабых устройствах:** Для устройств с низкой производительностью аниматор элементов `RecyclerView` отключается (`viewBinding.recyclerView.itemAnimator = null`).
*   **Динамическая видимость секций и действий:** Многие секции и кнопки действий отображаются или скрываются в зависимости от текущего статуса заказа и доступных действий.
*   **Голосовое воспроизведение:** Используется `TextToSpeech` для голосового воспроизведения номера заказа.
*   **Копирование в буфер обмена:** Номер заказа может быть скопирован в буфер обмена.
*   **Обработка скриншотов:** При созда��ии скриншота экрана, пользователю предлагается поделиться им.
*   **Обработка ошибок API:** Ошибки, возвращаемые API, обрабатываются, и в зависимости от типа ошибки могут быть предложены специфические действия (например, перезагрузка данных, исключение аптеки, переход к списку заказов).
*   **Логирование аналитики:** Все действия пользователя и изменения состояния заказа логируются с помощью `AnUtils.logEvent`.
*   **Подписка на трекер заказа:** При необходимости, запрашивается разрешение на уведомления для подписки на отслеживание заказа.