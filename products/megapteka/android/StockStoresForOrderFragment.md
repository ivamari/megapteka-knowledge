# StockStoresForOrderFragment

## 1. Обзор Экрана

Экран "Заказ со склада" (StockStoresForOrderFragment) предназначен для выбора аптеки, из которой будет оформлен заказ на товары, находящиеся на складе. Он предоставляет пользователю два режима просмотра: список аптек и карту аптек. Пользователь может применять различные фильтры (например, по расстоянию, маршруту) и искать аптеки.

**Основные функции:**
*   Отображение списка аптек, доступных для заказа со склада.
*   Отображение аптек на интерактивной карте.
*   Переключение между режимами списка и карты.
*   Применение фильтров к списку аптек (по адресу, маршруту).
*   Поиск аптек.
*   Выбор аптеки для оформления заказа.
*   Обработка разрешений на доступ к местоположению.

## 2. Элементы Пользовательского Интерфейса (UI Elements)

*   **TabLayout (tabs):**
    *   **Назначение/Функция:** Предоставляет две вкладки: "Список" и "Карта", для переключения между различными представлениями аптек.
    *   **Возможные состояния:** Выбрана одна из вкладок.
    *   **Взаимодействие пользователя:** Нажатие на вкладку переключает отображаемый фрагмент (`StockStoresForOrderListFragment` или `StockStoresForOrderMapFragment`).
*   **RecyclerView (filtersRecyclerView):**
    *   **Назначение/Функция:** Отображает доступные фильтры для списка аптек (`FiltersSection`).
    *   **Взаимодействие пользователя:** Нажатие на фильтр (например, "Адрес", "Маршрут") открывает соответствующий диалог или экран для выбора параметров фильтрации.
*   **FrameLayout (consumerContainer):**
    *   **Назначение/Функция:** Контейнер для динамической загрузки фрагментов `StockStoresForOrderListFragment` или `StockStoresForOrderMapFragment` в зависимости от выбранной вкладки.
    *   **Взаимодействие пользователя:** Не имеет прямых интерактивных элементов, служит для отображения контента выбранной вкладки.

## 3. Пользовательские Сценарии (User Flows)

*   **Просмотр аптек:**
    1.  Пользователь открывает экран "Заказ со склада".
    2.  По умолчанию выбрана одна из вкладок (например, "Список").
    3.  Отображается список аптек или карта аптек.
*   **Переключение между режимами:**
    1.  Пользователь нажимает на вкладку "Список" или "Карта".
    2.  Соответствующий фрагмент (`StockStoresForOrderListFragment` или `StockStoresForOrderMapFragment`) отображается в `consumerContainer`.
*   **Применение фильтров:**
    1.  Пользователь нажимает на фильтр в `filtersRecyclerView`.
    2.  В зависимости от типа фильтра, открывается диалог выбора адреса (`AddressesDialog`), выбора на карте (`SelectOnMapFragment`), или построения маршрута (`RouteFragment`).
    3.  После выбора параметров фильтрации, они применяются к списку аптек через `viewModel.applyAddressFilter()` или `viewModel.applyRouteFilter()`.
    4.  Список аптек обновляется в соответствии с фильтрами.
    5.  Регистрируется аналитическое событие `AnEvent.applyStoreFilters()`.
*   **Поиск аптек:**
    1.  Пользователь нажимает на иконку поиска в тулбаре.
    2.  Происходит навигация к экрану подсказок поиска аптек (`StoresSearchSuggestionsFragment`).
    3.  После выбора подсказки, она применяется как фильтр адреса.
*   **Выбор аптеки для заказа:**
    1.  Пользователь выбирает аптеку из списка или на карте.
    2.  Выбранная аптека передается в ViewModel через `viewModel.chooseStore()`.
    3.  Происходит навигация к экрану подтверждения заказа (`OrderConfirmFragment`).
*   **Обработка разрешений на местоположение:**
    1.  При создании фрагмента запрашивается разрешение `Manifest.permission.ACCESS_FINE_LOCATION`.
    2.  Результат запроса передается в ViewModel.

## 4. Навигация

С экрана "Заказ со склада" возможны следующие переходы:

*   **Внутренние переключения фрагментов:** Между `StockStoresForOrderListFragment` и `StockStoresForOrderMapFragment`.
*   **`AddressesDialog`:** Для выбора адреса.
*   **`AddEditAddressFragment`:** Для добавления/редактирования адреса (из `AddressesDialog`).
*   **`SelectOnMapFragment`:** Для выбора адреса на карте (из `AddressesDialog` или `RouteFragment`).
*   **`StoresSearchSuggestionsFragment`:** Для поиска аптек.
*   **`RouteFragment`:** Для построения маршрута.
*   **`OrderConfirmFragment`:** Для подтверждения заказа после выбора аптеки.

### Deep Links

На этот экран можно попасть по следующим deep links:

*   `ma://basket-on-order?orderUuid={orderUuid}&prevOrderId={prevOrderId}&source={source}`

## 5. Отображаемые Данные

*   **Типы данных:**
    *   `List<CheckFilterable>`: Список доступных фильтров для аптек.
    *   `Address`: Выбранный адрес для фильтрации.
    *   `StoreSearchSuggest`: Подсказка для поиска аптек.
    *   `Check`: Выбранная аптека для заказа.
*   **Источник данных:**
    *   **API:**
        *   `ApiService.checkStockOrder` (REST метод: `GET /app/v4/stock/orders/check`) - для получения списка аптек и предупреждений.
        *   `ApiService.getRegionsWithCities` (REST метод: `GET /app/v1/cities`) - для получения текущего города (через `RegionsRepository`).
        *   `ApiService.getRoutes` (REST метод: `POST /app/v1/routing/car`) - для построения маршрутов (через `AddressesRepository`).
    *   **Локальное хранилище:**
        *   Таблица `CitiesDao` (для получения текущего города).
        *   `SavedStateHandle` (для хранения `MultiCheck` и `prevOrderId`).
    *   **Внешние SDK:**
        *   `DGis SDK` (для построения маршрутов).
        *   `SuspendLocationProvider` (для получения текущего местоположения пользователя).

## 6. Особые Состояния/Логика

### 6.1. Логика Фильтрации
Экран использует абстрактный класс `Filterable` для представления различных типов фильтров. Для фильтрации аптек применяются различные реализации `CheckFilterable`, такие как `CityFilterable` (по городу), `AvailabilityFilterable` (по наличию), `DistanceFilterable` (по расстоянию), `OpennessFilterable` (по открытости), `AroundTheClockFilterable` (круглосуточные), `PriceFilterable` (по цене) и `AccessibilityFilterable` (по доступности). Управление фильтрами происходит через `FiltersSection`, который позволяет пользователю выбирать и применять значения фильтров, обновляя список аптек.

*   **Производительность на слабых устройствах:** Для устройств с низкой производительностью аниматор элементов `RecyclerView` отключается (`viewBinding.recyclerView.itemAnimator = null`).
*   **Динамическая видимость секций:** Секции предупреждений и аптек отображаются/скрываются в зависимости от наличия данных.
*   **Обработка ошибок:** Ошибки загрузки данных отображаются через `StateSection`.
*   **Сброс фильтров:** При нажатии на кнопку "Сбросить фильтры" в предупреждении, ViewModel сбрасывает примененные фильтры.