# CityChooseActivity

## 1. Обзор Экрана

Экран "Выбор города" (CityChooseActivity) позволяет пользователю выбрать город из списка, просмотреть историю недавних выборов, а также найти город с помощью поисковой строки. Этот экран является критически важным для персонализации контента приложения, так как многие функции зависят от выбранного города.

**Основные функции:**
*   Поиск городов по названию.
*   Отображение истории недавно выбранных городов.
*   Отображение списка регионов и городов.
*   Выбор города и сохранение его как текущего.
*   Возможность очистки истории поиска.
*   Обработка состояний загрузки, ошибок и пустого списка при получении данных о городах.

## 2. Элементы Пользовательского Интерфе��са (UI Elements)

*   **Toolbar (через `IncludeAppBarBinding`):**
    *   **Назначение/Функция:** Отображает заголовок экрана "Выбор города" и кнопку "Назад". Содержит поисковую строку (`SearchView`).
    *   **Взаимодействие пользователя:** Нажатие на кнопку "Назад" закрывает экран. Ввод текста в `SearchView` инициирует поиск городов.
*   **SearchView (action_search_view в меню):**
    *   **Назначение/Функция:** Поле для ввода поискового запроса для городов.
    *   **Взаимодействие пользователя:** Ввод текста для фильтрации списка городов. Запросы отправляются с задержкой (debounce) для оптимизации производительности.
*   **RecyclerView:**
    *   **Назначение/Функция:** Основной контейнер для отображения секций `HistorySection`, `ClearHistorySection`, `RegionsCitiesSection` и `StateSection`.
    *   **Взаимодействие пользователя:** Вертикальная прокрутка для прос��отра содержимого.
*   **HistorySection:**
    *   **Назначение/Функция:** Отображает список городов, которые пользователь выбирал ранее.
    *   **Возможные состояния:** Список городов, пустой список (влияет на видимость `ClearHistorySection`).
    *   **Взаимодействие пользователя:** Нажатие на город для его выбора. Кнопка "Очистить" для удаления города из истории.
*   **ClearHistorySection:**
    *   **Назначение/Функция:** Предоставляет кнопку для полной очистки истории выбранных городов.
    *   **Возможные состояния:** Видима, если `HistorySection` не пуста; скрыта в противном случае.
    *   **Взаимодействие пользователя:** Нажатие для очистки всей истории.
*   **RegionsCitiesSection:**
    *   **Назначение/Функция:** Отображает иерархический список регионов и городов, доступных для выбора.
    *   **Взаимодействие пользо��ателя:** Нажатие на город для его выбора.
*   **StateSection:**
    *   **Назначение/Функция:** Отображает состояния загрузки, ошибки или пустого состояния данных для списка регионов/городов.
    *   **Возможные состояния:**
        *   `LOADING`: Показывает индикатор прогресса и сообщение "Загрузка городов".
        *   `ERROR`: Показывает сообщение об ошибке и кнопку "Повторить".
        *   `EMPTY`: Показывает сообщение "Пусто" (если нет результатов поиска).
        *   `HIDDEN`: Скрыт, когда данные успешно загружены и отображаются.
    *   **Взаимодействие пользователя:** Нажатие на кнопку "Повторить" (в состоянии ошибки) для повторной попытки загрузки данных.

## 3. Пользовательские Сценарии (User Flows)

*   **Выбор города из списка:**
    1.  Пользователь открывает экран "Выбор города".
    2.  Отображается история городов и/или список регионов с городами.
    3.  Пользователь нажимает на название города.
    4.  Если экран запущен как `CHOOSER` (для возврата результата), выбранный город возвращается на предыдущий экран, и активность завершается.
    5.  В противном случае, выбранный город устанавливается как текущий в ViewModel, и активность завершается.
*   **Поиск города:**
    1.  Пользователь вводит текст в поисковую строку.
    2.  Список городов фильтруется в реальном времени по мере ввода.
    3.  Результаты поиска отображаются в `RegionsCitiesSection`.
*   **Очистка истории:**
    1.  Пользователь нажимает на кнопку "Очистить историю" (если она видна).
    2.  История выбранных городов удаляется.
*   **Обработка ошибок загрузки:**
    1.  При возникновении ошибки загрузки данных, `StateSection` ��тображает сообщение об ошибке и кнопку "Повторить".
    2.  Нажатие на кнопку "Повторить" инициирует повторную попытку загрузки данных.

## 4. Навигация

С экрана "Выбор города" возможны следующие действия:

*   **Закрытие экрана:** При выборе города, при нажатии кнопки "Назад" в тулбаре.
*   **Диалоговые окна:** Для отображения сообщений об ошибках.
*   **Экран чата:** При нажатии на кнопку чата.

### Deep Links

На этот экран нет прямых deep links.

## 5. Отображаемые Данные

*   **Типы данных:**
    *   `City`: Объект, представляющий город, с информацией о названии, ID и т.д.
    *   `Region`: Объект, представляющий регион, содержащий список городов.
*   **Источник данных:**
    *   **API:**
        *   `ApiService.getRegionsWithCities` (REST метод: `GET /app/v1/cities`) - для получения списка регионов с городами.
        *   `ApiService.telemetry` (REST метод: `PUT /ma/site/v1/auth/telemetry`) - для отправки телеметрии при смене города.
    *   **Локальное хранилище:** Таблица `CitiesDao` (для хранения истории выбранных городов и текущего города).

## 6. Особые Состояния/Логика

*   **Обработка Insets:** Экран корректно обрабатывает системные отступы (status bar, navigation bar, IME) для правильного отображения UI.
*   **Сохранение состояния запроса:** Последний поисковый запрос сохраняется при изменении конфигурации (например, поворот экрана) и восстанавливается.
*   **Оптимизация поиска:** Используется `debounce` и `distinctUntilChanged` для предотвращения частых запросов при вводе текста в `SearchView`.
*   **Аналитика:** Выбор города логируется с помощью `AnUtils.logEvent`, включая информацию о предыдущем и новом городе.
*   **Ширина `SearchView`:** Максимальная ширина `SearchView` динамически рассчитывается, чтобы она не перекрывала другие элементы меню.