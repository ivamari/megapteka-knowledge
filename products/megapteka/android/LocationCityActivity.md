# LocationCityActivity

## 1. Обзор Экрана

Экран "Автоматический выбор города" (LocationCityActivity) предназначен для автоматического определения текущего города пользователя на основе его местоположения. Если автоматическое определение не удается или пользователь хочет выбрать город вручную, экран предоставляет соответствующие опции. Этот экран часто является первым, который видит пользователь при запуске приложения, если город еще не определен.

**Основные функции:**
*   Автоматическое определение ближайшего города на основе геолокации.
*   Запрос необходимых разрешений на доступ к местоположению.
*   Обработка различных состояний определения местоположения (прогресс, успех, неудача).
*   Предложение пользователю подтвердить определенный город или выбрать его вручную.
*   Перенаправление на главный экран приложения после успешного выбора города.

## 2. Элементы Пользовательского Интерфейса (UI Elements)

*   **ImageView (progress):**
    *   **Назначение/Функция:** Отображает анимированный индикатор прогресса во время определения местоположения.
    *   **Возможные состояния:** Видимый во время загрузки, скрытый в других состояниях.
*   **ImageView (imgProgress):**
    *   **Назначение/Функция:** Отображает статичное изображение, соответствующее текущему состоянию (прогресс, успех, неудача).
    *   **Возможные состояния:** Изображение прогресса, изображение успеха (зеленая галочка), изображение неудачи (красный крест).
*   **TextView (label):**
    *   **Назначение/Функция:** Отображает основно���� заголовок или сообщение, описывающее текущее состояние (например, "Определяем город", "Это ваш город?", "Город не найден").
    *   **Взаимодействие пользователя:** Неинтерактивный элемент. Текст и стиль меняются в зависимости от состояния.
*   **TextView (text):**
    *   **Назначение/Функция:** Отображает название определенного города или дополнительное сообщение (например, "Попробуйте выбрать вручную").
    *   **Взаимодействие пользователя:** Неинтерактивный элемент. Текст и стиль меняются в зависимости от состояния.
*   **Button (buttonConfirm):**
    *   **Назначение/Функция:** Кнопка для подтверждения автоматически определенного города.
    *   **Возможные состояния:** Видима и активна только в состоянии успеха, когда город определен.
    *   **Взаимодействие пользователя:** Нажатие устанавливает определенный город как текущий и переходит на главный экран.
*   **TextView (cityChoose):**
    *   **Назначение/Функция:** Кнопка-ссылка для перехода к экрану ручного выбора города.
    *   **Взаимодействие пользователя:** Нажатие открывает `CityChooseActivity`.

## 3. Пользовательские Сценарии (User Flows)

*   **Автоматическое определение города:**
    1.  Экран открывается.
    2.  Проверяются разрешения на местоположение.
    3.  Если разрешения есть, запускается процесс определения ближайшего города (`viewModel.getNearest()`).
    4.  Отображается состояние `STATE_PROGRESS` (анимация загрузки, текст "Определяем город").
    5.  При успешном определении города, UI переходит в состояние `STATE_SUCCESS` (отображается название города, кнопка "Да, это мой город").
    6.  При ошибке определения (например, нет интернета, не удалось найти город), UI переходит в состояние `STATE_FAILURE` (сообщение "Город не найден").
*   **Подтверждение города:**
    1.  В состоянии `STATE_SUCCESS` пользователь нажимает кнопку "Да, это мой город".
    2.  Определенный город устанавливается как текущий.
    3.  Происходит переход на главный экран приложения (`NavigationActivity`).
*   **Ручной выбор города:**
    1.  Пользователь нажимает кнопку "Выбрать вручную" (в любом состоянии).
    2.  Происходит переход на экран `CityChooseActivity`.
    3.  После выбора города на `CityChooseActivity`, пользователь возвращается на этот экран, и затем перенаправляется на главный экран.
*   **Обработка отсутствия разрешений на местоположение:**
    1.  Если разрешения на местоположение не предоставлены, отображается `Snackbar` с предложением перейти в н��стройки приложения.
    2.  Нажатие на кнопку "Настройки" в `Snackbar` открывает системные настройки приложения для предоставления разрешений.
*   **Обработка отключенной службы геолокации:**
    1.  Если служба геолокации отключена, инициируется запрос на ее включение через `ResolvableApiException`.
    2.  Пользователю предлагается включить геолокацию через системный диалог.

## 4. Навигация

С экрана "Автоматический выбор города" возможны следующие переходы:

*   **`CityChooseActivity`:** Для ручного выбора города.
*   **`NavigationActivity`:** Главный экран приложения, после успешного выбора/подтверждения города.
*   **Системные настройки:** Для предоставления разрешений на местоположение или включения службы геолокации.
*   **Системные диалоги:** Для запроса включения геолокации.

### Deep Links

На этот экран нет прямых deep links.

## 5. О��ображаемые Данные

*   **Типы данных:**
    *   `City`: Объект, представляющий город, с информацией о названии, ID и т.д.
    *   `Resource<City?>`: Используется для отслеживания статуса определения ближайшего города.
    *   `Resource<City>`: Используется для отслеживания статуса установки текущего города.
*   **Источник данных:**
    *   **API:**
        *   `ApiService.getGuessedCity` (REST метод: `GET /app/v1/cities/locate`) - для определения ближайшего города.
        *   `ApiService.telemetry` (REST метод: `PUT /ma/site/v1/auth/telemetry`) - для отправки телеметрии при установке текущего города.
    *   **Локальное хранилище:** Таблица `CitiesDao` (для сохранения текущего города).

## 6. Особые Состояния/Логика

*   **Обработка Insets:** Экран корректно обрабатывает системные отступы (status bar, navigation bar, IME) для правильного отображения UI.
*   **Анимация загрузки:** Используется Glide для отображения анимированного прогресс-бара.
*   **Управление разрешениями:** Комплексная логика для запроса и обработки разрешений на местоположение, включая сценарии, когда разрешения были постоянно отклонены.
*   **Состояния UI:** Метод `setupUI` динамически изменяет видимость элементов, текст и стили в зависимости от состояния определения города (прогресс, успех, неудача).
*   **Доступность:** Используется `sendAccessibilityEvent` для улучшения доступности, чтобы скринридеры могли объявлять изменения текста.