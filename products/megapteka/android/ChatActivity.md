# ChatActivity

## 1. Обзор Экрана

Экран "Чат с провизором" (ChatActivity) предоставляет пользователю возможность общаться с провизором или службой поддержки. Он интегрирует внешний SDK для чата и позволяет отправлять сообщения, включая предварительно заданные, а также обрабатывает информацию о пользователе (email, телефон, город, токен устройства) для инициализации чата.

**Основные функции:**
*   Загрузка и отображение интерфейса чата.
*   Отправка сообщений в чат, включая сообщения, переданные при запуске активности.
*   Передача информации о пользователе (email, телефон, город, токен устройства) в чат.
*   Обработка успешной отправки сообщения с возможностью закрытия экрана.
*   Управление статусом неп��очитанных сообщений чата.

## 2. Элементы Пользовательского Интерфейса (UI Elements)

*   **Toolbar (через `IncludeAppBarBinding`):**
    *   **Назначение/Функция:** Отображает заголовок экрана (например, "Чат с провизором") и кнопку "Назад" для навигации.
    *   **Взаимодействие пользователя:** Нажатие на кнопку "Назад" закрывает экран.
*   **ChatView (из внешнего SDK):**
    *   **Назначение/Функция:** Основной компонент, предоставляющий функциональность и UI чата. Загружает веб-интерфейс чата.
    *   **Взаимодействие пользователя:** Ввод текста, отправка сообщений, просмотр истории чата.

## 3. Пользовательские Сценарии (User Flows)

*   **Открытие чата и инициализация:**
    1.  Пользователь открывает `ChatActivity`.
    2.  Происходит инъекция зависимостей и настройка системных отступов.
    3.  Загружается `ChatView`.
    4.  Получается информация о текущем городе и токене устройства.
    5.  Эта информация, а также email и телефон пользователя, передаются в `ChatView` для инициализации клиента чата.
    6.  Если при запуске активности было передано сообщение (`args.message`), оно отправляется в чат после получения `clientId`.
*   **Отправка сообщения:**
    1.  Пользователь вводит сообщение в поле ввода чата.
    2.  Нажимает кнопку отправки.
    3.  Сообщение отправляется через `viewModel.sendMessage`.
    4.  Если сообщение было отправлено успешно и флаг `closeOnSent` установлен, отображается диалог подтверждения, после которого экран может быть закрыт.
*   **Управление непрочитанными сообщениями:**
    1.  При входе на экран чата (`onResume`), отменяется фоновая задача `UnreadChatWorker` (предполагается, что она отслеживает непрочитанные сообщения).
    2.  При выходе с экрана чата (`onPause`), запускается `UnreadChatWorker` для возобновления отслеживания непрочитанных сообщений.

## 4. Навигация

С экрана "Чат с провизором" возможны следующие действия:

*   **Закрытие экрана:** При нажатии кнопки "Назад" в тулбаре или после успешной отправки сообщения, если `closeOnSent` установлен и пользователь подтверждает закрытие в диалоге.
*   **Диалоговое окно подтверждения:** Отображается после успешной отправки сообщения, если `closeOnSent` установлен.

### Deep Links

На этот экран нет прямых deep links.

## 5. Отображаемые Данные

*   **Типы данных:**
    *   `Map<String, String>`: Содержит данные о текущем городе и токене устройства, передаваемые в чат.
    *   `Resource<Unit>`: Используется для отслеживания статуса отправки сообщения.
*   **Источник данных:**
    *   **API:**
        *   Прямые HTTP-запросы через `OkHttpClient` к `https://lcab.talk-me.ru/json/v1.0/fileshare/upload/getUploadUrl` (для получения URL загрузки файла), `https://lcab.talk-me.ru/json/v1.0/chat/message/sendToOperator` (для отправки сообщений) и URL для загрузки файла.
        *   `ApiService.isOperatorOnline` (REST метод: `GET /ma/site/v1/chat/operator-available`) - для проверки статуса оператора.
    *   **Локальное хранилище:** Нет прямого использования локального хранилища для отправки сообщений или вложений.

## 6. Особые Состояния/Логика

*   **Обработка Insets:** Экран корректно обрабатывает системные отступы (status bar, navigation bar, IME) для правильного отображения UI.
*   **Инициализация клиента чата:** После загрузки `ChatView`, колбэк `setOnClientIdListener` используется для получения `clientId` и последующей отправки предварительно заданного сообщения.
*   **Управление фоновыми задачами:** `UnreadChatWorker` используется для управления уведомлениями о непрочитанных сообщениях, запускаясь при выходе из чата и отменяясь при входе.
*   **Аналитика:** Открытие экрана чата логируется с помощью `AnUtils.logEvent`.