# SpecialsFragment

## 1. Обзор Экрана

Экран "Мегасоветы" (SpecialsFragment) предназначен для отображения списка специальных предложений и акций (мегасоветов). Он позволяет пользователю переключаться между всеми мегасоветами и избранными, а также взаимодействовать с каждым мегасоветом (просматривать детали, добавлять в избранное).

**Основные функции:**
*   Отображение списка мегасоветов с пагинацией.
*   Переключение между вкладками "Все мегасоветы" и "Избранные".
*   Просмотр детальной информации о мегасовете.
*   Добавление/удаление мегасоветов из избранного.
*   Обновление списка мегасоветов с помощью "потяни-чтобы-обновить" (pull-to-refresh).
*   Поиск мегасоветов по текстовому запросу.
*   Обработка со��тояний загрузки, ошибок и пустого списка.

## 2. Элементы Пользовательского Интерфейса (UI Elements)

*   **Toolbar (через MenuProvider):**
    *   **Назначение/Функция:** Содержит поисковую строку (`SearchView`) для фильтрации мегасоветов.
    *   **Взаимодействие пользователя:** Ввод текста в `SearchView` инициирует поиск по мегасоветам.
*   **SearchView (action_search в меню):**
    *   **Назначение/Функция:** Поле для ввода поискового запроса для мегасоветов.
    *   **Взаимодействие пользователя:** Ввод текста для фильтрации списка мегасоветов. Запросы отправляются с задержкой (debounce) для оптимизации производительности.
*   **SwipeRefreshLayout (swipeRefresh):**
    *   **Назначение/Функция:** Позволяет пользователю обновить список мегасоветов, потянув экран вниз.
    *   **Взаимодействие пользователя:** Свайп вниз для обновления данных.
*   **RecyclerView:**
    *   **Назначение/Функция:** Основной контейнер для отображения секций `TabsSection`, `SpecialsSection` и `StateSection`.
    *   **Взаимодействие пользователя:** Вертикальная прокрутка для просмотра содержимого.
*   **TabsSection:**
    *   **Назначение/Функция:** Отображает вкладки для переключения между "Все мегасоветы" и "Избранные".
    *   **Возможные состояния:** Выбрана одна из вкладок.
    *   **Взаимодействие пользователя:** Нажатие на вкладку изменяет фильтр отображаемых мегасоветов.
*   **SpecialsSection:**
    *   **Назначение/Функция:** Адаптер для `RecyclerView`, который управляет отображением отдельных карточек мегасоветов. Каждая карточка, вероятно, включает изображение, заголовок и иконку избранного.
    *   **Взаимодействие пользователя:** Нажатие на мегасовет для перехода к детальному просмотру. Нажатие на иконку избранного для изменения статуса мегасовета.
*   **StateSection:**
    *   **Назначение/Функция:** Отображает состояния загрузки, ошибки или пустого состояния данных для списка мегасоветов.
    *   **Возможные состояния:**
        *   `LOADING`: Показывает индикатор прогресса и сообщение "Загрузка мегасоветов".
        *   `ERROR`: Показывает сообщение об ошибке и кнопку "Повторить".
        *   `EMPTY`: Показывает сообщение о пустом списке (разное для "Избранных" и "Всех мегасоветов").
        *   `HIDDEN`: Скрыт, когда данные успешно загружены и отображаются.
    *   **Взаимодействие пользователя:** Нажатие на кнопку "Повторить" (в состоянии ошибки) для повторной попытки загрузки данных. Нажатие на кнопку в пустом состоянии может инициировать нави��ацию.

## 3. Пользовательские Сценарии (User Flows)

*   **Просмотр всех мегасоветов:**
    1.  Пользователь открывает экран "Мегасоветы".
    2.  По умолчанию выбрана вкладка "Все мегасоветы".
    3.  Загружаются и отображаются мегасоветы с пагинацией.
    4.  Пользователь может прокручивать список для загрузки новых мегасоветов.
*   **Просмотр избранных мегасоветов:**
    1.  Пользователь нажимает на вкладку "Избранные".
    2.  Загружаются и отображаются только мегасоветы, добавленные в избранное.
    3.  Если избранных мегасоветов нет, отображается соответствующее сообщение о пустом списке.
*   **Поиск мегасоветов:**
    1.  Пользователь вводит текст в поисковую строку в тулбаре.
    2.  Список мегасоветов фильтруется по запросу.
*   **Переход к деталям мегасовета:**
    1.  Пользователь нажимает на любой мегасовет в списке.
    2.  Происходит навигация к экрану `SpecialDetailFragment` с передачей ID выбранного мегасовета.
*   **Добавление/удаление из избранного:**
    1.  Пользователь нажимает на иконку избранного на карточке мегасовета.
    2.  Статус избранного обновляется, и изменение отражается в списке.
*   **Обновление списка:**
    1.  Пользователь выполняет жест "потяни-чтобы-обновить".
    2.  Список мегасоветов перезагружается.

## 4. Навигация

С экрана "Мегасоветы" возможны следующие переходы:

*   **`SpecialDetailFragment`:** Для просмотра детальной информации о выбранном мегасовете.
*   **Навигация по DeepLink:** Если кнопка в пустом состоянии имеет deep-ссылку.

### Deep Links

На этот экран можно попасть по следующим deep links:

*   `{scheme}://{host}/specials`

## 5. Отображаемые Данные

*   **Типы данных:**
    *   `PagingData<Special>`: Для отображения списка мегасоветов, где `Special` представляет собой объект мегасовета (например, ID, заголовок, изображение, статус избранного).
    *   `Meta`: Метаданные, включая информацию для пустого состояния.
*   **Источник данных:**
    *   **API:**
        *   `ApiService.getSpecials` (REST метод: `GET /app/v1/specials`) - для получения списка мегасоветов.
        *   `ApiService.putFavoriteSpecial` (REST метод: `PUT /app/v1/specials/favorites`) - для обновления статуса избранного.
    *   **Локальное хранилище:** Нет.
    *   **Ввод пользователя:** Поисковый запрос.

## 6. Особые Состояния/Логика

*   **Производительность на слабых устройствах:** Для устройств с низкой производительностью аниматор элементов `RecyclerView` отключается (`viewBinding.recyclerView.itemAnimator = null`).
*   **Оптимизация поиска:** Используется `debounce` и `distinctUntilChanged` для предотвращения частых запросов при вводе текста в `SearchView`.
*   **Динамическая ширина `SearchView`:** Максимальная ширина `SearchView` динамически рассчитывается, чтобы она не перекрывала другие элементы меню.
*   **Обработка ошибок Paging:** `handleLoadStates` обрабатывает различные состояния загрузки (начальная загрузка, добавление, ошибка) и отображает соответствующий UI через `StateSection`.
*   **Синхронизация избранного:** Изменения в статусе избранного мегасовета, сделанные на экране деталей мегасовета (`SpecialDetailFragment`), синхронизируются с этим экраном через `globalViewModel.specialChanges`.
*   **Обработка пустого состояния:** В случае пустого списка мегасоветов, `StateSection` отображает кастомизированное сообщение и кнопку, которая может выполнить навигацию по deep-ссылке.
